# コンテナランタイム
- ホストマシン上でコンテナの作成・管理を行うソフトウェア
  - ホストから隔離された実行環境の作成
  - コンテナイメージからのコンテナ実行
  - コンテナイメージの配布

## コンテナランタイムのレイヤ
### 高レベルランタイム
- kubeletやユーザーから指示を受け、コンテナやイメージ、ネットワーク等の全般的な管理を行う
  - CRI(Container Runtime Interface) - Kubernetes上で用いられる高レベルランタイムの仕様
  - Ex. Docker、containerd、CRI-O

### 低レベルランタイム
- 高レベルランタイムから指示を受け、ホストから隔離された実行環境をコンテナとして作り出し、操作可能にする
  - OCI Runtime specification - 低レベルランタイムの仕様
  - OCI Image specification - コンテナイメージの標準仕様
    - コンテナイメージを構成するコンポーネント(ファイル)
    - コンポーネントのディスク上の配置方法
    - コンポーネントのメディアタイプ
  - OCI Distribution specification - コンテナレジストリのAPIを定義する仕様
  - Ex. runc、gVisor、Kata Containers

#### [OCI Runtime specification]] Filesystem bundle
- 高レベルランタイムから低レベルランタイムへ、コンテナイメージを構成するファイル群を渡す際の格納方法を定めた仕様
- 実行環境設定ファイルとルートファイルシステムを格納するディレクトリ
  - 実行環境設定ファイル - エントリーポイント、ユーザー、環境変数、namespace、cgroupの設定項目を含むJSONファイル
- 低レベルランタイムはFilesystem bundleに含まれるファイル群を用いて実際のコンテナを作成する

#### [OCI Runtime specification]] コンテナのライフサイクル
1. Filesystem bundleをOCI準拠のランタイムに指定し、コンテナを作成する
2. コンテナの実行を開始する
3. コンテナ内のアプリケーションが終了する
4. コンテナを削除する

#### [OCI Runtime specification] コンテナに対して可能な操作
- create - コンテナの作成
- start - コンテナ内でアプリケーションを実行
- kill - コンテナの終了
- delete - コンテナの削除
- state - コンテナの状態を取得

#### [OCI Image specification] コンポーネント
- マニフェスト - コンテナイメージの設計図となるJSONファイル
- レイヤー - コンテナのルートファイルシステムのレイヤー群
- コンフィギュレーション - イメージをコンテナとして実行する際の情報を含むJSONファイル(Filesystem bundle作成時に利用)
- インデックス(optional) - マニフェストへの参照情報を含むJSONファイル(マニフェストを複数参照可能にする)

## コンテナ作成の流れ
1. 高レベルランタイムがコンテナレジストリからコンテナイメージを取得
2. 高レベルランタイムがFilesystem bundleを作成
3. 高レベルランタイムがFilesystem bundleを低レベルランタイムへ渡し、コンテナの実行環境作成を指示する
4. 低レベルランタイムが指示に従い、Filesystem bundleからホストと隔離された実行環境をコンテナとして作成する
5. 低レベルランタイムがコンテナに格納されたアプリケーションを実行する

## 引用・参照
- イラストでわかるDockerとKubernetes
