# ファイルシステム
- Dockerにおけるファイルシステムは差分管理の仕組みを導入している
- コンテナ内のプロセスがイメージレイヤーに含まれるファイルを更新する場合、
  対象のファイルがイメージレイヤーからコンテナレイヤーへコピーされ、
  コピーに対して変更が加えられる(CoW戦略)
- コンテナ内のプロセスがファイルを読み込む場合、全てのレイヤーから対象のファイルが検索され、
  該当するファイルの中から一番新しいものが読み込まれる

#### イメージレイヤー
- コンテナイメージ内に存在する読み込み専用のレイヤー

#### コンテナレイヤー
- コンテナ内のプロセスによるファイルの追加や変更を記録するためのレイヤー
- コンテナ起動時にコンテナイメージの外側に作成され、コンテナ削除時に同時に削除される

## OverlayFS
- Dockerリポジトリにおいてイメージを格納する容量を削減する目的で使用されているファイルシステム
- レイヤーを重ね合わせ、一つのディレクトリであるかのように結合して見せるファイルシステム
  - 結合時に同名のファイルが存在する場合、上位レイヤー内に存在しているファイルのみ見える
```
$ mount -t overlay [一意の識別名] -o lowerdir=[lowerdirに指定するディレクトリ],upperdir=[upperdirに指定するディレクトリ],workdir=[workdirに指定するディレクトリ] [mergeddirに指定するディレクトリ]
```

### レイヤー構造
#### `mergedir`
- `lowerdir` / `upperdir`を結合したディレクトリ
- ファイルの追加・変更・削除操作を行う

#### `upperdir`
- mergedirで追加・変更・削除されたファイルが実際に保存されるディレクトリ
  - 追加操作 -> `upperdir`にファイルが追加される
  - 変更操作 -> `lowerdir`から`upperdir`へファイルがコピーされ内容が変更される
  - 削除操作 -> `lowerdir`から`upperdir`に同名のキャラクタデバイスファイルが作成される

#### `lowerdir`
- ベースとなるディレクトリ
- 読み取り専用(変更時は再mountが必要)

#### `workdir`
- 内部的に利用される作業用ディレクトリ

## DockerにおけるOverlayFS
- Dockerfileは上から下へ読み込まれる
- Dockerfileに記載されている設定一行ごとにOverlayFSの`lowerdir`層が形成される
  - ファイルシステムに影響のないコマンドを除く
- ベースとするDockerイメージが`lowerdir`の最下層レイヤーとなる
- 最終的に形成される`mergeddir`が起動したDockerコンテナの姿となる
- Dockerコンテナ(`mergeddir`)内で追加・変更・削除されたファイルは`upperdir`に保存される

## プライベートリポジトリ
- 任意の環境にプライベートなDockerリポジトリを作成する
  - Docker Hubと同じ動作を行う

```
# プライベートリポジトリregistry:2.7.1をpullし
# localhost:5000でアクセスできるようにする
$ docker run -d -p 5000:5000 registry:2.7.1

# localhost:5000のDockerリポジトリに対して
# ホスト内のDockerイメージxxxxをイメージ名xxxx、タグ1.0.0でタグ付け
$ docker tag xxxx localhost:5000/xxxx:1.0.0

# プライベートリポジトリへpush
$ docker push localhost:5000/xxxx
```

```
/var/lib/registry/docker/registry/v2
  |- repositories             // イメージのメタ情報
  |   |- xxxx                 // イメージ名
  |       |- _manifests/tags
  |           |- 1.0.0        // イメージのタグ名
  |               |- current
  |                   |- link // イメージのメタ情報
  |
  |- blobs            // 実際のコンテンツをレイヤーごとに格納
      |- sha256       // sha256でハッシュ化したディレクトリ
          |- ...      // イメージのメタ情報
          |   |- data // 圧縮された実データ
          |- ...
          |   |- data
          |- ...
          |   |- data
```
- Dockerfile内で発行された各コマンドで生成されたファイルはレイヤー単位で管理される
- 同じレイヤーは重複してリポジトリにはアップされず、リポジトリ上で共有される

## 参照
- [【連載】世界一わかりみが深いコンテナ & Docker入門 〜 その6:Dockerのファイルシステムってどうなってるの？ 〜](https://tech-lab.sios.jp/archives/21103)
- 仮想化&コンテナがこれ1冊でしっかりわかる教科書
