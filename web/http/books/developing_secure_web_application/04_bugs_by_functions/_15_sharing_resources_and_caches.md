# 安全なWebアプリケーションの作り方(脆弱性が生まれる原理と対策の実践) まとめ
- 徳丸浩 著

## 15 共通資源やキャッシュに関する問
- Webアプリケーションが複数のリクエストを同時に受け付けるために利用される
  共通資源やキャッシュに関連して脆弱性が発生するケースがある

### 競合状態の脆弱性
- 発生箇所: 共有資源を利用している箇所
- 影響範囲: すべてのページ
- 影響の種類: 別人の情報が表示される、DB不整合、ファイルの破壊
- 影響度合い: 中
- 利用者関与の範囲: 要・不要とも
- 対策:
  - 共有資源の利用を避ける
  - 共有資源に対する排他制御を行う

#### 共有資源
- 複数のプロセス・スレッドから同時に利用されている変数・共有メモリ・ファイル・DB

#### 事例
- 共有資源としてインスタンス変数を使用しているアプリケーションにおいて、
  二つの別々のリクエストが同じ処理をそれぞれ実行した際、
  後から実行された方の情報によってインスタンス変数が上書きされてしまう事故

#### 原因
- 共有資源を使いわましている
- 共有資源の排他処理を行なっていない

#### 対策
- 共有資源を使用しない(インスタンス変数をローカル変数に変更する
- 各処理を別スレッド内で行うことによって共有資源の上書きを避ける(排他処理)
  - 別スレッドの処理を行なっている時間、待機時間が発生することによってアプリケーションの性質は低下する
  - 排他処理を行わないためにも共有資源の使用を避ける

### キャッシュからの情報漏洩
- 発生箇所: キャッシュを利用している環境で秘密情報を表示している箇所
- 影響範囲: 秘密情報を表示しているページ
- 影響の種類: 別人の情報が表示される
- 影響度合い: 低〜中
- 利用者関与の範囲: 要
- 対策: キャッシュの設定を適切に実施する

#### 事例
- キャッシュサーバーを利用しているとき、複数のブラウザから同じサイトを別アカウントで表示しようとするが、
  同じアカウントの情報が表示されてしまう事故
- キャッシュサーバーの設定不備により、意図せずキャッシュを行なっている事故

#### 原因
- アプリケーション側のキャッシュ制御不備
  - `Cache-Control`ヘッダの設定が`public`になっている
- キャッシュサーバーの設定不備
  - `Cache-Control` `Expires` `Set-Cookie`ヘッダを無視するような設定が入っている

#### 対策
- キャッシュからの情報漏洩 -> キャッシュするべきでないリソースのキャッシュを行なっている
- アプリケーション側でキャッシュ制御用の適切なレスポンスヘッダを設定する
- キャッシュサーバー側でキャッシュ制御の適切な設定を行う
- キャッシュバスターを利用する
  - URLに乱数値を付加する
    - 毎回異なる乱数が付与されるので情報漏洩の可能性がなくなる
    - キャッシュ自体はされるのでキャッシュ用ストレージの無駄遣いとなる
