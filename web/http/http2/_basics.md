# HTTP/2概論
- 参照: [普及が進む「HTTP/2」の仕組みとメリットとは](https://knowledge.sakura.ad.jp/7734/)
- 参照: [HTTP の進化](https://developer.mozilla.org/ja/docs/Web/HTTP/Basics_of_HTTP/Evolution_of_HTTP)
- 参照: [そろそろ知っておきたいHTTP/2の話](https://qiita.com/mogamin3/items/7698ee3336c70a482843)
- 参照: [Request and Response](https://youtu.be/0cmXVXMdbs8)
- 参照: [HTTP/2 Server Pushとは？(CDN サーバープッシュでWeb高速化）](https://blog.redbox.ne.jp/http2-server-push-cdn.html)
- 参照: [HTTP/2とは](https://www.nic.ad.jp/ja/newsletter/No68/0800.html)
- 参照: [HTTP/2](https://hpbn.co/http2/#binary-framing-layer)
- HTTP/2サポートブラウザはSSLを使用している
  - HTTP/2自身はSSLが必須ではない

### SPDY
- Googleで開発されたHTTP/2の前身的なプロトコル

## 目的
- Webページのリソースの増加(数、サイズ)に伴うパフォーマンス改善
  - リクエストとレスポンスの多重化によるレイテンシの低減
  - HTTPヘッダフィールドの効率的な圧縮によるプロトコルのオーバーヘッド最小化
  - リクエストの優先順位付けとサーバプッシュ機能の追加
- 「HTTPメッセージのセマンティクスを維持し、パフォーマンスとセキュリティを改善する」

## 主な仕様
- テキストベース -> バイナリベース
- ストリームの導入
  - 一回のTCP接続で同時に並行して複数のリクエスト/レスポンスを処理する
- ヘッダの圧縮
  - HPACKの利用
- サーバプッシュ機能
  - リクエストより先にサーバーからクライアントのキャッシュにデータを加える
  - プッシュするコンテンツはWebサーバーのコンフィグに直接記載する、あるいはLinkヘッダ内の記述をみて判断する

## ストリームの導入
- ストリーム -> クライアント−サーバー間を結ぶ仮想的なコネクション
- 一つのTCPコネクションを再利用し、HTTPリクエストとHTTPレスポンスを複数のストリームによって多重化する
- 複数のリクエスト(ストリーム)を作成し、一回のTCP接続によって送信する
- ブラウザから複数のタブを開いていてもリクエストは一回の接続にまとめられる

### ストリーム -> TCP接続上に作成される複数の仮想的な通信単位
- 一対のリクエストとレスポンスが一ストリームに所属する(一往復したストリームは使われなくなる)
- 一意のID(ストリームID)を持つ
  - コネクション自体を意味するストリームIDは0
  - クライアントから開始したストリームは奇数ID
  - サーバプッシュによってサーバから開始されるストリームは偶数ID
- 各ストリームはそれぞれ独立しているため複数のリクエスト/レスポンスを同時並行的に処理することができる
- ストリームごとに優先度を設定することが可能(PRIORITYフレーム)
- ストリームレベルでフロー制御を行うことが可能(SETTINGSフレーム/WINDOW_UPDATEフレーム)
  - コネクションレベルでのフロー制御も可能
    - 参照: [コネクションレベルとストリームレベル](https://qiita.com/Jxck_/items/622162ad8bcb69fa043d#%E3%83%95%E3%83%AD%E3%83%BC%E5%88%B6%E5%BE%A1%E3%81%AE%E6%96%B9%E6%B3%95)

### TCPコネクションの再利用
- [HTTPの場合]ドメイン名のIPアドレスが同じ場合再利用可
- [HTTPSの場合]ドメイン名のIPアドレスが同じであり、 証明書が有効である場合再利用化

### フレーム -> データ単位
- フレームは所属しているストリームIDを持つ
- 実際の通信では各フレームがばらばらに送信され、ストリームIDを元に復元される

##### フレームタイプ
- 引用: [HTTP/2 Server Pushとは？(CDN サーバープッシュでWeb高速化）](https://blog.redbox.ne.jp/http2-server-push-cdn.html)
```
0x0  DATA          リクエスト・レスポンスボディ
0x1  HEADERS       非圧縮または圧縮されたHTTPヘッダー
0x2  PRIORITY      ストリーム優先度変更
0x3  RST_STREAM    ストリーム終了通知
0x4  SETTINGS      接続に関する設定
0x5  PUSH_PROMISE  リソースのプッシュ通知
0x6  PING          接続状況確認
0x7  GOAWAY        接続終了通知
0x8  WINDOW_UPDATE フロー制御ウィンドウの更新
0x9  CONTINUATION  HEADERSフレーム・PUSH_PROMISEフレームのデータ
```

## HPACK
- ハフマン符号とインデックステーブルの組み合わせでヘッダを圧縮し、
  作成したヘッダをHEADERSフレームに格納して送信する

### ハフマン符号
- 出現頻度の高い文字を短いbit数で示す

### インデックステーブル
- ヘッダ名とヘッダ値を格納する辞書テーブル
- 静的テーブル -> 事前に定義
- 動的テーブル -> 送信したヘッダを動的に追加

## サーバプッシュ機能
- サーバがリクエストを受信後、レスポンスを返す前にPUSH_PROMISEフレームを送信する
  - PUSH_PROMISEフレーム -> レスポンスのストリームの予約と、想定リクエストヘッダを記述
  - 予約したストリームでHTTPレスポンスを送信する

## セキュリティ
- HTTP/2においてTLSを使用する場合の規約
  - TLS 1.2以上
  - SNI（Server Name Indication）をサポート
  - 仕様で指定される暗号スイートを使用
  - TLSの圧縮機能を無効化
  - TLSの再ネゴシエーションを使用しない
- 規約が守られない通信はHTTP/2レイヤでコネクションエラーが発生

## ポートとスキーマ
- HTTP/1.0との互換性を保ち、使用するデフォルトのポート番号はhttpの場合80番、httpsの場合443番のまま

### 識別子
- ポート番号とは別に、どのような方式で接続を行うかを決めるためのもの
  - h2(HTTP/2 over TLS -> いわゆるhttps)
  - h2c(HTTP/2 over TCP -> いわゆるhttp)

## 利用方法
- まずHTTP/1.1以前と同じ方法でクライアントからサーバーへ接続を行い、サーバーが対応していればHTTP/2に移行する
- クライアント -> サーバーへHTTP/2での通信開始をネゴシエーションする
  - リクエストと同時にConnectionヘッダ、Upgradeヘッダ、HTTP2-Settingsヘッダをリクエストヘッダとして送信する
  - サーバーはステータスコード101のレスポンスを返し、HTTP/2コネクションに移行
  - [HTTPSの場合]ALPN(TLS拡張)を使用する
  - [HTTPの場合]HTTP/1.1 -> HTTP/2へのアップグレード
  - [接続済の場合など]ダイレクトで開始する
