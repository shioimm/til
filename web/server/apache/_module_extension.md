# 拡張モジュール
- 引用・参照: Webで使えるmrubyシステムプログラミング入門 Section026

## 拡張モジュールの追加手順
1. 拡張モジュールのプログラム(C言語)を作成(`mod_***`)
    - httpd.hからApache Portable Runtime(APR)をインクルード
2. `apxs`でモジュール`mod_***.so`をビルド
    - apxs - Apache拡張モジュールを作成するためのビルド、インストールなどを行うコマンド
3. ビルドしたモジュールをインストール、設定
4. Apacheの再起動

## 拡張
- `AP_MODULE_DECLARE_DATA`の設定に沿って必要な関数・変数の定義を行う
```c
#include "httpd.h"

module AP_MODULE_DECLARE_DATA minimruby_module = {
  // 1. STANDARD20_MODULE_STUFF(拡張モジュールの形式)
  // 2. ディレクトリ単位の設定初期化に利用する関数ポインタ
  // 3. ディレクトリ単位の設定のマージに利用する関数(NULL値可)
  // 4. サーバ単位の設定を初期化に利用する関数ポインタ
  // 5. サーバ設定のマージに利用する関数(NULL値可)
  // 6. command_rec型構造体(*)の配列
  //    (*設定ファイル上で呼ばれるディレクティブの名前と、ディレクティブ宣言時にフックする関数を設定する構造体)
  // 7. ap_hook_handler(*)を呼び出す関数
  //    (*モジュール内に記述した関数をフックのハンドラとして登録する)
};
```

## Apacheにおけるメモリ割り当てと解放
- Apacheはサーバー起動時、サーバー内部で使用するオブジェクトのためのメモリプールを保持する(apr_pool_t型)
- Apache拡張におけるメモリ割り当て・解放はApacheのメモリプールの機構を使用する
- `apr_pcalloc`関数 - Apache拡張内で使うデータのための領域をメモリプールに割り当てる(返り値はポインタ)

## `apxs`コマンドのオプション
- `-c`  - コンパイル
- `-i`  - インストール
- `-a`  - LoadModule設定を生成
- `-n`  - モジュール名を指定
- `-I`  - インクルードするヘッダを探すパスを追加
- `-L`  - ライブラリを探すパスを追加
- `-l`  - リンクするライブラリを指定
- `-Wc` - 追加でコンパイラに渡すフラグを指定
- `-Wl` - 追加でリンカに渡すフラグを指定
