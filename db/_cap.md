# CAP定理
- ネットワークでつながった複数のノードに分散して共通のデータを保存する際、
  一貫性、可用性、ネットワーク分断耐性の3要素を同時に満たすことができないという定理

#### 一貫性 (Consistency)
- あるデータの読み込みにおいて、どのノードにおいても必ず最新の書き込み結果もしくはエラーを取得すること

#### 可用性 (Availability)
- DBシステムを構成するノードの一部に障害が発生していたとしても常に読み込みと書き込みが可能であること

#### ネットワーク分断耐性 (Partition-tolerance)
- DBシステムを構成するノード間の通信が一時的に分断されても機能が継続されること

## CAP定理に基づく分類
### CA型 (一貫性＋可用性)
- RDB (e.g. Oracle、PostgreSQL、MySQL)
- 単一サーバーで動作するDB
- トランザクション処理機能により一貫性を保つ

#### ユースケース
- 検索条件が複雑 (集合関数、射影・結合、サブクエリ)
- 厳密なトランザクション・整合性が求められる
- アップデートの処理コストを最小限に抑えたい

#### 構成方針
- ノード間の同期を取りながら更新する
1. DBをプライマリ + セカンダリの2台で更新する
2. X/Openに対応した分散トランザクションで同時にノードへ更新をかけすよう2フェーズコミットする
    - 2フェーズコミット - 処理の整合性が保たれるように2段階に分けてコミットする

### AP型 (可用性＋分断耐性)
- Amazon DynamoDB派生 (e.g. Amazon DynamoDB、Apache Cassandra)
- DNS、NTP、HTTPキャッシュなど
- 複数台で運用し、特定の一台でアクセスを受け付け、ロックはかけない
- 更新情報がサーバ間で伝搬するまでデータの不整合が発生する

#### ユースケース
- 一部が利用できなくても大きな問題はなく、キャッシュやシャーディングを利用して高速化を図りたい

#### 構成方法
- シャーディング (データを複数のノードに分けて保存する)
  - シャーディング自体は性能向上を目的とする不可分さんのためにRDBでも使用される

### CP型 (一貫性＋分断耐性)
- Google Big Table派生 (e.g. HBase、Mongo DB、Redis)
- 分散データベース
- 2相、3相コミットにより一貫性を保てる
- サーバーが増えるとロック待ちが発生する
- 単一障害点がない

#### ユースケース
- 多数のアプリケーションからアクセスがある
- 後から性能を拡張したい
- グローバルな複数のデータセンターにまたがってデータを共通化・レプリケートしたい
- 書き込みトラフィックが多い

#### 構成方法
- 複数のノードにデータを分散し、全体で一つのDBとして動作するように構成する

## 参照
- [CAP定理](https://ja.wikipedia.org/wiki/CAP%E5%AE%9A%E7%90%86)
- [「メタデータ」「NoSQL」「CAP定理」を理解する](https://www.atmarkit.co.jp/ait/articles/1703/01/news204_2.html)
- AWSの基本・仕組み・重要用語が全部わかる教科書 06-01
