# PostgreSQL
#### URLの構造
```
postgres:/<DomainName>:<Password>@<URL>:<PortNumber>/<Path>
```

#### プロセス

| プロセス名             | 説明                                                                           |
| -                      | -                                                                              |
| マスターサーバ         | 親プロセス                                                                     |
| ロガー                 | サーバーログを書き出す                                                         |
| ライタ                 | 共有バッファ内の更新されたページを対応するデータファイルのブロックに書き出す   |
| WALライタ              | WALバッファの内容をWALファイルに書き出す                                       |
| チェックポインタ       | チェックポイント (すべてのダーティページをデータファイルに書き出す) を実行する |
| 自動バキュームランチャ | 自動バキュームワーカを起動する                                                 |
| 自動バキュームワーカ   | テーブルに対してバキューム・アナライズを実行する                               |
| 統計情報コレクタ       | DBの活動状況に関する統計情報を一定間隔で収集する                               |
| バックグラウンドワーカ | ロジカルレプリケーション用ワーカ                                               |
| バックエンドプロセス   | クライアントからの接続要求に対して生成され、クエリを受け取って実行する         |
| パラレルワーカ         | パラレルスキャン時に起動され、クエリを処理する                                 |

#### メモリ管理
- 共有メモリ域 - バックグラウンドプロセス、バックエンドプロセスから参照・更新される共有領域
  - 共有バッファ (`shared_buffers`) - テーブル・インデックスのデータをキャッシュするために使用
  - WALバッファ (`wal_buffers`) - ディスクに書き込まれていないトランザクションログをキャッシュュするために使用
  - 空き領域マップ (`FSM: Free Space Map`) - テーブル上の利用可能な領域を指し示す情報を扱う
  - 可視性マップ (`VM: Visibility Map`) - テーブルのデータが可視であるか否かを管理する情報を扱う
- プロセスメモリ域 - バックエンドプロセスごとに確保される作業用のメモリ領域
  - 作業メモリ (`work_mem`) - クエリ実行時の並び替え・ハッシュテーブル操作に使用
  - メンテナンス用作業メモリ (`meintenace_work_mem`) - バキューム、インデックス作成、外部キー追加時に使用
  - 一時バッファ (`temp_buffers`) - 一時テーブルアクセス時に使用

#### ファイル構成
- `データベースクラスタ/`
  - `base/`
    - `各データベース/`
      - テーブルファイル
      - インデックスファイル
      - TOASTファイル
      - <テーブル及びインデックスを示す数字>_fsm (Free Space Mapファイル)
      - <テーブル及びインデックスを示す数字>_vm (Visibility Mapファイル)
  - `grobal/`
    - クラスタ内で共有するテーブル群
  - `pg_wal/`
    - WALファイル
  - `pg_xact/`
    - トランザクションのコミット状態を管理するファイル群
  - `pg_tblspc/`
    - テーブル空間として作成されたディレクトリへのシンボリックリンク群
  - `PG_VERSION`
  - `postgresql.conf`
  - `pg_hba.conf`
  - `postmaster.pid`

## クエリの実行
1. SQL文をパーサに入力 (字句解析 / 構文解析 / テーブル・カラムの存在性の確認)
2. パーサが問い合わせツリーを出力
3. 問い合わせツリーをリライタに入力
4. リライタがDBのルールを参照して問い合わせツリーを修正
5. 問い合わせツリーをプランナに入力
6. プランナが実行計画 (テーブルに対するアクセス方法と結合方法) を出力
7. 実行計画をエグゼキュータに入力
8. エグゼキュータが実行計画に従った必要な行の集合を抽出

## SQLの種類
- DML - データ操作 (select、insert、update、delete)
- DDL - データベースオブジェクトの生成、削除、変更 (create、drop、alter)
- DCL - トランザクション制御 (begin、commit、rollback)
- DDL、DCLは問い合わせツリーの作成後、プランナに入力されるが何も行われず、対応する個々のコマンドを実行する

## 構造
#### データベース
- インストール直後はデータベースとして`template0`、`template1` (テンプレート用)、`postgres`が作成される

#### スキーマ
- データベース内のテーブル・関数などのオブジェクトをグループ化する仕組み
- データベース作成時には自動的に`public`スキーマが作成される
  - `public`スキーマはデフォルトですべてのロールにアクセス権限とCREATE権限を与えている
  - スキーマの指定をせずにテーブルを作成した場合、`public`スキーマにテーブルが作成される

#### テーブル
- テーブルはスキーマ内に作成される
- 別のスキーマ内に同名のテーブルを作成可能

## select文の解釈順序
1. with
2. from
3. join
4. where
5. group by
6. having
7. select
8. select distinct
9. union、intersect、except
10. order by
11. limit

## 参照
- [5.9. スキーマ](https://www.postgresql.jp/document/13/html/ddl-schemas.html)
- [SELECT](https://www.postgresql.jp/document/14/html/sql-select.html)
- 内部構造から学ぶpostgresql 設計 運用計画の鉄則 2.1~2.2, 4.3
