# `pthread`ライブラリ
- 参照: Linuxとpthreadsによるマルチスレッドプログラミング入門 P2 / 39-41

## TL;DR
- スレッドの管理
  - `pthread_create(3)` - スレッド生成
  - `pthread_exit(3)`  - 現在のスレッド終了
  - `pthread_join(3)`  - スレッドの終了待ち
  - `pthread_self(3)`  - 自身のスレッドIDを得る
  - `pthread_equal(3)` - スレッドIDが等しいか調べる
- 動作の排他(動作同期)
  - `pthread_mutex_init(3)`           - ミューテックスの初期化
  - `pthread_mutex_destroy(3)`        - ミューテックスの破棄
  - `pthread_mutex_lock(3)`           - ミューテックスのロック
  - `pthread_mutex_trylock(3)`        - ミューテックスのロック
  - `pthread_mutex_unlock(3)`         - ミューテックスのロック解除
  - `pthread_mutex_cond_wait(3)`      - 条件変数が有効になるのを待つ
  - `pthread_mutex_cond_timedwait(3)` - 条件変数が有効になるのを待つ
- イベント通知(条件待ち同期)
  - `pthread_cond_wait(3)`    - 条件変数の初期化
  - `pthread_cond_destroy(3)` - 条件変数の破棄
  - `pthread_cond_signal(3)`  - 条件変数の有効化
- 動作の一時停止
  - 該当の関数は存在しない

## Linuxにおけるスレッド
- スレッドはプロセス起動時に作成される(メインスレッド)
- プロセスは起動時に作成されるスレッド以外にも新たにスレッドを生成することができる
  - プロセスを取り扱うコマンドにおいてはメインスレッドのみが見えるようになっている
- Linuxは内部的にはスレッドに対してPIDに相当する番号を発行している(SPID)
  - メインスレッドのSPIDはプロセス起動時に発行されたPID
  - メインスレッド以外のスレッドのSPIDはメインスレッドのSPIDからインクリメントされる
  - プロセスに紐づく全てのスレッドのPIDは元のプロセスのPID

## スレッドの返り値
- スレッドが実行した関数がreturnされたときの返り値
- `pthread_exit(3)`の返り値

## スレッドの終了条件
- スレッドが実行した関数がreturnされたとき
- プロセスが終了したとき
  - プロセス内の全てのスレッドが強制終了する
  - `pthread_join(3)` - 全てのスレッドの終了を待ち合わせてからプロセスを終了する
- スレッド実行関数からさらに別の関数を呼び出し、その先では`pthread_exit(3)`が呼ばれたとき
- 他のスレッドから停止されられたとき
  - `pthread_cancel(3)` - スレッドから他のスレッドに停止要求を出す

## スレッドコンテキスト
- OSがスレッドの状態を保持するためのメモリ
  - スレッドの返り値を含む
- OSはスレッドの実行が終了した後もスレッドコンテキストを持ち続ける

## データ共有
### スレッド間で共有されるもの
- メモリ空間
  - スタック領域上の変数(関数の中の変数)はスレッドごと・関数呼び出しごとに異なる
    - スレッドごとに異なるスタック領域が用意される
    - メモリ空間自体は同一であるため、
      確保しているスタック領域のメモリアドレスがわかれば他のスレッドのスタック領域にアクセスすることが可能
  - スタック領域以外のメモリ空間はスレッド間で共通
    - `malloc(3)`はマルチスレッドセーフなので状態が競合することはない
- ファイルディスクリプタ
- ソケット
- スレッド
- プロセス属性
  - プロセスID
  - ユーザーID
  - カレントディレクトリ
  - リソース制限
  - nice値(プロセスの動作の優先順位を決める)
  - Ex1. 同じプロセス内のスレッドのうち、どのスレッドでファイルを新規作成してもオーナーは同じ
  - Ex2. あるスレッドで`chdir(2)`を実行した場合、他のスレッドのカレントディレクトリも変更される
  - Ex3. プロセスあたりのFD数に制限がある場合、全てのスレッドで開いているFDの合計数が対象になる
