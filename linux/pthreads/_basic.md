# `pthread`ライブラリ
- 参照: Linuxとpthreadsによるマルチスレッドプログラミング入門 P2 / 39-41

## TL;DR
- スレッドの管理
  - `pthread_create(3)` - スレッド生成
  - `pthread_exit(3)`  - 現在のスレッド終了
  - `pthread_join(3)`  - スレッドの終了待ち
  - `pthread_self(3)`  - 自身のスレッドIDを得る
  - `pthread_equal(3)` - スレッドIDが等しいか調べる
- 動作の排他(動作同期)
  - `pthread_mutex_init(3)`           - ミューテックスの初期化
  - `pthread_mutex_destroy(3)`        - ミューテックスの破棄
  - `pthread_mutex_lock(3)`           - ミューテックスのロック
  - `pthread_mutex_trylock(3)`        - ミューテックスのロック
  - `pthread_mutex_unlock(3)`         - ミューテックスのロック解除
  - `pthread_mutex_cond_wait(3)`      - 条件変数が有効になるのを待つ
  - `pthread_mutex_cond_timedwait(3)` - 条件変数が有効になるのを待つ
- イベント通知(条件待ち同期)
  - `pthread_cond_wait(3)`    - 条件変数の初期化
  - `pthread_cond_destroy(3)` - 条件変数の破棄
  - `pthread_cond_signal(3)`  - 条件変数の有効化
- 動作の一時停止
  - 該当の関数は存在しない

## Linuxにおけるスレッド
- スレッドはプロセス起動時に作成される(メインスレッド)
- プロセスは起動時に作成されるスレッド以外にも新たにスレッドを生成することができる
  - プロセスを取り扱うコマンドにおいてはメインスレッドのみが見えるようになっている
- Linuxは内部的にはスレッドに対してPIDに相当する番号を発行している(SPID)
  - メインスレッドのSPIDはプロセス起動時に発行されたPID
  - メインスレッド以外のスレッドのSPIDはメインスレッドのSPIDからインクリメントされる
  - プロセスに紐づく全てのスレッドのPIDは元のプロセスのPID

## スレッドの返り値
- スレッドが実行した関数がreturnされたときの返り値
- `pthread_exit(3)`の返り値

## スレッドの終了条件
- スレッドが実行した関数がreturnされたとき
- プロセスが終了したとき
  - プロセス内の全てのスレッドが強制終了する
  - `pthread_join(3)` - 全てのスレッドの終了を待ち合わせてからプロセスを終了する
- スレッド実行関数からさらに別の関数を呼び出し、その先では`pthread_exit(3)`が呼ばれたとき
- 他のスレッドから停止されられたとき
  - `pthread_cancel(3)` - スレッドから他のスレッドに停止要求を出す

## スレッドコンテキスト
- OSがスレッドの状態を保持するためのメモリ
  - スレッドの返り値を含む
- OSはスレッドの実行が終了した後もスレッドコンテキストを持ち続ける

## データ共有
### スレッド間で共有されるもの
- メモリ空間
  - スタック領域上の変数(関数の中の変数)はスレッドごと・関数呼び出しごとに異なる
    - スレッドごとに異なるスタック領域が用意される
    - メモリ空間自体は同一であるため、
      確保しているスタック領域のメモリアドレスがわかれば他のスレッドのスタック領域にアクセスすることが可能
  - スタック領域以外のメモリ空間はスレッド間で共通
    - `malloc(3)`はマルチスレッドセーフなので状態が競合することはない
- ファイルディスクリプタ
- ソケット
- スレッド
- プロセス属性
  - プロセスID
  - ユーザーID
  - カレントディレクトリ
  - リソース制限
  - nice値(プロセスの動作の優先順位を決める)
  - Ex1. 同じプロセス内のスレッドのうち、どのスレッドでファイルを新規作成してもオーナーは同じ
  - Ex2. あるスレッドで`chdir(2)`を実行した場合、他のスレッドのカレントディレクトリも変更される
  - Ex3. プロセスあたりのFD数に制限がある場合、全てのスレッドで開いているFDの合計数が対象になる

### マルチスレッドセーフ(リエントラント)
- スタック領域以外に隠そうされている変数は全てのスレッドで共有されている
- 関数内部でグローバル変数を使っている場合、その関数はマルチスレッドセーフではない
  - Ex. `localtime(3)` - 返り値がライブラリ内部のグローバル変数へのポインタになっている
    -> 他のスレッドが呼び出した場合、変数に格納した値が変わる
```c
#include <time.h>

time_t now;
time(&now);

const struct tm *nowtm = localtime_r(&now);
printf("%02d:%02d:%02d\n", nowtm->tm_hour, nowtm->tm_min, nowtm->tm_sec);
```
- C言語においてはマルチスレッドセーフであることを保障するため
  リエントラント化した関数を使用する(`関数名_r(3)`)
  - スタック上で変数を定義し、スレッド間の影響を排除しつつ関数の引数に持たせる
```c
#include <time.h>

time_t now;
time(&now);

struct tm nowtm;
localtime_r(&now, &nowtm);
printf("%02d:%02d:%02d\n", nowtm.tm_hour, nowtm.tm_min, nowtm.tm_sec);
```

### スレッドローカル変数
- スレッドごとに異なる値を持つ変数
- 可読性が下がり速度も遅くなるため、使用を避ける方が望ましい(代わりに構造体を使用するなど)
  - `pthread_key_t`型 - キー番号
  - `pthread_key_create(3)`  - スレッドローカル変数の用意
  - `pthread_key_delete(3)`  - スレッドローカル変数
  - `pthread_setspecific(3)` - スレッドローカル変数の設定
  - `pthread_getspecific(3)` - スレッドローカル変数の読み取り

## 排他制御
- Mutual Execution(排他実行) - スレッド同士が同じリソースに対して同時に操作を行うことを防止する
  - スレッドが処理の実行に入る前にミューテックスをONにする
  - スレッドが処理の実行を終えた後にミューテックスをOFFにする
  - `pthread_mutex_t`型        - ミューテックス
  - `pthread_mutex_init(3)`    - ミューテックスの初期化
  - `pthread_mutex_lock(3)`    - アンロック時 -> ロックして0を返す / ロック時 -> アンロックするまで待つ
  - `pthread_mutex_trylock(3)` - アンロック時 -> ロックして0を返す / ロック時 -> 0以外を返す
  - `pthread_mutex_unlock(3)`  - ロック時 -> アンロックする
  - `pthread_mutex_destroy(3)` - 排他制御完了時にミューテックスを破棄

### デッドロック
- ミューテックスがアンロックされるのを待っているが、アンロックできるスレッドが存在しない状態

#### アンロック処理漏れ
- 【原因】アンロック処理の書き忘れ
- 【対策】ロックするコードとアンロックするコードを同じ関数の中に書く

#### 自己ロック
- 【原因】すでにロックしているミューテックスを再度ロック
- 【対策】ロック中に行う処理を関数に切り出し、ロック -> 内部関数 -> アンロックの順で呼び出す

#### 相互ロック
- 【原因】複数のスレッドが複数のミューテックスを持ち、スレッド同士でお互いのミューテックスをロック
- 【対策】
  - 複数のミューテックスを同時にロックしない(処理性能が落ちる)
  - 複数のミューテックスをロックする場合は順番を決める
  - 無駄なロックをかけない

### 読み書きロック機構(rw lock)
- データ読み取り時と書き込み時にそれぞれ排他制御の仕組みを用意する
  - `pthread_rwlock_t`型 - rw lock型
  - `pthread_rwlock_init(3)`
  - `pthread_rwlock_destroy(3)`
  - `pthread_rwlock_rdlock(3)`
  - `pthread_rwlock_tryrdlock(3)`
  - `pthread_rwlock_wrlock(3)`
  - `pthread_rwlock_trywrlock(3)`
  - `pthread_rwlock_unlock(3)`
- 読み出しロック
  - ロックなし状態     -> 読み出しロック状態にする
  - 読み出しロック状態 -> 読み出しロック状態のまま
  - 書き込みロック状態 -> 書き込みロックが解除されるまで待つ
- 書き込みロック
  - ロックなし状態     -> 書き込みロック状態にする
  - 読み出しロック状態 -> 読み出しロックが解除されるまで待つ
  - 書き込みロック状態 -> 書き込みロックが解除されるまで待つ

