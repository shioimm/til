# メモリマッピング
## `mmap(2)`
- 自プロセスの仮想アドレス空間にメモリマッピングを新規作成する
- プロセスのマッピングは`/proc/PID/maps`で確認できる

## マッピングを他のプロセスと共有する方法
- 2プロセスが同じファイルの同じ範囲をマッピングすると
  物理メモリページを共有する
- `fork(2)`により作成した子プロセスは親プロセスのマッピングを受け継ぎ
  物理メモリページを共有する
  - `exec`を実行すると破棄される

## マッピング種類
### ファイルマッピング
- ファイル内容を自プロセスの仮想メモリへ直接マッピングする
- メモリへのアクセスはそのままファイルへのアクセスとなる
- マッピング内のメモリページは必要に応じてファイルからロードされる

### 無名マッピング
- 常に内容が0で初期化される仮想ファイルへマッピングする

## 変更の可視性
### 共有
- マッピング内のデータを変更すると、他プロセスも変更した内容を参照できる
- ファイルマッピングの場合は対応するファイルへ変更が反映される

### 非共有
- マッピング内のデータを変更しても、他プロセスからは変更した内容が参照できない
- ファイルマッピングの場合は対応するファイルへ変更が反映されない
- 変更内容はプロセス内に閉じる
- コピーオンライトによって動作が実現されている

## メモリマッピングの分類

| 変更の可視性 | ファイルマッピング     | 無名マッピング |
| -            | -                      | -              |
| 共有         | メモリマップIO、IPC    | IPC            |
| 非共有       | ファイル内容で初期化   | メモリ割り当て |

### 共有ファイルマッピング
- マッピング内容はファイル内容で初期化される
- 同じファイルの同じ範囲をマッピングする全プロセスは同じページを共有する
- マッピング内容の変更は対応するファイルへも反映される
- 主な用途はメモリマップIOとIPC
  - メモリマップIO - メモリ上のデータをアクセスするだけでファイルIOを実現できる
    - `read(2)` / `write(2)`システムコールをメモリアクセスで置き換える
  - IPC - 関連を持たないプロセス同士でのIPCを実現できる
    - 同じファイルを共有マッピングするプロセスは同じ物理ページを共有する
    - 何らかの手段で同期が必要

### 共有無名マッピング
- 物理ページを共有しない
- 子プロセスは親プロセスからマッピングを受け継ぐため同じページを参照する
- 主な用途は親子プロセス間でのメモリ共有

### 非共有ファイルマッピング
- マッピング内容はファイル内容で初期化される
- コピーオンライトマッピングにより、
  1プロセスが内容を変更しても他プロセスからはその変更が見えない
- 主な用途はメモリをファイル内容で初期化すること
  - 複数プロセスが同じライブラリファイルのテキストセグメントをマッピングする
  - 実行ファイル、共有ライブラリの初期化済みデータセグメントをマッピングする

### 非共有無名マッピング
- 物理ページを共有しない
- コピーオンライトマッピングにより、
  1プロセスが内容を変更しても他プロセスからはその変更が見えない
- 主な用途はプロセス固有の新規メモリ割り当て(`malloc(3)`など)

## ファイルマッピングの作成手順
1. `open(2)`でファイルディスクリプタを得る
2. ファイルディスクリプタに対して`mmap(2)`を実行する
    - `mmap(2)`がファイル内容を自プロセスのアドレス空間へマッピングする
    - `mmap(2)`後はファイルをクローズしても作成済みのマッピングには影響しない

## マッピングへのアクセス時に発生する可能性があるシグナル
- `SIGSEGV`
  - マッピングの保護フラグに一致しない種類のアクセス
- `SIGBUS`
  - ファイルマッピングにおいて対応するファイル部分が存在しないメモリ範囲へのアクセス

## スワップ領域のオーバーコミット機能
- システムが実際のRAMとスワップ領域の合計よりも大きなメモリを提供する機能
- 通常プロセスはマッピングした領域の全体を使用することはないため
  オーバーコミットが可能になる
- `mmap(2)`に`MAP_NORESERVE`フラグをセットするか`/proc`以下のファイルから操作可能

## `munmap(2)`
- 自プロセスの仮想アドレス空間からマッピングを削除する
- プロセスのマッピングはプロセスの終了時(または`exec`時)に自動的に全て削除される

## `msync(2)`
- 共有マッピングを対応ファイルへ反映するタイミングを制御する
- `msync(2)`実行後はマッピングの内容への変更が
  対応ファイルを`read(2)`する他プロセスから参照可能になることを保証する

## `mremap(2)`
- [Linux] 作成したマッピングのサイズ、アドレスを変更する

## `remap_file_pages(2)`
- [Linux] 非リニアマッピングを作成する
    1. `mmap(2)`で新規マッピングを作成する
    2. `remap_file_pages(2)`でファイルのページとメモリ領域のページ対応を操作する

## 参照
- Linuxプログラミングインターフェース 49章
