# パーミッション
- 参照: 例解UNIX/Linuxプログラミング教室P225-269 / P375-432
- 参照: 詳解UNIXプログラミング第3版 4. ファイルとディレクトリ
- 参照: Linuxプログラミングインターフェース 15章 / 16章 / 17章

## TL;DR
- ファイルに対する操作が許可されるかどうかはプロセスの属性とファイルの属性によって決まる
- パーミッション規則はファイルシステムが扱う全ての種類のファイルと
  プロセス間通信オブジェクト(共有メモリ、セマフォ、メッセージキュー)へ適用される
- ファイル実行時、ファイルパスに現れる全てのファイルに対してアクセス許可が検査される

## プロセス属性
- 各プロセスは実効ユーザーIDと実効グループIDを持つ
  - 実効ユーザーID(`uid_t`型) - そのプロセスを実行したユーザーのUID
  - 実効グループID(`gid_t`型) - そのプロセスを実行したユーザーのGID

## ファイル属性
- 各ファイルはパーミッション情報を持つ
  - set-user-IDビット(1ビット)
  - set-group-IDビット(1ビット)
  - スティッキービット(1ビット) - ディレクトリに対して削除処理を制限する
  - パーミッションビット(9ビット)
- `stat`構造体`mode_t st_mode`フィールドにファイル種類と共に格納される

### パーミッションビット
- 誰にどのような操作を許可するかを決める9ビットのフラグ

```
オーナー       グループ   他ユーザー
rwx            r-x        r-x
読み書き実行可 読み実行可 読み実行可
```

#### ユーザーカテゴリ
- オーナー - ファイルオーナーに対するアクセス許可
- グループ - ファイルと同じグループに属するユーザーに対するアクセス許可
- 他ユーザー - それ以外の全ユーザーに対するアクセス許可↲

#### アクセス種類(カテゴリユーザー別にアクセス種類を設定する)
- 読み取り許可
- 書き込み許可
- 実行許可(対象がディレクトリの場合、自身以下のファイルへアクセスする許可)

#### パーミッションビットのマクロ定数(`<sys/stat.h>`)
| `S_ISUID` | set-user-IDビット      |
| `S_ISGID` | set-group-IDビット     |
| `S_ISVTX` | スティッキービット     |
| `S_IRUSR` | オーナーの読み取り可   |
| `S_IWUSR` | オーナーの書き取り可   |
| `S_IXUSR` | オーナーの実行可       |
| `S_IRGSR` | グループの読み取り可   |
| `S_IWGSR` | グループの書き取り可   |
| `S_IXGSR` | グループの実行可       |
| `S_IROSR` | 他ユーザーの読み取り可 |
| `S_IWOSR` | 他ユーザーの書き取り可 |
| `S_IXOSR` | 他ユーザーの実行可     |

### 拡張ファイル属性(EA)
- 通常ファイルまたはディレクトリのi-nodeに情報を追加する機能(ファイルシステム依存)
- `namespace.name=value`の形式で任意の情報を保存できる
  - シェルからは`chattr(1)`でセット、`lsattr(1)`で参照できる
  - プログラムからは`ioctl(2)`で操作できる
    - 作成・変更 - `setxattr(2)` / `lsetxattr(2)` / `fsetxattr(2)`
    - 取得 - `getxattr(2)` / `lgetxattr(2)` / `fgetxattr(2)`
    - 削除 - `removexattr(2)` / `lremovexattr(2)` / `fremovexattr(2)`
    - 一覧 - `listxattr(2)` / `llistxattr(2)` / `flistxattr(2)`
- ディレクトリにセットしたEAは自身以下に作成したファイル・サブディレクトリにも引き継がれる
- プロセスの実効ユーザーIDがファイルオーナーに一致するか、プロセスが特権を持っている場合
  EAを変更することができる

#### `namespace`
- `user` - 非特権プロセスから操作でき、パーミッション検査に関連して使用される
- `trusted` - 非特権プロセスから操作できるが`CAP_SYS_ADMIN`ケーパビリティが必要
- `system` - カーネルが使用する、ファイルとシステムオブジェクトを関連づける
- `security` - OSのセキュリティモジュールが関連づける

## パーミッション検査アルゴリズム
- プロセスが特権を持っていればすべてのアクセスを許可する
- プロセスの実効ユーザーIDとファイルオーナーが同じ場合、
  ファイルオーナーに対する許可に基づく
- それ以外の場合はファイルパーミッションの他ユーザーに対する許可に基づく
- ユーザーカテゴリはオーナー -> グループ -> 他ユーザーの順に検査する

## ファイル作成時マスク(umask)
- プロセスはファイル作成時マスク(umask)を持つ
- ファイル作成時マスクはプロセスが新規ファイルや新規ディレクトリを作成する際
  `open(2)` / `creat(2)` / `mkdir(2)`などに指定されるmodeをクリア(打ち消し)するために用いられる
  - デフォルトのumask値は8進数で022(`----w--w-`)
- 新規ファイルを作成する場合、適切なパーミッションビットが有効になっていることを保障するため
  umask値を明示的に設定する必要がある
  - Ex. `open("filename", O_WRONLY|O_CREAT|O_TRUNC, 0666)`

## アクセス制御リスト(ACL)
- パーミッションモデルの拡張
  - 従来のパーミッションモデルもACLエントリとして表現することが可能
- ユーザー・グループ単位でのパーミッションを設定可能にする

### ACLエントリ
- 単独のユーザー・グループにファイルパーミッションを定義したもの
  - タグ種類 - 対象とするユーザー区分
  - タグ修飾子 - 特定のユーザーグループ(UID、GID)
  - パーミッション - 読み取り、書き取り、実行

### ACL検査アルゴリズム
- プロセスが特権を持っていればすべてのアクセスを許可する
- プロセスの実効ユーザーIDとファイルオーナーが同じ場合、
  `ACL_USER_OBJ`エントリに対する許可に基づく
- プロセスの実効ユーザーIDと`ACL_USER`エントリが一致する場合、
  そのエントリのパーミッションを`ACL_MASK`のパーミッションでマスクした値に基づく
- プロセスのグループIDと`ACL_GROUP_OBJ`か`ACL_GROUP`エントリが一致する場合、
  プロセスのグループIDに基づく検査を行う
- それ以外の場合は`ACL_OTHER`に対する許可に基づく
- ユーザーカテゴリはオーナー -> グループ -> 他ユーザーの順に検査する
