# ディレクトリとリンク
- 参照: 例解UNIX/Linuxプログラミング教室P225-269 / P375-432
- 参照: 詳解UNIXプログラミング第3版 4. ファイルとディレクトリ
- 参照: [試して理解]Linuxのしくみ 第7章 ファイルシステム
- 参照: Linuxプログラミングインターフェース 14章 / 18章

## TL;DR
- ディレクトリはファイル名とi-nodeの番号対応表
- ディレクトリはi-nodeテーブル上ではファイル種類`directory`として表現される
- プロセスはディレクトリに関連する属性を二つ持つ
  - ルートディレクトリ(絶対パスの処理開始地点)
  - カレントワーキングディレクトリ(相対パスの処理開始地点)

## i-nodeとディレクトリ構造の関係
- i-nodeテーブルはファイルのメタ情報を格納する
- i-nodeエントリはファイルデータ(データブロック)へのポインタを持つ
- ディレクトリファイルのデータブロックにはファイル名とi-node番号の対応表が格納される
  - 同じi-nodeに対応する別のファイル名をどのディレクトリ下にも追加できる(リンク)

### ディレクトリ構造
- ディレクトリはデータ領域にディレクトリエントリを持つ
  - ディレクトリエントリ - ファイル名 / i-node番号の組み
- ディレクトリエントリを格納するディレクトリは、
  ディレクトリエントリに対応するi-nodeへリンクしていると言える(ハードリンク)

### ハードリンク
- ディレクトリエントリがi-node番号を持つ(i-nodeを指す)こと
- 同じi-node番号を指す複数のディレクトリエントリが生成されうる
  - i-nodeは自身を指すディレクトリエントリの数(リンクカウント)をデータとして持つ
  - カーネルはディレクトリエントリを削除する際、i-nodeの持つリンクカウントをデクリメントする
    リンク数が0になったときi-nodeテーブルからi-nodeとデータブロックを削除する
    - 削除するファイルが他のプロセスからオープンされている場合、
      カーネルはファイルがクローズされた後でファイルを削除する

#### ハードリンクの制約事項
- ファイルシステムを跨ぐリンクは作成できない
  - i-node番号は同一ファイルシステムの中でのみ一意であることが担保されるため
- ディレクトリを参照するリンクは作成できない
  - `find(1)`、`tar(1)`などコマンド使用時の循環参照を避けるため

### シンボリックリンク
- 他のファイルの名前(パスを含む)をデータとして格納する特殊なファイル
  - ファイルであるため参照先ファイル名が対応するi-nodeのリンクカウントには数えられない
  - ファイルであるため参照先ファイル名が実際には存在していないファイルでも作成することができる
  - ファイルであるためi-nodeテーブルで管理される
  - シンボリックリンクはi-nodeテーブル上ではファイル種類`symlink`として表現される
- ファイルやディレクトリ構造全体をシステム上の他の場所へ移動するために使用される場合が多い

### ハードリンクの制約事項の回避
- ファイルシステムを跨ぐリンクを作成できる
  - i-nodeではなくファイル名をデータとして保持しているため
- ディレクトリを参照するリンクも作成できる
  - `find(1)`、`tar(1)`などコマンドはシンボリックリンクを参照先として無視するため

## ディレクトリの情報
- ディレクトリはディレクトリストリームによってディレクトリの開閉・取得を行う
  - `DIR`構造体 - ディレクトリストリーム / 読み取り中のディレクトリに関する情報を管理する内部構造

```c
// dirent構造体 - ディレクトリエントリの情報を格納する構造体 / 実装に依存する

struct dirent {
  ino_t          d_ino;       // i-node番号
  unsigned short d_reclen;    // このレコードの長さ
  unsigned char  d_type;      // ファイル種別
  char           d_name[256]; // NULL終端のファイル名
};
```
- `opendir(3)`   - ディレクトリを開く
- `readdir(3)`   - ディレクトリ項目を読み込み、`dirent`構造体に値を設定する
- `closendir(3)` - ディレクトリを閉める

## カレントワーキングディレクトリ
- 各プロセスはカレントワーキングディレクトリを持つ
- ログイン時点でのカレントワーキングディレクトリは
  `etc/passwd`の6番目のフィールドで指定されている(ホームディレクトリ)
  - カレントワーキングディレクトリ - プロセスの属性
  - ホームディレクトリ             - ログイン名の属性
- `getcwd(3)` - カレントワーキングディレクトリの取得
- `chdir(2)`  - カレントワーキングディレクトリの変更
  - `chdir(2)`を実行するプロセスと`chdir(2)`を実行するプロセスを起動したプロセスは別のプロセスであるため
    後者のカレントワーキングディレクトリには影響を及びさない
- `fchdir(2)` - 渡されたファイルディスクリプタを参照するディレクトリをカレントワーキングディレクトリとする
