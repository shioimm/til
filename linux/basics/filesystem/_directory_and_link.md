# ディレクトリとリンク
- 参照: 例解UNIX/Linuxプログラミング教室P225-269 / P375-432
- 参照: 詳解UNIXプログラミング第3版 4. ファイルとディレクトリ
- 参照: [試して理解]Linuxのしくみ 第7章 ファイルシステム
- 参照: Linuxプログラミングインターフェース 14章 / 18章

## TL;DR
- ディレクトリはファイル名とi-nodeの番号対応表
- ディレクトリはi-nodeテーブル上ではファイル種類`directory`として表現される
- プロセスはディレクトリに関連する属性を二つ持つ
  - ルートディレクトリ(絶対パスの処理開始地点)
  - カレントワーキングディレクトリ(相対パスの処理開始地点)

## i-nodeとディレクトリ構造の関係
- i-nodeテーブルはファイルのメタ情報を格納する
- i-nodeエントリはファイルデータ(データブロック)へのポインタを持つ
- ディレクトリファイルのデータブロックにはファイル名とi-node番号の対応表が格納される
  - 同じi-nodeに対応する別のファイル名をどのディレクトリ下にも追加できる(リンク)

### ディレクトリ構造
- ディレクトリはデータ領域にディレクトリエントリを持つ
  - ディレクトリエントリ - ファイル名 / i-node番号の組み
- ディレクトリエントリを格納するディレクトリは、
  ディレクトリエントリに対応するi-nodeへリンクしていると言える(ハードリンク)

### ハードリンク
- ディレクトリエントリがi-node番号を持つ(i-nodeを指す)こと
- 同じi-node番号を指す複数のディレクトリエントリが生成されうる
  - i-nodeは自身を指すディレクトリエントリの数(リンクカウント)をデータとして持つ
  - カーネルはディレクトリエントリを削除する際、i-nodeの持つリンクカウントをデクリメントする
    リンク数が0になったときi-nodeテーブルからi-nodeとデータブロックを削除する

#### ハードリンクの制約事項
- ファイルシステムを跨ぐリンクは作成できない
  - i-node番号は同一ファイルシステムの中でのみ一意であることが担保されるため
- ディレクトリへのハードリンクは作成できない

### シンボリックリンク
- 他のファイルの名前(パスを含む)をデータとして格納する特殊なファイル
  - ファイルであるため参照先ファイル名が対応するi-nodeのリンクカウントには数えられない
  - ファイルであるため参照先ファイル名が実際には存在していないファイルでも作成することができる
  - ファイルであるためi-nodeテーブルで管理される
  - シンボリックリンクはi-nodeテーブル上ではファイル種類`symlink`として表現される
- ハードリンクと同じ機能を提供するが、ハードリンクのような制約を持たない
  - リンク元ファイルと同一のファイルシステム上でなくても作成できる
  - スーパーユーザー以外でもディレクトリへのハードリンクを作れる
- リンクしたいファイル名へのポインタを格納するi-nodeのi-node番号を持つエントリ
  - i-nodeを共有しないため、リンク先のファイルとは別のファイルとなる
- ファイルやディレクトリ構造全体をシステム上の他の場所へ移動するために使用される場合が多い

## ディレクトリの情報
- ディレクトリはデータ領域にデータを持ち、そこにディレクトリエントリ(i-node番号 - ファイル名)を持つ
- ディレクトリの実際の形式は実装と設計に依存する
  - `read(2)`でディレクトリの内容にアクセスすることは禁止されている
- ディレクトリはディレクトリストリームによってディレクトリの開閉・取得を行う
  - `DIR`構造体 - ディレクトリストリーム / 読み取り中のディレクトリに関する情報を管理する内部構造

```c
// dirent構造体 - ディレクトリエントリの情報を格納する構造体 / 実装に依存する

struct dirent {
  ino_t          d_ino;       // i-node番号
  unsigned short d_reclen;    // このレコードの長さ
  unsigned char  d_type;      // ファイル種別
  char           d_name[256]; // NULL終端のファイル名
};
```
- `opendir(3)`   - ディレクトリを開く
- `readdir(3)`   - ディレクトリ項目を読み込み、`dirent`構造体に値を設定する
- `closendir(3)` - ディレクトリを閉める

## カレントワーキングディレクトリ
- 各プロセスはカレントワーキングディレクトリを持つ
- ログイン時点でのカレントワーキングディレクトリは
  `etc/passwd`の6番目のフィールドで指定されている(ホームディレクトリ)
  - カレントワーキングディレクトリ - プロセスの属性
  - ホームディレクトリ             - ログイン名の属性
- `getcwd(3)` - カレントワーキングディレクトリの取得
- `chdir(2)`  - カレントワーキングディレクトリの変更
  - `chdir(2)`を実行するプロセスと`chdir(2)`を実行するプロセスを起動したプロセスは別のプロセスであるため
    後者のカレントワーキングディレクトリには影響を及びさない
- `fchdir(2)` - 渡されたファイルディスクリプタを参照するディレクトリをカレントワーキングディレクトリとする

## ディレクトリの書き換え
### ディレクトリエントリの追加
- ファイルの追加
- 既存のファイルに対してリンクを追加
  - `link(2)`    - ハードリンクの生成
  - `symlink(2)` - シンボリックリンクの生成
- ディレクトリの追加
  - `mkdir(2)` - ディレクトリを作成し、親ディレクトリに新しいディレクトリエントリとして追加する
    - `.` / `..`のディレクトリは自動生成する
- 新しいディレクトリエントリの作成とリンクカウントの増加は不可分操作となる

### ディレクトリエントリの削除
- その名前のディレクトリエントリをディレクトリから削除する = リンクを取り除く
  - `unlink(2)`  - ディレクトリ項目を削除する
    - i-nodeを指すリンクを削除する
    - リンク数が0になった時i-nodeとi-nodeが指す実データ領域を解放する
    - プロセスが当該ファイルをオープンしている場合は削除できない
      当該ファイルをオープンしているプロセスの数が0になり、リンクカウントが0になると削除される
  - `rmdir(2)` - 親ディレクトリから空のディレクトリ項目(ディレクトリそのもの)を削除する
    - 空のディレクトリエントリ - `.` / `..`のディレクトリだけを持つディレクトリ

## Unixドメインソケットの操作
- `socket(2)` / `bind(2)`
