# ディレクトリとリンク
- 参照: 例解UNIX/Linuxプログラミング教室P225-269 / P375-432
- 参照: 詳解UNIXプログラミング第3版 4. ファイルとディレクトリ
- 参照: [試して理解]Linuxのしくみ 第7章 ファイルシステム
- 参照: Linuxプログラミングインターフェース 14章 / 18章 / 19章

## TL;DR
- ディレクトリはファイル名とi-nodeの番号対応表
- ディレクトリはi-nodeテーブル上ではファイル種類`directory`として表現される
- プロセスはディレクトリに関連する属性を二つ持つ
  - ルートディレクトリ(絶対パスの処理開始地点)
  - カレントワーキングディレクトリ(相対パスの処理開始地点)

## i-nodeとディレクトリ構造の関係
- i-nodeテーブルはファイルのメタ情報を格納する
- i-nodeエントリはファイルデータ(データブロック)へのポインタを持つ
- ディレクトリファイルのデータブロックにはファイル名とi-node番号の対応表が格納される
  - 同じi-nodeに対応する別のファイル名をどのディレクトリ下にも追加できる(リンク)

### ディレクトリ構造
- ディレクトリはデータ領域にディレクトリエントリを持つ
  - ディレクトリエントリ - ファイル名 / i-node番号の組み
- ディレクトリエントリを格納するディレクトリは、
  ディレクトリエントリに対応するi-nodeへリンクしていると言える(ハードリンク)

### ハードリンク
- ディレクトリエントリがi-node番号を持つ(i-nodeを指す)こと
- 同じi-node番号を指す複数のディレクトリエントリが生成されうる
  - i-nodeは自身を指すディレクトリエントリの数(リンクカウント)をデータとして持つ
  - カーネルはディレクトリエントリを削除する際、i-nodeの持つリンクカウントをデクリメントする
    リンク数が0になったときi-nodeテーブルからi-nodeとデータブロックを削除する
    - 削除するファイルが他のプロセスからオープンされている場合、
      カーネルはファイルがクローズされた後でファイルを削除する

#### ハードリンクの制約事項
- ファイルシステムを跨ぐリンクは作成できない
  - i-node番号は同一ファイルシステムの中でのみ一意であることが担保されるため
- ディレクトリを参照するリンクは作成できない
  - `find(1)`、`tar(1)`などコマンド使用時の循環参照を避けるため

### シンボリックリンク
- 他のファイルの名前(パスを含む)をデータとして格納する特殊なファイル
  - ファイルであるため参照先ファイル名が対応するi-nodeのリンクカウントには数えられない
  - ファイルであるため参照先ファイル名が実際には存在していないファイルでも作成することができる
  - ファイルであるためi-nodeテーブルで管理される
  - シンボリックリンクはi-nodeテーブル上ではファイル種類`symlink`として表現される
- ファイルやディレクトリ構造全体をシステム上の他の場所へ移動するために使用される場合が多い

### ハードリンクの制約事項の回避
- ファイルシステムを跨ぐリンクを作成できる
  - i-nodeではなくファイル名をデータとして保持しているため
- ディレクトリを参照するリンクも作成できる
  - `find(1)`、`tar(1)`などコマンドはシンボリックリンクを参照先として無視するため

## カレントワーキングディレクトリ
- 各プロセスはカレントワーキングディレクトリを属性として親プロセスから受け継ぐ
- ログイン時点でのカレントワーキングディレクトリは
  `etc/passwd`の6番目のフィールドで指定されている(ホームディレクトリ)
  - カレントワーキングディレクトリ - プロセスの属性
  - ホームディレクトリ             - ログイン名の属性

## ルートディレクトリ
- 各プロセスはルートディレクトリを属性として親プロセスから受け継ぐ
- デフォルトのルートディレクトリはファイルシステムの実際のルートディレクトリ
- ルートディレクトリを変更することによって
  アクセスできる範囲を制限したり、仮想環境(jail環境)を確立することができる
