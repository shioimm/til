# file構造体 / ファイルディスクリプタ
- 参照: 例解UNIX/Linuxプログラミング教室P133
- 参照: 詳解UNIXプログラミング第3版 3. ファイル入出力

## file構造体
- プロセスが`open(2)`を呼ぶとカーネル内にfile構造体が一つ生成される
- file構造体はopenが返すファイルディスクリプタとファイルの実体をつなぐ

## file構造体が格納する情報
- ファイル状態フラグ
  - フラグの集まり `O_APPEND` `O_NONBLOCK` `O_SYNC` etc
    - <-> ファイル生成フラグ - `O_CREAT` `O_TRUNC` `O_EXCL` `O_NOCITY` etc
- カレントファイルオフセット

## ファイルディスクリプタ
- ファイルを開く際、プロセスとファイルを結びつける記述子
  - ファイルを開くと生成される
  - ファイルを閉じると削除される
- ファイルディスクリプタが開かれている間、
  そのファイルに対するカレントファイルオフセットが保持される
  - カレントファイルオフセットはファイルを開いた時点で0に初期化される
- `open(2)`すると、その時点で空いている番号のうち、最小の番号がファイルディスクとなる

### `/dev/fd/`
- `/dev/fd/0` - 標準入力
- `/dev/fd/1` - 標準出力
- `/dev/fd/2` - 標準エラー出力
- ファイルディスクリプタnを複製する = `dev/fd/n`を開く
  - `fd = dup(0)` = `fd = open("dev/fd/0", mode);`
    - ディスクリプタ0と`fd`は同一のファイルテーブルエントリを共有する

### ファイルディスクリプタのコピー
- `dup2(2)` - file構造体を指すfd1がある時、同じfile構造体を指すfd2を生成する
- `dup(2)` - file構造体を指すfd1がある時、同じfile構造体を指すファイルディスクリプタ(最小値)を生成する
  - file構造体が持っている情報はfd1と新しいファイルディスクリプタに対して同じ内容で共有される
    - ファイル情報フラグ・カレントファイルオフセット・ファイルの実態へのポインタ
  - fd1を既存のファイルディスクリプタfd0に`dup`すると、
    fd0は既存のストリームを閉じてfd1と同じfile構造体を指すようになる

### その他の操作
- `fcntl(2)` - すでに開いているファイルの属性を変更する
  - 既存のファイルディスクリプタを複製・変更する
    - 第二引数`F_DUPED` / `F_DUPED_CLOSEXEC`
  - ファイルディスクリプタフラグの取得・設定
    - 第二引数 `F_GETFD` / `F_SETFD`
  - ファイルステータスフラグの取得・設定
    - 第二引数 `F_GETFL` / `F_SETFL`
  - 非同期入出力の所有者の取得・設定
    - 第二引数 `F_GETOWN` / `F_SETOWN`
  - レコードロックの取得・設定
    - 第二引数 `F_GETLK` / `F_SETLK` / `F_SETLKW`
- `ioctl(2)` - その他の入出力操作
  - 端末操作など

## プロセステーブル
- カーネルはプロセステーブルでプロセスを管理する
- プロセスはプロセステーブルに一つのプロセスエントリを持つ

### プロセステーブルエントリ
- プロセステーブルエントリは
  プロセスがオープンしているファイルディスクリプタを管理するファイルディスクリプタテーブルを持つ
  - プロセスがオープンしているファイルディスクリプタはファイルステータスフラグを持つ
  - プロセスがオープンしているファイルディスクリプタはファイルテーブルエントリへのポインタを持つ

- 子プロセスは親プロセスのファイルディスクリプタテーブルを複製するが
  各ファイルディスクリプタは対応するfile構造体は複製されず、同じfile構造体に紐づく
  - 親子プロセスはそのファイルの操作に関してfile構造体が格納する情報を共有する
- プロセスAが`close`を呼んだ場合、
  プロセスAのファイルディスクリプタテーブルから対象のファイルディスクリプタが消える
  - 対象のファイルディスクリプタに対応するfile構造体も消える
  - プロセスBのファイルディスクリプタテーブルは変更されない

### ファイルテーブルエントリ(file構造体)
- ファイルテーブルエントリは当該ファイルのファイルステータスフラグを持つ
- ファイルテーブルエントリは当該ファイルカレントファイルオフセットを持つ
- ファイルテーブルエントリは当該ファイルの汎用iノードテーブルエントリへのポインタを持つ

### 汎用iノードテーブルエントリ
- 各汎用iノードテーブルエントリは汎用iノード情報を持つ
- 各汎用iノードテーブルエントリは汎用iノードへのリンクを持つ

## ファイル操作の不可分性
- 二つのプロセスが同じファイルを操作する際に操作がコンフリクトした場合
  操作Aが完了してから操作Bを行う
  操作Bが完了してから操作Aを行う のいずれかの挙動を取る
  操作Aと操作Bの結果が混ざることはない
