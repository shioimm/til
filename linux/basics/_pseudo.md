# 疑似端末
- 参照: Linuxプログラミングインターフェース 64章

## TL;DR
- IPCチャネルの一種である仮想的なデバイス
- 疑似端末を使用することによって任意の2プロセスが通信を行うことができる
  - 疑似端末マスターデバイスをオープンするプロセスが他プロセスへスレーブデバイス名を通知する
    - 通知方法はファイルへの書き込み、IPC、`fork(2)`など
- チャネルの片方の口は端末へ接続するプログラム、
  もう片方の口は端末上での動作を想定したプログラム(端末指向プログラム)
  - 端末指向プログラム - ユーザー入力を端末へ書き込み、端末からの出力を読み取る

### 利用例
- リモートホスト上のsshd(ドライバプログラム)とログインシェル(端末指向プログラム)
- ウィンドウシステム端末エミュレーション
- `script(1)`
- `expect(1)`
- 長時間実行プログラムの出力監視

## 疑似端末ペア
- 疑似端末マスターデバイス / 疑似端末スレーブデバイスの組み
- 疑似端末ペアは双方向のIPCチャネルを持つ
  - 2プロセスがマスターデバイス・スレーブデバイスをそれぞれオープンし、
    疑似端末を介して双方向にデータを送受信する

## 疑似端末ペアの確立(`fork(2)`でスレーブデバイス名を通知する例)
1. ドライバプログラムが疑似端末マスターデバイスをオープン
2. ドライバプログラムは`fork(2)`を実行し、子プロセスを作成
3. 子プロセスは`setsid(2)`を実行し、新規セッションを開始し、制御端末を手放す
4. 子プロセスは疑似端末マスターデバイスに対応する疑似端末スレーブデバイスをオープン
    - 疑似端末スレーブデバイスが子プロセスの制御端末となる
5. 子プロセスは`dup(2)`を実行し、スレーブデバイスのファイルディスクリプタを標準入出力へ複製する
6. 子プロセスは`exec(2)`を実行し疑似端末スレーブデバイスへ接続した端末指向プログラムを実行する

## 疑似端末の使用
- 疑似端末ペアの確立以降、
  - ドライバプログラムがマスターデバイスへ書き込んだデータは
    全てスレーブデバイス上で動作する端末指向プログラムへの入力となる
  - 端末指向プログラムがスレーブデバイスへ書き込んだデータは
    全てマスターデバイス上で動作するドライバプログラムへの入力となる

## 高度な機能
- パケットモード
  - マスター側がスレーブ側の状態変化を感知できるようになる
- リモートモード
  - スレーブ側をリモートモードに設定する
  - スレーブはマスターから受け取ったデータの処理を行わない
- ウィンドウサイズの変更
- シグナル生起
  - マスターからスレーブのプロセスグループへシグナルを送る
