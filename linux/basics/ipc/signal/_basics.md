# シグナル
- 参照: 例解UNIX/Linuxプログラミング教室P323-374
- 参照: 詳解UNIXプログラミング第3版 10. シグナル
- 参照: Linuxプログラミングインターフェース 20章 / 21章

## TL;DR
- シグナルはプロセスに対して非同期的に送られる通知
  - ソフトウェア割り込み
    <-> ハードウェア割り込み
  - ハードウェアがシグナルを生成した場合や
    システムコールによりプロセス自身がシグナルを生成した場合は同期的に送られる
  - シグナルはプロセスがカーネルモードからユーザーモードへ移行した場合のみ受信される
- シグナルは`<signal.h>`にマクロとして定義されており、コンパイル時に整数に展開される

## シグナルの生起条件
- 端末生起シグナル
  - `SIGINT`
- ハードウェア例外(カーネルがサブルーチンを起動 -> プロセスへシグナルを送出)
  - `SIGSEGV`
  - `SIGFPE`
  - `SIGILL`
- ソフトウェアイベント
  - `SIGURG`
  - `SIGPIPE`
  - `SIGALRM`
    - プロセスは一つのアラームクロックを持つ
    - `alarm(3)` - 指定された秒数が経過した後に`SIGALRM`を送信
- `kill(1)` / `kill(2)` / `raise(3)`の実行

## シグナルの種類
- 標準シグナル(`<signal.h>`内で定義された1-31までのマクロ定数)
- リアルタイムシグナル

## シグナルのライフサイクル
1. シグナルの生成
2. プロセススケジューリング都合上、
   あるいはプロセスがシグナルをブロックしている場合、保留
3. (保留が解除された場合)シグナルの配送
4. プロセスがシグナルを受信
5. プロセスが実行中かつシグナルマスクを持っている場合、保留
6. (シグナルマスクが存在しない場合)プロセスがシグナル受信時の動作を実行

## シグナル受信時の動作
- デフォルト動作
  - 無視
  - 終了
  - 終了 + コアダンプ(`core`ファイル生成)
  - プロセスの実行停止
  - プロセスの実行再開
- デフォルト動作以外への変更(`signal(2)` / `sigaction(2)`)
  - 無視
  - デフォルト動作の実行
  - シグナルハンドラ(プログラマ定義の関数)実行
- シグナル`SIGKILL` / `SIGSTOP`に対しては捕捉・無視ができない

## シグナルを送信する条件
- 送信側の実ユーザーIDあるいは実行ユーザーIDが
  受信側の実ユーザーIDあるいは保存セットユーザーIDに一致していること

## シグナルの説明文字列
- 全てのシグナルは補足説明文字列を持つ
- 補足説明文字列は配列`sys_siglist`にまとめられている
- 補足説明文字は`strsignal(3)`で参照できる

## シグナルセット
- 複数のシグナルをまとめて扱うための単位(`sigset_t`)
- シグナルセットに対しては次の操作を行うことができる
  - 初期化(`sigemptyset(2)` / `sigfillset(2)`)
  - シグナルの追加(`sigaddset(2)`)
  - シグナルの削除(`sigdelset(2)`)
  - シグナルがセットされているかどうかの確認(`sigismember(2)`)
  - その他(`sigandset(2)` / `sigorset(2)` / `sigisemptyset(2)`)

## 特殊なシグナル
### `SIGKILL` / `SIGSTOP`
- 即時プロセスを終了させる
- ブロックできない
- シグナル受信時の動作を変更することができない

### `SIGCONT`
- 一時停止シグナルにより停止したシグナルを再開させる
- シグナル受信時の動作を変更していても常に実行を再開する

### `SIGBUS` / `SIGFPE` / `SIGILL` / `SIGSEGV`
- ハードウェア例外によって生成される
- SUSv3ではハードウェア例外によるシグナルに対して
  プロセスがシグナルを無視・ブロックしていた場合の動作、
  あるいはシグナルハンドラ実行後のプロセスの動作は不定

## シグナルの待ち合わせ
```
状況:

1. プログラムのクリティカルセクションへシグナルが割り込まないように、
   一時的にシグナルをブロックする
2. シグナルのブロックを解除し、シグナルを受信するまで待つ
```

- `sigsuspend(2)`を使用し、プロセスのシグナルマスクを一時的に任意のものに置き換える
  シグナルを捕捉しハンドラからリターンするまで、プロセスの実行を一時停止する
  ハンドラからリターンするとプロセスのシグナルマスクを元の値へ復元する
  - アトミックにシグナルをアンブロックし、待機させる

## race condition
- シグナルによる処理は非同期であるためrace conditionを招く場合がある
  - race condition   - プログラムの実行順やタイミングに依存して意図しない実行結果を招くこと
  - critical section - race conditionの原因となるプログラム部分
    - 排他制御・割り込みの禁止などを行いrace conditionを避けるようにする
  - atomicな処理     - 実行途中の状態を他のプロセス・スレッド・シグナルハンドラから見えないようにした処理

### グローバル変数へのアクセス
- `volatail`宣言 - `この変数は非同期的に変更されるため、最適化を行わない`とコンパイラに伝える
  - 最適化 -> レジスタへのキャッシュなど
  - グローバル変数に対して`volatail`をつける
- atomicにアクセスできるという保証がなければ、`sigprocmask`で囲んでシグナルをブロックするようにする

## シグナルのキュー
- `SIGQUEUE_MAX`数分のシグナルをキューすることができる
1. `sigaction`を使ってシグナルハンドラを設定する際に`SA_SIFINFO`をしていする
2. `sigaction`構造体の`sa_sigaction`メンバにシグナルハンドラを与える
3. `sigqueue`を使ってシグナルを送る
    - `sigqueue(2)` - 単一のプロセスにシグナルを送り、シグナルハンドラに指定の値を送る

## シグナル名・番号
- Linuxはシグナルの名前の文字列へのポインタの配列を持つ
```c
// 添字にシグナル番号が入る
extern char *sys_siglist[];
```
- `psignal(3)` - シグナル番号に対する文字列を表示
- `psiginfo(3)` - シグナル情報を表示
  - `sigaction`を介して`siginfo`構造体がある場合
- `strsignal(3)` - シグナル情報を説明する文字列へのポインタを取得
