# シグナルハンドラ
- 参照: 例解UNIX/Linuxプログラミング教室P323-374
- 参照: 詳解UNIXプログラミング第3版 10. シグナル
- 参照: Linuxプログラミングインターフェース 20章

## TL;DR
- プロセスが指定のシグナルを受信した際に実行される関数
  - プログラムの処理の流れに任意の時点で割り込む形で実行される
  - プロセスの代わりにカーネルがシグナルハンドラをコールし、
    関数が終了すると割り込んだ下に位置へ制御を戻す
  - シグナルの捕捉 - シグナルハンドラを使ってシグナルを処理すること

- 捕捉されたシグナルをプロセスで処理するとき、
  プロセスが実行中の命令列はシグナルハンドラによって一時的に中断される
  -> シグナルハンドラから戻ると元々プロセスが実行していた命令列に戻る
  - プロセスが非同期シグナル安全な関数を実行していた場合、
    シグナルによって一貫性を失うときはシグナルをブロックする
  - スレッドごとに`errno`の値は一つしかないため、
    シグナルハンドラが再入可能な関数を呼ぶと、
    値が上書きされる可能性がある

### `sigaction(2)`
- `sigaction(2)` - 指定のシグナルを受信した際の新しい動作と以前の動作をそれぞれ`sigaction`構造体に保存する
  - `sigemptyset(2)` - シグナルマスクの初期化
```c
// sigaction構造体
struct sigaction {
  sigset_t sa_mask;  // シグナルハンドラ実行中にブロックするシグナル群
  int      sa_flags; // オプション設定フラグ

  // どちらか一つだけ設定
  void (*sa_handler)(int);                        // 引数が一つのシグナルハンドラ
  void (*sa_sigaction)(int, siginfo_t *, void *); // 引数が三つのシグナルハンドラ
};

// sigactionの設定
//   struct sigaction xxx;
//   xxx.sa_hander = シグナルハンドラ
//   xxx.sa_flags  = シグナルハンドラ実行中の動作を設定
//   sigemptyset(&xxx.sa_mask);
//   sigaction(シグナル, &xxx, NULL);
```

### シグナルマスクの設定
- シグナルマスク - 各プロセスが持つブロック中のシグナルの集合
  - シグナルに対するビットがON = シグナルをブロックしている
- `sigset_t` - シグナルの集合を表すシステムデータ型
  - `sigemptyset(3)` - シグナル集合を空にする
  - `sigfillset(3)` - シグナル集合に全てのシグナルを加える
  - `sigaddset(3)` - シグナル集合に任意のシグナルを加える
  - `sigdelset(3)` - シグナル集合から任意のシグナルを削除
  - `sigismember(3)` - シグナル集合に任意のシグナルが含まれるか確認
- `sigprocmask(2)` - プロセスのシグナルマスクの設定と検査
- `sigpending(2)` - 呼び出したプロセスが配送をブロックしているシグナルの集合を検査
- `sigsuspend(2)` - シグナルのブロック解除から再ブロックまでをatomicに実行
  - `sigprocmask`(ブロック解除) -> `pause`(待機) -> `sigprocmask`(ブロックを元に戻す)
