# POSIX IPC
- 参照: 例解UNIX/Linuxプログラミング教室P257-289
- 参照: 詳解UNIXプログラミング第3版 15. プロセス間通信
- 参照: Linuxネットワークプログラミング Chapter7 プロセス間通信 7-8
- 参照: Linuxによる並行プログラミング入門 第6章 相互排除とセマフォ 6.2
- 参照: Linuxプログラミングインターフェース 45章 / 51-54章

## TL；DR
- System V IPCに対応したPOSIX.1bリアルタイム拡張によるIPC機構
- POSIXメッセージキュー / POSIXセマフォ / POSIX共有メモリの総称
- POSIX IPCオブジェクトは削除するかシャットダウンするまでカーネル内に存在する
  - IPCオブジェクトはシステム全体で共有される
  - 生存しているIPCオブジェクトにはどのプロセスからでもアクセスできる
- IPCオブジェクトは仮想ファイルシステム上に作成される
- IPCオブジェクトは一般のファイルと同様にパーミッションを持つ

## API

| インターフェース     | メッセージキュー | セマフォ            | 共有メモリ                    |
| -                    | -                | -                   | -                             |
| ヘッダファイル       | `<mqueue.h>`     | `<semaphore.h>`     | `<sys/mman.h>`                |
| オブジェクトハンドル | `mqd_t`          | `sem_t*`            | `int`(ファイルディスクリプタ) |
| オープン操作         | `mq_open(3)`     | `sem_open(3)`       | `shm_open(3)` + `mmap(2)`     |
| クローズ操作         | `mq_close(3)`    | `sem_close(3)`      | `munmap(3)`                   |
| 削除                 | `mq_unlink(3)`   | `sem_unlink(3)`     | `shm_unlink(3)`               |
| IPC実行              | メッセージ送受信 | セマフォ操作        | 共有メモリへのアクセス        |

### IPCオブジェクト名
- オブジェクトを特定・識別する名前
  - `/`始まり
  - Linuxにおいてはメッセージキュー・共有メモリの名前を`NAME_MAX`文字に制限
  - Linuxにおいてはセマフォ名の先頭に`sem.`が付加される

### オープン操作
- 全ての種類のIPCは`open(2)`に相当するオープン操作を持つ
- オブジェクトハンドルはファイルシステムにおけるファイルディスクリプタに相当する
- オブジェクトが存在しない場合: 指定のオブジェクト名のオブジェクトを新規に作成し、ハンドルを返す
- オブジェクトが存在する場合: 指定のオブジェクト名に対応するオブジェクトを開き、ハンドルを返す

### クローズ操作
- 使用を終えたIPCオブジェクトに対し、オブジェクトが
  メッセージキュー・セマフォの場合は明示的にクローズ操作を行う
  共有メモリの場合はメモリ領域をアンマッピングする

### 削除操作
- カーネル内ではレファレンスカウンタによってIPCオブジェクトのオープン / クローズを管理する
- 全ての種類のIPCは`unlink(2)`に相当する削除操作を持ち、全プロセスがクローズした時点で削除される

## IPCオブジェクトの管理
- System V IPCにおける`ipcs(1)` / `ipcrm(1)`は用意されていない
- POSIX IPCオブジェクトは実ファイルシステムまたは仮想ファイルシステム上に作成されているため
  システム標準の`ls(1)` / `rm(1)`コマンドで扱うことができる

```
# mqueueファイルシステムをマウントする

$ mkdir /dev/mqueue
$ sudo mount -t mqueue none マウントポイント

# mqueueファイルシステムのマウントディレクトリには
# 自動的にスティッキービットがセットされる
```

### Linuxでのコンパイル
- メッセージキュー、共有メモリを使用するプログラムにはコンパイル時に`-lrt`オプションを付加する
- セマフォを使用するプログラムにはコンパイル時に`-pthread`オプションを付加する

## System V IPC との比較
### POSIX IPCの利点
- インターフェースが簡潔
- キーではなく名前を使用して操作する
  UNIXファイル操作一般と整合性の取れたAPIを使用できる
- レファレンスカウンタによって管理される

### System V IPCの利点
- 可搬性(POSIX IPCはSUSv3ではオプション扱い)

## POSIXメッセージキュー
- メッセージ形式のデータをプロセス間で交換する機構
- メッセージキューを表すハンドルは`mq_open(3)`が返すメッセージキューディスクリプタ
- メッセージキューによる通信はメッセージ指向
- メッセージキューは属性を持つ
- メッセージキューはレファレンスカウンタによって管理される
- メッセージは優先度を持つ
- メッセージは優先度順に送受信される
- メッセージが読み取り可能になったことを非同期に通知する機能を持つ

### メッセージキューを実現するカーネル内の構造体
- システムはオープンメッセージキュー情報テーブルを管理する
  - フラグ、メッセージキューへのポインタ
- システムはメッセージキューテーブルを管理する
  - キューごとの情報、メッセージデータ
- 各プロセスは自身のメッセージキューディスクリプタテーブルを管理する
  - メッセージキュー情報へのポインタ
- LinuxではPOSIXメッセージキューを仮想ファイルシステム上のi-nodeとして実装しており、
  メッセージキューディスクリプタ及びオープンメッセージキュー情報は
  それぞれファイルディスクリプタ及びオープンファイル情報により実現されている

### System Vメッセージキューとの比較
- 新着メッセージ通知機能を持つ
- Linuxでは`poll(2)` / `select(2)` / `epoll(2)`でも処理可能
- 可搬性でSystem Vメッセージキューに劣る

### API
- `mq_open(3)` - 新規メッセージキューの作成または既存のメッセージキューディスクリプタ(`mqd_t`)を返す
- `mq_send(3)` - キューにメッセージを書き込む(`mq_timedsend(3)` - タイムアウト指定)
- `mq_receive(3)` - キューからメッセージを読み取る(`mq_timedreceive(3)` - タイムアウト指定)
- `mq_close(3)` - メッセージキューをクローズする
- `mq_unlink(3)` - メッセージキューの名前を削除し、削除マークを行う
  - 全プロセスがクローズすると実際に削除される
- `mq_getattr(3)` - メッセージキュー属性を参照する
- `mq_setattr(3)` - メッセージキュー属性を変更する
- `mq_notify(3)` - 空のキューにメッセージが書き込まれた際に読み取り可能通知を送る

#### メッセージキューの属性
```c
// mq_attr構造体 - メッセージキュー属性

struct mq_attr {
  long mq_flags;   // オープンメッセージキュー情報フラグ: 0かO_NONBLOCK
  long mq_maxmsg;  // キュー内最大メッセージ数
  long mq_msgsize; // 最大メッセージサイズ
  long mq_curmsgs; // キュー内現在メッセージ数
};
```

## POSIXセマフォ
- 複数のプロセス間で同期を取る機構
- カーネルが内部で管理する整数(数値0以上)として実装されている
- SUSv3では2種類のPOSIXセマフォを定義している
  - 名前付きセマフォ - 関連を持たないプロセス同士で同じセマフォを共有できる
  - 無名セマフォ - メモリ上に存在し、スレッド間・プロセス間(共有メモリ上に置いた場合)で共有できる
- スレッド間同期においてはmutexのほうが適している(コードの構造化促進のため)

### System Vセマフォとの比較
- インターフェースが簡略化されており機能を損なわない
- 初期化にまつわる問題が存在しない
- ダイナミックに割り当てたメモリオブジェクトとともに使用する場合
  無名セマフォのほうが簡潔
- コンテンションが少ない場合のパフォーマンス性能
- 可搬性でSystem Vセマフォに劣る
- System Vセマフォのundo機能を持たない

### セマフォ操作
- 絶対値への代入
- 絶対値への加算
- 絶対値からの減算
  - 減算した結果が数値0を下回る場合、自プロセスをブロックする
  - 他プロセスによってセマフォの値が変更されるとブロックを解除する

### 名前付きセマフォ
- プロセスが名前付きセマフォをオープンすると、
  システムはプロセスとセマフォの関係を保持、管理する
  また、レファレンスカウンタをインクリメントする
- プロセスが名前付きセマフォをクローズする(あるいはプロセスが終了する)と、
  システムは保持された情報を削除し、
  プロセス用に確保したセマフォのリソースを全て解放する
  また、レファレンスカウンタをデクリメントする

#### 実装
- SUSv3では名前付きセマフォの実装の定義を行っていない
- Linuxでは`/dev/shm`にマウントした専用の`tmpfs`ファイルシステム上に
  `sem.name`形式の名前を持つPOSIX共有メモリオブジェクトとして実装されている

#### API
- `sem_open(3)` - 新規セマフォの作成または既存のセマフォのハンドルを返す
  - 作成した場合は同時に初期化を行う
- `sem_post(3)` - 指定のセマフォの値をインクリメントする
- `sem_wait(3)` - 指定のセマフォの値をデクリメントする
- `sem_getvalue(3)` - 指定のセマフォの現在値を取得する
- `sem_close(3)` - 指定のセマフォをクローズする
- `sem_unlink(3)` - 指定のセマフォの名前を削除し、削除マークを行う
  - 全プロセスがクローズすると実際に削除される

### 無名セマフォ
- メモリベースのセマフォ
- セマフォを置いたメモリを共有していればそのプロセス・スレッドでも使用できる
- 無名セマフォ自体にパーミッションは存在せず、
  セマフォを置いた共有メモリのパーミッションに従う

#### 実装
- アプリケーションが割り当てたメモリ内に置く`sem_t`型の変数

#### 用途
- スレッド間でセマフォを共有するケース
- 関連プロセス間でセマフォを共有するケース
- バイナリツリーなどのデータをダイナミックに構築する場合

#### API
- 名前付きセマフォと同じAPIを使用できる
- `sem_init(3)` - 無名セマフォを初期化する
  - セマフォをプロセス間で共有するか同一プロセスのスレッド間で共有するかをシステムへ通知する
- `sem_destroy(3)` - 無名セマフォを破棄する

## POSIX共有メモリ
- ディスク内にファイルを作成せずメモリ空間を作成する
- 関連のないプロセス間で共有可能
- ファイルディスクリプタにより参照されるため、UNIXのファイル操作APIを使用できる
- メモリ空間のマッピング後に参照するファイルディスクリプタを削除しても
  システム終了か明示的に削除されるまでメモリ空間は残る

### 実装
- SUSv3ではPOSIX共有メモリの実装の定義を行っていない
- Linuxでは`/dev/shm`にマウントした専用の`tmpfs`ファイルシステム上に
  共有メモリオブジェクト名を作成する

### 使用手順
1. 共有メモリオブジェクトのオープン(名前を指定した`shm_open(3)`)
2. 共有メモリオブジェクトをプロセス仮想空間にマッピング(`MAP_SHARED`をセットした`mmap(2)`)
3. 共有メモリオブジェクトをマッピングしたプロセス仮想空間のアドレスに対して操作を行う

### API
- `shm_open(3)` - 新規共有メモリオブジェクトの作成または既存のファイルディスクリプタを返す
  - オープンしたファイルディスクリプタはプロセスが`exec`すると自動的にクローズされる
  - 新規作成した共有メモリオブジェクトのサイズは0に初期化される
  - `mmap(2)`実行前に`ftruncate(2)`で任意のサイズへ変更する
- `shm_unlink(3)` - 指定の共有メモリオブジェクトを削除する
  - 全プロセスからアンマッピングされた時点で削除される
  - 削除後はオブジェクトをオープンできなくなる

### 共有メモリAPIの比較
#### 共通点
- 高速なIPCを実現する
- 通常はセマフォと共に使用し、共有メモリへの排他的アドレスアクセスを実現する
- プロセスの仮想アドレス空間へマッピングし、通常のメモリと同じように使用する
- プロセスの仮想アドレス空間へ全て同じ方式で配置する
- Linuxの`/proc/PID/maps`は全種類の共有メモリを表示する
- 共有メモリ内でのアドレス指定はアドレス開始地点からの相対オフセットを使用する

#### 共有ファイルマッピング
- マッピング内容は対応ファイルに書き出される(システムを終了してもデータは保持される)

#### System V共有メモリ
- 共有メモリオブジェクトの識別に独自のキー、IDを使用する
- メモリサイズは作成時に固定される
- 可搬性が高い

#### POSIX共有メモリ
- 共有メモリオブジェクトの識別に名前、ファイルディスクリプタを使用する
- メモリサイズは変更可能
