# POSIX IPC
- 参照: 例解UNIX/Linuxプログラミング教室P257-289
- 参照: 詳解UNIXプログラミング第3版 15. プロセス間通信
- 参照: Linuxネットワークプログラミング Chapter7 プロセス間通信 7-8
- 参照: Linuxによる並行プログラミング入門 第6章 相互排除とセマフォ 6.2
- 参照: Linuxプログラミングインターフェース 45章 / 51-54章

## TL；DR
- System V IPCに対応したPOSIX.1bリアルタイム拡張によるIPC機構
- POSIXメッセージキュー / POSIXセマフォ / POSIX共有メモリの総称
- POSIX IPCオブジェクトは削除するかシャットダウンするまでカーネル内に存在する
  - IPCオブジェクトはシステム全体で共有される
  - 生存しているIPCオブジェクトにはどのプロセスからでもアクセスできる
- IPCオブジェクトは仮想ファイルシステム上に作成される
- IPCオブジェクトは一般のファイルと同様にパーミッションを持つ

## API

| インターフェース     | メッセージキュー | セマフォ            | 共有メモリ                    |
| -                    | -                | -                   | -                             |
| ヘッダファイル       | `<mqueue.h>`     | `<semaphore.h>`     | `<sys/mman.h>`                |
| オブジェクトハンドル | `mqd_t`          | `sem_t*`            | `int`(ファイルディスクリプタ) |
| オープン操作         | `mq_open(3)`     | `sem_open(3)`       | `shm_open(3)` + `mmap(2)`     |
| クローズ操作         | `mq_close(3)`    | `sem_close(3)`      | `munmap(3)`                   |
| 削除                 | `mq_unlink(3)`   | `sem_unlink(3)`     | `shm_unlink(3)`               |
| IPC実行              | メッセージ送受信 | セマフォ操作        | 共有メモリへのアクセス        |

### IPCオブジェクト名
- オブジェクトを特定・識別する名前
  - `/`始まり
  - Linuxにおいてはメッセージキュー・共有メモリの名前を`NAME_MAX`文字に制限
  - Linuxにおいてはセマフォ名の先頭に`sem.`が付加される

### オープン操作
- 全ての種類のIPCは`open(2)`に相当するオープン操作を持つ
- オブジェクトハンドルはファイルシステムにおけるファイルディスクリプタに相当する
- オブジェクトが存在しない場合: 指定のオブジェクト名のオブジェクトを新規に作成し、ハンドルを返す
- オブジェクトが存在する場合: 指定のオブジェクト名に対応するオブジェクトを開き、ハンドルを返す

### クローズ操作
- 使用を終えたIPCオブジェクトに対し、オブジェクトが
  メッセージキュー・セマフォの場合は明示的にクローズ操作を行う
  共有メモリの場合はメモリ領域をアンマッピングする

### 削除操作
- カーネル内ではレファレンスカウンタによってIPCオブジェクトのオープン / クローズを管理する
- 全ての種類のIPCは`unlink(2)`に相当する削除操作を持ち、全プロセスがクローズした時点で削除される

## IPCオブジェクトの管理
- POSIX IPCオブジェクトはシステム標準の`ls(1)` / `rm(1)`コマンドで扱うことができる

### Linuxでのコンパイル
- メッセージキュー、共有メモリを使用するプログラムにはコンパイル時に`-lrt`オプションを付加する
- セマフォを使用するプログラムにはコンパイル時に`-pthread`オプションを付加する

## System V IPC との比較
### POSIX IPCの利点
- インターフェースが簡潔
- キーではなく名前を使用して操作する
  UNIXファイル操作一般と整合性の取れたAPIを使用できる
- レファレンスカウンタによって管理される

### System V IPCの利点
- 可搬性(POSIX IPCはSUSv3ではオプション扱い)

## POSIXセマフォ
- System Vセマフォの欠陥に対処する
  - System Vセマフォよりも高実行効率
  - System Vセマフォよりもインターフェースが使いやすい
  - 削除操作はセマフォへの最後の参照が解放された後に行われる
- 無名POSIXセマフォ
  - メモリ内にのみ存在する
  - 同一プロセス内のスレッドか
    同一メモリ範囲をそれぞれのアドレス空間にマップしているプロセス内のスレッドのみが使用できる
- 名前付きPOSIXセマフォ
  - 名前を知っている任意のプロセスのスレッドから使用できる
- `sem_init(2)` - 無名セマフォの作成
- `sem_destroy(2)` - 無名セマフォの破棄
- `sem_getvalue(2)` - セマフォ値を取得
- `sem_open(2)` - 名前付きセマフォの作成・操作
- `sem_close(2)` - セマフォに付随するリソースの解放
  - `sem_close(2)`を呼ばずにプロセスが終了すると
    カーネルがオープンしているセマフォを自動的にクローズする
- `sem_unlink(2)` - 名前付きセマフォの破棄
- `sem_trywait(2)` / `sem_wait(2)` - セマフォ値を減ずる
- `sem_post(2)` - セマフォ値を増やす
