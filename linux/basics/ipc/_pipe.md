# IPC
- 参照: 例解UNIX/Linuxプログラミング教室P257-289
- 参照: 詳解UNIXプログラミング第3版 15. プロセス間通信
- 参照: Linuxネットワークプログラミング Chapter7 プロセス間通信 7-7

## パイプ
- 名前を必要としないプロセス間通信の仕組みの一つ
- データの流れは入力 -> 出力の一方通行(半二重)
- 共通先祖を持つプロセス間でのみ使える(Ex. 親 <-> 子)
- カーネルがパイプを持ち、プロセスはパイプへのファイルディスクリプタを持つ
  - データはプロセスの書き込み用ファイルディスクリプタ
    -> カーネル内のパイプの読み込み端点(ファイルディスクリプタ)
    -> カーネル内のパイプの書き込み端点(ファイルディスクリプタ)
    -> プロセスの読み込み用ファイルディスクリプタへ向かって流れる
- コマンドラインのパイプ(`|`)もパイプの仕組みを利用している

#### 読み書き
- パイプは書き込み端点と読み込み端点を持つ
  - 書き込み端点と読み込み端点はプログラム中においてファイルディスクリプタとして表現される

#### バッファ
- パイプに書き込んだデータはパイプ自身が持つバッファに書き込まれる
  - バッファが上限に達している状態で書き込もうとした場合
    またはバッファが空の状態で読み込もうとした場合、
    読み書きができるようになるまで操作がブロックされる

### 作成
- `pipe(2)` - パイプを作成する
  - パイプ両端のファイルディスクリプタ(読み込み端点・書き込み端点)を要素に持つ配列を返す
- `popen(3)` - パイプを作成し、`fork`してシェルコマンドを`exec`する
  - 標準入出力ファイルポインタを返す
  - プロセスがパイプを作成
    -> `fork`
    -> 子プロセスで使用しないパイプの端点を閉じてシェルを起動
    -> シェル上でコマンドを`exec`
- `pclose(3)` - `popen(3)`で開いた標準入出力ストリームを閉じ、コマンドの終了を待ち、シェルの終了状態を返す

### 通信
Ex. 親プロセス -> 子プロセスへの通信を行う場合

1. 親プロセスがカーネル内にパイプを生成
    - 親プロセス自身のファイルディスクリプタに書き込み端点・読み込み端点がつながったパイプが生成される
2. 親プロセスが`fork`する
    - 親プロセスのファイルディスクリプタをコピーする子プロセスが生成される
3. 親プロセスがパイプからの読み込み端点を閉じる
4. 子プロセスがパイプへの書き込み端点を閉じる
5. 親プロセスから子プロセスへ書き込み、子プロセスが親プロセス肩読み込み可能になる

### 使用上の注意
- 閉じたパイプへの読み書き
  - 書き手がパイプを閉じた後、読み手がパイプを読む -> EOF
  - 読み手がパイプを閉じた後、書き手がパイプに書く -> SIGPIPE
- パイプの閉じ忘れ
  - 書き込み端点の閉じ忘れ -> 読み手にEOFが来ずreadがブロックされる
  - 読み込み端点の閉じ忘れ -> パイプのバッファが溢れてwriteがブロックされる
