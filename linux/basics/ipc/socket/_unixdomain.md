# Unixドメインソケット
- 参照: 詳解UNIXプログラミング第3版 17. 高度なプロセス間通信
- 参照: Linuxネットワークプログラミング Chapter7 プロセス間通信 7-5/6
- 参照: Linuxプログラミングインターフェース 57章

## TL;DR
- 同一ホスト上でのプロセス間通信を行う機構
- データをコピーするだけで実現できるため、インターネットドメインに比べオーバーヘッドが少ない
- ストリームソケット、データグラムソケットそれぞれのインターフェースを提供する

### UNIXドメインソケットにおけるデータグラム通信
- カーネル内に閉じた環境でデータ転送を行うため、
  UNIXドメインソケットにおけるデータグラム通信は信頼性を備えている
  全てのメッセージ順序は維持され、重複することはない

## アドレシング
- UNIXドメインのソケットアドレス形式はパス名(ファイルシステムを使用する)
- UNIXドメインのソケットアドレスは`sockaddr_un`構造体で表現される

```c
#include <sys/un.h>

struct sockaddr_un {
  sa_family_t sun_family;    // AF_UNIX
  char        sun_path[108]; // パス名
};
```

- UNIXドメインソケットをアドレスへバインドするには
  `sockaddr_un`構造体を初期化(`memset(2)`でゼロクリア)し、
  そのポインタをキャスト演算し、`bind(2)`の`addr`として指定する
- UNIXドメインソケットをバインドすると、
  `bind(2)`はファイルシステム上にソケットファイル(種別`S_IFSOCK`)を作成する
  - 既存のパス名はバインドできない
  - 慣例的にファイルシステム上での固定アドレスに相当する絶対パス名を使用する
  - 1ソケットは1パス名と対応する
  - ソケットファイルは`open(2)`できない
  - ソケットの使用後はソケットファイルを`unlink(2)`する

## 作成
- インターネットドメインソケットと同じ`socket(2)`で作成できる
  - アドレス探索の際、`sockaddr_un`構造体にファイルのパス名を指定する必要がある

### ソケットペア
- `socketpair(2)` - 接続済みのUnixドメインソケットペアを生成する
  - 名前を必要としない(ファイルシステムを使用しない)ソケットペアを得ることができる
  - アドレスファミリとして`AF_UNIX`のみをサポートする
  - 各ソケットはユーザープロセスが持つ二つのファイルディスクリプタに対応する
  - Unixドメインの接続済みの組は全二重パイプのように動作する(読み書き両方でオープンされている) = `fd`パイプ


### ソケットペア
- `socketpair(2)`で作成されるソケットペアは名前を持たないため、
  直接ファイルディスクリプタを通信先に指定することができる
  - 関連しないプロセスからは指定することができない

## 接続
- インターネットドメインソケットと同じ`accept(2)` / `connect(2)`で接続できる
- インターネットドメインソケットと同じシステムコールで読み書きできる

## 切断
- インターネットドメインソケットと同じシステムコールで切断できる
