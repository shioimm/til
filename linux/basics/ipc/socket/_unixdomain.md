# Unixドメインソケット
- 参照: 詳解UNIXプログラミング第3版 17. 高度なプロセス間通信
- 参照: Linuxネットワークプログラミング Chapter7 プロセス間通信 7-5/6
- 参照: Linuxプログラミングインターフェース 57章

## TL;DR
- 同一ホスト上でのプロセス間通信を行う機構
- データをコピーするだけで実現できるため、インターネットドメインに比べオーバーヘッドが少ない
- ストリームソケット、データグラムソケットそれぞれのインターフェースを提供する

### UNIXドメインソケットにおけるデータグラム通信
- カーネル内に閉じた環境でデータ転送を行うため、
  UNIXドメインソケットにおけるデータグラム通信は信頼性を備えている
  全てのメッセージ順序は維持され、重複することはない

## パーミッション
- ソケットファイルを用いた通信のパーミッションは
  ソケットファイル自身のオーナー、パーミッションによって決まる
- UNIXドメインのストリームソケットへの接続及びデータグラムソケットを用いた通信には
  ソケットファイルに対する書き込み権限が必要

## アドレシング
- UNIXドメインのソケットアドレス形式はパス名(ファイルシステムを使用する)
- UNIXドメインのソケットアドレスは`sockaddr_un`構造体で表現される

```c
#include <sys/un.h>

struct sockaddr_un {
  sa_family_t sun_family;    // AF_UNIX
  char        sun_path[108]; // パス名
};
```

- UNIXドメインソケットをアドレスへバインドするには
  `sockaddr_un`構造体を初期化(`memset(2)`でゼロクリア)し、
  そのポインタをキャスト演算し、`bind(2)`の`addr`として指定する
- UNIXドメインソケットをバインドすると、
  `bind(2)`はファイルシステム上にソケットファイル(種別`S_IFSOCK`)を作成する
  - 既存のパス名はバインドできない
  - 慣例的にファイルシステム上での固定アドレスに相当する絶対パス名を使用する
  - 1ソケットは1パス名と対応する
  - ソケットファイルは`open(2)`できない
  - ソケットの使用後はソケットファイルを`unlink(2)`する

## [Linux]抽象ソケット名前空間
- ファイルシステム上にソケットファイルを作成せず、UNIXドメインソケットへ名前をバインドする
  - ファイルシステム上の既存のファイル名と衝突する恐れがなくなる
  - ソケットクローズ時に自動的に抽象名を削除するため、
    ソケットの使用後にソケットファイルを削除する必要がない
  - ソケットファイルのパス名を生成する必要がない
- `sockaddr_un`構造体の`sun_path`の先頭にNULLバイトを指定すると抽象バインドを設定できる

## API
### `socketpair(2)`
- プロセス内で接続済みの二つのソケット(ソケットペア)を作成する
- `socket(2)` / `bind(2)` / `listen(2)` / `connect(2)` / `accept(2)`をまとめて実行する
- `type`に`SOCK_STREAM`を指定した場合は双方向パイプの作成と等価(ソケットパイプ)
- `socketpair(2)`によって作成したソケットは関連のないプロセスからは隠蔽される

#### 引数
- `domain`、`type`、`protocol`、`sockfd[2]`を指定する
  - `domain` - `AF_UNIX`
  - `type` - `SOCK_STREAM` / `SOCK_DGRAM`
  - `protocol` - 数値0
  - `sockfd[2]` - 接続済みの二つのソケット

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す
