# ソケット
- 参照: 例解UNIX/Linuxプログラミング教室P291-322
- 参照: 詳解UNIXプログラミング第3版 16. ネットワークIPC: ソケット
- 参照: Linuxプログラミングインターフェース 56章

## TL;DR
- アプリケーション間でデータを交換するIPC
- ネットワークを介した異なるホスト間でも通信可能

### ソケット
- 通信を可能にする機構
- クライアント / サーバーいずれにもソケットが必要

### well-knownアドレス
- サーバーはソケットをwell-knownアドレスへバインドする
- クライアントはwell-knownアドレスによりサービスを特定する

### 通信ドメイン(通信領域、通信範囲)
- ソケットの特定方法
  - ソケットアドレスの形式
- 通信範囲
  - 同一ホスト上のアプリケーション間通信
  - ネットワーク介した異なるホスト上のアプリケーション間通信

| ドメイン   | 通信方法   | アプリケーション間通信       | アドレス形式              | アドレス構造体 |
| -          | -          | -                            | -                         | -              |
| `AF_UNIX`  | カーネル内 | 同一ホスト内                 | パス名                    | `sockaddr_un`  |
| `AF_INET`  | IPv4経由   | IPv4ネットワーク上の他ホスト | IPv4アドレス + ポート番号 | `sockaddr_in`  |
| `AF_INET6` | IPv6経由   | IPv6ネットワーク上の他ホスト | IPv6アドレス + ポート番号 | `sockaddr_in6` |

### ソケット種類

| 性質                   | ストリーム | データグラム |
| -                      | -          | -            |
| 配送の信頼性           | ○          | ×            |
| メッセージ区切りの維持 | ×          | ○            |
| コネクション(接続)指向 | ○          | ×            |

#### ストリームソケット(`SOCK_STREAM`)
- 信頼性と双方向性を備えたバイトストリームの通信チャネル
- 二つのソケットが接続した状態で動作する
- インターネットドメインではTCPを使用する
- アクティブソケット - `socket(2)`で作成したソケット(デフォルト)
  - クライアント - ソケットをアクティブオープンするアプリケーション
- パッシブソケット - `listen(2)`によって接続を受け付けるソケット
  - サーバー - ソケットをパッシブオープンするアプリケーション
- ストリームソケットのIOはカーネル内に入力バッファ・出力バッファを持つ

#### データグラムソケット(`SOCK_DRAM`)
- 信頼性を保証しないデータグラム(メッセージ区切りを維持する)の通信チャネル
- 他のソケットに接続せず使用する
- インターネットドメインではUDPを使用する

## API
### `socket(2)`
- プロセスに新しいソケットを一つ作成する

#### 引数
- `domain`、`type`、`protocol`を指定する
  - `domain` - ソケットの通信ドメインを示すマクロ定数
  - `type` - ソケット種類を示すマクロ定数
  - `protocol` - 数値0

#### 返り値
- ソケットディスクリプタを返す
  - エラー時は数値-1を返す

### `bind(2)`
- プロセスが紐づいているソケットを固有のアドレスへバインドする
  - サーバーソケットをwell-knownアドレスへバインドするために使用する
  - バインドせずに`listen(2)`する場合、カーネルが自動的に
    ソケットをエフェメラル(短期的)ポートへバインドする
    - サーバーは`getsockname(2)`によりそのアドレスを取得する
    - クライアントへは何らかの方法でアドレスを通知する必要がある

#### 汎用ソケットアドレス構造体(`sockaddr`構造体)
- 各ドメイン固有のアドレス構造体をソケットシステムコールの引数に使用できるよう
  一意の構造体へキャストするための汎用構造体

```c
struct sockaddr {
  sa_family_t sa_family; // アドレスファミリ
  char        sa_data[]; // ソケットアドレス
};
```

#### 引数
- `sockfd`、`*addr`、`addrlen`を指定する
  - `sockfd` - ソケットディスクリプタ
  - `*addr` - ソケットへバインドするアドレスを表す構造体へのポインタ
  - `addrlen` - `*addr`のサイズ

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `listen(2)`
- 指定のソケットディスクリプタのストリームソケットをパッシブソケットとしてマークする
- 他のアクティブソケットからの接続要求を受け付ける
- コネクションが確率済みのソケットを`listen(2)`することはできない

#### 引数
- `sockfd`、`backlog`を指定する
  - `sockfd` - 指定のソケットディスクリプタ
  - `backlog` - ソケットが管理する`accept(2)`待ち接続要求の上限数
    - `backlog`を超える新たな接続要求はキューが空くまでブロックされる
    - `<sys/socket.h>`で定義される`SOMAXCONN`は128

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `accept(2)`
- 指定のリスニングソケットに対する接続要求を取り出す
- 接続要求がなければブロックする
- 接続が確立した後もリスニングソケットは継続して以降の接続要求を受け付ける

#### 引数
- `sockfd`、`*addr`、`addrlen`を指定する
  - `sockfd` - ソケットディスクリプタ
  - `*addr` - 接続先のクライアントソケットアドレスを表す構造体へのポインタ
  - `*addrlen` - `*addr`が指すバッファのサイズへのポインタ
    - 関数の呼び出し完了後、バッファへ実際にコピーしたバイト数が代入される

#### 返り値
- 接続を確立した新規ソケットディスクリプタを返す
  - エラー時は数値-1を返す

### `connect(2)`
- 指定のアクティブソケットを指定のアドレスにバインドされているリスニングソケットへ接続する
- `connect(2)`がエラーを返し、`connect(2)`し直す場合、
　一度ソケットをクローズして作り直し、改めて`connect(2)`する(SUSv3・可搬性のため)

#### 接続済みデータグラムソケット
- データグラムソケットに対して`connect(2)`システムコールを実行したもの
- カーネルはピアソケットに特定のアドレスを割り当て管理する
- これに対して`connect(2)`を実行していないデータグラムソケットを
  未接続データグラムソケットと呼ぶ
- 接続済みデータグラムソケットは
  - `write(2)` / `send(2)`によってデータグラムを送信できる
  - `connect(2)`したピアソケットを送信先とする(`connect(2)`し直すことで接続先を変更できる)
  - ピアソケットが送信したデータグラムのみ受信する

#### 引数
- `sockfd`、`*addr`、`addrlen`を指定する
  - `sockfd` - 指定のアクティブソケットディスクリプタ
  - `*addr` - リスニングソケットへバインドしているアドレスを表す構造体へのポインタ
  - `addrlen` - `*addr`のサイズ
    - 実行後、`*addr`バッファへ実際にコピーしたバイト数が代入される

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `close(2)`
- ファイルIOの`close(2)`と同じAPIでオープン済みのソケットディスクリプタを閉じる
- 双方向通信チャネルの場合は送受信両方のチャネルがクローズされる
- 複数のソケットディスクリプタが同じソケットを参照している場合、
  すべてのディスクリプタをクローズした時点でコネクションが終了する

#### 引数
- `fd`を指定する

#### 返り値
- `0`を返す

### `shutdown(2)`
- 双方向通信チャネルにおいて、送受信どちらかのチャネルのみをクローズする
- ソケットは一方向のみの通信が可能となる
- 複数のソケットディスクリプタが同じソケットを参照していても接続チャネルをクローズする
  - `shutdown(2)`はオープンファイル情報を削除する
  - `shutdown(2)`はソケットディスクリプタを操作しないため、
    ソケットディスクリプタをクローズする場合は別途`close(2)`が必要になる

#### 引数
- `sockfd`、`how`を指定する
  - `sockfd` - 指定のソケットディスクリプタ
  - `how` - どのチャネルを閉じるかを示すマクロ定数
    - `SHUT_RD` - コネクションの受信チャネルをクローズする
    - `SHUT_WR` - コネクションの送信チャネルをクローズする
    - `SHUT_RDWR` - コネクションの送受信チャネルを両方クローズする

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `recv(2)` / `send(2)`
- 接続済みソケットに対してIOを実行する
- `flags`によって操作を指定することができる
- `recvmsg(2)` / `sendmsg(2)`は`recv(2)`/`send(2)`とファイルIOの機能を包含し、スキャッタギャザIO可能

#### 引数
- `sockfd`、`*buffer`、`length`、`flags`を指定する
  - `sockfd` - 指定のソケットディスクリプタ
  - `*buffer` - 読み取った / 書き込むデータを格納するバッファへのポインタ
  - `length` - `*buffer`のサイズ
  - `flags` - `recv(2)` / `send(2)`の動作を指定するビットマスク

#### 返り値
- `recvfrom(2)` - 読み取ったバイト数を返す
  - EOF時は数値0を返す
  - エラー時は数値-1を返す
- `sendto(2)` - 書き込んだバイト数を返す
  - エラー時は数値-1を返す

### [Linux]`sendfile(2)`
- ゼロコピー転送を行う
  - ディスク上のファイルをカーネル空間内のバッファキャッシュに読み込む
    -> ファイルをソケットの送信バッファにコピー
    -> ファイルを送信バッファからネットワークへ送信
  - 通常のファイルIOの場合:
    `read(2)`でディスク上のファイルをカーネル空間内のバッファキャッシュに読み込む
    -> ファイルをユーザー空間へコピー
    -> `write(2)`でファイルをカーネル空間内のソケットの送信バッファにコピー
    -> ファイルを送信バッファからネットワークへ送信

#### 引数
- `out_fd`、`in_fd`、`*offset`、`count`を指定する
  - `out_fd` - `in_fd`からファイルをコピーする先のソケットディスクリプタ
  - `in_fd` - ディスク上のファイルを指すファイルディスクリプタ
  - `*offset` - `in_fd`のファイル内の転送開始オフセットまたは数値0
  - `count` - 転送するバイト数

#### 返り値
- 転送バイト数を返す
  - エラー時は数値-1を返す

### `recvfrom(2)` / `sendto(2)`
- `recvfrom(2)` - 指定のソケットディスクリプタからデータグラムを受信する
- `sendto(2)` - 指定のソケットディスクリプタへデータグラムを送信する

#### 引数
- `sockfd`、`*buffer`、`length`、`flags`、`*src_addr`、`*addrlen`を指定する
  - `sockfd` - 指定のソケットディスクリプタ
  - `*buffer` - 読み取った / 書き込むデータを格納するバッファへのポインタ
  - `length` - `*buffer`のサイズ
  - `flags` - ソケットIOを操作するビットマスク(操作の必要がなければ0)
  - `*src_addr` - ピアソケットへバインドしているアドレスを表す構造体へのポインタ
    - `recvfrom(2)` - 実行後、受信したデータグラムを送信したリモートソケットアドレスを格納する
    - `sendto(2)` - データグラムを送信する先のリモートソケットアドレスを格納する
  - `addrlen` - `*src_addr`のサイズ
    - 実行後、`*src_addr`バッファへ実際にコピーしたバイト数が代入される

#### 返り値
- `recvfrom(2)` - 受信バイト数を返す
  - EOF時は数値0を返す
  - エラー時は数値-1を返す
- `sendto(2)` - 送信バイト数を返す
  - エラー時は数値-1を返す

### `getsockname(2)` / `getpeername(2)`
- `getsockname(2)` - ソケットへバインドしたローカルアドレスを取得する
- `getpeername(2)` - ピアソケットアドレスを取得する

#### 引数
- `sockfd`、`*addr`、`*addrlen`を指定する
  - `sockfd` - 対象のソケットディスクリプタ
  - `*addr` - ソケットアドレスを格納する`sockaddr`構造体
  - `*addrlen` - `addr`のサイズ

#### 返り値
- 転送バイト数を返す
  - エラー時は数値-1を返す
