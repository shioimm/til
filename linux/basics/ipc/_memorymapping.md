# メモリマッピング
- 参照: Linuxプログラミングインターフェース 49章

## `mmap(2)`
- 自プロセスの仮想アドレス空間にメモリマッピングを新規作成する
- プロセスのマッピングは`/proc/PID/maps`で確認できる

## マッピングを他のプロセスと共有する方法
- 2プロセスが同じファイルの同じ範囲をマッピングすると
  物理メモリページを共有する
- `fork(2)`により作成した子プロセスは親プロセスのマッピングを受け継ぎ
  物理メモリページを共有する
  - `exec`を実行すると破棄される

## マッピング種類
### ファイルマッピング
- ファイル内容を自プロセスの仮想メモリへ直接マッピングする
- メモリへのアクセスはそのままファイルへのアクセスとなる
- マッピング内のメモリページは必要に応じてファイルからロードされる

### 無名マッピング
- 常に内容が0で初期化される仮想ファイルへマッピングする

## 変更の可視性
### 共有
- マッピング内のデータを変更すると、他プロセスも変更した内容を参照できる
- ファイルマッピングの場合は対応するファイルへ変更が反映される

### 非共有
- マッピング内のデータを変更しても、他プロセスからは変更した内容が参照できない
- ファイルマッピングの場合は対応するファイルへ変更が反映されない
- 変更内容はプロセス内に閉じる
- コピーオンライトによって動作が実現されている

## メモリマッピングの分類

| 変更の可視性 | ファイルマッピング               | 無名マッピング   |
| -            | -                                | -                |
| 共有         | メモリマップIO、プロセス間で共有 | プロセス間で共有 |
| 非共有       | ファイル内容で初期化             | メモリ割り当て   |

### 共有ファイルマッピング
- マッピング内容はファイル内容で初期化される
- 同じファイルの同じ範囲をマッピングする全プロセスは同じページを共有する
- マッピング内容の変更は対応するファイルへも反映される
- 主な用途はメモリマップIOと関連を持たないプロセス間でのIPC

### 共有無名マッピング
- 物理ページを共有しない
- 子プロセスは親プロセスからマッピングを受け継ぐため同じページを参照する
- 主な用途は親子プロセス間でのIPC

### 非共有ファイルマッピング
- マッピング内容はファイル内容で初期化される
- コピーオンライトマッピングにより、
  1プロセスが内容を変更しても他プロセスからはその変更が見えない
- 主な用途はメモリをファイル内容で初期化すること

### 非共有無名マッピング
- 物理ページを共有しない
- コピーオンライトマッピングにより、
  1プロセスが内容を変更しても他プロセスからはその変更が見えない
- 主な用途は新規メモリ割り当て(`malloc(3)`など)
