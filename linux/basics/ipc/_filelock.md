# ファイルロック
- 参照: Linuxプログラミングインターフェース 55章

## TL;DR
- ファイルIOに対する同期機構(`flock(2)` / `fcntl(2)`)
- カーネルがロックとファイルの対応を自動的に管理する
- デフォルトのロックはアドバイザリロック(強制力がないロック)
  - 各プロセスがIOを実行する前にファイルをロックするよう強調する必要がある

## 使用手順
1. ファイルをロックする
2. ファイルIOを実行する
3. ファイルをアンロックし、他プロセスからロック可能とする

## バッファリング
- `stdio`ライブラリはユーザー空間でバッファリングするため、
  ファイルをロックする前に入力がバッファリングされる
  ファイルをアンロックする前に出力バッファがフラッシュされる
  - ファイルロック直後・ファイルアンロック直前にに明示的に`stdio`ストリームをフラッシュする
  - `stdio`のバッファリングを停止する
  - `stdio`ライブラリを使用せずシステムコールで代用する

## `flock(2)`
- 指定のファイル全体をロックする
- 共有ロック・排他ロックはファイルのアクセスモードとは関係しない
- `flock(2)`し直すことによって共有ロック -> 排他ロック / 排他ロック -> 共有ロックへ変換可能
  - ロックの変換中に他のプロセスのロックが割り込む可能性がある
- ロックはアンロックするかファイルディスクリプタをクローズすることで解放される
- 複製されたファイルディスクリプタ(`dup(2)`、`fork(2)`など)も
  元のファイルディスクリプタと同じファイルロックを持つ

#### 制限事項
- ロック対象は常にファイル全体
- アドバイザリロックしか使用できない
- `flock(2)`のファイルロックに対応しないNFS実装が多く存在する

#### 引数
- `fd`、`operation`を指定する
  - `fd` - 指定のファイルへのファイルディスクリプタ
  - `operation` - ロック種類を示すマクロ定数
    - `LOCK_SH` - 共有ロック - 同時に複数プロセスがロックできる
    - `LOCK_EX` - 排他ロック - 同時に1プロセスのみがロックできる
    - `LOCK_UN` - アンロック
    - `LOCK_NB` - ノンブロッキング動作でロックを試みる

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

## `fcntl(2)`
- 指定のファイル内の範囲を指定し、その部分だけロックする(レコードロック)

```c
struct flock flockstr;

fcntl(fd, cmd, &flockstr)
```

### `fd`
- 指定のファイルへのファイルディスクリプタ

### `cmd`
- ファイルロック操作
  - `F_SETLK` - 指定の範囲に対してロックを獲得または解放する
  - `F_SETLKW` - 指定の範囲に対してロックを獲得または解放する
    - 対象ロック範囲と重複して他プロセスが一致しないロックを設けていた場合は処理をブロックする
  - `F_GETLK` - 指定のロックを獲得できるか調べる

### `flock`構造体
- 獲得・解放するロックの内容を示す

```c
struct flock {
  short l_type;   // ロック種類
  short l_whence; // l_startの意味
  off_t l_start;  // ロック開始オフセット
  off_t l_len;    // ロック範囲バイト数
  pid_t l_pid;    // ロック獲得中のプロセスID
};
```

- `l_type` - ロック種類
  - `F_RDLCK` - リードロック(共有ロック相当)
  - `F_WRLCK` - ライトロック(排他ロック相当)
  - `F_UNLCK` - アンロック

- `l_whence` - 範囲開始地点
  - `SEEK_SET` - ファイルの先頭
  - `SEEK_CUR` - 現在のファイルオフセット
  - `SEEK_END` - ファイルの末尾

### 制限事項
- アンロックは常に成功する
- ファイル内の同じ範囲に対してはプロセスは一種類のロックしか保持できない
- 同じファイルを複数の異なるファイルディスクリプタからロックしても
  ブロックすることはない
- 既存のロック範囲内に異なる種類のロックを新たに設けると
  既存のロックは分割され、新たなロックの前後に並ぶ
- 既存のロックに連続するor重なるように同種のロックを新たに設けると
  ロックは連結されてひとつのロックになる
