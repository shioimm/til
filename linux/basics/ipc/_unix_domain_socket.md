# Unixドメインソケット
- 参照: 詳解UNIXプログラミング第3版 17. 高度なプロセス間通信
- 参照: Linuxネットワークプログラミング Chapter7 プロセス間通信 7-5/6

## TL;DR
- ソケットを使用して同一コンピュータ上で行われるプロセス間通信の仕組み
  - データをコピーするだけであるためインターネットドメインに比べオーバーヘッドが少ない
- アドレスファミリは`AF_UNIX`
- 通信の識別を行う識別子としてファイルのパス名を使用する(ファイルシステムを使用する)
  それ以外はインターネットドメインソケットと同じ
  - ファイルのパス名を指定しない場合は`socketpair(2)`を使用する
- ソケットとパイプの混ぜ合わせで実装される
- ストリームとデータグラムそれぞれのインターフェースを提供する

## 作成
- インターネットドメインソケットと同じ`socket(2)`で作成できる
  - アドレス探索の際、`sockaddr_un`構造体にファイルのパス名を指定する必要がある

### ソケットペア
- `socketpair(2)` - 接続済みのUnixドメインソケットペアを生成する
  - 名前を必要としない(ファイルシステムを使用しない)ソケットペアを得ることができる
  - アドレスファミリとして`AF_UNIX`のみをサポートする
  - 各ソケットはユーザープロセスが持つ二つのファイルディスクリプタに対応する
  - Unixドメインの接続済みの組は全二重パイプのように動作する(読み書き両方でオープンされている) = `fd`パイプ

## アドレシング
- Unixドメインソケットのアドレス形式は`sockaddr_un`構造体で表現される
- インターネットドメインソケットと同じ`bind(2)`でアドレシングできる

```c
#include <sys/un.h>

struct sockaddr_un {
  sa_family_t sun_family;    // AF_UNIX
  char        sun_path[108]; // パス名
};
```

- Unixドメインソケットにアドレスをつけると、
  システムはファイル種別`S_IFSOCK`として同じ名前のファイルを作成する
  - ソケット名をクライアントに告知するためだけに使用される
  - ソケットをクローズしてもファイルは自動的に削除されないため手動で削除する必要がある

### ソケットペア
- `socketpair(2)`で作成されるソケットペアは名前を持たないため、
  直接ファイルディスクリプタを通信先に指定することができる
  - 関連しないプロセスからは指定することができない

## 接続
- インターネットドメインソケットと同じ`accept(2)` / `connect(2)`で接続できる
- インターネットドメインソケットと同じシステムコールで読み書きできる

## 切断
- インターネットドメインソケットと同じシステムコールで切断できる
