# API
- 参照: 例解UNIX/Linuxプログラミング教室P185-224
- 参照: 詳解UNIXプログラミング第3版 7. プロセスの環境 / 8. プロセスの制御 / 9. プロセスの関係
- 参照: Linuxプログラミングインターフェース 6章

## プロセスIDの取得
### `getpid(2)`
- プロセスIDの取得

#### 返り値
- プロセスID(`pid_t`)を返す

### `getppid(2)`
- プロセスの親プロセスIDの取得

#### 返り値
- プロセスID(`pid_t`)を返す

## 環境リスト
### `export(1)`
- 環境の追加

```
$ export XXX=yyy

# 一回のコマンド実行commandに対してのみ環境変数を変更する場合
$ XXX=yyy command
```

### `printenv(1)`
- 現在の環境リストを出力

### `getenv(3)`
- プロセスから個別の環境を参照する

#### 引数
- `*name`を指定する
  - `*name` - 環境変数

#### 返り値
- 環境の値の文字列へのポインタ
  - 存在しない場合はNULL

### `putenv(3)`
- プロセス自身の環境リストへ新しい環境を追加する

#### 引数
- `*string`を指定する
  - `*string` - `NAME=value`形式の環境

#### 返り値
- 数値0
  - エラー時は数値0以外

### `setenv(3)`
- プロセス自身の環境リストへ新しい環境を追加する

#### 引数
- `*name`、`*value`、`overwrite`を指定する
  - `*name` - 環境変数(`=`を加えない)
  - `*value` - 環境の値
  - `overwrite` - 0が設定されている場合、上書きしない

#### 返り値
- 数値0
  - エラー時は数値-1

### `unsetenv(3)`
- プロセス自身の環境リストから環境を削除する

#### 引数
- `*name`を指定する
  - `*name` - 環境変数(`=`を加えない)

#### 返り値
- 数値0
  - エラー時は数値-1

### `clearenv(3)`
- プロセスの環境リストをリセットする
  - `clearenv(3)`を実行してもメモリ領域は解放されない

## 非局所脱出
### `setjmp(3)`
- 呼び出し位置を`longjamp(3)`のジャンプ先として登録

#### 引数
- `env`を指定する
  - `env` - 環境を保存する`jmp_env`型のバッファ
    (プログラムカウンタレジスタとスタックポインタレジスタ)
    - プログラムカウンタレジスタ - 現在実行中の機械語命令
    - スタックポインタレジスタ - スタックトップ
    - `env`に格納した値は`longjmp(3)`した時点で破棄される

#### 返り値
- 数値0
  - エラー時は数値0以外

### `longjmp(3)`
- `setjmp(3)`の呼び出し位置へジャンプする
  - `setjmp(3)`で`env`に退避したレジスタのデータをレジスタに回復する
  - ジャンプした後は`setjmp(3)`から返ってきたように処理が継続する

#### 引数
- `env`、`val`を指定する
  - `env` - 環境を保存する`jmp_env`型のバッファ
    (プログラムカウンタレジスタとスタックポインタレジスタ)

## プログラムブレーク
### `brk(2)`
- 指定のアドレス位置へプログラムブレークを移動させる

#### 引数
- `*end_data_segment`を指定する↲
  - `*end_data_segment` - 新しいプログラムブレーク
    - 仮想メモリはページ単位に割り当てられるため、ページ境界へ丸め上げられる

#### 返り値
- 数値0
  - エラー時は数値-1

### `sbrk(2)`
- プログラムブレークに`increment`分の数値を加算してアドレス移動させる

#### 引数
- `increment`を指定する
  - `increment` - プログラムブレークに加算する数値
    - 新たに割り当てたメモリ領域の先頭アドレス

#### 返り値
- 数値0
  - エラー時は数値-1

## ヒープ上のメモリの割り当て
### `malloc(2)`
- 指定したバイト数のメモリを割り当てる
- 割り当てられた領域の初期値は不定

#### `brk`と比較した際の利点
- マルチスレッドアプリケーションから利用可能
- 小さいサイズの領域も割り当て可能
- 内部でフリーリストを管理し、以降の割り当てに再利用するため、メモリを自由に解放できる

#### `malloc(3)`ファミリ
- `mallopt(3)` - `malloc(3)`のパラメータを操作
- `mallinfo(3)` - `malloc(3)`が割り当てたメモリの統計情報をまとめた構造体を返す

#### 引数
- `size`を指定する
  - `size` - 割り当てを行う領域のサイズ

#### 返り値
- 割り当てた領域の先頭アドレスへのポインタを返す
  - エラー時はNULLを返す(プログラムブレークが上限に達した場合など)

### `free(3)`
- 指定されたメモリを解放する

#### 引数
- `ptr`を指定する
  - `ptr` - 事前に`malloc(3)`などで返されたポインタ

### `calloc(2)`
- 指定した数の要素を格納できるバイト数のメモリを割り当てる
- 割り当てられた領域の初期値は0

#### 引数
- `numitems` / `size`を指定する
  - `numitems` - 配列の要素数
  - `size` - 割り当てを行う領域のサイズ

#### 返り値
- 割り当てた領域の先頭アドレスへのポインタを返す
  - エラー時はNULLを返す(プログラムブレークが上限に達した場合など)

### `realloc(2)`
- `malloc(3)`が割り当てた領域のサイズを変更する

#### 引数
- `ptr` / `size`を指定する
  - `ptr` - サイズを変更する領域のポインタ
  - `size` - 割り当てを行う領域のサイズ

#### 返り値
- 割り当てた新しい領域の先頭アドレスへのポインタを返す
  - エラー時はNULLを返す(プログラムブレークが上限に達した場合など)

## スタック上のメモリ割り当て
### `alloca(2)`
- スタックフレーム上に指定したバイト数のメモリを割り当てる

#### 引数
- `size`を指定する
  - `size` - 割り当てを行うスタック上のメモリサイズ

#### 返り値
- 割り当てた領域の先頭アドレスへのポインタを返す

## プロセスグループ
### `getpgrp(2)`
- 自プロセスが所属するプロセスグループIDを取得する

### 返り値
- 自プロセスのプロセスグループIDを返す

### `setpgid(2)`
- 指定のプロセスが所属するプロセスグループを指定のプロセスグループへ変更する
  - 指定できるのは自プロセスか自プロセスの子プロセスのみ
  - プロセスグループを移動する場合、移動先のプロセスグループは同一セッション内に限られる
  - `exec`実行後の子プロセスのプロセスグループIDは変更できない

```c
// 自プロセスを所属するプロセスグループのリーダーにする
setpgrp(0, 0)
```

### 引数
- `pid`、`pgid`を指定する

### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `tcgetpgrp(2)`
- 端末のプロセスグループを参照する

#### 引数
- `fd`を指定する
  - `fd` - 自プロセスの制御端末のファイルディスクリプタ

#### 返り値
- フォアグラウンドプロセスグループのIDを返す
  - エラー時は数値-1を返す

### `tcsetpgrp(2)`
- 端末のプロセスグループを変更する

#### 引数
- `fd`、`pgid`を指定する
  - `fd` - 自プロセスの制御端末のファイルディスクリプタ
  - `pgid` - 自プロセスと同じセッションに属するプロセスグループID

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

## セッション
### `getsid(2)`
- 指定のプロセスのセッションIDを返す

```c
// 自プロセスのセッションIDを返す
getsid(0)
```

### 引数
- `pid`を指定する

### 返り値
- セッションIDを返す
  - エラー時は数値-1を返す

### `setsid(2)`
- 自プロセスがプロセスグループリーダーではない場合
  自プロセスをセッションリーダーとする新規セッションを作成する
  - セッション内に自プロセスをプロセスグループリーダーとする新規プロセスグループを作成する
  - 自プロセスは制御端末を持たず、それまで接続されていた制御端末は切断される
- 自プロセスがプロセスグループリーダーの場合、`EPERM`エラーが発生

### 返り値
- 新規セッションIDを返す
  - エラー時は数値-1を返す

## 制御端末
###`*ctermid`
- 制御端末のパス名を返す

#### 引数
- `*ttyname`を指定する
  - `*ttyname` - サイズが`L_ctermid`の領域へのポインタまたはNULL

#### 返り値
- 制御端末へのパスを示す文字列へのポインタを返す
  - パス名を特定できなかった場合はNULLを返す

## プロセススケジューリング
### `getpriority(2)`
- プロセス、プロセスグループ、ユーザのnice値を取得する

#### 引数
- `which`、`who`を指定する
  - `which` - どんなプロセスを対象にするかを示すフラグ
  - `who` - プロセスIDまたはユーザーID(`which`によって変わる)

#### 返り値
- 指定したプロセスのIDを返す
  - エラー時は数値-1を返す

### `setpriority(2)`
- プロセス、プロセスグループ、ユーザのnice値を変更する

#### 引数
- `which`、`who`、`prio`を指定する
  - `which` - どんなプロセスを対象にするかを示すフラグ
  - `who` - プロセスIDまたはユーザーID(`which`によって変わる)
  - `prio` - 優先度

#### 返り値
- 指定したプロセスのIDを返す
  - エラー時は数値-1を返す

## リアルタイムスケジューリング
### `sched_get_priority_min(2)` / `sched_get_priority_max(2)`
- 指定したポリシーの優先度の範囲を取得する

#### 引数
- `poricy`を指定する
  - `poricy` - 対象のスケジューリングポリシー

#### 返り値
- 非負の整数(優先度)を返す
  - エラー時は数値-1を返す

### `sched_getscheduler(2)`
- 指定のプロセスのスケジューリングポリシーと優先度を取得する
- `sched_getparam(2)` - 優先度のみを取得する

#### 引数
- `sched_getscheduler(2)` - `pid`を指定する
  - `pid` - 対象のプロセス(数値0で自プロセス)
- `sched_getparam(2)` - `pid`、`poricy`、`*param`を指定する
  - `pid` - 対象のプロセス(数値0で自プロセス)
  - `*param` - 対象プロセスの優先度を格納するための`sched_param`構造体へのポインタ

#### 返り値
- `sched_getscheduler(2)` - スケジューリングポリシーを返す
  - エラー時は数値-1を返す
- `sched_getparam(2)` - 数値0を返す
  - エラー時は数値-1を返す

### `sched_setscheduler(2)`
- 指定のプロセスのスケジューリングポリシーと優先度を設定する
- `sched_setparam(2)` - 優先度のみを変更する

#### 引数
- `pid`、`poricy`、`*param`を指定する
  - `pid` - 対象のプロセス(数値0で自プロセス)
  - `poricy` - 対象のスケジューリングポリシー
  - `*param` - `sched_param`構造体へのポインタ

```c
struct sched_param {
  int sched_priority;
};
```

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `sched_yield(2)`
- リアルタイムプロセスが自発的にCPUを手放す

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

## CPUアフィニティ
### `sched_getaffinity(2)`
- CPUアフィニティを取得する

#### 引数
- `pid`、`len`、`*set`を指定する
  - `len` - `cpu_set_t`構造体のサイズ
  - `*set` - CPUアフィニティを格納する`cpu_set_t`構造体へのポインタ
    - `cpu_set_t`構造体への操作は専用のマクロを使用して行う

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す
### `sched_setaffinity(2)`
- CPUアフィニティを指定する

#### 引数
- `pid`、`len`、`*set`を指定する
  - `len` - `cpu_set_t`構造体のサイズ
  - `*set` - プロセスへ設定するCPUアフィニティを示す`cpu_set_t`構造体へのポインタ
    - `cpu_set_t`構造体への操作は専用のマクロを使用して行う

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

## リソース
### `getrusage(2)`
- 自プロセスまたは子プロセスが消費したソステムリソースの合計を返す

#### 引数
- `who`、`*res_usage`を指定する
  - `who` - 対象とするプロセスを示すフラグ
  - `*res_usage` - 消費リソースを格納する`rusage`構造体へのポインタ

```c
struct rusage {
  struct timeval ru_utime;   使用されたユーザー時間
  struct timeval ru_stime;   使用されたシステム時間
  long           ru_maxrss;  常駐メモリサイズ
  long           ru_majflt;  ハードページフォールト
  long           ru_minflt;  ソフトページフォールト
  long           ru_inblock; ファイルシステムによるブロック読み取り
  long           ru_oublock; ファイルシステムによるブロック書き込み
  long           ru_nvcsw;   自発的コンテキストスイッチ
  long           ru_nivcsw;  強制コンテキストスイッチ
  ...
}
```

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `getrlimit(2)` / `setrlimit(2)`
- `getrlimit(2)` - リソースリミットを取得する
- `setrlimit(2)` - リソースリミットを変更する

#### 引数
- `resource`、`*rlim`を指定する
  - `resource` - 参照・設定するリソース種類を示すフラグ
  - `*rlim` - `rlimit`構造体へのポインタ

```c
struct rlimit {
  rlim_t rlim_cur; // ソフトリミット(実際に使用されるプロセスの上限)
  rlim_t rlim_max; // ハードリミット(rlim_curの上限)
};
```

