# API
- 参照: 例解UNIX/Linuxプログラミング教室P185-224
- 参照: 詳解UNIXプログラミング第3版 7. プロセスの環境 / 8. プロセスの制御 / 9. プロセスの関係
- 参照: Linuxプログラミングインターフェース 6章

## プロセスIDの取得
### `getpid(2)`
- プロセスIDの取得

#### 返り値
- プロセスID(`pid_t`)を返す

### `getppid(2)`
- プロセスの親プロセスIDの取得

#### 返り値
- プロセスID(`pid_t`)を返す

## 環境リスト
### `export(1)`
- 環境の追加

```
$ export XXX=yyy

# 一回のコマンド実行commandに対してのみ環境変数を変更する場合
$ XXX=yyy command
```

### `printenv(1)`
- 現在の環境リストを出力

### `getenv(3)`
- プロセスから個別の環境を参照する

#### 引数
- `*name`を指定する
  - `*name` - 環境変数

#### 返り値
- 環境の値の文字列へのポインタ
  - 存在しない場合はNULL

### `putenv(3)`
- プロセス自身の環境リストへ新しい環境を追加する

#### 引数
- `*string`を指定する
  - `*string` - `NAME=value`形式の環境

#### 返り値
- 数値0
  - エラー時は数値0以外

### `setenv(3)`
- プロセス自身の環境リストへ新しい環境を追加する

#### 引数
- `*name`、`*value`、`overwrite`を指定する
  - `*name` - 環境変数(`=`を加えない)
  - `*value` - 環境の値
  - `overwrite` - 0が設定されている場合、上書きしない

#### 返り値
- 数値0
  - エラー時は数値-1

### `unsetenv(3)`
- プロセス自身の環境リストから環境を削除する

#### 引数
- `*name`を指定する
  - `*name` - 環境変数(`=`を加えない)

#### 返り値
- 数値0
  - エラー時は数値-1

### `clearenv(3)`
- プロセスの環境リストをリセットする
  - `clearenv(3)`を実行してもメモリ領域は解放されない

## 非局所脱出
### `setjmp(3)`
- 呼び出し位置を`longjamp(3)`のジャンプ先として登録

#### 引数
- `env`を指定する
  - `env` - 環境を保存する`jmp_env`型のバッファ
    (プログラムカウンタレジスタとスタックポインタレジスタ)
    - プログラムカウンタレジスタ - 現在実行中の機械語命令
    - スタックポインタレジスタ - スタックトップ
    - `env`に格納した値は`longjmp(3)`した時点で破棄される

#### 返り値
- 数値0
  - エラー時は数値0以外

### `longjmp(3)`
- `setjmp(3)`の呼び出し位置へジャンプする
  - `setjmp(3)`で`env`に退避したレジスタのデータをレジスタに回復する
  - ジャンプした後は`setjmp(3)`から返ってきたように処理が継続する

#### 引数
- `env`、`val`を指定する
  - `env` - 環境を保存する`jmp_env`型のバッファ
    (プログラムカウンタレジスタとスタックポインタレジスタ)

## プログラムブレーク
### `brk(2)`
- 指定のアドレス位置へプログラムブレークを移動させる

#### 引数
- `*end_data_segment`を指定する↲
  - `*end_data_segment` - 新しいプログラムブレーク
    - 仮想メモリはページ単位に割り当てられるため、ページ境界へ丸め上げられる

#### 返り値
- 数値0
  - エラー時は数値-1

### `sbrk(2)`
- プログラムブレークに`increment`分の数値を加算してアドレス移動させる

#### 引数
- `increment`を指定する
  - `increment` - プログラムブレークに加算する数値
    - 新たに割り当てたメモリ領域の先頭アドレス

#### 返り値
- 数値0
  - エラー時は数値-1

## ヒープ上のメモリの割り当て
### `malloc(2)`
- 指定したバイト数のメモリを割り当てる
- 割り当てられた領域の初期値は不定

#### `brk`と比較した際の利点
- マルチスレッドアプリケーションから利用可能
- 小さいサイズの領域も割り当て可能
- 内部でフリーリストを管理し、以降の割り当てに再利用するため、メモリを自由に解放できる

#### `malloc(3)`ファミリ
- `mallopt(3)` - `malloc(3)`のパラメータを操作
- `mallinfo(3)` - `malloc(3)`が割り当てたメモリの統計情報をまとめた構造体を返す

#### 引数
- `size`を指定する
  - `size` - 割り当てを行う領域のサイズ

#### 返り値
- 割り当てた領域の先頭アドレスへのポインタを返す
  - エラー時はNULLを返す(プログラムブレークが上限に達した場合など)

### `free(3)`
- 指定されたメモリを解放する

#### 引数
- `ptr`を指定する
  - `ptr` - 事前に`malloc(3)`などで返されたポインタ

### `calloc(2)`
- 指定した数の要素を格納できるバイト数のメモリを割り当てる
- 割り当てられた領域の初期値は0

#### 引数
- `numitems` / `size`を指定する
  - `numitems` - 配列の要素数
  - `size` - 割り当てを行う領域のサイズ

#### 返り値
- 割り当てた領域の先頭アドレスへのポインタを返す
  - エラー時はNULLを返す(プログラムブレークが上限に達した場合など)

### `realloc(2)`
- `malloc(3)`が割り当てた領域のサイズを変更する

#### 引数
- `ptr` / `size`を指定する
  - `ptr` - サイズを変更する領域のポインタ
  - `size` - 割り当てを行う領域のサイズ

#### 返り値
- 割り当てた新しい領域の先頭アドレスへのポインタを返す
  - エラー時はNULLを返す(プログラムブレークが上限に達した場合など)

## スタック上のメモリ割り当て
### `alloca(2)`
- スタックフレーム上に指定したバイト数のメモリを割り当てる

#### 引数
- `size`を指定する
  - `size` - 割り当てを行うスタック上のメモリサイズ

#### 返り値
- 割り当てた領域の先頭アドレスへのポインタを返す

## プロセスの作成
### `fork(2)`
- プロセスの複製を作成する

#### 返り値
- 親プロセス - 子プロセスのプロセスIDを返す
  - エラー時は数値-1を返す
- 子プロセス - 数値0を返す

## プロセスの正常終了
### `_exit(2)`
- 指定の`wait`ステータスでプロセスを終了させる

#### 引数
- `status`を指定する
  - `status` - プロセスの`wait`ステータス
    - 親プロセスに送信する

### `exit(2)`
1. `exit`ハンドラを登録順と逆順に実行する
2. `stdio`ストリームのバッファをフラッシュする
3. `_exit(2)`を実行する - 指定の`wait`ステータスでプロセスを終了させる

#### 引数
- `status`を指定する
  - `status` - プロセスの`wait`ステータス
    - 親プロセスに送信する

### `atexit(3)`
- 指定の`exit`ハンドラを登録する
- プロセスの終了コードを参照する方法はない
- ハンドラに引数を渡せない

#### 引数
- `*func`を指定する
  - `*func` - 指定の`exit`ハンドラ

```c
void func(void)
{
  // 処理
}
```

#### 返り値
- 数値0
  - エラー時は数値0以外を返す

### `on_exit(3)`
- 指定の`exit`ハンドラを登録する
- ハンドラがプロセスの終了コードと任意の値を引数にとる

#### 引数
- `*func`、`*arg`を指定する
  - `*func` - 指定の`exit`ハンドラ
  - `*arg` - `*func`に渡す引数

```c
void func(int status, void *arg)
{
  // 処理
}
```

#### 返り値
- 数値0
  - エラー時は数値0以外を返す

## プロセスの監視
### `wait(2)`
- 指定の子プロセスが終了するまで処理をブロックする
  - すでに終了済みの場合は`ECHLD`を送信して即時返す
- 子プロセスが終了したら`wait`ステータスを取得する

#### 引数
- `*status`を指定する
  - `*status` - `wait`ステータスを保存するメモリへのポインタ

#### 返り値
- 子プロセスのプロセスIDを返す
  - エラー時は数値-1を返す

### `waitpid(2)`
- 指定の子プロセスが終了するまで処理をブロックする
  - `WNOHANG`フラグをセットすると処理をブロックせず
    子プロセスの終了を定期的に確認する
- 子プロセスが終了したら`wait`ステータスを取得する
- オプションで処理のブロックを行うことができる
- オプションでジョブ制御を扱うことができる
- `waitid(2)`は`siginfo_t`構造体を使用して子プロセスの状態をより詳細に取得できる
- `wait3(2)` / `wait(4)`は`rusage`構造体を使用してリソース消費情報を取得できる
  - `wait(3)`は`waitpid(-1, &status, options)`と同じ
  - `wait(4)`は`waitpid(pid, &status, options)`と同じ

#### 引数
- `pid`、`*status`、`options`を指定する
  - `pid` - 指定の子プロセスのプロセスID
    - `pid > 0` - 指定したPIDを持つ子プロセス
    - `pid == 0` - 親プロセスと同じプロセスグループに属する子プロセス
    - `pid == -1` - 任意の子プロセス(`wait`と同じ)
    - `pid < -1` - プロセスグループIDが指定したPIDの絶対値に等しい子プロセス
  - `*status` - `wait`ステータスを保存するメモリへのポインタ
  - `options` - `waitpid(2)`の動作を制御するフラグ

#### 返り値
- 子プロセスのプロセスIDを返す
  - エラー時は数値-1を返す

### `wait`ステータス用標準マクロセット
- `WIFEXITED(status)` - 子プロセスが正常終了した場合、真を返す
- `WIFSIGNALE(status)` - 子プロセスが補足しないシグナルによって異常終了した場合、真を返す
- `WIFSTOPPED(status)` - 子プロセスがシグナルにより実行を一時停止している場合、真を返す
- `WIFCONTINUED(status)` - 子プロセスが`SIGCONT`により実行を再開した場合、真を返す

## プログラムの実行
### `execve(2)`
- 自プロセスに指定のプログラムをロードして実行

#### `exec`関数群
- いずれも`内部でexecve(2)`を実行する

| 関数名     | プログラム名(-, p)  | パラメータ(v, l) | 元にする環境(e, -)    |
| -          | -                   | -                | -                     |
| `execve(2)`| パス名              | 配列             | 引数`envp`            |
| `execle(2)`| パス名              | 文字列リスト     | 引数`envp`            |
| `execlp(2)`| ファイル名 + `PATH` | 文字列リスト     | 自プロセスの`environ` |
| `execvp(2)`| ファイル名 + `PATH` | 配列             | 自プロセスの`environ` |
| `execv(2)` | パス名              | 配列             | 自プロセスの`environ` |
| `execl(2)` | パス名              | 文字列リスト     | 自プロセスの`environ` |

- `fexecve(3)` - ファイルディスクリプタ指定によるプログラム実行

#### 引数
- `*pathname`、`argv[]`、`envp[]`を指定する
  - `*pathname` - 指定のプログラムのパス名を示す文字列へのポインタ
  - `argv[]` - 新規プログラムへのコマンドラインパラメータを示す配列へのポインタ
  - `envp[]` - 新規プログラムの環境リストを示す配列へのポインタ

#### 返り値
- リターンしない
  - エラー時は数値-1を返す
