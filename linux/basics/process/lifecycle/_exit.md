# プロセスの終了
- 参照: 例解UNIX/Linuxプログラミング教室P185-224
- 参照: 詳解UNIXプログラミング第3版 7. プロセスの環境 / 8. プロセスの制御 / 9. プロセスの関係
- 参照: Linuxプログラミングインターフェース 2章 / 6章 / 25章

## TL;DR
- プロセスは正常終了 / 異常終了する
- プロセスが終了すると、カーネルはその親に`SIGCHLD`を送り、プロセスの終了コードを保持する
  -> 親プロセスが`SIGCHLD`を捕捉し子プロセスの終了コードを読み出す
  -> カーネルが子プロセスを消滅させる
  - 親プロセスは`fork`後、子プロセスを`wait`することで子プロセスの終了を待ち合わせる
  - 親プロセスが子プロセスの終了コードを読み出すまで、子プロセスは消去されない(ゾンビプロセス)
- プロセスが終了する時、そのプロセスが使っていたリソースは
  自動的に解放されカーネルによって回収される

## 正常終了
- `_exit(2)`を呼ぶ処理
  - 関数`main`から戻る(関数`main`は戻り時に`exit`を呼ぶため)
  - `exit(3)`を呼ぶ(内部で`_exit(2)`を呼ぶ)
  - 直接`_exit(2)` / `_Exit(2)`を呼ぶ
  - スレッドの開始ルーティンの最後のスレッドから戻る
  - 最後のスレッドから`pthread_exit(3)`を呼ぶ

### `exit`関数群
- `_exit(2)` / `_Exit(2)` - プロセスを終了し、直ちにカーネルに戻る
- `exit(3)` - 前処理を行ってからプロセスを終了し、後処理を行った後カーネルに戻る
- `exit`関数群はステータスを引数に取る
  - 0 - 正常終了
  - 1 - 異常終了
  - 引数なし - 未定義の挙動

## 異常終了
- プロセスを終了させるシグナルを呼ぶ処理
  - 当該シグナルを受信(`abort(3)`など)
  - キャンセル要請に対する最後のスレッドの応答

## プロセス終了時の共通動作
- ファイルディスクリプタをクローズ
  -> プロセスが獲得したファイルロックの解放
- ディレクトリストリーム、メッセージカタログディスクリプタ、コンバージョンディスクリプタをクローズ
- SystemV共有メモリセグメントをデタッチ
  -> 各セグメントに対応する`shm_nattach`カウントをデクリメント
- (制御端末を持つ制御プロセスの場合)端末とセッションを切断
- POSIX名前付きセマフォをクローズ
- POSIXメッセージキューをクローズ
- メモリロックの削除
- メモリマッピングのアンマッピング
- (一時停止中のプロセスが含まれる孤児プロセスグループが発生する場合)孤児プロセスグループへシグナルを送信

## プロセス終了時の`exit`ハンドラによる終了動作
- プログラムの任意の時点で登録し、`exit(3)`実行時に自動的に実行される関数
- `atexit(3)` / `on_exit(3)`によってハンドラの登録を行うことができる
- `exit(3)`時には`atexit(3)` / `on_exit(3)`を呼び出した順とは逆順に実行される
  - ハンドラの中でプロセスが終了すると残りのハンドラ・`exit(3)`の後処理は実行されない

## 親子プロセスによる`stdio`バッファの共有
- 親子プロセス間でメモリ空間が共有される = `stdio`バッファは子プロセスに複製される
- バッファリングの種類(ブロックバッファリング)によりバッファを出力しきれなかった場合、
  親プロセスの`stdio`バッファ内に溜まったデータが子プロセスに複製され、
  `exit(3)`時に子プロセスのバッファとして別途フラッシュされる場合がある

### 回避策
- `fork(2)`前に`fflush(3)`を呼び親になるプロセスのバッファをフラッシュする
- `exit(2)`ではなく`_exit(2)`で終了させる

## `abort(3)`
- 呼び出し側にシグナル`SIGABRT`を送る
  - `raise(SIGABRT)`として内部実装される
  - `SIGABRT`を捕捉しシグナルハンドラから戻っても呼び出し側には戻らない
  - `SIGABRT`を捕捉した後実行されるシグナルハンドラにおいては、
    プロセスの終了に必要な後処理を行う
    - シグナルハンドラ内でプロセス自身を終了させなかった場合は
      `abort(3)`自身がプロセスを終了させる

## `system(2)`
- 引数のコマンドをコマンドインタプリタ`sh`に渡す
  -  呼び出し側のプロセスはシェルがコマンドの実行を終了するのを待つ
  - `SIGINT` / `SIGQUIT` を無視し、`SIGCHLD`をブロックする
