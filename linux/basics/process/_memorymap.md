# メモリレイアウト
- 参照: 詳解UNIXプログラミング第3版 7. プロセスの環境
- 参照: [試して理解]Linuxのしくみ 第5章 メモリ管理
- 参照: Linuxプログラミングインターフェース 2章 / 6章 / 7章

## TL;DR
- プロセスに割り当てられたユーザーメモリ空間は複数のセグメントに分割される
  - テキストセグメント
  - 初期化済みデータセグメント
  - 未初期化データセグメント(bss)
  - スタック
  - ヒープ

## 典型的なメモリレイアウト
```
カーネル
(仮想メモリ空間へマッピングされるがプログラムからは使用不可)
    |
コマンド行引数・環境変数
    |
スタック
(下方向へ伸びる)
    |
未割り当て領域
    |
ヒープ
(上方向へ伸びる)
    |
未初期化データ(bss) - execが自動的に初期化
    |
初期化済みデータ - execがプログラムから読み取る
    |
テキスト
```

## テキストセグメント
- プロセス(CPUが)実行する機械語命令群
- 書き込み不可・読み取り専用
- 同じプログラムを複数のプロセスが共有するため、他のプロセスと共有可能
  - 一つのプログラムコードを全プロセスが仮想アドレス空間へマッピングする

## 初期化済みデータセグメント
- `user-initialized data segment`
- 明示的に初期化されたグローバル変数・スタティック変数を置く
  - 関数外で定義されている変数のうち、ユーザーが初期化値を設定するもの
```c
int i = 99;
```
- プログラムをメモリへロードした際、このセグメントから変数の値を読み取る

## 未初期化データセグメント(bss)
- `zero-initialized data segment`
- 明示的に初期化されていないグローバル変数・スタティック変数を置く
  - プログラムの実行が始まる前に
    カーネルが数値0やNULLポインタに初期化するもの
    - 関数外で定義されている変数のうち、カーネルが初期化値を設定するもの
```c
long sum[1000];
```
- プログラムをメモリへロードした際、このセグメントは0で初期化される

## スタック
- スタックフレームを置く
  - 関数を呼び出すごとにスタックフレームが一つ割り当てられる(`push`)
  - 関数が終了するとスタックフレームとスタックフレームが持つ情報が削除される(`pop`)
- スタック領域はメモリアドレスの高位に位置し、低位に向かってリニアに成長・縮小する
  - スタック領域の下端をトップと呼ぶ
  - 専用のレジスタであるスタックポインタが常にスタックトップを指す
- カーネルが内部関数の実行のために使用するカーネルスタックとは別物

### スタックフレーム
- スタックフレームにはローカル変数、引数、返り値が置かれる
- スタックフレームは関数内で別の関数を呼び出した際に、
  その戻り時に必要となるCPUレジスタを退避させるためにも使われる(コールリンケージ情報)

## ヒープ
- 実行時に動的にメモリを割り付ける場所
  - ヒープ領域の上端をプログラムブレークと呼ぶ

### ヒープ領域へのメモリの割り当て・解放
- ヒープ領域へのメモリの割り当て・解放はプログラムブレークの移動によって行われる
  - `brk(2)` / `sbrk(2)`
    - ヒープ領域が増えた(= プログラムブレークの値が増加・アドレス位置が上位に移動した)場合
      プログラムがその領域に初めてアクセスする際に物理メモリが割り当てられる

### ヒープ上のメモリの割り当て・解放
- ヒープ上のメモリの割り当て・解放は`malloc()`関数群の実行によって行われる
  - `malloc(3)` / `calloc(3)` / `realloc(3)`
    - 内部で管理するフリーメモリリストの空き領域をスキャンし、
      要求されたサイズ以上の領域があればそのポインタを返す
      なければメモリ領域を分割し、残った方をフリーリストへ繋ぐ
    - ヒープ上に要求されたサイズ以上の領域が残っていない場合は
      `sbrk(2)`を呼んでプログラムブレークを移動させる
  - `free(3)`
    - `free(3)`実行後もプログラムブレークは移動せず、
      指定されたポインタを内部で管理するフリーメモリリストへ追加する
      フリーメモリリストは以降の`malloc(3)`で再利用される

### 動的メモリ割り付け
- `malloc(3)`
  - 指定したバイト数のメモリを割り付ける
  - 割り付けられた領域の初期値は不定
- `calloc(3)`
  - 指定したサイズのオブジェクト用に指定した個数分の領域を割り付ける
  - 割り付けられた領域は数値0で初期化される
- `realloc(3)`
  - すでに割り付けた領域のサイズを増減する
  - 増やす場合、追加分の場所を確保するためすでに割り付けた領域を解放し、別の場所で領域を確保し直す場合がある
  - 増やす場合、増やした領域の初期値は不定
- `free(3)`
  - 動的にメモリが割り付けられた領域を解放する
  - 解放した領域は利用可能なメモリプールに保管される(カーネルに返さない)

#### 動的メモリ割付の動作
- `malloc(3)`はメモリ獲得のため内部的に`mmap(2)`を呼び出す
- `mmap(2)`は時プロセスの仮想アドレス空間内に新規メモリマッピングを作成する
  - ファイルマッピング - ファイル内の指定した範囲を自プロセスの仮想メモリへマッピング
  - 無名マッピング - 対応するファイルを持たずマッピングしたページ内容は0で初期化される
- `mmap(2)`はページ単位でメモリを獲得する
- `malloc(3)`はバイト単位でメモリを獲得する
- `glibc`は`malloc(3)`呼び出し時に`mmap(2)`によって大きなメモリ領域を獲得してプールしておく
  - `malloc(3)`発行のたびにプールから必要な単位のメモリを切り出してプログラムに返す
  - プールに空きがない場合は再び`mmap(2)`で新たなメモリ領域を獲得する

####  デマンドページング
- 動的メモリ割付の動作によって使用されない無駄な物理メモリが発生する可能性がある
- デマンドページングは、実際に仮想メモリに対してアクセスが発生するまで
  ページテーブル上に仮想メモリ内のアドレス情報のみを保管する仕組み
  - プログラムが仮想メモリに対してアクセスするとCPU内でページフォールトが発生し、
    動的に物理メモリを確保し、仮想メモリアドレスと紐づける

#### 代替えメモリ割り付け関数
- `alloca(3)`
  - ヒープからではなく、今の関数のスタックフレームからメモリを割り付ける
  - `alloca(3)`の呼び出しによってスタックフレームのサイズが増える
  - 関数を抜けると領域は自動的に解放される
