# 子プロセスの監視
- 参照: 例解UNIX/Linuxプログラミング教室P185-224
- 参照: 詳解UNIXプログラミング第3版 7. プロセスの環境 / 8. プロセスの制御 / 9. プロセスの関係
- 参照: Linuxプログラミングインターフェース 2章 / 6章 / 26章

## 親子の終了関係
- 子プロセスが実行中に親プロセスが終了した場合
  -> 子プロセスが孤児化する -> プロセス`init`が子プロセスの親になる
- 親プロセスが実行中に子プロセスが終了した場合
  -> 親プロセスが`wait`していた場合: 親プロセスが子プロセスの終了を検知する
  -> 親プロセスが`wait`していなかった場合: 子プロセスがゾンビになる

## `wait`関数群
- `wait(2)` / `waitpid(2)`によって子プロセスの終了を監視する
  - 指定の子プロセスが終了するまで処理をブロックし、
    子プロセスが終了したら`wait`ステータスを取得する
  - カーネルは子プロセスが消費したCPU時間を自プロセスが持つ全子プロセスの合計値に加える

## `wait`ステータス
- `wait`関数群で得られる`wait`ステータスは子プロセスの状態変化を表す
  - 終了ステータス
    - 子プロセスが`exit(2)` / `_exit(2)`により終了したかどうか
    - 子プロセスが捕捉しないシグナルによって終了したかどうか
  - シグナルの捕捉状況
    - 子プロセスがシグナルにより実行を一時停止し、
      かつ`waitpid(2)`に`WUNTRACED`がセットされているかどうか
    - 子プロセスが`SIGCONT`により実行を再開し、
      かつ`waitpid(2)`に`WCONTINUED`がセットされているかどうか
- `wait`ステータス用標準マクロセットを使用してステータスをパースする
  - `WIFEXITED(status)`
  - `WIFSIGNALE(status)`
  - `WIFSTOPPED(status)`
  - `WIFCONTINUED(status)`

## 子プロセスの監視方法
- 親プロセスは`WNOHANG`フラグをセットせず`wait(2)` / `waitpid(2)`を実行する
  親プロセスは子プロセスが終了するまで処理をブロックする
- 親プロセスは`WNOHANG`フラグをセットして`waitpid(2)`を実行する
  親プロセスは処理をブロックせず、子プロセスの終了を定期的に確認する
- 親プロセスは子プロセス終了時に受信する`SIGCHLD`シグナルに対してハンドラを設定しておく
  ハンドラの中で終了した子プロセスに対して`wait()`をループ実行する
  (デフォルト動作は無視)

## シグナルハンドラからのプロセス終了
- 子プロセスがシグナルによって終了する場合、シグナルハンドラ内で`_exit(2)`が実行されると
  親プロセスからは子プロセスが正常終了したように見える
- 子プロセスがシグナルによって終了したことを親プロセスが感知するためには
  - 1.子プロセスのシグナルハンドラは自身の設定を取り消す
  - 2.子プロセスは同じシグナルを生成し、シグナルのデフォルト動作によって終了させる

## ゾンビプロセス
- カーネルはプロセスがゾンビになった場合、
  ゾンビになったプロセスが消費したリソースの大部分を解放する
  ゾンビプロセスにはカーネル内のプロセステーブルで管理される
  プロセスID、終了ステータス、リソースの消費情報のみが残る

### ゾンビプロセスの終了
- ゾンビプロセスはその親プロセスが`wait`を実行すると終了する
- 親プロセスがゾンビプロセスを`wait`せずに終了した場合、
  `init`プロセスが代わりにゾンビプロセスの親になり、 自動的に`wait`を実行する
