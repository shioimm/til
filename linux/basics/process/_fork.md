# プロセスの作成
- 参照: 例解UNIX/Linuxプログラミング教室P185-224
- 参照: 詳解UNIXプログラミング第3版 7. プロセスの環境 / 8. プロセスの制御 / 9. プロセスの関係
- 参照: Linuxプログラミングインターフェース 2章 / 6章 / 24章

## TL;DR
- プロセスは`fork(2)`を使用して自分を複製したプロセスを一つ作成する
- UNIXで新しくプロセスを生成する唯一の手段は既存のプロセスをforkすること
- 親子プロセスは非同期で動作する
  それぞれの動作のタイミングはカーネルが行うプロセススケジューリングによって決まる
  - 同期させる場合はプロセス間通信が必要

## プロセス作成操作
- `fork(2)`
- `clone(2)` - `fork(2)`が内部的に使用する
- `vfork(3)`
- `spawn(2)`

## `fork(2)`の動作
1. 親プロセスが持つ情報を複製して子プロセスを生成する
2. 複製が終わると親プロセスと子プロセス両方にそれぞれ制御が移る
3. 各プロセスは「`fork`から戻る」ところから後続の処理を行う
   各プロセスは同じテキストセグメントを実行するが、
   スタック、データ、ヒープセグメントは個別に持つ

### `spawn(2)`の動作
- `fork(2)` + `exec()`
- ワンショットでのプロセス作成 -> 実行のために使用する

### `vfork(3)`(非推奨)の動作
- 親プロセスのアドレス空間を子にコピーしない
- 子プロセスは`vfork(3)`の直後に`exec` / `exit`を呼ぶ
  - 子プロセスは`exec` / `exit`を呼ぶまで親プロセスのアドレス空間で動作する(メモリを共有する)
  - 子プロセスが`exec` / `exit`を呼ぶまで親プロセスの実行は停止される

## 子プロセスに複製される情報
- 実行状態
- メモリマップ
- ユーザーID / グループID / セッションID
- 環境
- 作業ディレクトリ
- umask値
- シグナルマスク・シグナルハンドラの設定
- ファイルディスクリプタ
- ディレクトリストリーム
- 制御端末

## 子プロセスに複製されない情報
- PID / PPID
- `fork`からの返り値
- 親の`tms_utime` / `tms_stime` / `tms_cutime` / `tms_ctime`
- 親が設定したファイルロック
- 親の保留中アラーム
- 親の保留中シグナルセット

## `fork(2)`のメモリ処理
- 親プロセスの仮想メモリページを単純に子プロセスにコピーするのは無駄が大きい
  - Ex. 子プロセスは`fork(2)`直後に`exec()`する(コピーしたメモリを使用しない)ケースがある
- カーネルはメモリコピー処理の最適化によって無駄なコピー処理を避ける

### メモリコピー処理の最適化
- カーネルは全プロセスのテキストセグメントを読み取り可能とする
  - 親子プロセス間でテキストセグメントを共有する
- カーネルは親プロセスのスタック、データ、ヒープセグメントにコピーオンライトを適用する
  - 親子プロセスのいずれかがスタック、データ、ヒープセグメントを変更するまで
    子プロセスは親プロセスのメモリページを読み取り専用で参照する
  - ページが変更されたらこの時点で変更されたページをコピーする

#### プロセスのメモリ消費最大値の制御
- 子プロセスの実行を`fork(2)` - `wait(2)`で囲むことによって
  子プロセスが使用するメモリ消費量をその範囲内に収めることができる(COWのため)

## 親子プロセス間のファイル共有
- 親プロセスは子プロセスに対して
  同じオープンファイルへの参照を持つファイルディスクリプタ
  およびオープンファイルフラグを複製する
  = ファイルに対する操作が親子で競合する可能性がある
  - ファイルオフセットの共有により競合を避ける
  - 親が子の完了を`wait`することによって親子の操作を同期させる
  - 各自が不要なストリームを切り離す
    (各自が不要なファイルディスクリプタを閉じ、操作が干渉しないようにする)

## `fork(2)`後の競合状態
- `fork(2)`後に親子プロセスのスケジューリング順序は非決定性動作
  - マルチプロセッサシステム上では同時に実行される可能性もある
- `/proc/sys/kernel/sched_child_runs_first`に代入する数字によって
  どちらを優先したいか示すことはできるが、動作の保証はない
