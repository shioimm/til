# デーモンプロセス
- 長時間動き続けるプロセス
- 制御端末がなく、バックグラウンドで動作する
- 標準デーモンの多くはシステムシャットダウンによって終了する
  - そうでないものは`init`プロセスがシステムシャットダウン時に
    全ての子プロセスへ送信する`SIGTERM`を受信する

## 標準デーモン
- `init` - システムデーモン
- `kthreadd` - 他のカーネルプロセスを生成する
- `kswapd` - ページアウトデーモン
  - 変更されたページをディスクへ書き出すことで仮想記憶サブシステムを支援する
- `flush` - フラッシュデーモン
  - 利用可能なメモリが設定の下限値に達した場合や一定間隔でページをディスクに書き出す
- `sync_supers` - ファイルシステムのメタデータを定期的にディスクに書き出す
- `jbd` - ジャーナルの実装を補佐する
- `rpcbind` - PRCプログラム番号をネットワークのポート番号にマップする
- `rsyslogd` - 管理者向けのシステムメッセージをコンソール / ファイルに出力
- `inetd` - ネットワークインターフェースを介して接続要求を受け付ける
- `nfsd` / `nfsiod` / `lockd` / `rpciod` - ネットワークファイスシステムをサポートするカーネルデーモン
- `rpc.idmapd` / `rpc.statd` / `rpc.mountd` / `rpciod` - ネットワークファイスシステムをサポートするユーザーレベルデーモン
- `cron` - コマンドの定期実行
- `atd` - コマンドのスケジュール実行
- `cupsd` - プリントスプーラ
- `sshd` - 遠隔ログイン

## プロセスのデーモン化
1. `fork(2)`を実行し、親プロセスは終了する
    - デーモンは`init`の子プロセスとなる
2. プロセスは`setsid(2)`により新規セッションを開始する
    - プロセスは新しいセッションのリーダーとなる
    - プロセスは新しいプロセスグループのリーダーとなる
    - プロセスは自身と制御端末を切断する(以降デーモンは端末デバイスをオープンしない)
3. プロセスの`umask`をクリアし、デーモンがファイルやディレクトリを作成しても
   指定した通りのパーミッションになるようにする
4. プロセスのカレントワーキングディレクトリをルートディレクトリ`/`へ移動する
5. 親プロセスから受け継いだファイルディスクリプタを全てクローズする
6. 標準入出力をクローズ後、`/dev/null`をオープンする
   `dup2(2)`を使用して標準入出力を`/dev/null`に対応させる

## プロセスのデーモン化のガイドライン
- デーモンプロセスの実行はプログラムにつき一インスタンスに制限する
- メモリリークやファイルディスクリプタリークを避ける
- システム終了時にクリーンアップ作業を要するデーモンプロセスは
  `init`から送信される`SIGTERM`へのハンドラを設定する
  - ハンドラの実行は5秒以内に終了させる

## エラーログ
- デーモン化を行うと標準入出力が無効化されるため別途エラーログの収集が必要
- システム全体のログを扱う`syslog`へ情報を書き出すようにする
- 各ユーザープロセスは`syslog(3)`を呼び出してログメッセージを生成し、/`dev/log`に送信する
- カーネルルーティン群は`log(1)`を呼び出してログメッセージを生成し、`/dev/klog`に送信する
- ホスト上のユーザープロセス / ホストに接続している他ホストはUDPポート514へログメッセージを送信する

### `syslog`
- ログ出力を一箇所で一元管理する
- システム上の全アプリケーションから利用できる

#### `syslog`デーモン(`syslogd`)
- UNIXドメインソケット(`/dev/log`)からローカルホスト内で生成されたログメッセージを受け取る
- インターネットドメインソケット(UDPポート番号514)からネットワーク経由でログメッセージを受け取る
- システム起動時に設定ファイル`/etc/syslog.conf`を読み取った設定に基づき、
  受け取ったメッセージの`facility` / `level`属性に応じて出力動作を決定する
  - `facility`属性 - メッセージを出力したプログラム種類
  - `level`属性 - メッセージの重要度

### `/etc/syslog.conf`
- `syslogd`デーモンの動作を決定する設定ファイル
- 空白文字で区切った`facility.level`(selector)、`action`を記述する

## 慣習
- デーモンがロックファイルを使う場合、通常そのファイルは`/var/run`下に置かれる
  - Ex. `/var/run/crond.pid`
- デーモンが構成設定ファイルを使う場合、通常そのファイルは`/etc`下に置かれる
  - Ex. `/etc/syslog.conf`
- デーモンはシステム初期化スクリプトの一つから始動される
  - Ex. `etc/init.d/*`
- デーモンが構成設定ファイルを使う場合、始動時にそのファイルを読み取るが、以降は見ない

## クライアント - サーバーモデル
- デーモンプロセスはサーバープロセスとしても利用される
- サーバーでは`fork`してクライアントにサービスを提供する別プログラムを`exec`する

## 参照
- 詳解UNIXプログラミング第3版 13. デーモン
- Linuxネットワークプログラミング Chapter10 TCPサーバプログラミング 10-5
- Linuxプログラミングインターフェース 37章
