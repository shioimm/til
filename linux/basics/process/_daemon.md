# デーモンプロセス
- 参照: 詳解UNIXプログラミング第3版 13. デーモン
- 参照: Linuxネットワークプログラミング Chapter10 TCPサーバプログラミング 10-5

## TL;DR
- 長時間動き続けるプロセス
- システムがブートした時に動き出し、システムを停止する時にのみ停止する
- 制御端末がなく、バックグラウンドで動作する

## 代表的なデーモンプロセス
- `init` - システムデーモン
- `kthreadd` - 他のカーネルプロセスを生成する
- `kswapd` - ページアウトデーモン
  - 変更されたページをディスクへ書き出すことで仮想記憶サブシステムを支援する
- `flush` - フラッシュデーモン
  - 利用可能なメモリが設定の下限値に達した場合や一定間隔でページをディスクに書き出す
- `sync_supers` - ファイルシステムのメタデータを定期的にディスクに書き出す
- `jbd` - ジャーナルの実装を補佐する
- `rpcbind` - PRCプログラム番号をネットワークのポート番号にマップする
- `rsyslogd` - 管理者向けのシステムメッセージをコンソール / ファイルに出力
- `inetd` - ネットワークインターフェースを介して接続要求を受け付ける
- `nfsd` / `nfsiod` / `lockd` / `rpciod` - ネットワークファイスシステムをサポートするカーネルデーモン
- `rpc.idmapd` / `rpc.statd` / `rpc.mountd` / `rpciod` - ネットワークファイスシステムをサポートするユーザーレベルデーモン
- `cron` - コマンドの定期実行
- `atd` - コマンドのスケジュール実行
- `cupsd` - プリントスプーラ
- `sshd` - 遠隔ログイン

## 作り方
- `daemon(3)`を呼ぶ
  - `umask`を呼び、ファイルモード作成時マスクを既知の値に設定する
  - `fork`を呼び、親は`exit`する
  - `setsid`を読んで新しいセッションを開始する
    - プロセスは新しいセッションのリーダーとなる
    - プロセスは新しいプロセスグループのリーダーとなる
    - プロセスは制御端末から切り離される
  - カレントワーキングディレクトリをプロセスのルートディレクトリとする
  - 不必要なファイルディスクリプタを閉じる
    - 標準入出力は`/dev/null`につなぐ

## エラーログ
- デーモン化を行うと標準入出力が無効化されるため別途エラーログの収集が必要
- システム全体のログを扱う`syslog`へ情報を書き出すようにする
  - `syslog` - デーモン`syslogd`がデータを受け取り、ログファイルへ書き込む
    - 起動時に構成設定ファイルを読み取り、異なるクラスのメッセージをどこに送るべきか決定する
- 各ユーザープロセスは`syslog(3)`を呼び出してログメッセージを生成し、/`dev/log`に送信する
- カーネルルーティン群は`log(1)`を呼び出してログメッセージを生成し、`/dev/klog`に送信する
- ホスト上のユーザープロセス / ホストに接続している他ホストはUDPポート514へログメッセージを送信する

### `syslog`機能
- `openlog(3)` - 各ログメッセージに付加するプログラム名を指定
  - `syslog(3)`呼び出し時に呼ばれる
- `syslog(3)` - ログメッセージの生成
- `closelog(3)` - ログファイルを閉じる
- `setlogmask(3)` - プロセスのログ優先度マスクを設定
- `logger(1)` - `syslog`機能へログメッセージを送る

## 慣習
- デーモンがロックファイルを使う場合、通常そのファイルは`/var/run`下に置かれる
  - Ex. `/var/run/crond.pid`
- デーモンが構成設定ファイルを使う場合、通常そのファイルは`/etc`下に置かれる
  - Ex. `/etc/syslog.conf`
- デーモンはシステム初期化スクリプトの一つから始動される
  - Ex. `etc/init.d/*`
- デーモンが構成設定ファイルを使う場合、始動時にそのファイルを読み取るが、以降は見ない

## クライアント - サーバーモデル
- デーモンプロセスはサーバープロセスとしても利用される
- サーバーでは`fork`してクライアントにサービスを提供する別プログラムを`exec`する
