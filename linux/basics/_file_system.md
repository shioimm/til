# ファイルシステム
- 参照: 例解UNIX/Linuxプログラミング教室P225-269

## TL;DR
- カーネルが提供しているファイル操作の仕組み
  - データの格納・ファイルの名前付け・ファイルの属性の保持・ファイルの整理などの機能
- ハードディスクの中に作られたデータの集まり
  - ファイル、ディレクトリ、属性情報

## ファイル抽象
- Unixのファイルシステムにおいて多くの対象をファイルとしてみなす
  - ファイル
    - バイト列を格納するファイル
  - ディレクトリ
    - ファイルシステムの構造を作るファイル
  - 文字型特殊ファイル(端末など)
    - 1バイトごとに入出力する装置を表すファイル
  - ブロック型特殊ファイル(ディスクなど)
    - 512バイトごとに入出力する装置を表すファイル
  - シンボリックリンク
    - ファイルを別の名前で参照するためのファイル
  - 名前付きパイプ
    - プロセス間通信を行うためのファイル
  - ソケット
    - プロセス間通信を行うためのファイル

## アクセス制御
- ファイルに対する操作の許可はプロセスの属性とファイルの属性によって決まる
  - プロセスの属性はパスワードファイルに登録される

### プロセスの属性
- ユーザーID(`uid_t`型) - そのプロセスを実行したユーザーのユーザーID
- グループID(`gid_t`型) - そのプロセスを実行したユーザーのグループID

### ファイルの属性
- ユーザーID - そのファイルを作ったプロセスのユーザーID
- グループID - そのファイルを作ったプロセスのユーザーのグループID
- アクセス許可ビット - 誰にどのような操作を許可するかを決める9ビットのビットフラグ
  - 読み・書き・実行
  - 同ユーザーID・同グループID・どちらでもない

## ユーザーID / グループID
- プロセスは複数のユーザーID / グループIDを持ちうる

### ユーザーIDの種類
- 実ユーザーID
  - そのプロセスを実行したユーザーを表すユーザーID
- 実効ユーザーID(アクセス許可の可否の検査に使用される)
  - そのプロセスを実行したユーザーを表すユーザーID
- 保存セットユーザーID

### グループIDの種類
- 実グループID
  - そのプロセスを実行したユーザーのグループID↲
- 実効グループID(アクセス許可の可否の検査に使用される
  - そのプロセスを実行したユーザーのグループID↲
- 補助グループID群(アクセス許可の可否の検査に使用される
  - 一つのプロセスを実行したユーザーが複数のグループに所属できるようにするID群
- 保存セットグループID

### セットユーザーID / セットグループID
- 実行可能ファイルに与える特殊な属性
- ファイルの実効ユーザー / 実効グループ以外のユーザーが
  対象のファイルを操作できるようにする仕組み
  - セットユーザーIDが付与されたファイルが実行されるとき、
    プロセスの実効ユーザーIDがファイル所有者のユーザーIDに置き換えられる
  - セットグループIDが付与されたファイルが実行されるとき、
    プロセスの実効グループIDがファイル所有者のグループIDに置き換えられる

#### セットユーザーIDの実行
- セットユーザーIDされた実行可能ファイルをプロセスがexecで実行するとき、
  プロセスのユーザーIDは以下のように変更される
  - 実ユーザーID
    - プロセスの元の実ユーザーIDのまま
  - 実効ユーザーID
    - 実行可能ファイルの所有者のユーザーIDに置き換えられる
  - 保存セットユーザーID
    - 実行可能ファイルの所有者のユーザーIDに置き換えられる
- グループIDは影響を受けない

#### セットグループIDの実行
- セットグループIDされた実行可能ファイルをプロセスがexecで実行するとき、
  プロセスのグループIDは以下のように変更される
  - 実グループID
    - プロセスの元の実グループIDのまま
  - 実効グループID
    - 実行可能ファイルの所有者のグループIDに置き換えられる
  - 保存セットグループID
    - 実行可能ファイルの所有者のユーザーIDに置き換えられる
- 補助グループID群は影響を受けない

## 内部構造
- コンピュータは連続したブロックから構成されるディスク領域を持つ
- ディスク領域はパーティションに区切って使用される
- 各パーティションごとにファイルシステムが存在する
- ファイルシステムはデータ領域とiノード領域を持つ
  - データ領域    - ファイルの実データを格納する領域
  - iノード領域   - iノードの配列を格納する領域
    - iノード番号 - 配列の添字
    - iノード     - 各ファイルの属性情報を格納する構造体

### iノードが持つ情報
- ファイルの種別
- ファイル所有者
- ファイル所有グループ
- ファイルモード
- ファイルの大きさ
- 最後に使用された時刻
- 最後に変更された時刻
- 最後にiノードが変更された時刻
- リンク数
- データ領域内の実データブロックへのリンク

### マウント
- ディスク領域に存在するファイルシステム群は
  OS起動時に一つの木構造にまとめ上げられる(マウント)
- アプリケーションからはまとめ上げられたファイルシステム群が
  一つのファイルシステムのように見える

#### `mount(8)`
- ファイルシステムのルートディレクトリを
  別のファイルシステムのルートディレクトリと一体化させる
  - マウントポイント - 一体化されたディレクトリ

#### `unmount(8)`
- `mount(8)`と逆の操作を行う

### ディレクトリ
- ディレクトリはデータ領域にデータを持つ(ディレクトリ項目)
  - ディレクトリ項目 - ファイル名 / iノード番号の組み

#### リンク
- ディレクトリ内に存在するiノードへの対応づけ
  - ディレクトリ`A`がディレクトリ項目`A'`を持ち、
    ディレクトリ項目`A'`がiノード`A"`を指しているとき、
    ディレクトリ`A`はiノード`A"`にリンクしている
- 同じiノードを指す別名のファイル(リンク)を生成することが可能(`ln(1)`)
  - iノードは自身が持つリンクの数をデータとして持つ
  - カーネルはディレクトリ項目を削除する際、iノードのリンク数を減らしてゆく
    リンク数が0になったときiノードと実データを削除する
  - パーティションが異なるディレクトリからのリンクは作成できない
  - ディレクトリへのリンクは作成できない

#### シンボリックリンク
- リンク先のファイル名を指すファイル
  - リンク先のファイルとは別のファイルであり、異なるiノードを持つ
- リンクの作成における制約が排除されている
- 実体が存在していなくても作成することができる

## 操作
### 作業ディレクトリに関する操作
- `getcwd(3)` - 作業ディレクトリの取得
- `chdir(2)`  - 作業ディレクトリの設定
- `fchdir(2)` - 渡されたファイルディスクリプタを参照するディレクトリを作業ディレクトリとする

### ディレクトリの情報の取得
- ディレクトリストリームによってディレクトリの開閉・取得を行う
  - `DIR`型        - ディレクトリストリーム
  - `dirent`構造体 - ディレクトリ項目の情報を格納する構造体
- `opendir(3)`   - ディレクトリを開く
- `readdir(3)`   - ディレクトリ項目を読み込み、`dirent`構造体に値を設定する
- `closendir(3)` - ディレクトリを閉める

### ディレクトリ項目の編集
#### リンクの操作
- `link(2)`    - ハードリンクの生成
- `symlink(2)` - シンボリックリンクの生成
- `unlink(2)`  - ディレクトリ項目を削除する
  - iノードを指すリンクを削除する
  - リンク数が0になった時iノードとiノードが指す実データ領域を解放する

#### ディレクトリの操作
- `mkdir(2)` - ディレクトリを作成し、親ディレクトリに新しいディレクトリ項目として追加する
- `rmdir(2)` - 親ディレクトリからディレクトリ項目(ディレクトリそのもの)を削除する

### ファイルの属性の取得
- iノードに格納されているファイルの属性を取得し`stat`構造体に格納する
  - `stat`構造体 - `stat(2)` `lstat(2)` `fstat(2)`の結果を格納するための構造体
    - `dev_t st_dev`   - iノードが存在する装置のID
    - `ino_t st_ino`   - iノード番号
    - `mode_t st_mode` - ファイルの種類とファイルモード(アクセス許可ビット・SUID/SGIDビット・スティッキービット)
- `stat(2)`  - パスの指定 / シンボリックリンクに対してはシンボリックリンクが指すファイルの属性を返す
- `lstat(2)` - パスの指定 / シンボリックリンクに対してはシンボリックリンクの属性を返す
- `fstat(2)` - ファイルディスクリプタの指定

### ファイルの属性の変更
- `chmod(2)`  - パスの指定 / ファイルモードの変更
- `fchmod(2)` - ファイルディスクリプタの指定 / ファイルモードの変更
- `chown(2)`  - ファイルの所有者・所有グループを変更

### その他
- 特殊ファイルの作成
  - `mknod(2)` - 文字型/ブロック型特殊ファイルの作成
- ファイルシステムのマウント
  - `mount(2)` `unmount(2)`
- Unixドメインソケットの操作
  - `socket(2)` `bind(2)`
- ルートディレクトリの変更
  - `chroot(2)`
