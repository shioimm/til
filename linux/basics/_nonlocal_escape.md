# 非局所脱出
- 参照: 例解UNIX/Linuxプログラミング教室P433-448

## TL;DR
- 深い関数呼び出しの入れ子からプログラムの実行制御を一気にリターンさせる機能
  - goto文     - 関数の中でのみジャンプ可能
  - 非局所脱出 - 関数の範囲を超えてジャンプ可能(ただしリターンする方向だけ)
    - `setjmp(3)`  - ジャンプ先の登録
    - `longjmp(3)` - ジャンプ先への非局所脱出

### スタックフレーム
- 関数呼び出し一回分に必要なデータを格納するスタック領域
  - 局所変数、関数の引数、関数の返り値、戻り番地、レジスタを対比した値などを格納
- 関数が呼び出されるたびスタック上にプッシュされ、関数がリターンされるたびスタック上からポップされる

## ジャンプ先の登録
- `setjmp(3)` - `setjmp(3)`を呼び出した位置をジャンプ先として登録
  - `jump_buf env`を引数に渡し、プログラムカウンタとスタックポインタを含むレジスタの値を格納する
  - `jump_buf env`に格納したレジスタの値(スタックフレーム)は`longjmp(3)`した時点で破棄される
    - `jump_buf`はプラットフォームごとに必要なデータサイズで用意された配列型

## ジャンプ先への非局所脱出
- `longjmp(3)` - 登録されたジャンプ先へ非局所脱出
  - `setjmp(3)`で格納したレジスタのデータをレジスタに回復する
  - ジャンプした後は`setjmp(3)`から返ってきたように処理が継続する
  - 自動変数やレジスタの値は`setjmp(3)`した時の値に戻ることがある
    - `volatile`をつけると元に戻らないことを保証する
    - 確実に元に戻す方法はない
