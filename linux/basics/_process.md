# プロセス
- 参照: 例解UNIX/Linuxプログラミング教室P185-224

## TL;DR
- 実行中のプログラム
- 一つのプロセスは独立したメモリ空間(仮想記憶領域)を持つ
- 一つのプロセスは一意なプロセスIDを持つ

## プログラムとプロセス
- プログラムはファイルシステムの中に実行可能ファイルとして存在する
- 実行可能ファイルを実行するとプロセスが生成される
  - `main`の先頭が呼ばれた時点
- プロセスはプログラム終了時消える
  - `exit`が呼ばれた時点
- ファイルを複数回実行すると複数の独立したプロセスが生成される

## 環境変数
- プロセスに付随するデータ
- プロセス自身からはグローバルな外部変数`char **environ`で参照可能
- 環境変数はプロセスから新しく起動したプロセスに自動的に引き継がれる

### 環境変数の操作
- `getenv`   - 値の取得
- `setenv`   - 値の設定
- `unsetenv` - 変数の削除
  - `setenv` `unsetenv`は環境を新しいメモリ領域に作り直し領域内で環境変数を変更する
  - 外部変数`environ`を直接操作することはしない

## 操作
### 作成
- プロセスは自分の複製を作ることができる(`fork`)
  - 親プロセス - 元のプロセス
  - 子プロセス - 新しくできたプロセス
    - 子プロセスは親プロセスが持つ情報を全て引き継ぐ
- UNIXで新しくプロセスを生成する唯一の手段は既存のプロセスをforkすること
- プロセスがforkした後、それぞれのプロセスがいつ動作するかは
  カーネルが行うプロセススケジューリングによって決まる

#### `fork(2)`が実行する処理
1. 親プロセスが持つ全ての情報を複製して子プロセスを生成する
2. 複製が終わるとforkから親プロセスに戻る
    - 親プロセスにはforkから子プロセスのPIDが返る
3. 子プロセスは「forkから戻る」ところから始まる
    - 子プロセスにはforkから0が返る

#### 子プロセスが親プロセスから引き継ぐ情報
- 実行状態
- 親プロセスが持つメモリ領域の内容
- ユーザーID / グループID
- 環境
- 作業ディレクトリ
- umask値
- シグナルマスク・シグナルハンドラの設定
- ファイルディスクリプタ
- ディレクトリストリーム

### 実行
- `exec`関数 - 実行可能ファイルに格納されているプログラムをプロセスとして実行する関数群
  - プロセス上で実行中のプログラムを新しいプログラムへ置き換える
  - 呼び出しプロセスのメモリ領域の内容を新しいプログラムを実行する内容で置き換える
    - `exec`呼び出し時点で標準入出力ライブラリのバッファに残っているデータは
      呼び出しが成功すると捨てられる
- `exec`の呼び出しに成功した場合、元のプログラムのexec以降は実行されない

#### `exec`関数群の使い分け
- 環境変数`PATH`を参照して実行可能ファイルを探す - `p`
- `exec`前の環境を引き継ぐ - `e`
- 新しいプログラムへの引数がベクタ - `v`
- 新しいプログラムへの引数がリスト - `l`

#### execの前後で引き継ぐ情報
- PID / PPID
- ユーザーID / グループID
- 環境
- umask値
- シグナルマスク・シグナルハンドラの設定
- ファイルディスクリプタ
- そのプロセスがそれまでに利用した資源の情報

### 終了
- 親プロセスが子プロセスの終了状態を捕捉すると、カーネルが子プロセスを消滅させる
  - 親プロセスは`fork`した後、子プロセスを`wait`し、その終了状態を捕捉する
  - 親プロセスが子プロセスの終了状態を捕捉できない場合、子プロセスはゾンビ化する
- プロセスが終了する時、そのプロセスが使っていた資源は自動的に解放され
  カーネルによって回収される
- `main`が`return`される際に`exit`が呼ばれる

#### `exit(3)`が実行する処理
- `at_exit(3)`で登録された処理の呼び出し
- 標準入出力ライブラリの後始末
- 出力ストリームのフラッシュ
- ストリームを閉じる
- 一時ファイルの消去
- 終了コードを返す

#### `wait(2)が実行する処理`
- `wait`    - 子プロセスの状態を得る
- `waitpid` - 指定した子プロセスの状態を得る
  - `pid > 0`  - 指定したPIDを持つ子プロセス
  - `pid = 0`  - 親プロセスと同じプロセスグループに属する子プロセス
  - `pid = -1` - 任意の子プロセス(`wait`と同じ)
  - `pid < -1` - プロセスグループIDが指定したPIDの絶対値に等しい子プロセス

## シェルの入出力リダイレクト
- `fork` `exec`におけるファイルディスクリプタの引き継ぎを利用して実現されている
```
(1) 親プロセスがコマンドを受け取る
(2) 親プロセスが子プロセスをfork
(3) 子プロセスは親プロセスのファイルディスクリプタを引き継ぐ
(4) 子プロセスがリダイレクトに不要なファイルディスクリプタを閉じる
(5) 子プロセスがリダイレクトに必要なファイルディスクリプタを開く
(6) 子プロセスが親プロセスから引き継いだコマンドを実行
```

## `init`(現在の`systemd`)
- 全てのプロセスの先祖
- 孤児プロセスは`init`が親プロセスとなり`wait`する
  - 孤児プロセス - 自身の終了前に親プロセスが終了したプロセス

## カーネルプロセス
- カーネルの中にあるプログラムの動作
  - プロセススケジューリングを行うプロセス
  - 仮想記憶に関する処理を行うプロセス など

## プロセスグループ
- 参照: 例解UNIX/Linuxプログラミング教室P366-
- プロセスグループ - プロセスの集まり
  - 同じプロセスグループに属するプロセスは同じシグナルを受け取る

### プロセスグループの種類
- フォアグランドプロセスグループ   - 端末を介してユーザーと対話中のプロセスグループ(一セッションにつき一つ)
  - `tcgetpgrp(3)` - フォアグランドプロセスグループIDを取得
  - `tcsetpgrp(3)` - フォアグランドプロセスグループを変更
- バックグラウンドプロセスグループ - フォアグランドプロセスグループ以外の全てのプロセスグループ

### プロセスグループリーダー
- プロセスIDとプロセスグループIDが等しいプロセス
- `getpgid(2)` - 自プロセスのプロセスグループリーダーのプロセスIDを取得
- `setpgid(2)` - 新しいプロセスグループを作り、そこに移動する
  - プロセスグループを作ったプロセスがプロセスグループリーダーになる

## ジョブ
- ユーザーが端末から実行したコマンド
- ジョブは一つのプロセスグループ
  - パイプ`|`でつなげたコマンド同士は一つのジョブ(一つのプロセスグループ)
  - アンパサンド`&`でつなげたコマンド同士は別のジョブ(別のプロセスグループ)

### ジョブ制御
- ユーザーが端末からジョブを操作すること
  - `^Z` - フォアグランドのジョブをバックグラウンドにして一時中断
  - `bg` - 一時中断状態のジョブをバックグラウンドで実行再開
  - `fg` - バックグラウンドのジョブをフォアグランドで実行
- ジョブ制御はシグナルを利用して行われる

### プロセスとジョブの違い
- プロセス - 実行中のプログラムをカーネルが管理する
- ジョブ   - 実行中のプログラムをユーザーが管理する
