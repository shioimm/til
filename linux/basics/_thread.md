# スレッド
- 参照: 詳解UNIXプログラミング第3版 11. スレッド

## TL;DR
- プロセスは一つのスレッドを持つ(メインスレッド)
- プロセスはスレッドを追加で作成することができる
- 単一スレッド(スレッドベースモデル)
  - 単一のプロセスの中で一つのスレッドが動作する
    -> 各プロセスは一つの処理を担う
- 複数スレッド
  - 単一のプロセスの中で複数のスレッドが動作する
    -> 各プロセスは複数の処理を担う

### スレッドの持つ情報
- プロセス内での実行状況を表現するために必要な情報
  - スレッドID
  - 一連のレジスタ群の値
  - スタック
  - スケジュール優先度と方針
  - シグナルマスク
  - 変数`errno`
  - スレッド固有のデータ
- プロセス内にあるすべてのものはプロセス内のスレッドによって共有される
  - 実行可能プログラムのテキスト部
  - プログラムの大域メモリ・ヒープメモリ・スタック・ファイルディスクリプタ

## スレッドID
- `pthread_t`型 - 構造体でも可
- スレッドIDを表示するポータブルな方法はない
  - `pthread_equal(3)` - スレッドIDの比較
  - `pthread_self(3)` - 自スレッドIDの取得

## スレッドの作成
- `pthread_create(3)`
- スレッド作成後、新しく作成されたスレッドと呼び出し側のスレッドのうち
  どちらが先に動き出すかについては保証がない
- 新しく作成されたスレッドは呼び出し側のスレッドの浮動小数点数環境とシグナルマスクを継承する
  - 保留中のシグナルセットは破棄される

## スレッドの終了
### プロセスの終了
- プロセス内の任意のスレッドで`exit`関数群を呼ぶとプロセス全体が終了する
- プロセスを終了させるシグナルをスレッドに送ると当該プロセス全体が終了する

### スレッドの終了
- スレッドの始動ルーティンから戻る
  - スレッドの脱出コードが返る
- 同一プロセス内の他のスレッドが`pthread_cancel(2)`を呼ぶ
  - 指定されたスレッドは`pthread_exit(3)`を呼んだ時のように振る舞う
- スレッドで`pthread_exit(3)`を呼ぶ

### スレッドの待機
- 呼び出し側スレッドが`pthread_join(3)`を呼ぶ
  - 指定したスレッドが終了するまで呼び出し側スレッドの処理がブロックされる
  - 対象スレッドを自動的にデタッチ状態にしてリソースを解放することができる

### スレッドのデタッチ
- `pthread_detach(3)` - 当該スレッドが終了した場合直ちに領域を解放
  - `pthread_join(3)`で待ち合わせることはできない

### スレッドクリーンアップハンドラ
- スレッド終了時に呼び出す関数群
- スレッドは複数個のクリーンアップハンドラを確立できる
- ハンドラはスタックに記録され、登録順とは逆順に実行される
  - `pthread_cleanup_push(3)` - ハンドラの呼び出しをスケジュール
  - `pthread_cleanup_pop(3)` - 直近にスケジュールされたハンドラを呼び出し

#### ハンドラが呼び出されるタイミング
- `pthread_exit(3)`
- `pthread_cancel(3)`
- `pthread_cleanup_pop(3)`

## プロセスに関する操作との類似性
| プロセス  | スレッド               |
| -         | -                      |
| `fork`    | `pthread_create`       |
| `exit`    | `pthread_exit`         |
| `waitpid` | `pthread_join`         |
| `atexit`  | `pthread_cleanup_push` |
| `getpid`  | `pthread_self`         |
| `abort`   | `pthread_cancel`       |

## ミューテックス
- `pthread`の排他制御インターフェース
  - データを保護し一度に一つのスレッドだけが共有リソースにアクセスすることを保証する
- 共有リソースにアクセスする前にロックし、処理を完了したらアンロックする
  - すでにロックされているミューテックスを他のスレッドがロックしようとすると
    ミューテックスがアンロックされるまで他のスレッドはブロックされる
  - ミューテックスをアンロックした時に複数のスレッドがブロックしている場合、
    当該ミューテックスでブロックしているスレッド全てを実行可能にし、
    最初に動いたスレッドがロックを獲得する
    - 他のスレッドは再びブロックされる
- ミューテックスは全て野津レッドが同一のデータアクセス規則に従う場合のみ意味を成す
- `pthread_mutex_t`型 - ミューテックス変数型
- `pthread_mutex_init(3)` - ミューテックス変数の初期化
- `pthread_mutex_destroy(3)` - ミューテックス変数の削除
- `pthread_mutex_lock(3)` - ミューテックスのロック
- `pthread_mutex_trylock(3)` - ミューテックスのロック(条件付き)
- `pthread_mutex_unlock(3)` - ミューテックスのアンロック
