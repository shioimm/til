# タイマー / スリープ
- 参照: Linuxプログラミングインターフェース 20章 / 21章 / 22章

## TL;DR
- タイマー - 一定時間が経過したことを自プロセスへ通知する機能
- スリープ - プロセス・スレッドの実行を一定時間停止する機能

## タイマー・スリープ時間精度
- タイマー・スリープ時間精度はソフトウェアクロックによって丸め上げられる

## POSIXクロック
- `timespec`構造体を使用し、ナノ秒の解像度でクロックを使用するAPI
- リアルタイムライブラリ`librt`を使用する
  コンパイル時に`-lrt`を指定する必要がある

## API
### `alarm(2)`
- 一回だけタイムアウトするタイマーを設定する
- タイムアウト時`SIGALRM`を送信する
- それまでセットされていたタイマーを上書きする
  - 0秒を指定するとタイマーを停止する

#### 引数
- `seconds`を指定する
  - `seconds` - タイムアウトするまでの秒数

#### 返り値
- 以前にセットされたタイマーの残り時間を返す
  初めての場合は数値0を返す

### `setitimer(2)`
- 指定時間後にタイムアウトするインターバルタイマー(定期タイマー)を設定する

#### 引数
- `which`、`*new_value`、`*old_value`を指定する
  - `which` - タイマー種類
    - `ITIMER_REAL` - 実時間をカウント -> `SIGALRM`を送信
    - `ITIMER_VIRTUAL` - プロセスのユーザーCPU時間をカウント -> `SIGVALRM`を送信
    - `ITIMER_PROF` - プロセスのユーザーCPU時間 + システムCPU時間をカウント -> `SIGPROF`を送信
  - `*new_value` - 変更後のタイマーの値を示す`itimerval`構造体へのポインタ
    - `it_interval`に0以外を指定するとタイムアウト時にタイマーがリセットされる
    - `it_value`で残り時間を示す
  - `*old_value` - 変更前のタイマーの値を示す`itimerval`構造体へのポインタ
    - 変更前のタイマーを復元しない場合はNULLを指定する

```c
// itimerval構造体

struct itimerval {
  struct timeval it_interval; // インターバルタイマーの間隔
  struct timeval it_value;    // 次のタイムアウトまでの時間
};
```

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `gettitimer(2)`
- タイマーの現在値(タイムアウトまでの時間)を取得

#### 引数
- `which`、`*curr_value`を指定する
  - `which` - タイマー種類
  - `*curr_value` - タイマーの現在値を保存する`itimerval`構造体へのポインタ

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `sleep(3)`
- 指定された秒数(またはシグナルを捕捉するまで)プロセスの実行を停止する

#### 引数
- `second`を指定する

#### 返り値
- 数値0を返す
  - 中断時は残り秒数を返す

### `nanosleep(3)`
- 指定されたナノ秒数プロセスの実行を停止する

#### 引数
- `*request`、`*remain`を指定する
  - `*request` - 指定のスリープ時間を示す`timespec`構造体へのポインタ
  - `*remain` - 残り時間を格納する`timespec`構造体へのポインタ

#### 返り値
- 数値0を返す
  - エラー時または中断時は数値-1を返す

### `clock_gettime(2)`
- 指定のクロック種類でクロックの現在値を得るPOSIXクロックAPI

#### 引数
- `clockid`、`*tp`を指定する
  - `clockid` - 指定のクロック種類を表すフラグ
  - `*tp` - クロック値を格納する`timespec`構造体へのポインタ

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `clock_settime(2)`
- 指定のクロック種類でクロックの現在値を変更するPOSIXクロックAPI

#### 引数
- `clockid`、`*tp`を指定する
  - `clockid` - 指定のクロック種類を表すフラグ
  - `*tp` - 変更後のクロック値を示す`timespec`構造体へのポインタ

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `clock_getcpuclockid(2)` / `pthread_getcpuclockid(2)`
- 指定のプロセス / スレッドが消費したCPU時間を表すクロックIDを取得するPOSIXクロックAPI

#### 引数
- `clock_getcpuclockid(2)` - `pid`、`*clockid`を指定する
- `pthread_getcpuclockid(2)` - `thread`、`*clockid`を指定する

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `clock_nanosleep(2)`
- 指定されたナノ秒数(またはシグナルを捕捉するまで)プロセスの実行を停止するPOSIXクロックAPI

#### 引数
- `clockid`、`flags`、`*request`、`*remain`を指定する
  - `clockid` - 指定のクロック種類を表すフラグ
  - `flags` - `clock_nanosleep(2)`の動作を制御するフラグ
  - `*request` - 指定のスリープ時間を示す`timespec`構造体へのポインタ
  - `*remain` - 残り時間を格納する`timespec`構造体へのポインタ

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す
