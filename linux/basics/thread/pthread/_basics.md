# POSIXスレッド
- 参照: 詳解UNIXプログラミング第3版 11. スレッド
- 参照: 詳解UNIXプログラミング第3版 12. スレッドの制御
- 参照: Linuxプログラミングインターフェース 29章

## TL;DR
- プロセスは一つのスレッドを持つ(メインスレッド)
- プロセスはスレッドを追加で作成することができる
- シングルスレッド(スレッドベースモデル)
  - 単一のプロセスの中で一つのスレッドが逐次的に動作する
    -> 各プロセスは一つの処理を担う
- マルチスレッド
  - 単一のプロセスの中で複数のスレッドが並行に動作する
    -> 各プロセスは複数の処理を担う
    - マルチプロセッサシステムにおいては並列に動作する
- スレッドはプロセスと同じ状態遷移を持つ
- スレッドはプロセスと同じくカーネルによりスケジューリングと実行スレッドの切り替えが行われる

## プロセスとの比較
- プロセス作成よりもスレッド作成のほうが10倍以上高速
- マルチスレッド環境ではスレッド間で容易かつ高速に情報を共有できる
- マルチスレッド環境では処理がスレッドセーフである必要がある
  - スレッド間でデータを共有しているため、
    一スレッドでのバグが全スレッドに影響を及ぼす
- マルチスレッド環境では全スレッドがプロセス内の有限な仮想アドレス空間を奪い合う
- マルチスレッド環境下でのシグナルの扱いが難しい
- マルチスレッド環境では全スレッドが同じプログラムを実行する

### API
| プロセス  | スレッド               |
| -         | -                      |
| `fork`    | `pthread_create`       |
| `exit`    | `pthread_exit`         |
| `waitpid` | `pthread_join`         |
| `atexit`  | `pthread_cleanup_push` |
| `getpid`  | `pthread_self`         |
| `abort`   | `pthread_cancel`       |

## スレッドが共有する情報
- メモリ空間
- プロセスID / 親プロセスID
- プロセスグループID / セッションID
- 制御端末
- プロセス権限(UID / GID)
- ファイルディスクリプタ
- `fnctl(2)`によるレコードブロック
- シグナル動作
- ファイルシステム関連情報
- インターバルタイマ
- SystemVセマフォの`undo`
- リソース消費時間
- 消費したCPU時間
- 消費したリソース
- `nice`値

## スレッド固有の情報
- プロセス内での実行状況を表現するために必要な情報
  - スレッドID
  - 一連のレジスタ群の値
  - スタック(ローカル変数・関数コールリンケージ情報)
  - リアルタイムスケジューリングポリシー・優先度
  - シグナルマスク
  - シグナル処理専用スタック
  - スレッド固有の変数`errno`
  - スレッド固有のデータ(`thread-specific-data`)
  - CPUアフィニティ
  - ケーパビリティ
- 新規作成されたスレッドは呼び出し側のスレッドの浮動小数点数環境とシグナルマスクを継承する
  - 保留中のシグナルセットは破棄される

## Pthreadsデータ型
- `pthread_t` - スレッドID
- `pthread_mutex_t` - mutex
- `pthread_mutexattr_t` - mutex属性オブジェクト
- `pthread_cond_t` - 条件変数
- `pthread_condattr_t` - 条件変数属性オブジェクト
- `pthread_key_t` - スレッド固有のデータのキー
- `pthread_once_t` - 一回のみの初期化処理
- `pthread_attr_t` - スレッド属性オブジェクト

## スレッドID
- スレッドの一意な識別子

## スレッド属性
- `pthread_attr_t`構造体
  - スタックのアドレスおよびサイズ
  - スレッドスケジューリングポリシーおよび優先度
  - join可能 / デタッチ済み状態

### `pthread_attr_t`構造体に含まれないスレッド属性
- キャンセル属性 - `pthread_cancel`時の動作

## Pthreads関数の返り値
- 成功時 - 数値0を返す
- エラー時 - `errno`の値を示す正の整数を返す

## Pthreadsプログラムのコンパイル
- コンパイル時に`-pthread`オプションを付加する
  - プリプロセッサマクロ`_PEENTRANT`を定義する
    リエントラント対応版のライブラリ関数宣言が有効になる
  - `libpthread`ライブラリとリンクする
    `-lpthread`オプションと等価

## スレッドの作成
- メインスレッド - プログラム実行開始時、プロセスの生成と共に生成される
- メインスレッド以外のスレッド - `pthread_create(3)`を使用する

## スレッドの終了
- スレッド関数がリターンする
- スレッドが`pthread_exit(3)`を実行する
- スレッドが`pthread_cancel(3)`により実行をキャンセルする
- プロセスが終了する
  - 任意のスレッドが`exit()`する
  - メインスレッドが`main`関数からリターンする

## スレッドの終了の待機
- `pthread_join(3)`を呼ぶ
  - デタッチしていないスレッドは`pthread_join(3)`によってjoinしないと
    ゾンビスレッド化する

## スレッドのデタッチ
- `pthread_detach(3)`を呼ぶ
  - 終了時にjoinをさせず、自動的に破棄させる
  - デタッチを設定するとjoinすることができなくなる
- デタッチしたスレッドはプロセスから独立するわけではなく、
  プロセス終了時には一緒に終了する

### スレッドクリーンアップハンドラ
- スレッド終了時に呼び出す関数群
- スレッドは複数個のクリーンアップハンドラを確立できる
- ハンドラはスタックに記録され、登録順とは逆順に実行される
  - `pthread_cleanup_push(3)` - ハンドラの呼び出しをスケジュール
  - `pthread_cleanup_pop(3)` - 直近にスケジュールされたハンドラを呼び出し

#### ハンドラが呼び出されるタイミング
- `pthread_exit(3)`
- `pthread_cancel(3)`
- `pthread_cleanup_pop(3)`

## 制限事項
- `PTHREAD_DESTRUCTOR_ITERATIONS` - 4回
  - スレッド終了時にスレッド固有データを破棄する実装の最大試行回数
- `PTHREAD_KEYS_MAX` - 1024個
  - スレッドが作成できるキーの最大個数
- `PTHREAD_STACK_MIN` - 16384バイト
  - スレッドスタックに使用可能な最小バイト数
- `PTHREAD_THREADS_MAX` - 無制限
  - プロセスで作成可能なスレッドの最大個数

## 再入可能性
- スレッド安全 - 同時に複数のスレッドから呼び出しても正しく動作する
  - 静的なメモリ領域行きにデータを格納して返す関数はスレッド安全ではない
  - 呼び出し側が自前の領域を用意するようにインターフェースを変更している関数はスレッド安全になる
- `flockfile(3)` / `ftrylockfile(3)` - `FILE`に付随する排他ロックを取得
  - `flockfile(3)` - 他のスレッドが先にロックを取得している場合、ロックが解除されるまでブロック
  - `ftrylockfile(3)` - 他のスレッドが先にロックを取得している場合、0を返す

## スレッド固有データ(スレッドローカル変数)
- 特定のスレッドに付随するデータを格納したり探索する機構
- 他のスレッドに対して同期してアクセスすることを気にせず各スレッドがそれ独自のデータにアクセスする
- 当該データに付随するキーを作成し、キーを使ってスレッド固有データへのアクセス権限を得る
- `pthread_key_t`型 - キー型
- `pthread_key_create(3)` - キーの作成
- `pthread_key_delete(3)` - キーの削除
- `pthread_once(3)` - 複数スレッドにおける呼び出しでも最初の一回だけ初期化ルーティンを呼ぶ
- `pthread_setspecific(3)` - スレッド固有の値と以前`pthread_key_create(3)` を呼び出して取得したキーを関連づける

## シグナル
- 各スレッドは独自のシグナルマスクを持つ
- シグナル処理はプロセス内の全てのスレッドで共有する
- 個々のスレッドはシグナルをブロックできるが、
  個々のスレッドにおいてシグナルに付随した変更を行うと
  全てのスレッドでその変更を共有する
- シグナルはプロセス内の一つのスレッドに配送される
- `pthread_sigmask(3)` - シグナルマスクを設定する
- `sigwait(2)` - スレッドにおいて指定のシグナル(群のいずれか)の生起を待つ
  - 対象のシグナルをアンブロックし、配送を不可分に待つ
  - 事前に待つ対象のシグナルをブロックしておく必要がある
- `pthread_kill(3)` - スレッドに任意のシグナルを送る
  - シグナルのデフォルト動作が終了の場合、プロセス全体が終了する

## `fork(2)`
- スレッドで`fork(2)`を呼ぶと、プロセスのアドレス空間全体を子プロセスにコピーする
- 子プロセスは親プロセスで`fork`を読んだスレッドのコピーとなる単一のスレッドを持つ
  - 親のスレッドがロックを持つ場合、子のスレッドもロックを持つ
- 子プロセスは親プロセスからミューテックス、reader / writerロック、条件変数の各状態を継承する
  - 親プロセスが複数のスレッドから成り、子プロセスで`fork`直後に`exec`しない場合
    ロック状態をクリアする必要がある
- `pthread_atfork(3)` - 三つのフォークハンドラを確立する
  - `prepare`フォークハンドラ - `fork`で子プロセスを作る前に親側で呼ばれる
    - 親で定義している全てのロックを獲得する
  - `parent`フォークハンドラ - `fork`で子プロセスを作り`fork`から戻る前に親側で呼ばれる
    - `prepare`が獲得したロックをアンロックする
  - `child`フォークハンドラ - `fork`から戻る前にこの環境で呼ばれる
    - `prepare`が獲得したロックをアンロックする
    - 親と子がそれぞれのロックをアンロックすると、
      子に新たにメモリが割り付けられ親から子へメモリ内容をコピーする
