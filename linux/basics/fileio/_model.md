# ファイルIOモデル
- 参照: 例解UNIX/Linuxプログラミング教室P133
- 参照: 詳解UNIXプログラミング第3版 3. ファイル入出力
- 参照: Linuxによる並行プログラミング入門 第3章 ファイル入出力 3.2
- 参照: Linuxプログラミングインターフェース 2章 / 4章

## TL;DR
- UNIXシステムのIOモデルにおいては、一つのシステムコールが全種類のファイルに対するIOを処理する
- IOを処理するシステムコールはオープンしたファイルをファイルディスクリプタによって参照する

## file構造体
- プロセスが`open(2)`を呼ぶとカーネル内にfile構造体が一つ生成される
- file構造体はopenが返すファイルディスクリプタとファイルの実体をつなぐ

## file構造体が格納する情報
- ファイル状態フラグ
  - フラグの集まり `O_APPEND` `O_NONBLOCK` `O_SYNC` etc
    - <-> ファイル生成フラグ - `O_CREAT` `O_TRUNC` `O_EXCL` `O_NOCITY` etc
- カレントファイルオフセット

## ファイルディスクリプタ
- IOシステムコールが対象のファイルを特定し、プロセスとファイルを結びつけるための識別子(整数値)
  - プロセスごとに固有の値となる
  - ファイルを開くと生成される
  - ファイルを閉じると削除される
- ファイルディスクリプタが開かれている間、
  そのファイルに対するカレントファイルオフセットが保持される
  - カレントファイルオフセットはファイルを開いた時点で0に初期化される
- シェルから起動されたプロセスは、オープン済みのファイルディスクリプタを受け継ぐ
  (標準入力・標準出力・標準エラー出力)
- `open(2)`すると、その時点で空いている番号のうち、最小の番号がファイルディスクとなる

### 標準ファイルディスクリプタ
| FD | 用途           | POSIX名         | stdioストリーム  |
| -  | -              | -               | -                |
| 1  | 標準入力       | `STDIN_FILENO`  | `stdin`          |
| 2  | 標準出力       | `STDOUT_FILENO` | `stdout`         |
| 3  | 標準エラー出力 | `STDERR_FILENO` | `stderr`         |

- 標準入力にはEOFが無い
  - 出力が常に入力待ちの状態になる
  - `Ctrl + D`でシグナルを送出する

### `/dev/fd/`
- `/dev/fd/0` - 標準入力
- `/dev/fd/1` - 標準出力
- `/dev/fd/2` - 標準エラー出力
- ファイルディスクリプタnを複製する = `dev/fd/n`を開く
  - `fd = dup(0)` = `fd = open("dev/fd/0", mode);`
    - ディスクリプタ0と`fd`は同一のファイルテーブルエントリを共有する

### ファイルディスクリプタのコピー
- `dup2(2)` / `dup(2)`
  - ファイルディスクリプタテーブルの中で指定のエントリ番号 or 最小のエントリ番号を持つ空のエントリを探し、
    そこにファイルディスクリプタテーブルのエントリ1(標準出力)のコピーを書き込む(標準出力を指す)
  - file構造体が持っている情報はfd1と新しいファイルディスクリプタに対して同じ内容で共有される
    - ファイル情報フラグ・カレントファイルオフセット・ファイルの実態へのポインタ
  - fd1を既存のファイルディスクリプタfd0に`dup`すると、
    fd0は既存のストリームを閉じてfd1と同じfile構造体を指すようになる

## プロセステーブル
- カーネルはプロセステーブルでプロセスを管理する
- プロセスはプロセステーブルに一つのプロセスエントリを持つ

### プロセステーブルエントリ
- プロセステーブルエントリは
  プロセスがオープンしているファイルディスクリプタを管理するファイルディスクリプタテーブルを持つ
  - プロセスがオープンしているファイルディスクリプタはファイルステータスフラグを持つ
  - プロセスがオープンしているファイルディスクリプタはファイルテーブルエントリへのポインタを持つ
- 子プロセスは親プロセスのファイルディスクリプタテーブルを複製するが
  各ファイルディスクリプタは対応するfile構造体は複製されず、同じfile構造体に紐づく
  - 親子プロセスはそのファイルの操作に関してfile構造体が格納する情報を共有する
- プロセスAが`close`を呼んだ場合、
  プロセスAのファイルディスクリプタテーブルから対象のファイルディスクリプタが消える
  - 対象のファイルディスクリプタに対応するfile構造体も消える
  - プロセスBのファイルディスクリプタテーブルは変更されない

### ファイルディスクリプタテーブル
- ファイルディスクリプタの情報を保管するテーブル
  - ファイルディスクリプタはカーネル内でプロセスごとに管理される
    - プロセスがファイルディスクリプタを開閉するとテーブルが更新される
  - テーブル内の1エントリが1ファイルディスクリプタに対応する
- テーブル内の1エントリは次の情報を持つ
  - ファイルディスクリプタを操作する際にその動作を制御するフラグ(`close-on-exec`)
  - オープンしたファイル情報へのポインタ

### ファイルテーブルエントリ(file構造体)
- ファイルテーブルエントリは当該ファイルのファイルステータスフラグを持つ
- ファイルテーブルエントリは当該ファイルカレントファイルオフセットを持つ
- ファイルテーブルエントリは当該ファイルの汎用i-nodeテーブルエントリへのポインタを持つ

### 汎用i-nodeテーブルエントリ
- 各汎用i-nodeテーブルエントリは汎用i-node情報を持つ
- 各汎用i-nodeテーブルエントリは汎用i-nodeへのリンクを持つ

## ファイル操作の不可分性
- 二つのプロセスが同じファイルを操作する際に操作がコンフリクトした場合
  操作Aが完了してから操作Bを行う
  操作Bが完了してから操作Aを行う のいずれかの挙動を取る
  操作Aと操作Bの結果が混ざることはない
