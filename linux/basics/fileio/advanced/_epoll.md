# [Linux2.6~]`epoll(2)`
- 参照: Linuxプログラミングインターフェース 63章

## TL;DR
- 複数のファイルディスクリプタをIO可能になるまで監視する
- `epoll`インスタンスを使用して監視対象のファイルディスクリプタを管理する
- 監視対象とするファイルディスクリプタそれぞれにつき、
  監視するイベントをビットマスクで設定する

### API
- `epoll_crete(2)` - 新規`epoll`インスタンスを作成
- `epoll_ctl(2)` - `epoll`インスタンスに対応するインタレストリストを操作する
- `epoll_wait(2)` - `epoll`インスタンスに対応するレディリストの要素を返す

### `epoll(2)` APIの長所
- 大量のファイルディスクリプタを監視する際、`select(2)` / `poll(2)`よりスケールする
- レベルトリガ通知・エッジトリガ通知いずれも使用可能(デフォルトではレベルトリガ通知)
- 複雑なシグナル処理を回避できる
- 監視内容を柔軟に指定できる

## `epoll`インスタンス
- カーネル内のデータを操作するための特殊なファイルディスクリプタ

### `epoll`インスタンスによる操作
- インタレストリスト(監視対象のファイルディスクリプタ群)をカーネル内に保持させる
  - インタレストリストに保持したファイルディスクリプタは明示的に削除されるまで動作を続ける
- レディリスト(IO可能になったファイルディスクリプタ群)を管理する

### インタレストリストへ設定可能なファイルディスクリプタ数
- 設定可能なファイルディスクリプタ数の上限は`/proc/sys/fs/epoll`下の`max_user_watches`にて確認・変更可能
- デフォルトでは値はシステムメモリサイズから算出

## 内部動作
### 新規`epoll`インスタンスを生成時の動作
- カーネルは内部にメモリi-node及びオープンファイル情報を作成する
- カーネルは自プロセスにオープンファイル情報を参照するファイルディスクリプタを作成する
- `epoll`インスタンスのインタレストリストはオープンファイル情報を参照する
  - `epoll`ファイルディスクリプタを複製した場合
    あるいは子プロセスから`epoll`ファイルディスクリプタを参照した際、
    複製インスタンスも同じインタレストリスト・レディリストを参照する

### インタレストリストへファイルディスクリプタ追加時の動作
- カーネルは監視対象ファイルディスクリプタ数およびオープンファイル情報への参照を保持する
  `epoll`インタレストリストへ要素を追加する

### ファイルディスクリプタ監視時の動作
- カーネルは内部でオープンファイル情報を監視する
- インタレストリストで保持されているファイルディスクリプタは
  同じオープンファイル情報を参照している他の全てのファイルディスクリプタがクローズされた時点で
  `epoll`インタレストリストから削除される

## API
### `epoll_crete(2)`
- 新規`epoll`インスタンスを作成する
- インタレストリストは空に初期化される
- `epoll`インスタンスの使用を終えたら対応するファイルディスクリプタを`close(2)`でクローズする

#### 引数
- `size`を指定する
  - `size` - 監視対象ファイルディスクリプタ数(初期化のため)

#### 返り値
- `epoll`インスタンスに対応するファイルディスクリプタを返す
  - エラー時は数値-1を返す

### `epoll_ctl(2)`
- 指定の`epoll`インスタンスに対応するインタレストリストを操作する

#### 操作内容
| マクロ定数      | 内容                                                 |
| -               |-                                                     |
| `EPOLL_CTL_ADD` | `epfd`のインタレストリストへ`fd`を追加               |
| `EPOLL_CTL_MOD` | `fd`上で監視するイベントを`ev`の内容へ変更           |
| `EPOLL_CTL_DEL` | `epfd`のインタレストリストから`fd`を削除(`ev`は無効) |

#### 引数
- `epfd`、`op`、`fd`、`*ev`を指定する
  - `epfd` - 指定の`epoll`インスタンスに対応するファイルディスクリプタ
  - `op` - 操作内容を示すマクロ定数
  - `fd` - 操作対象となるインタレストリスト内のファイルディスクリプタ
  - `*ev` - `fd`に対する処理を決定する`epoll_event`構造体へのポインタ

```c
struct epoll_event {
  uint32_t     events; // epollイベント(ビットマスク)
  epoll_data_t data;   // ユーザーデータ変数
};

// 自プロセスが後で付加データとして受け取る共用体
typedef union epoll_data {
  void     *ptr; // ユーザー定義のデータへのポインタ
  int       fd;  // ファイルディスクリプタ
  uint32_t  u32; // 32ビット整数
  uint64_t  u64; // 64ビット整数
} epoll_data_t;
```

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `epoll_wait(2)`
- 指定の`epoll`インスタンスからIO可能なファイルディスクリプタに関する情報を取得する
- 一度の`epoll_wait(2)`の実行で複数のIO可能なファイルディスクリプタの情報を取得できる
- [Linux2.6.19~]`epoll_pwait(2)` - ブロック中にアンマスクするシグナルを指定したい場合

#### 引数
- `epfd`、`*evlist`、`maxevents`、`timeout`を指定する
  - `epfd` - 指定の`epoll`インスタンスに対応するファイルディスクリプタ
  - `*evlist` - IO可能なファイルディスクリプタの情報を格納した`epoll_event`構造体の配列
  - `maxevents` - `*evlist`の要素数
  - `timeout` - ブロック動作を指定する数値
    - 数値-1 - インタレストリスト内のファイルディスクリプタが一つでもIO可能になるまで動作をブロック
    - 数値0 - ブロックしない・インタレストリスト内のファイルディスクリプタがIO可能か検査する
    - 正の値 - ミリ秒単位のタイムアウト時間

#### 返り値
- `*evlist`配列へ代入したファイルディスクリプタ数を返す
  - タイムアウト時は数値0を返す
  - エラー時は数値-1を返す

### `epoll`イベント
- `epoll_ctl(2)`実行時に`ev.events`にセットする、あるいは`epoll_wait(2)`が`evlist[].events`に返すイベント

| フラグ         | `epoll_ctl` | `epoll_wait` | 説明                                      |
| -              | -           | -         | -                                            |
| `EPOLLIN`      | 可能        | 可能      | 高優先度データ以外の通常データを読み取り可能 |
| `EPOLLPRI`     | 可能        | 可能      | 高優先度データを書き込み可能                 |
| `EPOLLDHUP`    | 可能        | 可能      | ピアソケットが`shutdown(2)`された            |
| `EPOLLOUT`     | 可能        | 可能      | 通常データを書き込み可能                     |
| `EPOLLET`      | 可能        | -         | エッジトリガ通知を使用                       |
| `EPOLLONESHOT` | 可能        | -         | イベント通知後に監視を停止                   |
| `EPOLLHUP`     | -           | 可能      | ハングアップ発生                             |
| `EPOLLERR`     | -           | 可能      | エラー発生                                   |

## 性能
- 監視対象ファイルディスクリプタが増大しても`select(2)`や`poll(2)`のように性能が劣化することがない
  - `epoll_ctl(2)`実行時に監視対象ファイルディスクリプタを指定し、
    ファイルディスクリプタがIO可能になるような処理が実行された時点で
    カーネルがそのファイルディスクリプタをレディリストへ追加する
    - `epoll_wait(2)`はレディリストからデータを取り出すだけ
  - カーネル空間内に監視対象を表すデータを構築し、IO可能になったファイルディスクリプタだけを返す
