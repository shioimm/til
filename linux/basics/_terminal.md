# 端末
- 参照: 例解UNIX/Linuxプログラミング教室P375-432
- 参照: Linuxプログラミングインターフェース 62章

## TL;DR
- 端末(ターミナル) = キーボード + ディスプレイ
  - 「端末」の語源はテレタイプ端末
  - 端末エミュレータ - ソフトウェアで実装された端末
- 端末ではシェルが実行されている <-> シェルのデフォルトの標準入出力は端末
- 端末装置はカーネル内にある端末ドライバによって制御される

```
1. ユーザーがキーボードからコマンドを入力
2. 端末エミュレータがユーザーの入力値をシェルの標準入力に送信
3. シェルが入力値を実行し標準出力から端末エミュレータに送信
4. 端末エミュレータがシェルの出力値をキーボードに出力
```

### プログラマが行う端末処理
- 端末ラインディシプリン(端末回線規約)の設定の取得・変更
- エスケープシーケンスの取得・発行

## 端末ドライバ
- 端末デバイス - プロセス間を取り持つ
  - 入力を処理する
  - 特殊文字(割り込みキーによる入力など)を処理する(canonicalモード時)
  - 内部に入力キュー・出力キューを持つ
    - 入力キュー - 端末デバイスに入力された文字をプロセスに渡す
    - 出力キュー - プロセスからの出力を端末デバイスに渡す

### 端末ドライバによる入力モード
#### canonicalモード
- 端末からの入力を行単位に処理し、行編集を可能にするモード
- 行は改行文字で終端する
- 一度に一行分のデータを読み取る
- デフォルトの入力モード

#### noncanonicalモード
- 端末からの入力を行単位にまとめないモード
  - Ex. vi、more、less

## 端末ラインディシプリン
- カノニカル処理を行うモジュール
- カーネル内でデバイスドライバと汎用`read` / `write`関数群の間を取り持つ

```
ユーザープロセス
----------------
     |
read / write関数群
     |
端末ラインディシプリン
     |
端末デバイスドライバ
     |
----------------
物理装置
```

## 端末ウィンドウサイズ
- 端末ウィンドウサイズを変更するとフォアグラウンドプロセスグループへ`SIGWINCH`が送信される
- プロセスは`ioctl(2)`のTIOCGWINSIZ操作を実行すると端末ウィンドウのサイズを取得できる

```c
struct winsize {
  unsigned short ws_row;    // 文字単位行数
  unsigned short ws_col;    // 文字単位カラム数
  unsigned short ws_xpixel; // 未使用
  unsigned short ws_ypixel; // 未使用
};
```

## エスケープシーケンス
- 端末の画面を制御する特殊な文字列
  - 通常の文字では表現できない機能を表現する
```
echo ^V^[[7m abc ^V^[[0m # 反転したabcが表示される
```
- 文字コードを切り替える特殊な文字列
- エスケープシーケンスは標準化されておらず端末の種類によって変わる
  - `$ printenv TERM` - 端末の種類を表示

## API
### `tcgetattr(3)`
- 端末の属性を取得する
- シェルから操作する場合は`stty(1)`を使用できる

#### 引数
- `fd`、`*termios_p`を指定する
  - `fd` - 指定の端末をオープンしたファイルディスクリプタ
  - `*termios_p` - 端末の属性を格納する`termios`構造体へのポインタ

```c
struct termios {
  tcflag_t c_iflag;    // 端末からの入力を操作するフラグ群
  tcflag_t c_oflag;    // 端末への出力を操作するフラグ群
  tcflag_t c_cflag;    // 端末を接続する回線を制御するフラグ群(ラインディシプリン)
  tcflag_t c_lflag;    // 端末へ入力するユーザーインターフェースを操作するフラグ群
  cc_t     c_cc[NCCS]; // 特殊制御文字の配列
};
```

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `tcsetattr(3)`
- 端末の属性を変更する
- シェルから操作する場合は`stty(1)`を使用できる

#### 引数
- `fd`、`optional_actions`、`*termios_p`を指定する
  - `fd` - 指定の端末をオープンしたファイルディスクリプタ
  - `optional_actions` - 変更がいつから有効化するかを示すマクロ定数
  - `*termios_p` - 端末の属性を格納する`termios`構造体へのポインタ

#### 返り値
- 1属性でも変更できた場合は数値0を返す
  - 全属性エラー時は数値-1を返す

### `termcap`ライブラリ
- テキストファイル`/etc/termcap`を読むためのルーティン群
- `terminfo`方式 / `curses`ライブラリに置き換えられた

### `terminfo`
- 端末機能のDB、および端末機能のDBを処理するライブラリ・コマンド
- `infocmp(1)`        - バイナリ形式で格納されているterminfoをテキスト形式にして出力する
- `tic(1)`            - テキスト形式で格納されているterminfoをバイナリ形式にして出力する
- `tput(3)` `putp(3)` - エスケープシーケンスを端末上に出力する

### `curses`ライブラリ
- `termios`ライブラリや端末ラインディシプリンの操作をより簡単に行うことができる
```c
#include <curses.h>

int main()
{
  char buf[1024];
  initscr();                   // 端末の初期化
  noecho();                    // エコーをOFF
  getnstr(buf, sizeof(buf));   // fgets()のcurses版
  move(x, y);                  // 座標x, yにカーソルを移動
  attron(A_REVERSE);           // 文字属性の反転ON
  printw("input = %s\n", buf); // printfのcurses版
  refresh();                   // 画面の変更を適用する
  getch();                     // getcharのcurses版
  endwin();                    // 端末を元に戻す

  return 0;
}
```
- `initscr`で初期化し、`endwin`で終了する
- `refresh`で画面を更新

### 端末回線速度
- 入出力回線速度の取得・変更
  - `cfgetispeed(3)` / `cfsetispeed(3)` - 入力回線速度を取得・変更する
  - `cfgetospeed(3)` / `cfsetospeed(3)` - 出力回線速度を取得・変更する

### ライン制御関数群
- 端末装置に対する信号制御機能を提供する
  - `tcdrain(3)` - 全ての出力が送出されるのを待つ
  - `tcflow(3)` - コンピュータと端末の間のデータの流れを制御する
  - `tcfluch(3)` - 入力キュー・出力キューのバッファをフラッシュする
  - `tcsendbreak(3)` - 連続する0ビットを送信し、BREAK信号を生成する

## 擬似端末(pseudo terminal)
- アプリケーションプログラムには端末のように見えるが、実際の端末ではない
- ファイルディスクリプタ(マスター)とファイルディスクリプタ(スレーブ)の間を
  パイプ二本で双方向通信させ、パイプのスレーブ側の一端に端末ラインディシプリンをつけたもの
  - スレーブ側に書いたデータはマスター側から読める
  - マスター側に書いたデータはスレーブ側から読める
  - スレーブ側のファイルディスクリプタは端末に見える(`isatty(3)`は真を返す)
- `posix_openpt(3)` - 疑似端末マスターデバイスをオープンする
- `grantpt(3)` - 擬似端末スレーブへのアクセスを許可
- `ptsname(3)` - 擬似端末スレーブの名前を取得する
- `unlockpt(3)` - 擬似端末マスター / スレーブのペアのロックを解除する

### 配置
- プロセスは擬似端末のマスター側をオープンして`fork`する
- 子プロセスは新たなセッションを確立し、擬似端末のスレーブ側をオープンし、端末ラインディシプリンをつけて`exec`
- マスター側に書いたものはスレーブ側の入力、スレーブ側に書いたものはマスター側の入力として扱われる

### 利用例
- ネットワークログインサーバー
- ウィンドウシステム端末エミュレーション
- `script(1)`
- `expect(1)`
- 長時間実行プログラムの出力監視

### 擬似端末を使う手順
1. 擬似端末マスター(`/dev/ptmx`)を開く(`open`)
2. 擬似端末スレーブを`chomod` / `chown`でアクセスできるようにする(`grantpt`)
3. 擬似端末の内部的なロックを解除(`unlockpt`)
4. 擬似端末スレーブのファイル名を取得(`ptsname`)
5. 擬似端末スレーブを開く(`open`)

### 高度な機能
- パケットモード
  - マスター側がスレーブ側の状態変化を感知できるようになる
- リモートモード
  - スレーブ側をリモートモードに設定する
  - スレーブはマスターから受け取ったデータの処理を行わない
- ウィンドウサイズの変更
- シグナル生起
  - マスターからスレーブのプロセスグループへシグナルを送る
