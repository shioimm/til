# `dlopen` API
- 参照: Linuxプログラミングインターフェース 42章

## TL;DR
- プログラム実行中にダイナミックに共有ライブラリをオープンし、
  名前をキーに関数を検索し、その関数を呼び出し可能とする
- ダイナミックロード - プログラム実行中のライブラリローディング
- Linuxで`dlopen` APIを使用するプログラムをビルドするには
  `libdl`ライブラリをリンクするよう、リンカに`-ldl`オプションを与える必要がある

## 共有ライブラリのオープン
### `*dlopen(3)`
- 指定の共有ライブラリを自プロセスの仮想アドレス空間へロードし、
  ライブラリのレファレンスカウントをインクリメントする
- 指定の共有ライブラリが他の共有ライブラリに依存する場合、
  依存先のライブラリも再帰的にロードする(依存ツリー)

#### 引数
- `*libfilename`、`flags`を指定する
  - `*libfilename` - 指定の共有ライブラリの名前を示す文字列へのポインタ
  - `flags` - `dlopen(3)`の動作を指定するマクロ定数

#### 返り値
- 以降で使用するライブラリハンドルを返す
  - エラー時はNULLを返す

## シンボル参照
### `*dlsym(3)`
- 指定のハンドルが示すライブラリ及びその依存ツリーから
  指定のシンボル(関数または変数)を検索する
  - ハンドルの代わりに疑似ハンドルを示すマクロ定数を指定することが可能

```c
int (*funcp)(int);
*(void**)(&funcp) = dlsym(handle, symbol);
```

### 引数
- `*handle`、`*symbol`を指定する
  - `*handle` - 指定のライブラリハンドルを示す文字列へのポインタ
  - `*symbol` - 指定のシンボルを示す文字列へのポインタ

### 返り値
- `symbol`のアドレスを返す
  - 見つからない場合はNULLを返す

## シンボルの情報
### `dladdr(3)`
- 指定されたアドレスに関する情報を取得する
- `#define _GNU_SOURCE` / `#include <dlfcn.h>`の記述が必要

#### 引数
- `*addr`、`*info`を指定する
  - `*addr` - 指定のアドレスを示す文字列へのポインタ
  - `*info` - 情報を格納する`Dl_info`構造体へのポインタ

```c
// Dl_info構造体

typedef struct {
  const char *dli_fname;  // addrを含む共有ライブラリのパス名
  void       *dli_fbase;  // 共有ライブラリのベースアドレス
  const char *dli_sname;  // addr以下の範囲で最も近いシンボル名
  void       *dli_saddr;  // dli_snameのシンボルのアドレス
} Dl_info;
```

## 共有ライブラリのクローズ
### `*dlclose(3)`
- 指定のハンドルに対応するライブラリをクローズし、
  レファレンスカウントをデクリメントする
  - レファレンスカウントが0になるとライブラリをメモリからアンロードする
- 指定の共有ライブラリが他の共有ライブラリに依存する場合、
  依存先のライブラリにも再帰的に適用される
- プロセス終了時には全ライブラリに対して暗黙的に`dlclose(3)`が呼ばれる

#### 引数
- `*handle`を指定する
  - `*handle` - 指定のライブラリハンドルを示すポインタ

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

## エラー診断
### `dlerror(3)`
- `dlopen` APIが返したエラーの原因を示す文字列を取得する

### 返り値
- エラー原因を示す文字列
  - 直前の`dlopen` APIがエラーを発生させていない場合はNULLを返す
