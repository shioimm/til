# ファイルバッファリング
### `fsync(2)` / `fdatasync(2)`
- 指定のファイルディスクリプタに関する
  全てのメタデータおよびカーネルバッファ内のファイルデータをディスクへフラッシュする
- `fsync(2)` - ファイル保全の完了状態へ移行する
- `fdatasync(2)` - データ保全の完了状態へ移行する

#### 引数
- `fd`を指定する

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `sync(2)`
- 更新したファイル情報のカーネルバッファを全てディスクへフラッシュする
- すべてのデータがディスクへフラッシュされるまで戻らない

### `setvbuf(3)`
- 指定したファイルストリームのバッファリングモードを変更する

#### 引数
- `*stream`、`*buf`、`mode`、`size`を指定する
  - `*stream` - 対象のファイルストリーム(`FILE`)へのポインタ
  - `*buf` - `stream`用のバッファへのポインタ
  - `mode` - バッファリングモード
    - `_IONBF` - 非バッファリングIO
    - `_IOLBF` - 行バッファリングIO
    - `_IOFBF` - フルバッファリングIO(デフォルト)
  - `size` - `stream`用のバッファサイズ

#### 返り値
- 数値0を返す
  - エラー時は数値0以外を返す

### `setbuf(3)`
- 指定したファイルストリームのバッファリングモードを以下のように変更する
```
setvbuf(fp, buf, (buf != NULL) ? _IOFBF : _IONBF, BUFSIZE);

// BUFSIZE - 8192バイト
```

#### 引数
- `*stream`、`*buf`を指定する
  - `*stream` - 対象のファイルストリーム(`FILE`)へのポインタ
  - `*buf` - `stream`用のバッファへのポインタ

### `fflush(3)`
- 設定されたバッファリングモードとは無関係に
  `stdio`ストリームがバッファリングした出力をフラッシュする
  - 内部で`read(2)`を使用し、カーネルバッファ内の入力データを破棄する
  - 内部で`write(2)`を使用し、出力データをカーネルバッファ内ヘコピーする

#### 引数
- `*stream`を指定する
  - `*stream` - 対象のファイルストリーム(`FILE`)へのポインタ

#### 返り値
- 数値0を返す
  - エラー時は`EOF`を返す

### `posix_fadvise(2)`
- バッファキャッシュの使用を最適化するアクセスパターン情報を与え、
  プロセスのIO性能を向上させる

#### 引数
- `fd`、`offset`、`len`、`advise`を指定する
  - `offset` - アクセスパターンを適用するファイルの範囲
  - `len` - アクセスパターンを適用するファイルの範囲
  - `advise` - アクセスパターンを示す数値

#### 返り値
- 数値0を返す
  - エラー時は正のエラー番号を返す

### `fileno(3)` / `fdopen(3)`
- システムコールと標準Cライブラリを混合してIOする
- `fileno(3)` - 指定のファイルストリーム(`FILE`)に対応するファイルディスクリプタを返す
  - stdioライブラリが内部でストリーム用にオープンしたファイルディスクリプタ
- `fdopen(3)` - 指定のファイルディスクリプタから作成したファイルストリーム(`FILE`)を返す
  - 通常ファイルでないファイルディスクリプタ(ソケット、パイプ)に対して
    stdioライブラリを使用したい際に有用

#### 引数
- `fileno(3)` - `*stream`を指定する
  - `*stream` - 対象のファイルストリーム(`FILE`)へのポインタ
- `fdopen(3)` - `fd`、`*mode`を指定する
  - `*mode` - 読み取り、書き込み、追加書きを示すフラグへのポインタ

#### 返り値
- `fileno(3)` - ファイルディスクリプタを返す
  - エラー時は数値-1を返す
- `fdopen(3)` - ファイルポインタ(`FILE`)を返す
  - エラー時はNULLを返す

## 参照
- 例解UNIX/Linuxプログラミング教室P107-148 / P271-275
- 詳解UNIXプログラミング第3版 3. ファイル入出力
- 詳解UNIXプログラミング第3版 4. ファイルとディレクトリ
- Linuxプログラミングインターフェース 4章 / 5章 / 13章
