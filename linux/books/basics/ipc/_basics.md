# IPC
- 参照: Linuxプログラミングインターフェース 43章

## TL;DR
- プロセスやスレッドが相互に通信し、動作の強調を図る機構

### 分類
- 通信機構 - プロセスのデータ交換
  - データ転送
    - バイトストリーム
    - メッセージ
    - 疑似端末
  - 共有メモリ
    - SystemV共有メモリ
    - POSIX共有メモリ
    - メモリマッピング
- 同期機構 -プロセス、スレッド動作の同期を取る
  - セマフォ
    - SystemVセマフォ
    - POSIXセマフォ
  - ファイルロック
    - レコードロック(`fnctl(2)`)
    - ファイルロック(`fnctl(2)`)
  - mutex(スレッド)
  - 条件変数(スレッド)
- シグナル
  - 標準シグナル
  - リアルタイムシグナル

## 通信機構
### データ転送
- プロセスがIPCへデータを書き込み、別プロセスがIPCからデータを読み取ることで通信する
  - 書き込み時はユーザーメモリ -> カーネルメモリへのデータ転送が必要
  - 読み取り時はカーネルメモリ -> ユーザーメモリへのデータ転送が必要
- データは単一の読み取りプロセスのみが参照でき、読み取りにより消費される
- 読み取りプロセス、書き込みプロセスは自動的に同期する
  - 読み取りプロセスは読み取れるデータがない場合、処理をブロックする

#### 種類
- バイトストリーム - 区切りを持たない形式のデータ(任意のバイト数)を通信する
  - パイプ
  - FIFO
  - ストリームソケット
- メッセージ - 区切りを持つ形式のデータを通信する
  - SystemVメッセージキュー
  - POSIXメッセージキュー
  - データグラムソケット
- 疑似端末 - ある専用の状況下での使用を想定した通信手段

### 共有メモリ
- 複数プロセスがあるメモリ領域を共有し、データをそのメモリへ配置することで交換する
  - カーネル内ではRAM上の同じページを参照するよう、それぞれのプロセスのページテーブルを操作する
  - ユーザーメモリ - カーネルメモリ間のデータ転送を必要としないため高速に通信する
- データはデータが置かれたメモリを共有する全プロセスから参照できる
- プロセスが共有メモリ内のデータを更新中は、他のプロセスはデータにアクセスすべきではない
  - セマフォを利用して同期を取る

#### 種類
- SystemV共有メモリ
- POSIX共有メモリ
- メモリマッピング
  - 無名マッピング
  - ファイルマッピング

## 同期機構
- 複数プロセスの動作を協調させる

### セマフォ
- カーネルが管理する整数(数値0を下回ることはない)
- プロセスはセマフォをインクリメント / デクリメントする
  数値0未満へデクリメントしようとしたときに、値がインクリメントされるまで
  カーネル内で処理をブロックする

#### 種類
- SystemVセマフォ
- POSIXセマフォ
  - 名前付きセマフォ
  - 無名セマフォ

### ファイルロック
- 同じファイルを処理する複数プロセスの協調動作を目的に開発された同期機構
  - ファイル以外の共有リソースにも使用できる
- リードロック / ライトロックの組み合わせによって排他制御を行う

#### 種類
- レコードロック(`fnctl(2)`)
- ファイルロック(`fnctl(2)`)

### mutex(スレッド) / 条件変数(スレッド)
- POSIXスレッドから使用する同期機構

## シグナル
- 標準シグナル
- リアルタイムシグナル

## IPCの比較
### IPC IDとハンドル

| 種類                           | 識別子                  | オブジェクトを参照するハンドル |
| -                              | -                       | -                              |
| パイプ                         | なし                    | ファイルディスクリプタ         |
| FIFO                           | パス名                  | ファイルディスクリプタ         |
| UNIXドメインソケット           | パス名                  | ファイルディスクリプタ         |
| インターネットドメインソケット | IPアドレス + ポート番号 | ファイルディスクリプタ         |
| SystemVメッセージキュー        | SystemV IPC キー        | SystemV IPC ID                 |
| SystemVセマフォ                | SystemV IPC キー        | SystemV IPC ID                 |
| SystemV共有メモリ              | SystemV IPC キー        | SystemV IPC ID                 |
| POSIXメッセージキュー          | POSIX IPC パス名        | メッセージキューディスクリプタ |
| POSIX名前付きセマフォ          | POSIX IPC パス名        | セマフォポインタ               |
| POSIX無名セマフォ              | なし                    | セマフォポインタ               |
| POSIX共有メモリ                | POSIX IPC パス名        | ファイルディスクリプタ         |
| 無名マッピング                 | なし                    | なし                           |
| メモリマッピング               | パス名                  | ファイルディスクリプタ         |
| `flock()`ロック                | パス名                  | ファイルディスクリプタ         |
| `fnctl()`ロック                | パス名                  | ファイルディスクリプタ         |

### 機能
- データ転送は読み取り・書き込み動作が伴い、読み取りにより消費される
  読み取り側・書き込み側の動作同期はカーネルが自動的に処理する
- 共有メモリはあるメモリ領域を共有する複数プロセス間で、
  いずれかプロセスがその領域へ書き込んだデータは他の全プロセスから参照可能になる
- ネットワークを介した通信が可能な手段はソケットのみ
- POSIX IPCはそれほど普及しておらずSystemVに比べると可搬性が低い
- SystemV IPCは設計上の問題があり使用上不便

### アクセス可否

| 種類                           | アクセス可否                   | 永続性           |
| -                              | -                              | -                |
| パイプ                         | 関連プロセスのみ               | プロセス         |
| FIFO                           | パーミッションマスク           | プロセス         |
| UNIXドメインソケット           | パーミッションマスク           | プロセス         |
| インターネットドメインソケット | 任意のプロセス                 | プロセス         |
| SystemVメッセージキュー        | パーミッションマスク           | カーネル         |
| SystemVセマフォ                | パーミッションマスク           | カーネル         |
| SystemV共有メモリ              | パーミッションマスク           | カーネル         |
| POSIXメッセージキュー          | パーミッションマスク           | カーネル         |
| POSIX名前付きセマフォ          | パーミッションマスク           | カーネル         |
| POSIX無名セマフォ              | 対応するメモリのパーミッション | メモリ併存       |
| POSIX共有メモリ                | パーミッションマスク           | カーネル         |
| 無名マッピング                 | 関連プロセスのみ               | プロセス         |
| メモリマッピング               | パーミッションマスク           | ファイルシステム |
| `flock()`ロック                | ファイルの`open(2)`            | プロセス         |
| `fnctl()`ロック                | ファイルの`open(2)`            | プロセス         |
