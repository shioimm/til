# サーバー設計
- 参照: Linuxプログラミングインターフェース 60章

## 共通
- サーバーをデーモン化する
- クライアントへ送信できなかった場合は`syslog(2)`によりログ出力する

## 反復サーバー
- 一度に1クライアントを処理し、完了するまで次のクライアント処理を開始しない

## 並行サーバー
- 複数のクライアントを同時に処理する

### マルチプロセス
- 無限ループでクライアントからの接続要求を受け付け、接続のたびに`fork()`を行う
  - リスニングソケット、接続ソケットは`fork()`のたびに子プロセスに複製される
  - 親プロセスは接続ソケットを閉じ、子プロセスはリスニングソケットを閉じる
  - 子プロセスは1クライアントのみを処理し、終了する
- ゾンビプロセスが発生した場合に消滅させる処理を行う(Ex. `SIGCHLD`のシグナルハンドラ)

### Prefork(Prethread)
- クライアントごとに子プロセス(スレッド)を新規作成せず、
  サーバー起動直後に限定数の子プロセス(スレッド)を予め作成する(サーバープール)
- サーバープール内の子プロセス(スレッド)は1クライアントを処理する
  処理終了後、別途保持されるデータから次のクライアントを取り出し、処理を開始する
- サーバープールにはクライアントからの接続要求に対応できるプロセス(スレッド)数が必要
- 親プロセス(スレッド)は空きリソース数を管理し、必要に応じてスケールアップ・ダウンさせる
- サーバープール内の子プロセス(スレッド)ではクライアントからの接続要求を排他的に選択する
  - 子プロセス(スレッド)それぞれがリスニングソケットを`accept()`するようにする
    - 親プロセスは子プロセス作成前にリスニングソケットを作成する
    - 子プロセスは`fork()`によりリスニングソケットの複製を持つ
  - あるいは親プロセスが`accept()`し、得たディスクリプタを子プロセスに送信する

### イベント駆動
- 1プロセスで同時に複数のディスクリプタのIOイベントを監視する
  - IO多重化、シングルドリブンIO、`epoll`
- シングルサーバー設計ではスケジューリングをサーバープロセスが実行する
  - 一部のクライアントがサーバーを独占する事態を回避する

### サーバーファーム
- サーバーシステムを複数台用意する

#### DNSラウンドロビンロードシェアリング
- 権威を持ったネームサーバー(ANS)がひとつのドメイン名に複数のIPアドレスを登録しておき、
  該当ドメイン名の問い合わせを受けると複数のIPアドレスをラウンドロビンで順に返す
- DNSサーバーは反復サーバーであるため、問い合わせ結果をキャッシュする必要がある
- DNSラウンドロビンはロードバランス機能や高可用性を備えていない
- 同一クライアントから複数回に分けて送信されるデータを必ず同じサーバーに向けることは困難

### サーバー負荷分散
- 一台のロードバランスサーバーがサーバーファーム内から一台を選択し、
  クライアントからの接続要求を振り分ける
  - ロードバランスサーバークラッシュ時に代替するバックアップサーバーが用意されることもある
- サーバーファームは公開IPアドレスをひとつしか持たない(ロードバランスサーバーのIPアドレス)
- ロードバランスサーバーはサーバー負荷を測定または予測するアルゴリズムを実装する
- サーバーファーム内のサーバーに以上が発生した場合はロードバランスサーバーが検知する
