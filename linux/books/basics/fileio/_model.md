# ファイルIOモデル
- 参照: 例解UNIX/Linuxプログラミング教室P133
- 参照: 詳解UNIXプログラミング第3版 3. ファイル入出力
- 参照: Linuxによる並行プログラミング入門 第3章 ファイル入出力 3.2
- 参照: Linuxプログラミングインターフェース 2章 / 4章

## TL;DR
- UNIXシステムのIOモデルにおいては、一つのシステムコールが全種類のファイルに対するIOを処理する
- IOを処理するシステムコールはオープンしたファイルをファイルディスクリプタによって参照する

## ファイルディスクリプタ
- IOシステムコールが対象のファイルを特定し、プロセスとファイルを結びつけるための識別子(整数値)
  - プロセスごとに固有の値となる
  - ファイルを開くと生成される
  - ファイルを閉じると削除される
- ファイルディスクリプタが開かれている間、
  そのファイルに対するカレントファイルオフセットが保持される
  - カレントファイルオフセットはファイルを開いた時点で0に初期化される
- シェルから起動されたプロセスは、オープン済みのファイルディスクリプタを受け継ぐ
  (標準入力・標準出力・標準エラー出力)
- `open(2)`すると、その時点で空いている番号のうち、最小の番号がファイルディスクとなる

### 標準ファイルディスクリプタ
| FD | 用途           | POSIX名         | stdioストリーム  |
| -  | -              | -               | -                |
| 1  | 標準入力       | `STDIN_FILENO`  | `stdin`          |
| 2  | 標準出力       | `STDOUT_FILENO` | `stdout`         |
| 3  | 標準エラー出力 | `STDERR_FILENO` | `stderr`         |

- 標準入力にはEOFが無い
  - 出力が常に入力待ちの状態になる
  - `Ctrl + D`でシグナルを送出する

### `/dev/fd/`
- カーネルはプロセスそれぞれに専用の`/dev/fd`ディレクトリを実装している
  - `/dev/fd/0` - 標準入力(シンボリックリンク: `/dev/stdin`)
  - `/dev/fd/1` - 標準出力(シンボリックリンク: `/dev/stdout`)
  - `/dev/fd/2` - 標準エラー出力(シンボリックリンク: `/dev/stderr`)
  - `/dev/fd/n` - ファイルディスクリプタn
- プロセスが`/dev/fd/n`を開くのはプロセスがファイルディスクリプタnを複製するのと同じ
  - `open("dev/fd/1", WR_ONLY)` = `dup(1)`
    - 同一のファイルテーブルエントリを共有する
- `/dev/fd`は`/proc/self/fd`のシンボリックリンク
  - `/proc/self/fd`は`/proc/PID/fd`を取り出したもの

## ファイル情報の管理
### ファイルディスクリプタテーブル(プロセス毎)
- ファイルディスクリプタの情報を格納するテーブル
  - プロセスごとに生成・管理される
    - プロセスがファイルディスクリプタを開閉するとテーブルが更新される
  - テーブル内の1エントリが1ファイルディスクリプタに対応する

#### テーブルエントリが持つ情報
- ファイルディスクリプタを操作する際にその動作を制御するフラグ(`close-on-exec`)
- オープンしたファイル情報へのポインタ

#### リソースの共有範囲
- ファイルディスクリプタが異なっていてもオープンファイル情報が同じなら
  ファイルオフセット/オープンファイルステータスフラグ情報は複数のプロセスで共有される
- ファイルディスクリプタの情報はプロセスに固有のため、
  ファイルディスクリプタが持つフラグは複数のプロセスで共有されない

### オープンファイルテーブル(システム全体)
- システム全体のオープンファイルの情報を格納するテーブル
- オープンファイルテーブルエントリはファイルストリーム(`FILE`)として表すことができる

#### テーブルエントリ(オープンファイルハンドル)が持つ情報
- カレントファイルオフセット
- ファイルステータスフラグ
- ファイルアクセスモード
- シグナルドリブンIO情報
- ファイルのi-node(メモリi-node)へのポインタ

### i-nodeテーブル(システム全体)
- i-node(各ファイルに対応するメタ情報)エントリを格納するテーブル
  - i-modeテーブルはファイルシステム内に格納される
  - 各オープンファイルハンドルから参照される

#### テーブルエントリ(i-node)が持つ情報
- ファイル種別
- UID / GID
- パーミッション
- タイムスタンプ(最終ファイルアクセス時刻、最終ファイル変更時刻、最終i-node変更時刻)
- ハードリンクカウント
- ファイルサイズ
- ファイルに割り当てた実ブロック数
- ファイルデータを保存したデータブロックへのポインタ

#### i-nodeの種類
- ディスクi-node
  - i-nodeが持つ情報を永続的に保存する
- メモリi-node
  - ファイルアクセス時にメモリ上に作成されるディスクi-nodeの複製

## ファイル操作の不可分性
- 二つのプロセスが同じファイルを操作する際に操作がコンフリクトした場合
  操作Aが完了してから操作Bを行う
  操作Bが完了してから操作Aを行う のいずれかの挙動を取る
  操作Aと操作Bの結果が混ざることはない
