# ログイン
- 参照: 詳解UNIXプログラミング第3版 9. プロセスの関係

## 端末ログイン
### 手順
- (0) 端末装置ごとの設定ファイル`/etc/ttys`を設定
- (1) システムがブート
- (2) プロセスID1でプロセス`init`を作成
- (3) `init`がシステムをマルチユーザーモードに移行
- (4) `init`がファイル`/etc/ttys`を読み取りログイン可能な各端末装置に対して`fork`を実行
- (5) `fork`された子プロセスがプログラム`getty`を`exec`
  - プロセスの実ユーザーID / 実行ユーザーIDは0(スーパーユーザー)
- (6) `getty`が端末装置を読み書きモードで`open`
  - ファイルディスクリプタ0 - `STDIN` / 1 - `STDOUT` / 2 - `STDERR`が設定される
- (7) `getty`がユーザー名の入力を待つ
- (8) ユーザー名が入力されると`getty`が環境を初期化してプログラム`login`を`exec`
- (9) `login`がパスワードファイルのエントリを取得(`getpwnam`)
- (10) `login`がパスワードの入力を待つ
- (11) パスワードが入力されると`login`はパスワードを暗号化(`crypt`)
- (12) 暗号されたパスワードとシャドーパスワードファイルのエントリーフィールド(`pw_passwd`)を比較
  - 不正なパスワードが複数回入力された場合は`login`が
  `exit`を呼び、(4)からやり直し
- (13) 正しくログインできた場合`login`配下の処理を実行
  - ホームディレクトリに移動(`chdir`)
  - 端末装置の所有者をユーザーに変更(`chown`)
  - 端末装置のアクセス許可を変更し、ユーザーに読み書きを許可
  - グループIDを設定(`setgid` / `initgroups`)
  - 環境を初期化
    - `HOME` / `SHELL` / `USER` / `LOGIN` / `PATH`
  - ユーザーのユーザーIDに変更(`setuid`)
  - ユーザーのログインシェルを起動
    - `execle("/bin/sh", "-sh", (char *)0);`
- (14) ユーザーのログインシェルが始動ファイル(`.bash_profile`など)を読み込み

## ネットワークログイン
- 全てのログインはカーネルのネットワークインターフェースドライバ(Ex. Ethernet)を介する
- 端末ログインと同じソフトウェアで処理するため
  擬似端末(pseudo terminal)を利用して
  シリアル端末の振る舞いをエミュレートする

### 手順
- (1) プロセス`init`がシェルスクリプト`/etc/rc`を実行するシェルを起動
- (2) シェルスクリプト`/etc/rc`がインターネットスーパーサーバー`inetd`を起動
  - インターネットスーパーサーバー - スーパーデーモン
    - 全ての接続要求を受け取り、適切なデーモンプロセスに受け渡す
  - `/etc/rc`が終了すると`init`が`inetd`の親プロセスとなる
  - 拡張インターネットサービスデーモン`xinetd`が使われるディストリビューションもある
    - `xinetd` - `inetd`よりも細かい制御を行うことができる
- (3) `inetd`がホストの到着するTCP/IPの接続要求を待つ
- (4) 接続要求が到着する
- (5) `inetd`は`fork`する
- (6) `fork`された子プロセスは要求されたアプリケーションを起動するプログラムを`exec`する
- (7) `exec`されたプログラムは擬似端末装置をオープンし、`fork`する
  - 親子は擬似端末装置を介して接続する
- (8) `fork`された親プロセスはネットワーク接続を介した通信を処理する
- (9) `fork`された子プロセスはプログラム`login`を`exec`する
- (10) `login`プロセスは端末ログインの手順を踏み、環境を初期化する
- (11) `login`プロセスが`exec`で自身をユーザーのログインシェルに置き換える

## `utmp` / `wtmp`ファイルの更新
- ログイン時、そのユーザーがログインしたことを示すレコードを`utmp`ファイルへ記録する
- ログアウト時、先に`utmp`ファイルへ記録したレコードを削除する
