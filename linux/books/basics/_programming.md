# システムプログラミング
- 参照: Linuxプログラミングインターフェース 3章

## システムコール
- カーネルの機能を呼び出すためのAPI
  - glibcラッパー関数から呼ばれる
  - 「システムコールを実行する」 = システムコールを実行するglibcラッパー関数をコールする
- `syscall(2)` - カーネルが提供するシステムコール一覧

### 特性
- システムコールはプロセスの状態をユーザーモードからカーネルモードに移行させる
  - カーネルモードにおいて、CPUは保護されたカーネルメモリへのアクセスも可能
- システムコールセットは固定されており、全てのシステムコールには一意な番号が割り振られている
  - システムコール番号はカーネルが`sys_call_table`から呼び出すシステムコールを特定するために使用される
- システムコールは必要な情報を得るための引数を実装できる
  - ユーザー空間(プロセスの仮想アドレス空間) -> カーネル空間
  - カーネル空間 -> ユーザー空間(プロセスの仮想アドレス空間)

### システムコールの呼び出し手順
1. [ユーザーモード]アプリケーションプログラムからglibcラッパー関数が呼ばれる
2. [ユーザーモード]glibcラッパー関数がシステムコール番号を特定のレジスタに置く
3. [ユーザーモード]glibcラッパー関数がトラップ命令を実行する
4. カーネルモードへ移行
5. [カーネルモード]カーネルが`sys_call`ルーチンをコール
6. [カーネルモード]カーネルがレジスタをカーネルスタックへ退避
7. [カーネルモード]カーネルがカーネルスタックからシステムコール番号を取り出す
8. [カーネルモード]カーネルが`sys_call_table`から呼び出すシステムコールを特定し、実行
9. [カーネルモード]カーネルがシステムコールの返り値をカーネルスタックに置く
10. ユーザーモードへ移行

### エラーハンドリング
- システムコールでエラーが発生した場合:
  - エラーを表す返り値`-1`が返る
  - グローバル変数`errno`へエラーの原因を表す整数値が代入される
    - `<errno.h`をインクルードすることでエラーを表す定数と共に参照できる
    - システムコール・ライブラリ関数終了後も`errno`はリセットされない

## ライブラリ関数
- 標準Cライブラリを構成する関数
  - 内部でシステムコールを実行する(一部を除く)
- 代表的な標準Cライブラリ実装はGNU Cライブラリ(glibc)

### ライブラリパスの確認
- glibcとリンクされたプログラムをパラメータに渡して`ldd(1)`を実行する

```
$ ldd xxx | grep glibc

# glibcのインストール先が表示される
```

### glibcバージョンの確認
- `gnu_get_libc_version(3)` - 実行時のglibcのバージョンを表示

### エラーハンドリング
- ライブラリ関数の戻り値の型は様々
  - `-1`を返し、`errno`を更新する
  - `-1`以外を返し、`errno`を更新する
  - `errno`を一切使用しない
