# `pthread`ライブラリ
- 参照: Linuxとpthreadsによるマルチスレッドプログラミング入門 Chapter1-6

## TL;DR
- スレッドの管理
- 動作の排他(動作同期)
- イベント通知(条件待ち同期)
- 動作の一時停止
  - 該当の関数は存在しない

## Linuxにおけるスレッド
- スレッドはプロセス起動時に作成される(メインスレッド)
- プロセスは起動時に作成されるスレッド以外にも新たにスレッドを生成することができる
  - プロセスを取り扱うコマンドにおいてはメインスレッドのみが見えるようになっている
- Linuxは内部的にはスレッドに対してPIDに相当する番号を発行している(SPID)
  - メインスレッドのSPIDはプロセス起動時に発行されたPID
  - メインスレッド以外のスレッドのSPIDはメインスレッドのSPIDからインクリメントされる
  - プロセスに紐づく全てのスレッドのPIDは元のプロセスのPID

## スレッドの返り値
- スレッドが実行した関数がreturnされたときの返り値
- `pthread_exit(3)`の返り値

## スレッドの終了条件
- スレッドが実行した関数がreturnされたとき
- プロセスが終了したとき
  - プロセス内の全てのスレッドが強制終了する
  - `pthread_join(3)` - 全てのスレッドの終了を待ち合わせてからプロセスを終了する
- スレッド実行関数からさらに別の関数を呼び出し、その先では`pthread_exit(3)`が呼ばれたとき
- 他のスレッドから停止されられたとき
  - `pthread_cancel(3)` - スレッドから他のスレッドに停止要求を出す

## スレッドコンテキスト
- OSがスレッドの状態を保持するためのメモリ
  - スレッドの返り値を含む
- OSはスレッドの実行が終了した後もスレッドコンテキストを持ち続ける

## データ共有
### スレッド間で共有されるもの
- メモリ空間
  - スタック領域上の変数(関数の中の変数)はスレッドごと・関数呼び出しごとに異なる
    - スレッドごとに異なるスタック領域が用意される
    - メモリ空間自体は同一であるため、
      確保しているスタック領域のメモリアドレスがわかれば他のスレッドのスタック領域にアクセスすることが可能
  - スタック領域以外のメモリ空間はスレッド間で共通
    - `malloc(3)`はマルチスレッドセーフなので状態が競合することはない
- ファイルディスクリプタ
- ソケット
- スレッド
- プロセス属性
  - プロセスID
  - ユーザーID
  - カレントディレクトリ
  - リソース制限
  - nice値(プロセスの動作の優先順位を決める)
  - Ex1. 同じプロセス内のスレッドのうち、どのスレッドでファイルを新規作成してもオーナーは同じ
  - Ex2. あるスレッドで`chdir(2)`を実行した場合、他のスレッドのカレントディレクトリも変更される
  - Ex3. プロセスあたりのFD数に制限がある場合、全てのスレッドで開いているFDの合計数が対象になる

### マルチスレッドセーフ(リエントラント)
- スタック領域以外に隠そうされている変数は全てのスレッドで共有されている
- 関数内部でグローバル変数を使っている場合、その関数はマルチスレッドセーフではない
  - Ex. `localtime(3)` - 返り値がライブラリ内部のグローバル変数へのポインタになっている
    -> 他のスレッドが呼び出した場合、変数に格納した値が変わる
```c
#include <time.h>

time_t now;
time(&now);

const struct tm *nowtm = localtime_r(&now);
printf("%02d:%02d:%02d\n", nowtm->tm_hour, nowtm->tm_min, nowtm->tm_sec);
```
- C言語においてはマルチスレッドセーフであることを保障するため
  リエントラント化した関数を使用する(`関数名_r(3)`)
  - スタック上で変数を定義し、スレッド間の影響を排除しつつ関数の引数に持たせる
```c
#include <time.h>

time_t now;
time(&now);

struct tm nowtm;
localtime_r(&now, &nowtm);
printf("%02d:%02d:%02d\n", nowtm.tm_hour, nowtm.tm_min, nowtm.tm_sec);
```

### スレッドローカル変数
- スレッドごとに異なる値を持つ変数
- 可読性が下がり速度も遅くなるため、使用を避ける方が望ましい(代わりに構造体を使用するなど)
  - `pthread_key_t`型 - キー番号
  - `pthread_key_create(3)`  - スレッドローカル変数の用意
  - `pthread_key_delete(3)`  - スレッドローカル変数の削除
  - `pthread_setspecific(3)` - スレッドローカル変数の設定
  - `pthread_getspecific(3)` - スレッドローカル変数の読み取り
