# プロセス
- プログラミングElixir 第15章

## プロセスの性質
- Elixirにおけるプロセスは、OSレベルのプロセスではなく
  Erlangでサポートされているプロセス
- プロセスは他のプロセスとメッセージを送受信する(アクターモデル)
- プロセスは一度メッセージの送受信を行うと終了する

## プロセスの開始
- `spawn` / `spawn_link` / `spawn_monitor`
  - 新しいプロセスを生成し、指定のプログラムを実行させ、プロセス識別子(PID)を返す
  - `spawn_link`で生成されたプロセスは、生成した側のプロセスへリンクされる
  - `spawn_monitor`で生成されたプロセスは、生成した側のプロセスからモニタされる

## メッセージの送受信
- `receive` - メッセージの受信時
- `send` - メッセージの送信

```exs
# プログラミングElixir 15.1 spawn/spawn-basic1 - 4.ex

# -- spawnされたプロセス側 --
defmodule Spawn do
  def greet do
    # spawnsしたプロセスからメッセージを受信
    receive do
      # spawnしたプロセスへメッセージを送り返す
      { sender, msg } -> send sender, { :ok, "Hello, #{msg}" }

      # 繰り返し処理のために再帰を呼ぶ
      greet()
    end
  end
end


# -- spawnしたプロセス側 --

pid = spawn(Spawn, :greet, [])

# spawnしたプロセスへメッセージを送信
send pid, { self(), "World!" }

# spawnされたプロセスからメッセージを受信
receive do
  { :ok, message } -> IO.puts message
end
```

### メッセージの送受信の失敗
- すでに終了しているプロセスにメッセージを送信した場合
  処理がブロックされる
  - `after 秒数 -> 処理`でタイムアウトを設定しておく

## プロセスの終了
- プロセスは通常、終了時にどこにも通知を送らない
- プロセス終了時に別のプロセスも終了させたい -> リンク
- プロセス終了時に終了したことを通知させたい -> モニタ

### リンク
- プロセスをリンクした場合、
  リンクされた側のプロセスが異常終了する際にリンクした側のプロセスへエラーメッセージを送信する
  リンクした側のプロセスも終了する
- `Process.flag(:trap_exit, true)` - 対象のプロセスの終了をトラップする
  - リンクされた側のプロセスが終了する際に、リンクした側のプロセスへメッセージを送信する

### モニタ
- プロセスをモニタした場合、
  モニタされた側のプロセスが終了する際にモニタした側のプロセスへ`:DOWN`メッセージを送信する
- `Process.monitor` - 対象のプロセスの終了を監視する
  - 呼び出し完了前に対象のプロセスが完了すると競合状態が発生する
