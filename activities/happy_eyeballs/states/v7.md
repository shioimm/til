# 状態遷移についての理解 (7)
- selectが複数の値を返すケースを考慮する

```
扱うリソース
- Resolution waiting pipe
- Hostname resolution queue # TODO キューである必要性があるかどうかを考える
- Resolved addrinfos
  - Resolved addrinfo
- Connecting sockets
- Writable sockets
  - Writable socket

---

Thread.new { IPv6 Addrinfo.getaddrinfo }
Thread.new { IPv4 Addrinfo.getaddrinfo }

loop do
  select(Resolution waiting pipe, Connecting sockets, Ends at)
  # キューが閉じている場合、第一引数はnil

  if イベント発生: Writable sockets: any (*)
    Writable socket = Writable sockets.pop
    Connecting sockets.remove Writable socket
    getsockopt(<接続エラーの確認>)

    case 接続エラー: あり
      return Writable socket
    case 接続エラー: なし
      if Writable sockets: any
        retry (*)
      if Writable sockets: empty
        # WIP
        case Resolved addrinfos: any && Connecting sockets: any && Hostname resolution queue: opened
        case Resolved addrinfos: any && Connecting sockets: any && Hostname resolution queue: closed
        case Resolved addrinfos: any && Connecting sockets: empty && Hostname resolution queue: opened
        case Resolved addrinfos: any && Connecting sockets: empty && Hostname resolution queue: closed
        case Resolved addrinfos: empty && Connecting sockets: any && Hostname resolution queue: opened
        case Resolved addrinfos: empty && Connecting sockets: any && Hostname resolution queue: closed
        case Resolved addrinfos: empty && Connecting sockets: empty && Hostname resolution queue: opened
        case Resolved addrinfos: empty && Connecting sockets: empty && Hostname resolution queue: closed
      end
    end
  end

  if イベント発生: Hostname resolution queue: any
    # TODO キューが空になるまで取得が必要
    Resolved family, Resolved addrinfos = Hostname resolution queue.pop
    Resolved addrinfos.add(Resolved family, Resolved addrinfos)

    case Resolved family: IPv6 && Resolved addrinfos: IPv4 resolved
      # Do nothing
    case Resolved family: IPv6 && Resolved addrinfos: IPv4 not yet resolved
      # Do nothing
    case Resolved family: IPv4 && Resolved addrinfos: IPv6 resolved
      # Do nothing
    case Resolved family: IPv4 && Resolved addrinfos: IPv6 not yet resolved
      Ends at = now + Resolution Delay # このループでは接続試行を開始しない
  end

  if Ends at: 現在時刻を超過 && Resolved addrinfos: any
    if Local addrinfos
    end

    # ...
  end
end
```
