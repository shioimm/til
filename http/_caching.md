# キャッシュ
## 分類
### 機構による分類
- クライアント側のキャッシュ(ローカルキャッシュ) - ブラウザキャッシュ
- 配信経路上のキャッシュ - CDNのキャッシュ
- オリジンのキャッシュ(ゲートウェイキャッシュ) - プロキシのキャッシュ

### 対象による分類
- private - 特定のクライアントのみが参照可能なキャッシュ(e.g. ユーザー情報を含むAPI)
- shared - 複数のクライアントから参照可能なキャッシュ(e.g. 画像やCSS)

| 種類    | クライアントとの対応 | 格納できる場所                   |
| -       | -                    | -                                |
| private | 1:1                  | ローカル                         |
| shared  | 1:n                  | ローカル + 経路上 + ゲートウェイ |

### 仕組みによる分類
#### 更新日時によるキャッシュ
1. サーバーはコンテンツの送信時、レスポンスヘッダにLast-Modifiedを含める
2. クライアントはリクエストヘッダにLast-Modifiedの値から生成したIf-Modified-Sinceを含める
3. サーバーはLast-ModifiedとIf-Modified-Sinceを比較し、レスポンスボディにコンテンツを含めるか判断する

#### 有効期限によるキャッシュ
1. サーバーはレスポンスヘッダにExpiresを含める
2. クライアントはExpiresの値を元に、キャッシュを利用するかリクエストを送信するか判断する

#### ファイルに関連するハッシュ値によるキャッシュ
1. サーバーはコンテンツの送信時、レスポンスヘッダにETagを含める
2. クライアントはリクエストヘッダにETagの値を付与したIf-Modified-Sinceを含める
3. サーバーはEtagとIf-Modified-Sinceを比較し、レスポンスボディにコンテンツを含めるか判断する

#### Cache-Controlヘッダによるキャッシュ
- コンテンツの送信時、レスポンスヘッダにCache-Controlを含める
  - キャッシュの設定を柔軟に行う
    - `no-cache` - キャッシュが有効かどうか毎回サーバーに問い合わせる(`max-age=0`と同じ)
    - `no-store` - キャッシュしない
    - `max-age` - キャッシュの鮮度(秒)
    - `public` - 同一のコンピュータを使う複数ユーザー間でキャッシュを再利用する
    - `private` - 同一のコンピュータを使う複数ユーザー間でキャッシュを再利用しない
    - `immutable` - コンテンツが変化しないことを保証する

```
no-cache            / no-cache                     / max-age
(キャッシュを削除)    (キャッシュの鮮度を0に設定)    (キャッシュの鮮度を設定)
--------------------------------------------------------------------------------
                    | public                       / private
                    | (共有キャッシュに保存)         (個人キャッシュに保存)
```

#### Varyヘッダによるキャッシュ
- コンテンツの送信時、レスポンスヘッダにVaryを含める
  - ユーザー(Ex. User-Agent)ごとに異なるコンテンツを返す

## キャッシュしない条件
- 冪等ではないメソッドの使用時
- Cache-Controlヘッダに`private`が設定されている場合
- Cache-Controlヘッダに`no-store`が設定されている場合
- Authorizationヘッダがあるが、Cache-Controlヘッダに`public`が設定されていない場合
- ステータスコードが200 / 203 / 207 / 302 / 410 / 404以外

## 参照
- Real World HTTP 第2版
- Web配信の技術
