# 条件
## キャッシュする条件
- 全ての条件を満たしているとき、
  レスポンスのCache-Controlヘッダに`public`を含む場合はprivateキャッシュ、
  そうでない場合はsharedキャッシュとして保存される

### 条件(AND)
- リクエストメソッドが解釈可能であり、キャッシュ可能なメソッドとして定義されている(RFC7231#4.2.3)
  - GET / HEAD / POST(あまり使われない)
- ステータスコードが解釈可能(RFC7231#6.1)
  - 200 / 203 / 204 / 206
  - 300 / 301
  - 404 / 405 / 410 / 414 / 421(RFC7540#9.1.2) / 451(RFC7725#3)
  - 501
- リクエスト・レスポンスのCache-Controlヘッダに`no-store`が含まれていない
- 経路上のキャッシュ(shared)として格納しようとしている場合:
  - レスポンスのCache-Controlヘッダに`private`の指定がない
  - リクエストにAuthorizationヘッダが含まれていない(明示的に許可している場合を除く)
- レスポンスであり以下のうちどれかを満たす場合:
  - Expiresヘッダを含む
  - Cache-Controlヘッダに`max-age`を含む
  - 拡張ディレクティブで明示的に許可されているもの
  - ステータスコードがデフォルトでキャッシュ可能
  - 経路上のキャッシュ(shared)として格納しようとしている場合:
    - Cache-Controlヘッダに`s-max-age`を含む

#### キャッシュしない条件
- 冪等ではないメソッド
- Cache-Controlヘッダに`private`が設定されている
- Cache-Controlヘッダに`no-store`が設定されている
- Authorizationヘッダがあるが、Cache-Controlヘッダに`public`が設定されていない
- ステータスコードが200 / 203 / 207 / 302 / 410 / 404以外

### TTLの計算
```
TTL = (Date - Last-Modified) / ブラウン座実装による定数(10)
```

## キャッシュを使う条件(AND)
- リクエストとキャッシュのURIが一致している
- キャッシュ格納時のメソッドがリクエストのメソッドで使えることを許容している
- キャッシュ中にVaryでヘッダが指定されている場合:
  - キャッシュ中のセカンダリキーとリクエストの指定ヘッダが一致している
- リクエスト中のCache-ControlかPragma内に`no-cache`を含む場合
  - キャッシュの検証が成功している
- キャッシュ中のCache-Control内に`no-cache`を含む場合
  - キャッシュの検証が成功している
- キャッシュの状態が以下のいずれかである
  - Fresh
  - Staleでの利用が許容されている
  - 検証が成功している


## 参照
- Real World HTTP 第2版
- Web配信の技術
