# HTTP/3の通信
- ストリームは各フレームを送受信し、ストリームタイプによって送受信できるフレームのタイプが異なる

## ストリーム
- HTTP/3における通信管理の仮想単位
- HTTP/3ではQUICストリームを利用してメッセージを送受信する
- HTTP/3のストリームはQUICの単方向ストリーム / 双方向ストリームをどのように使うかを定義する

### 単方向ストリーム
| タイプ名      | タイプ値          | 説明                                               |
| -             | -                 | -                                                  |
| Control       | 0x00              | 制御情報(通信に関わるパラメータ、エラー通知)の送信 |
| Push          | 0x01              | サーバー: サーバープッシュによるリソースのプッシュ |
| QPACK Encoder | 0x02              | QPACKの動的テーブルの更新操作                      |
| QPACK Decoder | 0x03              | QPACK Encoderの操作に対するフィードバック          |
| Reserved      | (0x1f * N) + 0x21 | 不明なストリームタイプを無視していることを確認     |

### 双方向ストリーム
| タイプ名      | タイプ値          | 説明                                               |
| -             | -                 | -                                                  |
| Request       | -                 | クライアント: 1リクエスト送信・1レスポンス受信     |

## フレーム
- HTTP/3におけるメッセージの単位
- QUICの`STREAM`フレームの中に格納される

### フレームタイプ
| タイプ名         | タイプ値 | 用途                                          | HTTP/2との相違点           |
| -                | 0x0      | -                                             | -                          |
| `DATA`           | 0x1      | コンテンツの送信                              | パディングがなくなる       |
| `HEADERS`        | 0x2      | HTTPフィールドの送信                          | 優先度が`PRIORITY`へ移動   |
| `CANCEL_PUSH`    | 0x3      | サーバープッシュのキャンセル                  | 新規                       |
| `SETTINGS`       | 0x4      | 通信に関わるパラメータの送信                  | コネクション開始時のみ送信 |
| `PUSH_PROMISE`   | 0x5      | サーバープッシュ開始の予約                    | -                          |
| `GOAWAY`         | 0x6      | エラーを通知し、通信を切断                    | サーバーのみ送信可         |
| `PRIORITY`       |          | 依存するストリーム、優先度、排他フラグ        | Controlストリーム上で送信  |
| `MAX_PUSH_ID`    | 0xD      | クライアントが受信可能なPush IDの最大値の通知 | 新規                       |

## 通信
### 通信開始
1. クライアント -> サーバー
    - HTTP/1.1もしくはHTTP/2でリクエストを送信する
2. サーバー -> クライアント
    - サーバー自身がHTTP/3に対応していることをAlt-Svcヘッダを利用してクライアントに通知
    - `Alt-Svc: h3=":ポート番号" ; ma=この情報の有効期間`
3. クライアント -> サーバー
    - 指定されたポートに対してQUICコネクションの確立を試行する
    - アプリケーションプロトコルのネゴシエーションに則ってHTTP/3通信を行うことに合意する
4. クライアント -> サーバー / サーバー -> クライアント
    - 両ノードがそれぞれControlストリームをオープン(HTTP/3通信の終了時までオープンしたままにする)
    - 両ノードがそれぞれ`SETTINGS`フレームを送信し、通信に関するパラメータを通知
    - クライアントはれ`SETTINGS`フレームの送信が終わればHTTPメッセージの送信を開始できる
5. クライアント <-> サーバー
    - クライアントがRequestストリームをオープン(複数のRequestストリームが並列に使用される)
    - クライアントはリクエストが格納された`HEADERS`フレーム・`DATA`フレームを送信
    - サーバーはレスポンスが格納された`HEADERS`フレームと`DATA`フレームを送信
6. サーバー -> クライアント
    - HTTPの送受信が終わるか、通信を継続できない不具合が発生した場合
    - サーバーがControlストリームをオープン
    - サーバーは`GOAWAY`フレームを送信し、受信中のHTTPメッセージの受信が完了するのを待つ
7. サーバー -> クライアント
    - サーバーがQUICでの即時クローズを実行(QUICの`CONNECTION_CLOSE`フレーム:0×1dを送信)

## 参照
- Real World HTTP 第2版
- WEB+DB PRESS Vol.123 HTTP/3入門
