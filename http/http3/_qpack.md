# QPACK
- ハフマン符号 + 辞書データによってHTTPフィールドを圧縮する仕様

## 辞書データ
- 辞書データであるテーブルを使ってフィールドを表現する
- テーブルの各エントリはインデックス番号、フィールド名、フィールド値を持つ
  - フィールド値は格納されていないこともある
  - インデックス番号は0番から始まる

#### 静的テーブル
- QPACKの仕様で定義された汎用的なフィールドを持つテーブル

#### 動的テーブル
- 1つのHTTP/3通信中に更新されていくテーブル
- 静的テーブルにないフィールドを個々にエントリとして追加する
- 通信ごとに管理される
- エントリに対しては行うことができる操作は追加と削除のみ
- キャパシティに達すると古いエントリから順に削除される

### 動的テーブルの状態
- エンコーダとデコーダ間でテーブルの状態を一致させる必要がある
  - エンコーダ - Requestストリームで`HEADERS`フレームを送信する側
  - デコーダ - Requestストリームで`HEADERS`フレームを受信する側
  - リクエストの場合クライアントがエンコーダ、サーバーがデコーダ
  - レスポンスの場合サーバーがエンコーダ、クライアントがデコーダ
- テーブルの状態を一致させるために単方向ストリームのQPACK Encoderストリームと
  QPACK Decoderストリームをそれぞれ1つずつ使用する

#### QPACK Encoderストリーム
- エンコーダはQPACK EncoderストリームをオープンしてEncoder instructionsメッセージを送信することにより
  動的テーブルにエントリを追加する
- 動的テーブルのエントリは、エンコーダが送信するRequestストリームの
  `HEADERS`フレームが格納するHeader Block Representationsから参照することによって利用できる

#### QPACK Decoderストリーム
- デコーダはQPACK DecoderストリームをオープンしてDecoder instructionsメッセージを送信することにより
  エンコーダにフィードバックを送信する
  - Header Acknowledgement - 動的テーブルを参照するストリームを処理した際、当該ストリームIDを示す
  - Insert Count Increment - 前回送信した後に動的テーブルに追加されたエントリの増分を示す
  - Stream Cancellation - Requestストリームのキャンセル: 動的テーブルを参照しなかったことを示す
- エンコーダはフィードバックを受信する
  - 動的テーブルの処理済みエントリを削除する
  - デコード側で追加されたエントリを把握する

## フィールドの表現
- フィールド群はハフマン符号やテーブルへの参照を使ってHeader Block Representations形式で表現され、
  `HEADERS`フレームに格納される
  - Indexed Field Line方式
    - テーブルのインデックス番号か相対インデックス番号のみでフィールドを表現する
  - Indexed Field Line With Post-Base Index方式
    - テーブルのPost-Baseインデックス番号のみでフィールドを表現する
  - Literal Field Line With Name Reference方式
    - フィールド名のみテーブルのインデックス番号か相対インデックス番号で表現する
    - フィールド値は文字列もしくはハフマン符号で表現する
  - Literal Field Line With Post-Base Name Reference方式
    - フィールド名のみテーブルのPost-Baseインデックス番号で表現する
    - フィールド値は文字列もしくはハフマン符号で表現する
  - Literal Field Line With Literal Name方式
    - フィールド名とフィールド値共にそれぞれ文字列もしくはハフマン符号で表現する
- 静的テーブルのエントリを参照する場合はインデックス番号を使用する
- 動的テーブルのエントリ参照する場合は相対インデックス番号もしくはPost-Baseインデックス番号を使用する
- 相対インデックス番号 - インデックス番号上の基準点よりいくつ小さいか
- Post-Baseインデックス番号 -  インデックス番号上の基準点よりいくつ大きいか

## 擬似ヘッダ
- HTTPフィールドをどのように`HEADERS`フレームに格納するかはQPACKによって定義される
- HTTP/1.1でステータスラインにあった情報はHTTP/3では擬似ヘッダとして表される

#### リクエスト擬似ヘッダ
| フィールド名 | フィールド値                           |
| -            | -                                      |
| :method      | リクエストメソッド                     |
| :scheme      | リクエストURLのスキーム                |
| :authority   | リクエスト先のドメイン(Hostヘッダ相当) |
| :path        | リクエストURLのパス                    |

#### レスポンス擬似ヘッダ
| フィールド名 | フィールド値                 |
| -            | -                            |
| :status      | レスポンスのステータスコード |

## HPACKとの関係
- QUICトランスポートによりストリーム内部でのパケット順序は保証されるが、
  ストリーム間のパケット順序が保証されなくなり、
  送信順序に依存するHPACKが利用できなくなった
- HPACKはテーブルのインデックスの位置がデフォルトで決定されているが、
  QPACKはインデックスの位置を追加でデータとして送信する


## 参照
- Real World HTTP 第2版
- WEB+DB PRESS Vol.123 HTTP/3入門
