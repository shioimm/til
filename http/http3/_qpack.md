# QPACK
- ハフマン符号 + 辞書データによってHTTPフィールドを圧縮する仕様

## HPACKとの関係
- QUICトランスポートにより、ストリーム内部でのパケット順序は保証されるが
  ストリーム間のパケット順序が保証されなくなり、
  送信順序に依存するHPACKが利用できなくなった
- HPACKに代わって導入されたQPACKでも、HPACKと同じハフマン符号による圧縮と辞書データ方式を使用する
- HPACKはテーブルのインデックスの位置がデフォルトで決定されているが、
  QPACKはインデックスの位置を追加でデータとして送信する

## 辞書データ
- HTTP/3通信は汎用的なフィールドを持つ静的テーブルと通信中に更新されていく動的テーブルをそれぞれ参照する
  - 動的テーブルは通信ごとに管理される
  - 動的テーブルのエントリに対しては追加と削除のみ操作を行うことができる
  - 動的テーブルはキャパシティに達すると、古いエントリから順に削除される
- テーブルの各エントリはインデックス番号、フィールド名、フィールド値を持つ
  - インデックス番号は0番から始まる

### 動的テーブルの状態
- `HEADERS`フレームを送信する側(エンコーダ)と受信する側(デコーダ)間でテーブルの状態を一致させる必要がある
1. エンコーダは動的テーブルにエントリを追加する
    - QPACK Encoderストリームをオープンし、Encoder instructionsメッセージを送信する
    - エンコーダが送信するRequestストリームの`HEADERS`フレームが格納するHeader Block Representationsから
      エントリを参照して使うことができる
2. デコーダはフィードバックを送信する
    - QPACK Decoderストリームをオープンし、Decoder instructionsメッセージを送信する
      - Header Acknowledgement - 動的テーブルを参照するストリームを処理した際、当該ストリームIDを示す
      - Insert Count Increment - 前回送信した後に動的テーブルに追加されたエントリの増分を示す
      - Stream Cancellation - Requestストリームのキャンセル: 動的テーブルを参照しなかったことを示す
3. エンコーダはフィードバックを受信し、動的テーブルの処理済みエントリを削除する
    - フィードバックにより、特定のエントリを参照する`HEADERS`フレームがデコーダに処理されたと判断する

### フィールドの表現
- フィールド群はハフマン符号やテーブルへの参照を使用してHeader Block Representations形式で表現され、
  `HEADERS`フレームに格納される
- 静的テーブルのエントリを参照する場合はインデックス番号を使用する
- 動的テーブルのエントリ参照する場合は相対インデックス番号もしくはPost-Baseインデックス番号を使用する

#### Indexed Field Line方式
- テーブルのインデックス番号か相対インデックス番号のみでフィールドを表現する

#### Indexed Field Line With Post-Base Index方式
- テーブルのPost-Baseインデックス番号のみでフィールドを表現する

#### Literal Field Line With Name Reference方式
- フィールド名のみテーブルのインデックス番号か相対インデックス番号で表現する
- フィールド値は文字列もしくはハフマン符号で表現する

#### Literal Field Line With Post-Base Name Reference方式
- フィールド名のみテーブルのPost-Baseインデックス番号で表現する
- フィールド値は文字列もしくはハフマン符号で表現する

#### Literal Field Line With Literal Name方式
- フィールド名とフィールド値共にそれぞれ文字列もしくはハフマン符号で表現する

## 擬似ヘッダ
- HTTPフィールドをどのように`HEADERS`フレームに格納するかはQPACKによって定義される
- HTTP/1.1でステータスラインにあった情報はHTTP/3では擬似ヘッダとして表される

#### リクエスト擬似ヘッダ
| フィールド名 | フィールド値                           |
| -            | -                                      |
| :method      | リクエストメソッド                     |
| :scheme      | リクエストURLのスキーム                |
| :authority   | リクエスト先のドメイン(Hostヘッダ相当) |
| :path        | リクエストURLのパス                    |

#### レスポンス擬似ヘッダ
| フィールド名 | フィールド値                 |
| -            | -                            |
| :status      | レスポンスのステータスコード |

## 参照
- Real World HTTP 第2版
- WEB+DB PRESS Vol.123 HTTP/3入門
