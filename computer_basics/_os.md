# OS
- 参照: 例解UNIX/Linuxプログラミング教室 システムコールを使いこなすための12講 P1-4/96
- 参照: [試して理解]Linuxのしくみ 第6章 記憶階層

## 役割
### プログラムの実行
- プログラムをファイルからメモリにコピー
  -> プログラムがコピーされたメモリ領域を指すようにプログラムカウンタを修正
  -> CPUがプログラムを実行
- プログラム実行中カーネルの実行は止まっている
  -> タイマー割り込みを使い割り込みハンドラなどを実行する
  -> プログラムカウンタがメモリ上のカーネルの位置に戻る
  -> プログラムの実行がカーネルに戻る

#### プログラムの実行順序
1. 命令をもとに、メモリからレジスタにデータを読み出す
2. レジスタ上のデータをもとに計算する
3. 計算結果をメモリに書き戻す

#### キャシュメモリ
- CPUに内蔵されているキャッシュ
- 1-2、2-3の操作を行う際に、直接メモリとレジスタ間にデータをやりとりするのではなく、
  キャッシュメモリを介在させることによって処理を高速化する
- 読み出すデータのサイズ(キャッシュラインサイズ)はCPUごとに定められている
- メモリ読み出し後、レジスタで値が書き換えられたデータは
  キャッシュライン上でダーティな状態になる
  ダーティなデータは所定のタイミングでバックグラウンド処理としてメモリに書き戻され
  キャッシュライン上ではダーティな状態でなくなる
- キャッシュメモリがいっぱいになった時、
  キャッシュ内に存在しないデータを読み書きしようとすると、
  既存のキャッシュラインのうち一つを廃棄し、新しいデータをキャッシュに読み出す

#### ページキャッシュ
- カーネルのメモリ上に存在するキャッシュ
- レジスタ - メモリ間のキャッシュであるキャッシュメモリに対して、
  メモリ - ストレージ間のキャッシュ
- キャッシュライン単位でデータを扱うキャッシュメモリに対して、
  ページキャッシュはページ単位でデータを扱う
- データは一旦カーネルのメモリ上にページキャッシュとしてコピーされ、
  プロセスのメモリにコピーされる
- データ更新の仕組み・容量枯渇時の仕組みはキャッシュメモリと同じ

### ブロック
- プログラムの実行を一時的に中断すること
  - OSはあるプログラムの実行がブロックした場合、他のプログラムの実行に切り替える(プロセス切り替え)

### マルチタスク
- 見かけ上同時に複数のプログラムを実行する(平行実行)仕組み
- 短時間で次々にプロセスの切り替えを行う

#### プリエンプション(横取り)
- ハードウェアタイマー割り込みを使用し、一定のタイムスライスごとに割り込みによって強制的にカーネルへ制御を移す仕組み

#### プリエンプティブ・マルチタスク
- プリエンプションを利用したタスクスケジューリング方式
- カーネルがCPU資源を管理する
- システムコール処理のタイミングにおいては、より優先度の高いタスク・プロセス・スレッドにCPUを割り当てる

#### ノンプリエンプティブ・マルチタスク
- 各タスク自身が短い時間間隔でOSに処理を返すタスクスケジューリング方式
- 各タスクがCPU資源を管理する

### システムコール
- アプリケーション(あるいはユーザー)からカーネルを仲介してハードウェアの操作を行う仕組み
  - カーネルだけにCPUの特権命令の実行が許可されている

#### システムコールとライブラリ関数
- システムコール - OSの一部
  - OS内部の機能を関数として呼び出すための仕組み
  - トラップ命令で呼び出されてカーネル空間で実行される
- ライブラリ関数 - プログラムの一部
  - コール命令で呼び出されてユーザー空間で実行される
  - ライブラリ関数の多くは内部でシステムコールを呼び出す
