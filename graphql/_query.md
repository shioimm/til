# クエリ
- 参照: [GraphQL](https://graphql.org/)
- 参照: 初めてのGraphQL 3章

## TL;DR
- GraphQLにおけるクエリは問い合わせ(`query`)と変更(`mutation`)の二種類
- GraphQLは全てのHTTPリクエストをPOSTリクエストとして発行する
- GraphQLはクエリをPOSTリクエストのbodyとして使用する

```
query {
  user {
    name
  }
}

# 上記のクエリは以下のHTTPリクエストに等しい
#   $ curl 'http://example.com/' \
#           -H 'Content-Type: application/json' \
#           --data '{"query":"{ allLifts { name }}"}'

mutation {
  setUserStatus(id: 1, status: OK) {
    name
    status
  }
}

# 上記のクエリは以下のHTTPリクエストに等しい
#   $ curl 'http://snowtooth.herokuapp.com/' \
#          -H 'Content-Type: application/json' \
#          --data '{"query":"mutation {setUserStatus(id: \"1\" status:OK) {name status}}"}'
```

- GraphQLサーバーはリクエストが指定したJSONを返す
  - 正常系 -> dataキーに返り値を与える
  - 異常系 -> errorキーに返り値を与える

## 文法
- ルート型 - `query` / `mutation`
- 選択セット - `{ }`で囲まれたブロック
- フィールド - 処理名

```
ルート型 フィールド {
  取得したいデータ
}
```

- クエリドキュメントトップレベルには複数のクエリを書ける
- 一回で実行できるのは一クエリのみ

```
ルート型 フィールド1 {
  取得したいデータ
}

ルート型 フィールド2 {
  取得したいデータ
}
```

- 複数のクエリを同時に実行するためにはトップレベルの一クエリの中で複数のクエリを書く必要がある

```
ルート型 フィールド0 {
  フィールド1 {
    取得したいデータ
  }

  フィールド2 {
    取得したいデータ
  }
}
```

### エイリアス / 引数 / ID
- レスポンスのキーをエイリアスとして指定可能
- クエリ引数を与えることが可能
- IDを指定しレコードの特定を行うことが可能
```
ルート型 フィールド0 {
  エイリアス1: フィールド1(引数名: クエリ引数)
  エイリアス2: フィールド2 {
    エイリアスA: 取得したいデータ
    取得したいデータ
  }
  フィールド3(id: IDの指定) {
    取得したいデータ
  }
}
```

### フラグメント
- フラグメントによってフィールドの再利用が可能
```
# フラグメントの定義

fragment フラグメント名 on オブジェクト型名 {
  取得したいデータ
  取得したいデータ
}

# フラグメントの利用

ルート型 {
  オブジェクト型名 {
    ...フラグメント名
  }
}

# フラグメントを立てた型と呼び出し時の型が一致していること
```

### ユニオン型
- 異なるオブジェクト型同士をユニオン型で表現できる
```
fragment フラグメント名1 on オブジェクト型名1 {
  取得したいデータA
}

fragment フラグメント名2 on オブジェクト型名2 {
  取得したいデータa
  取得したいデータb
}

ルート型 {
  ユニオン型名 {
    ...フラグメント名1
    ...フラグメント名2
  }
}

# ユニオン型名の値としてオブジェクト型1か2の形で値が返る

# インラインフラグメント(無名フラグメント)
query {
  ユニオン型名 {
    ...on オブジェクト型1 {
      取得したいデータA
    }
    ...on オブジェクト型2 {
      取得したいデータa
      取得したいデータb
    }
  }
}

# ユニオン型名の値としてオブジェクト型1か2の形で値が返る
```

### インターフェース
- 類似したオブジェクト型が実装すべきフィールドのリストをインターフェース型で表現できる
```
interface インターフェース名 {
  キー1: 型1
  キー2: 型2
}
```

### 変数
- 変数は`$変数名`で表現する
```
ルート型 フィールド0($変数1:型1 $変数2:型2) {
  フィールド1($変数1:型1 $変数2:型2) {
    取得したいデータ1
    取得したいデータ2
  }
}
```
- GraphiQL / Playgroundにおいてはクエリ変数ウィンドウにJSONで変数を定義できる

### サブスクリプション
- GraphQLサーバーからクライアントへリアルタイムにデータの更新情報を送信する
  - WebSocketを通じてクライアントへ変更通知をpushする
```
subscription {
  フィールド1 {
    取得したいデータ1
    取得したいデータ2
  }
}
```

## 型
- スカラー型
  - Int (JSONではnumber)
  - Float (JSONではnumber)
  - String (JSONではstring)
  - Boolean
  - ID (JSONではstring / 一意であること)
- オブジェクト型
  - 一つ以上のスキーマで定義されているフィールドの集合
- ユニオン型
  - 複数の異なる型のオブジェクトをまとめた型
