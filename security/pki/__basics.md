# 公開鍵基盤 (PKI: Public Key Infrastructure)
- 公開鍵の信頼性を保障するための仕組み
  - 人や組織とそれに紐づく公開鍵の対応を保証する
  - PKIの使用により (個人で直接公開鍵を配布させない) 公開鍵の身元を明らかにし、
    中間者攻撃による公開鍵のすり替えなどを防止することができる

#### トラストモデル
- 信頼できる第三者によって、通信相手が本物かどうかを証明する仕組み

#### Web of トラストモデル
- 信頼できる第三者の署名によって、公開鍵の所有者を保証する仕組み
- 分散型モデル
- OpenPGP規格に準拠するソフトウェアで採用されている

#### 認証局モデル
- 信頼できる第三機関 (TTP: Trusted Third Party) の署名によって、公開鍵の所有者を保証する仕組み
- 中央集権型モデル
- TTPは公開鍵の発行に先立って公開鍵の所有者の本人性を何らかの方法で確認し、
  公開鍵とその所有者を保証する証明書を発行する
  - 証明書には改竄防止のためTTPの署名が施される

## 概念
#### PKI
- 公開鍵基盤 (人や組織とそれに紐づく公開鍵の対応を保証する仕組み)

#### PKC (Public Key Certificate)
- 公開鍵証明書 (認証局によって発行された証明書)

#### CA (Certification Authority)
- 認証局 (公開鍵を保証する機関) : RA / IA
  - ルート認証局 - 自己の正当性を証明することができるCA (トラストアンカー)
  - 中間認証局 - ルート認証局以外の全てのCA
  - パブリックCA - 運用ポリシーである証明書ポリシーに則って公的に運営されるCA
  - プライベートCA - 組織内で独自の運用基準を設けて運用されるCA
- 利用者の鍵ペアを作成する (利用者が作成する場合もある)
- 証明書所有者となるユーザーの本人性の審査・確認を行う
- 公開鍵を登録する
- 証明書を作成し証明書所有者へ発行する
- 他のCAあるいはより権威のあるCAに対して証明書の発行を依頼する
- 必要時、証明書を破棄する
- 証明書と証明書失効リストをリポジトリに公開する

#### RS (Registration Authority)
- 登録局
- 証明書所有者となるユーザーの本人性の審査・確認を行う
- IAに対して証明書の発行・失効を要求する

#### IA (Issuing Authority)
- 証明書の発行 (署名) を行う
- リポジトリの管理を行う

#### リポジトリ
- 証明書及び証明書失効リストを格納し、証明書所有者や証明書利用者へ公開する

#### X.509
- 公開鍵証明書の国際標準規格

#### フィンガープリント
- 公開鍵証明書のハッシュ値

#### 証明書所有者 (certificate holder: サーバー)
- 鍵ペアを作成する(CAが作成する場合もある)
- CAに鍵を登録する
- CAから証明書を発行してもらう
- 必要時、CAに登録した公開鍵を無効にしてもらう
- 受診した暗号文を復号する
- メッセージにデジタル署名を行う

#### 証明書利用者 (relying party: クライアント)
- メッセージを暗号化してサーバーへ送信する
- デジタル署名の検証を行う

#### 証明書失効確認機構
- CRLサーバー
  - 証明書利用者からの証明書失効確認に応答する
- OCSPサーバー
  - 証明書利用者からの証明書失効確認に応答する

## 運用フロー
1. 証明書所有者となるユーザーが鍵ペアを作成する
2. 証明書所有者となるユーザーはCAに公開鍵を登録する
3. CAは証明書所有者となるユーザーの公開鍵に自局の秘密鍵でデジタル署名し、
   証明書を作成し、証明書所有者となるユーザーへ送付する
4. 証明書利用者はCAのデジタル署名がついた証明書所有者の公開鍵 (証明書) を入手する
5. 証明書利用者はCAの公開鍵を使ってデジタル署名を検証し、証明書所有者の公開鍵が正しいことを確認する
6. 証明書利用者は証明書所有者の公開鍵でメッセージを暗号化して証明書所有者へ送信する
7. 証明書所有者は証明書利用者から受信した暗号メッセージを自身の秘密鍵で復号する

## SSLターミネーション
- Webサーバー手前のロードバランサーに証明書を設置する手法
- ロードバランサーとWebサーバー間はHTTPで通信を行う

## 参照
- [How is data secure over https?](https://blog.joshsoftware.com/2019/08/23/how-is-data-secure-over-https/)
- よくわかるHTTP/2の教科書P18-20/124-125
- SSLをはじめよう ～「なんとなく」から「ちゃんとわかる！」へ～
- [図解で学ぶネットワークの基礎：SSL編](https://xtech.nikkei.com/it/article/COLUMN/20071002/283518/)
- ハイパフォーマンスブラウザネットワーキング
- サーバ／インフラエンジニアの基本がこれ1冊でしっかり身につく本 3.6
- 食べる！SSL！　―HTTPS環境構築から始めるSSL入門
- プロフェッショナルSSL/TLS
- [OCSP (Online Certificate Status Protocol)](https://www.cybertrust.co.jp/sureserver/support/glossary/ocsp.html)
- マスタリングTCP/IP 情報セキュリティ編
- 暗号技術入門 第3版
- 図解即戦力　暗号と認証のしくみと理論がこれ1冊でしっかりわかる教科書
