# 踏み台サーバ

```
クライアント -> | -> 踏み台サーバ -> 対象ホスト
```

#### 踏み台サーバーをトンネルして対象ホストに接続したい

```
$ ssh -L \
<ローカルで使用するポート>:<対象ホストのアドレス>:<対象ホストのポート> \
<踏み台サーバーのユーザー名>@<踏み台サーバーのアドレス>
```

```
$ ssh -vvv -L 9999:***.ap-northeast-1.rds.amazonaws.com:5432 misaki-shioi@***-***.aws.***.jp
$ psql -U *** -h localhost -p 9999 -d ***
```

#### 対象ホストに多段SSHしたい
1. 鍵ファイルをローカル環境から踏み台サーバーへ転送 (初回のみ)
2. 踏み台サーバへssh
3. 踏み台サーバに転送した鍵ファイルの権限を変更 (初回のみ)
4. 鍵ファイルを利用して対象ホストにssh

```
$ scp path/to/<鍵ファイル> <踏み台サーバのユーザー名>@<踏み台サーバのアドレス>:~/.ssh/

$ ssh -A <踏み台サーバのユーザー名>@<踏み台サーバのアドレス>

$ chmod 400 ~/.ssh/<対象ホストの鍵ファイル>

$ ssh -i ~/.ssh/<対象ホストの鍵ファイル> <対象ホストのユーザー名>@<対象ホストのプライベートIPアドレス>
```

```
$ scp -i ~/***.pem misaki-shioi@***-***.aws.***.jp:~/.ssh/
$ ssh -A misaki-shioi@***-***.aws.***.jp
$ chmod 400 ~/.ssh/***.pem
$ ssh -i ~/.ssh/***.pem ***@****.****.****.****

# 対象サーバーのDockerコンテナの中に入る
$ docker ps
$ docker exec -it *** /bin/sh
$ # 操作したいコマンドを実行
```

## 参照
- [楽しいトンネルの掘り方(オプション: -L, -R, -f, -N -g)](https://www.kmc.gr.jp/advent-calendar/ssh/2013/12/09/tunnel2.html)
