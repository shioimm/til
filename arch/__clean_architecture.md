# Clean Architecture 達人に学ぶソフトウェアの構造と設計 メモ
- アーキテクチャの関心事 - コンポーネントの分離、データ管理、機能

## プログラミングパラダイム (P49~)

| 種類   | 制限された機能                          | 導入された概念         | 発展的な考え方           |
| -      | -                                       | -                      | -                        |
| 構造化 | 直接的な制御の移行 (goto文の使用)       | 機能分割、テスト可能性 | -                        |
| OOP    | 間接的な制御の移行 (関数ポインタの使用) | 依存関係の方向の制御   | プラグインアーキテクチャ |
| 関数型 | 代入 (可変変数の使用)                   | 可変性の分離           | イベントソーシング       |

## モジュールレベルの設計 (P77~)
- SOLID原則の目的 - 変更に強い、理解しやすい、再利用性の高いモジュールレベルのソフトウェア構造の構築

### 単一責任の原則 (SRP)
- モジュールはたった一つのアクターに対して責務を負うべきである
  (= 複数のアクターが利用するモジュールは複数のモジュールへ分割するべきである)
- 関数・クラスレベル   -> 単一責任の原則
- コンポーネントレベル -> 閉鎖性共通の原則
- アーキテクチャレベル -> (アーキテクチャの境界を作るための) 変更の軸

### オープン・クローズドの原則 (OCP)
- モジュールは拡張に対しては開き、修正に対しては閉じていなければならない
  (= モジュールの振る舞いは既存の成果物を変更せず拡張できるようにすべきである)
- モジュールの依存関係は階層構造とし、上位レベルのモジュールは下位レベルのモジュールの変更の影響を受けない

### リスコフの置換原則 (LSP)
- S型のオブジェクトをT型のオブジェクトに置き換えても動作が変わらない場合、SはTの派生型である
  (= モジュールは定義されたインターフェースとそのインターフェースの実装の置換可能性に依存するべきである)

### インターフェース分離の原則 (ISP)
- モジュールが依存するインターフェースにはモジュールが必要とする実装のみが含まれているべきである
  (= インターフェースはモジュールが必要とする実装ごとに分離されているべきである)

### 依存関係逆転の原則 (DIP)
- モジュールは具象的な実装ではなく安定した抽象インターフェース (= 変化しにくい要素) にのみ依存するべきである
  - モジュールは具象を名指しで参照するべきではない
  - モジュールは具象クラスを継承するべきではない
  - モジュールは具象関数をオーバーライドするべきではない

## コンポーネントレベルの設計 (P107~)
- コンポーネント - デプロイ単位
- 再利用・リリース等価の原則と閉鎖性共通の原則は包含関係にあり、全利用性の原則はそれらと相反する
- 3つの原則のバランスをとることが必要

#### 再利用・リリース等価の原則 (REP)
- 再利用の単位とリリースの単位は等価になる
  (再利用性のためのグループ化)
  - コンポーネントを構成するモジュールは凝集性のあるグループでなければならない
  - コンポーネントを構成するモジュール群はまとめてリリース可能でなければならない

#### 閉鎖性共通の原則 (CCP)
- 同じ理由、同じタイミングで変更されるモジュールは一つのコンポーネントにまとめ、
  変更の理由やタイミングが異なるモジュールは別のコンポーネントに分ける
  (保守性のためのグループ化)
- 単一責任の原則と類似 (同じ理由で変更するものはひとまとめにする)

#### 全利用性の原則 (CRP)
- コンポーネントのユーザーに対して、実際に使わないモジュールへの依存を強要してはいけない
  (不要なリリース作業を減らすための分割)
- インターフェース分離の原則と類似 (不要なものには依存しない)

### コンポーネントの結合 (P125~)
- 変動性の低いコンポーネントは安定度が高く抽象度が高い状態に置く
- 変動性の高いコンポーネントは安定度が低く抽象度が低い状態に置く
- D (主系列からの距離) - `D = A + I - 1` (1に近いほど主系列から離れている)

#### 非循環依存関係の原則 (ADP)
- コンポーネント同士の依存関係は一方向になっている (循環依存しない) べきである

#### 安定依存の原則 (SDP)
- コンポーネントは安定度の高い方向に依存するべきである
- 他のコンポーネントからの依存を多く持つコンポーネントは変更しづらい (安定度が高い)
  - 独立コンポーネント - 他のコンポーネントに依存せず、他のコンポーネントから依存されるコンポーネント
  - 従属コンポーネント - 他のコンポーネントに依存し、他のコンポーネントから依存されないコンポーネント
  - ファン・イン - 依存入力数 (自コンポーネントに依存する外部のコンポーネント数)
  - ファン・アウト- 依存出力数 (自コンポーネントが依存する外部のコンポーネント数)
  - I (安定度) - `ファン・アウト / (ファン・イン + ファン・アウト)` (1に近いほど不安定)

#### 安定度・抽象度等価の原則 (SAP)
- コンポーネントの抽象度はその安定度と同程度であるべきである
- 抽象クラスとインターフェースを多く持つコンポーネントは拡張しづらい (抽象度が高い)
  - Nc - コンポーネント内のクラスの総数
  - Na - コンポーネント内の抽象クラスとインターフェースの総数
  - A (抽象度) - `A = Na / Nc` (1に近いほど抽象的)

## システムレベルの設計
- アーキテクチャは方針 (上位レベル) と詳細 (下位レベル) を分離し、依存性のルールに従う境界によって定義される
- アーキテクチャの方針は詳細の決定を可能な限り遅延させられるようにデザインするべきである
- アーキテクチャはシステムのユースケースを中心に構成し、運用、開発、デプロイをサポートするべきである

### システムの切り離し方式 (P157~)
- 独立した運用・開発・デプロイを行うための選択肢
- 異なる理由で変更されるものを分離し、同じ理由で変更されるものをまとめる
- アプリケーションをレイヤ (水平方向) とユースケース (垂直方向) の2方向から各層ごとに分割する
- 時間とともに最適な切り離し構造が変化する可能性がある

### アーキテクチャの境界線 (P167~)
- アーキテクチャにとって重要なものとそうでないものの間に境界線を引く
- システムをコンポーネントに分割した際、ビジネスルールを表すコンポーネントが最も重要であり、
  それ以外のコンポーネントはプラグイン可能であるべきである
  - ビジネスルールを表すコンポーネントはそれ以外のコンポーネントに依存しない
  - ビジネスルールを表すコンポーネントはそれ以外のコンポーネントから依存される

#### アーキテクチャの境界線の分割単位 (P179~)

| コンポーネントの単位 | コンポーネント境界の通信 |
| -                    | -                        |
| ソースレベル         | 関数呼び出し             |
| デプロイレベル       | 関数呼び出し             |
| スレッドレベル       | スレッド間通信           |
| プロセスレベル       | プロセス間通信           |
| サービスレベル       | ネットワーク間通信       |

#### Humble Objectパターン (P207~)
- 振る舞いを持つコンポーネントをテストしやすい部分とテストしづらい部分に2分割するパターン
- アーキテクチャの境界を越える通信において境界の近くのコンポーネントをテスト容易にするために用いる

#### Pros / Cons
- 完全な境界を構築する場合: 境界を構築・保守するためのコストが発生する
  (ポリモーフィックなインターフェース、入出力のデータ構造、双方のデプロイを独立させるための依存性管理)
- 一切の境界を構築しない場合: 新しいレイヤを追加するコストが増大する

### クリーンアーキテクチャのアイディア (P199~)
- 関心事の分離を目的にビジネスルール層とインターフェース層が切り離されていること
- フレームワーク・UI・DB非依存であり、ビジネスルールが単体でテスト可能であること

#### コンポーネントの分類 (抽象度・安定度 降順) (P189~)
- エンティティ
  - ドメイン固有のビジネスルールとドメイン固有のデータをカプセル化したコンポーネント
- ユースケース
  - アプリケーション固有のビジネスルール、エンティティへの参照と入出力をカプセル化したコンポーネント
- インターフェースアダプタ (Presenter, View, Controller)
  - ユースケースとドライバ間におけるデータの変換をカプセル化したコンポーネント
- ドライバ / フレームワーク (IO, UI, DB)
  - 詳細の実体となるコンポーネント

#### mainコンポーネント (P223~)
- システムのエントリーポイントとして動作する最も下位レベルのコンポーネント
- 初期状態や構成を設定し、外部リソースを集め、
  アプリケーションの上位レベルの方針に制御を渡すためのプラグインとして捉える

#### サービス
- アプリケーションを振る舞いによって分割し、別のプロセス・プラットフォームに切り離した単位
- サービス (振る舞いによる分割) ≠ コンポーネント (アーキテクチャの境界による分割)
- アーキテクチャの境界はサービスを横断する

### 詳細となる要素
- どのようなソフトウェア・データ形式・入出力方法を使用するかを決定する要素
  - DB
  - GUI
  - フレームワーク

## 参照
- Clean Architecture 達人に学ぶソフトウェアの構造と設計
