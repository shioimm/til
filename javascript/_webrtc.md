# WebRTC
- ブラウザ間での動画・音声・データ通信を実現するプロトコル・ネットワーク・JavaScript API
- 効率的なリアルタイムの音声・動画処理のため、
  ブラウザのネットワークレイヤーから再構築されたメディアスタックが導入された
  - データ転送にUDPを使用する
  - サーバーを介した通信も可

### 特徴
- プラグインやサードパーティソフトウェアのインストールが不要
- NATを超えてプライベートアドレスだけで通信が可能
- 通信はデフォルトで暗号化されている
  - DTLS(データグラム向けのTLS)を採用
- ライブ配信におけるリアルタイム性の高さ

### ユースケース
- P2P
  - プライベートなネットワークのビデオ通話システム
  - グローバルなネットワークのビデオ通話システム(ICEを使用)
  - ファイアウォール越しのビデオ通話システム
  - スクリーンの共有
  - ファイル交換
  - 複数人でのビデオ通話
  - 複数人でのボイスチャットつきのオンラインゲーム
- MCU(サーバーが各区クライアントの映像を合成して配信) / SFU(サーバーが各クライアントの映像を中継)
  - カスタマーセンター
  - IP電話端末
  - 中央サーバーを使ったビデオ会議システム

## 構成要素
#### SDP
- Session Description Protocol
- P2Pのネゴシエーション時にお互いのIPアドレスとポート、
  双方で利用できるオーディオや動画のコーデック情報を共有するための技術

#### ICE
- Interactive Connectivity Establishment
- NATを超えてP2P通信を確立するための技術
  - STUNサーバー - リクエストがあったグローバルIPアドレスとポートをNAT内のコンピュータに返送する
  - TURNサーバー - STUNサーバーで通信できなかった際、TCPへのフォールバックを仲介する
- ICEのプロセスの内部でSDPを使用している

##### メディアチャネル
- 音声と映像をP2Pで送受信する
- DTLS上でセキュアなリアルタイム通信(SRTP)として実行される

##### データチャネル
- 音声以外のデータをP2Pで送受信する
- DTLS上でセキュアなリアルタイム通信(SRTP)として実行される

#### MediaStream API
- アプリケーションからプラットフォームに対して音声・動画のストリームをリクエストするJavaScript API
- 取得した音声・動画のストリームの操作や処理を行うJavaScript API

#### RTCPeerConnection
- 通信経路の確保と音声や動画の通信を行うJavaScript API

#### RTCDataChannel API
- 任意のアプリケーションデータの通信を行うJavaScript API

## 音声・動画処理エンジン
- 送信側ピアはストリームに対して音質・画質の最適化、音声・映像の同期、出力ビットレートの調整を行う
- 受信側ピアはストリームに対してリアルタイムでデコードを行い、ネットワークのジッタやレイテンシに対応できる状態を保つ
- WebRTC APIは内部に音声処理エンジン・動画処理エンジンを持ち、ストリームに対する処理を行う

#### 音声処理エンジンの仕事
1. ノイズリダクション
2. エコー除去
3. ジッタ・パケットロス補正
4. オーディオコーデック

#### 動画処理エンジンの仕事
1. 音声・動画の同期
2. ジッタ・パケットロス補正
3. 画像補正
4. ビデオコーデック

### MediaStream オブジェクト
- リアルタイムのメディアストリームを表すJavaScriptオブジェクト
  - 一つ以上のトラック(MediaStreamTrack)によって構成され、トラック同士は同期されている
- アプリケーションコードはMediaStreamオブジェクトを利用してデータを取得し、各トラックを操作し、出力先を指定する
  - ローカルの動画・音声要素、ポストプロセスを行うJavaScript、リモートピアなど一つ以上の出力先に送信可能
- メディアストリームの内容は入力ソースの種類や機能に依存する
  - 入力ソースは物理デバイス、ローカルハードディスクのメディアファイル、ピアのメディアファイルなど

## 参照
- [WebRTC](https://webrtc.org/)
- [WebRTC API](https://developer.mozilla.org/ja/docs/Web/API/WebRTC_API)
- [WebRTC コトハジメ](https://gist.github.com/voluntas/67e5a26915751226fdcf)
- Real World HTTP 第2版
- ハイパフォーマンスブラウザネットワーキング
