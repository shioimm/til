# WebRTC
- ブラウザ間での動画・音声・データ通信を実現するプロトコル・ネットワーク・JavaScript API
- 効率的なリアルタイムの音声・動画処理のため、
  ブラウザのネットワークレイヤーから再構築されたメディアスタックが導入された
  - データ転送にUDPを使用する
  - サーバーを介した通信も可

### 特徴
- プラグインやサードパーティソフトウェアのインストールが不要
- NATを超えてプライベートアドレスだけで通信が可能
- 通信はデフォルトで暗号化されている
  - DTLS(データグラム向けのTLS)を採用
- ライブ配信におけるリアルタイム性の高さ

### ユースケース
- P2P
  - プライベートなネットワークのビデオ通話システム
  - グローバルなネットワークのビデオ通話システム(ICEを使用)
  - ファイアウォール越しのビデオ通話システム
  - スクリーンの共有
  - ファイル交換
  - 複数人でのビデオ通話
  - 複数人でのボイスチャットつきのオンラインゲーム
- MCU(サーバーが各区クライアントの映像を合成して配信) / SFU(サーバーが各クライアントの映像を中継)
  - カスタマーセンター
  - IP電話端末
  - 中央サーバーを使ったビデオ会議システム

## WebRTCプロトコルスタック
```
--------------------------------------------
 RTCPeerConnection |      DataChannel
--------------------------------------------
       SRTP        |          SCTP
          ----------------------------------
          |        セッション(DTLS)
--------------------------------------------
            ICE / STUN / TURN
--------------------------------------------
           トランスポート(UDP)
--------------------------------------------
             ネットワーク(IP)
--------------------------------------------
```

- ICE - Interactive Connectivity Establishment
  - UDPでP2P接続を確立し維持する
  - ICEのプロセスの内部でSDPを利用する
  - STUN - Session Traversal Utilities for NAT
  - TURN - Traversal Using Relays around NAT
- SDP - Session Description Protocol
  - ピア同士のP2P接続パラメータをネゴシエートするためのデータフォーマット
  - SDPのオファーとアンサーは帯域外(シグナリングチャネル)で通信されるため、プロトコル図には描かれない
- DTLS - Datagram Transport Layer Security
  - ピア間全ての通信を暗号化し、セキュアにするために使用される(必須)
- SCTP - Stream Control Transmission Protocol
  - ストリームの多重化、輻輳制御、フロー制御を行い、部分的に信頼性のある配信サービスなどをUDPに追加する
- SCTP - Secure Real-Time Transport Protocol
  - ストリームの多重化、輻輳制御、フロー制御を行い、部分的に信頼性のある配信サービスなどをUDPに追加する

## P2P接続開始プロセス
- 送信ピア: WebRTC接続を開始
  1. ピア接続オブジェクトとシグナリングチャネルを初期化
  2. メディアストリームを取得・登録
  3. SDPオファーを送信
  4. ICE候補を次々に送信(Tricle ICE)
  5. リモートピアから取得したメディアストリームの出力を行う
- 受信ピア: WebRTC接続にレスポンスを返す
  1. ピア接続を開始
  2. メディアストリームを取得・登録
  3. シグナリングチャネル経由で配信されるリモートオファーを受信
  4. リモートICE候補を登録し、各候補の接続性を確認
  5. ピア接続を記述したSDPアンサーを生成し、ピアに送信
  6. ICE候補を次々に送信(Tricle ICE)
  7. リモートピアから取得したメディアストリームの出力を行う

## WebRTC API
#### MediaStream API
- アプリケーションからプラットフォームに対して音声・動画のストリームをリクエストするJavaScript API
- 取得した音声・動画のストリームの操作や処理を行うJavaScript API

#### RTCPeerConnection
- 通信経路の確保と音声や動画の通信を行うJavaScript API

#### RTCDataChannel API
- 任意のアプリケーションデータの通信を行うJavaScript API

## WebRTCメディアエンジン
- 送信側ピアはストリームに対して音質・画質の最適化、音声・映像の同期、出力ビットレートの調整を行う
- 受信側ピアはストリームに対してリアルタイムでデコードを行い、ネットワークのジッタやレイテンシに対応できる状態を保つ
- WebRTC APIは内部に音声処理エンジン・動画処理エンジンを持ち、ストリームに対する処理を行う

#### 音声処理エンジンの仕事
1. ノイズリダクション
2. エコー除去
3. ジッタ・パケットロス補正
4. オーディオコーデック

#### 動画処理エンジンの仕事
1. 音声・動画の同期
2. ジッタ・パケットロス補正
3. 画像補正
4. ビデオコーデック

### MediaStream オブジェクト
- リアルタイムのメディアストリームを表すJavaScriptオブジェクト
  - 一つ以上のトラック(MediaStreamTrack)によって構成され、トラック同士は同期されている
- アプリケーションコードはMediaStreamオブジェクトを利用してデータを取得し、各トラックを操作し、出力先を指定する
  - ローカルの動画・音声要素、ポストプロセスを行うJavaScript、リモートピアなど一つ以上の出力先に送信可能
- メディアストリームの内容は入力ソースの種類や機能に依存する
  - 入力ソースは物理デバイス、ローカルハードディスクのメディアファイル、ピアのメディアファイルなど

## リアルタイムネットワークトランスポート
### RTCPeerConnection API
- 各P2P接続のライフタイム管理を行うAPI
- 内部にSTUN/TURNサーバーとの通信を担うICEエージェントを持ち、
  全接続のセットアップ、管理、状態を単一のインターフェースにカプセル化している

#### RTCPeerConnectionの動作
- NATトラバーサルを行うICEワークフロー全体を管理する
- ピア間の自動キープアライブ(STUN)を送信する
- ローカルストリームの変化を記録する
- リモートストリームの変化を記録する
- 必要時にストリームの再ネゴシエーションを行う
- 接続のオファーの生成とアンサーの受領に必要なAPIを提供し、接続の現在状態の問い合わせを受け付ける

#### ICEエージェント
- それぞれのRTCPeerConnection接続オブジェクトはICEエージェントを持つ
- ICEエージェントは他のピアが自身に接続できる可能性のあるIPアドレスとポートの組みを収集する
- ICEエージェントはピア間の持続性確認を行う
- ICEエージェントは接続のキープアライブを送信する

#### ICEエージェントのるIPアドレス・ポート収集プロセス
1. RTCPeerConnectionオブジェクトにローカル/リモートのセッション記述が設定されると収集プロセスが開始される
2. ICEエージェントは自身のローカルIPアドレスをOSに問い合わせる
3. ICEエージェントは外部のSTUNサーバーへ問い合わせを行い、自身のパブリックIPアドレス・ポートの組みを取得する
4. ICEエージェントは自身にパケットをリレーするTURNサーバーのIPアドレス・ポートを追記する
    - P2P接続に失敗した場合はデータはTURNサーバーを経てリレーされる
- ICEエージェントが発見したIPアドレスとポートの組みの候補はRTCPeerConnectionオブジェクトに登録され、
  `onicecandidate`コールバック関数を通じてアプリケーションに通知される

## P2P接続の確立
### P2P接続の確立の前提条件
- ローカルユーザーはP2P接続の開始意図を相手側ピアに伝え、到着パケットを待機する必要がある
- P2P接続が可能なルーティングパスを双方のピアで確認し、情報をピア間で交換する必要がある
- メディアやデータストリームのパラメータ情報(プロトコルやエンコーディングなど)を交換する必要がある
- 通知(シグナリング)の配信や最初のセッションネゴシエーションはアプリケーション自身が行う必要がある

### シグナリング
- WebRTCはシグナリングトランスポートとプロトコルの選択をアプリケーションに移譲する
- ピア間では最低限シグナリングチャネルの共有が必要
- アプリケーションは共有シグナリングチャネルを実装する必要がある

#### 代表的なシグナリングプロトコル
- Session Initiation Protocol(SIP)
- Jingle
- ISDN User Part(ISUP))

### SDP
- セッションプロファイル(接続のプロパティのリスト)を記述するために使用されるテキストベースのプロトコル
  - セッションプロファイルはIPアドレスとポート、コーデック情報、帯域幅などのメタ情報を格納する
- SDPにおける内部作業はJSEP(JavaScript Session Establishment Protocol)によって
  RTCPeerConnectionオブジェクトのメソッドとして抽象化されている

#### SDPネゴシエーションの流れ
1. ピア1はローカルのRTCPeerConnectionオブジェクトに一つ以上のストリームを登録し、SDPオファーを生成する
2. ピア1は生成されたSDPオファーを自身のセッションに「ローカル記述」として設定する
3. ピア1は生成されたセッションオファーをピア2に送信する
4. ピア2はセッションオファーを受信する
5. ピア2は受信したセッションオファーを自身のセッションに「リモート記述」として設定する
6. ピア2は自身のストリームをのRTCPeerConnectionオブジェクトに登録する
7. ピア2は生成されたセッションアンサーをピア1に送信する
8. ピア1がSDPアンサーを受信する
9. ピア1が受信したSDPアンサーを自身のセッションに「リモート記述」として設定する

### ICE
- P2P接続確立時にNATトラバーサルをネゴシエーションするために使用されるプロトコル

#### ルーティングの流れ
1. ピア1のRTCPeerConnectionオブジェクトが持つICEエージェントがIPアドレスとポートの組みの候補収集プロセスを実行する
2. ピア1の候補収集プロセスが完了すると、SDPオファーが生成される
3. ピア1の候補を記載したSDPオファーがシグナリングチャネルを通じて相手のピアに送信できる
4. ピア2がオファーを受信する
5. ピア2のRTCPeerConnectionオブジェクトにピア1の候補を含んだリモートセッション記述が設定される
6. ピア2のRTCPeerConnectionオブジェクトが持つICEエージェントがピア1の各候補の接続性確認を行う
    - 全ての候補が失敗するとRTCPeerConnectionは失敗とされるか、TURNリレーサーバーにフォールバックされる

#### インクリメンタルプロビジョニング(Tricle ICE)
- 候補収集プロセスの完了を待たずにインクリメンタルな候補収集とピア間の接続性確認を行うICEの拡張機能
- 双方のピアは候補を持たないSDPオファーの交換が可能
- 候補は発見され次第シグナリングチャネルを通じて相手に送信される
- 接続性確認は新たな候補の記述が利用可能になり次第行われる

### DTLS
- メディアデータの暗号化とアプリケーションデータを安全に転送するための秘密鍵交換に使用されるプロトコル
- DTLSはTLSと同じ機能をUDPに提供するために設計されている
- UDPはTCPのような信頼性の高いパケット転送を行うことができないため、
  ハンドシェイク時に通信の信頼性(順序・パケットロスの検出)を担保させるための仕組みが必要になる
- DTLSレコードは単一のネットワークパケットに収める必要がある
- レコードデータの暗号化にはブロック暗号を用いる必要がある

#### DTLSハンドシェイク
- DTLSは各ハンドシェイクレコードにフラグメントオフセットとシーケンス番号を明示的に追加し、
  TLSプロトコルで定義されている順序通りに送信されなかった場合はエラーを発生させる
- 双方のピアはタイマーを持ち、時間内に返信を受信できなかった場合はハンドシェイクレコードを再送させる
- 双方のピアは自己署名の証明書を発行し、TLSハンドシェイクと同じく証明書の交換を行う

### SRTP
- 音声と動画ストリームを転送するために使用されるプロトコル
- IPネットワーク上のリアルタイムデータ配信のための標準パケットフォーマットRTPのセキュア版
- SRTPパケットはストリームのリアルタイムプレイバックのためにメディアエンジンが必要とする情報を提供する
- SRTCPプロトコルが各SRTPパケットの配信制御を行う
  - SRTCPは各メディアストリームから独立した帯域外のフィードバックチャネルを実装する
- SRTCPとSRTPはUDP/DTLS上でアプリケーションによる音声・動画ストリームのリアルタイム配信の最適化と状態適応を行う

### SCTP
- アプリケーションデータを転送するために使用されるプロトコル
- SRTPフローにおける送信者と受信者の統計情報や制御情報の配信用制御プロトコルRTCPのセキュア版
- 二つのエンドポイント間のSCTPアソシエーションは複数の独立したストリームを運ぶ可能性がある
- 各ストリームはアプリケーションメッセージの転送により通信を行う
- 各メッセージは一つ以上のチャンクに分割され、SCTPパケットに格納されて配信される
- 各チャンクは送信先でメッセージとして再構成される
- SCTPはUDP/DTLS上でTCPに似たハンドシェイクシーケンスとフロー制御を行う

### DataChannel API
- DataChannelはピア間における任意のアプリケーションデータの双方向のやり取りを行うネットワークチャネル
  - 全てのDataChannelはRTCPeerConnectionに関連付けられる
  - 共通のRTCPeerConnectionを持つ双方のピアが各自新規DataChannelセッションを開始することができる
- WebSocket APIに似たインターフェースを持つ(DataChannel APIはWebSocket APIの上位集合)
- DataChannelはP2Pの接続性を提供することができるUDP、送信データの暗号化を行うDTLS、
  多重化・フロー制御・服装制御を行うSCTP全てのプロトコル上で動作する
- 送信元ピアが最初に接続オファーを生成する際または送信先ピアがアンサーを生成する際、
  ピアはSDPのセッション記述においてSCTPアソシエーションのパラメータをアドバタイズする必要がある

## 参照
- [WebRTC](https://webrtc.org/)
- [WebRTC API](https://developer.mozilla.org/ja/docs/Web/API/WebRTC_API)
- [WebRTC コトハジメ](https://gist.github.com/voluntas/67e5a26915751226fdcf)
- Real World HTTP 第2版
- ハイパフォーマンスブラウザネットワーキング
