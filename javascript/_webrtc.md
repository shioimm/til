# WebRTC
- ブラウザ間での動画・音声・データ通信を実現するプロトコル・ネットワーク・JavaScript API
- 効率的なリアルタイムの音声・動画処理のため、
  ブラウザのネットワークレイヤーから再構築されたメディアスタックが導入された
  - データ転送にUDPを使用する
  - サーバーを介した通信も可

### 特徴
- プラグインやサードパーティソフトウェアのインストールが不要
- NATを超えてプライベートアドレスだけで通信が可能
- 通信はデフォルトで暗号化されている
  - DTLS(データグラム向けのTLS)を採用
- ライブ配信におけるリアルタイム性の高さ

### ユースケース
- P2P
  - プライベートなネットワークのビデオ通話システム
  - グローバルなネットワークのビデオ通話システム(ICEを使用)
  - ファイアウォール越しのビデオ通話システム
  - スクリーンの共有
  - ファイル交換
  - 複数人でのビデオ通話
  - 複数人でのボイスチャットつきのオンラインゲーム
- MCU(サーバーが各区クライアントの映像を合成して配信) / SFU(サーバーが各クライアントの映像を中継)
  - カスタマーセンター
  - IP電話端末
  - 中央サーバーを使ったビデオ会議システム

## WebRTCプロトコルスタック
```
--------------------------------------------
 RTCPeerConnection |      DataChannel
--------------------------------------------
       SRTP        |          SCTP
          ----------------------------------
          |        セッション(DTLS)
--------------------------------------------
            ICE / STUN / TURN
--------------------------------------------
           トランスポート(UDP)
--------------------------------------------
             ネットワーク(IP)
--------------------------------------------
```

- ICE - Interactive Connectivity Establishment
  - UDPでP2P接続を確立し維持する
  - ICEのプロセスの内部でSDPを利用する
  - STUN - Session Traversal Utilities for NAT
  - TURN - Traversal Using Relays around NAT
- SDP - Session Description Protocol
  - ピア同士のP2P接続パラメータをネゴシエートするためのデータフォーマット
  - SDPのオファーとアンサーは帯域外(シグナリングチャネル)で通信されるため、プロトコル図には描かれない
- DTLS - Datagram Transport Layer Security
  - ピア間全ての通信を暗号化し、セキュアにするために使用される(必須)
- SCTP - Stream Control Transmission Protocol
  - ストリームの多重化、輻輳制御、フロー制御を行い、部分的に信頼性のある配信サービスなどをUDPに追加する
- SCTP - Secure Real-Time Transport Protocol
  - ストリームの多重化、輻輳制御、フロー制御を行い、部分的に信頼性のある配信サービスなどをUDPに追加する

## WebRTC API
#### MediaStream API
- アプリケーションからプラットフォームに対して音声・動画のストリームをリクエストするJavaScript API
- 取得した音声・動画のストリームの操作や処理を行うJavaScript API

#### RTCPeerConnection
- 通信経路の確保と音声や動画の通信を行うJavaScript API

#### RTCDataChannel API
- 任意のアプリケーションデータの通信を行うJavaScript API

## 音声・動画処理エンジン
- 送信側ピアはストリームに対して音質・画質の最適化、音声・映像の同期、出力ビットレートの調整を行う
- 受信側ピアはストリームに対してリアルタイムでデコードを行い、ネットワークのジッタやレイテンシに対応できる状態を保つ
- WebRTC APIは内部に音声処理エンジン・動画処理エンジンを持ち、ストリームに対する処理を行う

#### 音声処理エンジンの仕事
1. ノイズリダクション
2. エコー除去
3. ジッタ・パケットロス補正
4. オーディオコーデック

#### 動画処理エンジンの仕事
1. 音声・動画の同期
2. ジッタ・パケットロス補正
3. 画像補正
4. ビデオコーデック

### MediaStream オブジェクト
- リアルタイムのメディアストリームを表すJavaScriptオブジェクト
  - 一つ以上のトラック(MediaStreamTrack)によって構成され、トラック同士は同期されている
- アプリケーションコードはMediaStreamオブジェクトを利用してデータを取得し、各トラックを操作し、出力先を指定する
  - ローカルの動画・音声要素、ポストプロセスを行うJavaScript、リモートピアなど一つ以上の出力先に送信可能
- メディアストリームの内容は入力ソースの種類や機能に依存する
  - 入力ソースは物理デバイス、ローカルハードディスクのメディアファイル、ピアのメディアファイルなど

## リアルタイムネットワークトランスポート
### RTCPeerConnection API
- 各P2P接続のライフタイム管理を行うAPI
- 内部にSTUN/TURNサーバーとの通信を担うICEエージェントを持ち、
  全接続のセットアップ、管理、状態を単一のインターフェースにカプセル化している

#### RTCPeerConnectionの動作
- NATトラバーサルを行うICEワークフロー全体を管理する
- ピア間の自動キープアライブ(STUN)を送信する
- ローカルストリームの変化を記録する
- リモートストリームの変化を記録する
- 必要時にストリームの再ネゴシエーションを行う
- 接続のオファーの生成とアンサーの受領に必要なAPIを提供し、接続の現在状態の問い合わせを受け付ける

## P2P接続の確立
### P2P接続の確立の前提条件
- ローカルユーザーはP2P接続の開始意図を相手側ピアに伝え、到着パケットを待機する必要がある
- P2P接続が可能なルーティングパスを双方のピアで確認し、情報をピア間で交換する必要がある
- メディアやデータストリームのパラメータ情報(プロトコルやエンコーディングなど)を交換する必要がある
- 通知(シグナリング)の配信や最初のセッションネゴシエーションはアプリケーション自身が行う必要がある

### シグナリング
- WebRTCはシグナリングトランスポートとプロトコルの選択をアプリケーションに移譲する
- ピア間では最低限シグナリングチャネルの共有が必要
- アプリケーションは共有シグナリングチャネルを実装する必要がある

#### 代表的なシグナリングプロトコル
- Session Initiation Protocol(SIP)
- Jingle
- ISDN User Part(ISUP))

### SDP
- セッションプロファイル(接続のプロパティのリスト)を記述するために使用されるテキストベースのプロトコル
  - セッションプロファイルはIPアドレスとポート、コーデック情報、帯域幅などのメタ情報を格納する
- SDPにおける内部作業はJSEP(JavaScript Session Establishment Protocol)によって
  RTCPeerConnectionオブジェクトのメソッドとして抽象化されている

#### SDPネゴシエーションの流れ
1. ピア1はローカルのRTCPeerConnectionオブジェクトに一つ以上のストリームを登録し、SDPオファーを生成する
2. ピア1は生成されたSDPオファーを自身のセッションに「ローカル記述」として設定する
3. ピア1は生成されたセッションオファーをピア2に送信する
4. ピア2はセッションオファーを受信する
5. ピア2は受信したセッションオファーを自身のセッションに「リモート記述」として設定する
6. ピア2は自身のストリームをのRTCPeerConnectionオブジェクトに登録する
7. ピア2は生成されたセッションアンサーをピア1に送信する
8. ピア1がSDPアンサーを受信する
9. ピア1が受信したSDPアンサーを自身のセッションに「リモート記述」として設定する

### ICE


## 参照
- [WebRTC](https://webrtc.org/)
- [WebRTC API](https://developer.mozilla.org/ja/docs/Web/API/WebRTC_API)
- [WebRTC コトハジメ](https://gist.github.com/voluntas/67e5a26915751226fdcf)
- Real World HTTP 第2版
- ハイパフォーマンスブラウザネットワーキング
