# Berkeley Packet Filter (BPF / eBPF: extended BPF)
- ユーザーランドで作成したコードをカーネル内で安全に実行する枠組み
  - Linuxには諸々のイベントに対してBPFのプログラムをアタッチする仕組みがある
  - ユーザーは目的のBPFプログラムを作成することにより、カーネルの再コンパイルなしに
    該当のイベントに対するカーネルの動作を変更したり、ログを記録したりすることができる
  - システムコールの呼び出しやカーネル内の関数だけでなく、ユーザー空間のプログラムもトレースできる
- プログラムは独自の命令セットを持つ64ビットのBPF仮想マシン上で実行される
  - 仮想マシンはBPFバイトコード (BPF用独自の命令セットで表現されたコード) を解釈し、
    カーネルが動作するプロセッサに適したネイティブ命令に変換し、カーネルにロードする
  - ロードされたBPFバイトコードは指定されたイベントが発生するたびに実行される

#### 特徴
- 汎用的な命令セットを持ち、カーネル内のヘルパー関数呼び出しを利用することによって様々な処理が実行可能
- 一部の機能を制限し、BPFプログラムで許可されていない動作を行わないことによってプログラムを安全に実行する
- JITコンパイルをサポート

#### 用途
- ネットワーキング (e.g. パケットに関する操作、トンネリング、トラフィック制御)
- トレーシング (e.g. カーネル or ユーザープログラムトレーシング、パフォーマンスカウンタモニタリング)
- セキュリティ (e.g. システムコールフィルタリング)

#### cBPF / eBPF
- cBPF (classic BPF) - 従来利用されてきたカーネル内のパケットフィルタリング機構
- eBPF (extended BPF) - パケットフィルタリング以外に用途を広げたトレース機構
  - cBPFに比べて命令セットが一新され、使用可能なレジスタ数が増え、ヘルパー関数呼び出しの機能が追加された

## eBPFプログラムの書き方
- eBPFバイトコード
- eBPFマクロ
- eBPFアセンブラ
- C (Clang/LLVMでコンパイル)
- BPF C (BCCでコンパイル)
- bpftrace DSL (bpftraceコマンドで実行)
- libbpf (libbpfライブラリのAPIを使用)

## BPFを利用したプロジェクト
- BCC (BPF Compiler Collection) - Cで書かれたeBPFプログラムのコンパイラ
- bpftrace - BPFをラップするDSLを提供する汎用的なトレーシングCLI
- XDP (eXpress Data Path) - NICから受け取ったパケットデータを直接操作するツール
- Katran - XDPを活用した高性能L4ロードバランサ
- Cilium - コンテナ間通信に対してパケット処理に可観測性・セキュリティ・高度な通信制御を付与するソフトウェア

## 参照・引用
- [Berkeley Packet Filter（BPF）入門（1）](https://www.atmarkit.co.jp/ait/articles/1811/21/news010.html)
- [eBPFとは何か、なぜそれがオブザーバビリティに関係するのか？](https://newrelic.com/jp/blog/best-practices/what-is-ebpf)
- [eBPFプログラムを手軽にコーディング、ビルドし、コンテナ形式にパッケージングしてシェアできる「Bumblebee」オープンソースで登場](https://www.publickey1.jp/blog/22/ebpfbumblebee.html)
- [Linux eBPFトレーシング技術の概論とツール実装](https://blog.yuuk.io/entry/2021/ebpf-tracing)
