# eBPF仮想マシンアーキテクチャ
## 命令セット
- 各種算術演算
- ロード / ストア命令
- ジャンプ命令
- カーネル関数の呼び出し・アトミック命令
- カーネル内のネットワークパケットデータへのアクセス
- エンディアン変換など

#### 命令セットフォーマット
- 1命令あたり64ビット固定長

```c
struct bpf_insn {
  __u8  code;      // オペコード (LSB)
  __u8  dst_reg:4; // デスティネーションレジスタ
  __u8  src_reg:4; // ソースレジスタ
  __s16 off;       // オフセット (signed)
  __s32 imm;       // 即値 (signed) (MSB)
};
```

## レジスタ
- 仮想マシンのレジスタはJIT動作のためにホストCPUの実レジスタに割り当てられて利用される

#### レジスタの種類
- R0
  - 読み書き可能な汎用レジスタ
  - eBPFのプログラムおよびカーネル関数の戻り値を格納する
- R1 ~ R5
  - 読み書き可能な汎用レジスタ
  - eBPFのプログラムから呼び出すカーネル関数の引数を格納する
- R6 ~ R9
  - 読み書き可能な汎用レジスタ
- R10
  - 読み込み専用のスタックポインタ
  - スタックサイズは512バイト固定

## 参照
- [eBPF - 仮想マシン 編](https://zenn.dev/hidenori3/articles/cb8ddfb964bbc5)
