# BPF CO-RE
- 移植性のあるeBPFバイナリを作成するための仕組み

#### BTF (BPF Type Format)
- データ構造のレイアウトや関数のシグネチャを表現するためのフォーマット
  - eBPFアプリケーションをLinuxカーネルのどのバージョンに対してもポータブルに実行できるようにする
  - LinuxカーネルはBTFをサポートしており、実行中のシステムからvmlinux.hというヘッダファイルを生成し、
    BPFプログラムが必要とするカーネルに関するすべてのデータ構造情報を含むことができる
  - eBPFに関するメタデータを持ち、eBPFアプリケーションがロードされる際に
    プラットフォームとなるLinuxカーネルに対して常に適切な参照を持てるように
    バイナリ内のマッピングを直接書き換える

#### libbpf
- eBPFプログラムとMapをカーネルにロードするための関数を提供するライブラリ
- コンパイル時のデータ構造と移植先のマシンのデータ構造の違いを補正するため、
  BTFの情報を利用してeBPFのコードを調整する

#### Clangによるサポート
- ClangコンパイラはeBPFプログラムをコンパイルする際、BTFリロケーションを含むように改良された
- BTFリロケーション - libbpfがBPFプログラムとMapをカーネルにロードする際に調整するべき内容を表す

#### BPFスケルトン (オプショナル)
- ユーザー空間からBPFプログラムのライフサイクルを管理することができる関数群
    - BPFプログラムのライフサイクル - カーネルへのロード、イベントへのアタッチなど
- コンパイルされたBPFオブジェクトファイルから`bpftool gen skeleton`を使って自動生成することができる

## 参照
- What is eBPF? Chapter 4
- [BPF Type Format (BTF)](https://www.kernel.org/doc/html/latest/bpf/btf.html)
