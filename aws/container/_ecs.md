# Amazon ECS (Elastic Container Service)
- Dockerコンテナをスケーラブルかつ簡単に実行・停止・管理できる
  AWS独自のフルマネージドコンテナオーケストレーションサービス
- コンテナが実行されるリソースとしてEC2にクラスタを構築し、コンテナをプロビジョニングする
  - EC2起動型 - クラスタを手動で運用する
  - Fargate - クラスタもAWSマネージドとする
- コンテナの元となるDockerイメージはECRやDockerHubから取得する
- プラットフォームとしてKubernetesを使用する場合はEKSを利用する

## 構成要素
### クラスタ
- Dockerコンテナを実行するためのデータプレーン (コンテナが実行されるリソース) の実態となる
  1つ以上のEC2インスタンス群
- クラスタ内のそれぞれのインスタンスは単なるリソース量 (CPU,メモリ,ポートを供給するリソース量) として扱われる
- Fargateではクラスタ自体がAWSのマネージドサービスとして管理される

### タスク
- Dockerコンテナイメージ設定とイメージから生成されるコンテナにおけるクラスタ上の実行設定をセットにした概念
- どんなDockerコンテナを起動するのかと、それらの起動するDockerコンテナをグルーピングを定義する
- Kubernetesにおけるポッドの役割を担う
- タスクに含まれるコンテナは、同じタスクに含まれる他のコンテナとライフサイクルを共有する
- localhostを宛先にするとタスク内のコンテナ同士で通信が可能
- タスクごとにAWSのネットワークインターフェース (Elastic Network Interface) が割り当てられる
- タスクの仕様はJSON形式のテキストファイルへ宣言的に記述する (タスク定義)

#### タスクの定義項目
- タスクメモリ
- タスクCPU
- ネットワークモード
- ボリューム
- タスクロール
- タスク実行ロール

### サービス
- タスク定義された内容に基づき、実際に実行される複数のDockerコンテナの集合体
- どのタスク定義を利用するのか、何個のタスクを起動するのか、リクエスト分散するのかを管理する
- Kubernetesにおけるレプリカセットとデプロイメントの役割を兼ねる
- タスクのローリングアップデートや死活監視を行う
- サービスの仕様はJSON形式のテキストファイルへ宣言的に記述する(サービス定義)

#### サービスの定義項目
- 起動タイプ
- タスク定義
- クラスタ
- サービスタイプ
- タスクの数
- 最小ヘルス率
- 最大率
- デプロイメントタイプ
- ヘルスチェックの猶予期間
- ELB
- サービス検出統合の有効化
- ServiceAutoScaling

## ECSが行う仕事
### Dockerイメージのダウンロード
- タスクで指定されたDockerイメージを外部レジストリからダウンロードする
  - 外部レジストリとしてDocker HubやECR(Elastic Container Registry: AWSのDockerレジストリ)を指定できる

### タスクの配置の管理
- ユーザーのタスク配置戦略に従ってあらかじめ定義されたクラスタ内で適切な仮想インスタンスを選び出す
  - タスク配置戦略 - コンテナがどのインスタンスで起動され、スケーリング時にどのように増減するのか
  - 仮想インスタンスにDockerイメージを配置することにより、指定された計算タスクが開始される

### クラスタ (仮想サーバーのプール) のスケーリング
- クラスタのスケーリングやタスク配置戦略を設定すると、
  ECSはユーザーが投入した計算ジョブを必要に応じてスケーリングを行いながら実行する
- クラスタのスケーリングによって対象のジョブを実行するのにちょうど十分なだけのインスタンスが起動し、
  ジョブが完了した後は不要なインスタンスはすべて停止される

#### 起動タイプ
- Fargate
  - タスクの配置の管理が不要
  - コンテナイメージを指定するだけで簡単にコンテナを起動できる
  - コンテナを起動していなければ料金は発生しない
  - FargateインスタンスはEC2インスタンスのようにSSHでログインしたり
    追加のソフトウェアをインストールするなどの操作はサポートされていない
    (基本的にDockerコンテナを介してすべてのプログラムが実行される)
- EC2
  - タスクの配置の管理が必要
  - ノードのネットワーク構成などを細かく設定できる
  - コンテナを起動していなくてもインスタンスを起動していれば料金が発生

## 利点
- インフラストラクチャの管理・運用をAWSに任せることができる
- ユーザーはアプリケーション開発など本質的な仕事に集中できる
- AWSの他のサービスと統合されており、サービス同士の連携が容易
  - Amazon EC2 - サーバー仮想化サービス
  - AWS Fargate - サーバーレスなコンテナ実行環境サービス
  - AWS IAM - アクセス管理
  - Amazon Route 53 - DNSサービス
  - Amazon CloudWatch - モニタリングサービス
  - AWS CodePipeline - 自動ビルドサービス
  - AWS CodeDeploy - 自動デプロイサービス

## 欠点
- インフラストラクチャの管理・運用の権限をAWSが持つため、
  情報セキュリティマネジメントなどの要件によってはデメリットになる
- AWSに依存することでマルチクラウドへの展開が困難化する

## 参照
- 仮想化&コンテナがこれ1冊でしっかりわかる教科書
- [7. Docker 入門](https://tomomano.github.io/learn-aws-by-coding/#sec_docker_introduction)
- AWSの基本・仕組み・重要用語が全部わかる教科書 11-02
- [Amazon EC2 Container Service(ECS)の概念整理](https://qiita.com/NewGyu/items/9597ed2eda763bd504d7)
