# Kubernetes
- Cloud Native Computing Foundationが開発するコンテナオーケストレーションツール

### コンテナオーケストレーション
- 負荷分散
- 死活監視
- スケーリング

#### Kubernetesができること
- 死活監視と停止したコンテナの再起動
- エンドポイント提供と負荷分散
- 消費リソースを考慮したコンテナの配備
- ローリングアップデートとロールバック
- ストレージの管理
- 機密情報や構成情報の保管

#### Kubernetesができないこと
- 自動ビルド
- ログの記録・監視
- メッセージブローカー、DBなどミドルウェア的機能
- マシン自体の管理

### 特徴
- ファイルを用いた宣言的管理
- 広範なデプロイ形式のサポート
- 拡張性の高いアーキテクチャ・開発者コミュニティ

## 構成要素
### マシン要素
- Pod - 論理的なホスト環境・コンテナの最小実行単位
- ノード - アプリケーションを実行する各マシン
- クラスタ - ノードの集合体
- コントロールプレーン - Kubernetesクラスタ全体の管理を行うコンポーネント群

#### Pod
- KubernetesはPod単位でIPアドレスを払い出し、Pod同士はIPアドレスを介して通信可能
- Pod内のコンテナ同士はlocalhostで通信可能

#### クラスタ
- 少なくとも1つ以上のマスターノードと１つ以上のワーカーノードを含む

#### ノード
- マスターノード - ワーカーノードの管理を行うノード
  - コントロールプレーンをインストールしたサーバー群
  - 管理者はマスターノードに対して指示を出す
- ワーカーノード - 実際にコンテナを動作させるサーバー群
  - Pod単位でコンテナやネットワーク、ストレージを管理する
  - マスターノードから制御される
  - kube-let - kube-schedulerと連携してワーカーノード上にPodを配置し、Podに含まれるコンテナを実行する
    - 実行中のPodを監視し、kube-schedulerへ通知する
  - kube-proxy - ネットワーク通信をルーティングする

#### コントロールプレーン
- kube-controller-manager - コントローラを統括管理・実行する
  - コントローラ - 一連のKubernetesオブジェクトを処理するコンポーネント
- kube-scheduler - Podをワーカーノードへ割り当てる
- kube-apiserver - リソースの外部公開・リソースへのリクエストをHTTP APIで受ける
  - リソース - クラスタ全体の管理情報
- etcd - Kubernetesクラスタの情報を全管理するDB
- could-controller-manager - クラウドサービスと連携しクラウドサービス上で必要となるものを作る
  - AWS、Azure、GCP
  - ネットワークのルーティング、ロードバランサー、ストレージとなるボリュームの構成

### API
- `kubectl` - クラスタを操作するためのコマンド
- マニフェスト - クラスタへの操作をまとめて宣言(適用)するための設定ファイル

## 基本的なリソース
### Pod群のデプロイにまつわるリソース
- Deployment - Pod群を一定数に維持しながらクラスタ上に展開するリソース
  - セルフヒーリング
  - Pod群のスケーリング
  - アップデート・ロールバック
- StatefulSet - StatefulなPod管理を行うリソース
  - 各Podに一意のインデックスを付与
  - PersistentVolume(各Podに固有のボリューム(永続的なデータ格納領域)を割り当て)
- DaemonSet - 各ノード上にPodが一つずつ実行されている状態を維持するリソース
- Job - Podを単発で実行するリソース
- CronJob - PodをCronフォーマットで定期実行するリソース

### 設定項目に関するリソース
‐ ConfigMap - コンテナ内のアプリケーションが実行時に参照する設定項目を管理するリソース
- Secret - 秘匿性の高い設定項目(認証情報など)を管理するリソース

### ボリュームに関するリソース
- Volume - Podと同じライフサイクルを持つ格納領域およびリソース
- PersistentVolume - Podと独立したライフサイクルを持つ格納領域
- PersistentVolumeClaim - PersistentVolumeをPodから利用するためのリソース

### サービスディスカバリのためのリソース
- Service - 複数のPod群に共通のIPアドレスを付与することで単一のサービスのように提供するリソース
  - NodePort - Serviceの一種
    - 各ノード上のポートをクラスタ外に公開し、そのポートを通じた通信を
      Serviceを構成するPodのいずれかにロードバランスする
  - LoadBalancer Service - Serviceの一種
    - クラウドプロバイダなどKubernetes向けにロードバランサ機能を提供しているプラットフォームで利用可能
    - そのロードバランサを通じて各サービスをクラスタ外に公開できる
- Ingress ‐ L7ロードバランシング機能を提供するリソース
  - URLのルールベースでバックエンドとするServiceを指定することができる

## Kubernetesのマネージドサービス
- Amazon EKS
- GCP GKE
- Azure AKS

## 仕組み
```
          $ kubectl apply
                |
            APIサーバー
                |
---------------------------------------- ノード内
                |
              kubelet
              (ノード上のPod群への操作指示に応じてCRIランタイムを呼び出す)
                | <- gRPC
           CRIランタイム
           (イメージの取得、Pod・コンテナ群の管理)
           /           \
OCIランタイム          CNIプラグイン
(実行環境作成)         (Pod同士の通信機能を与える)
             \        /
                Pod
```

#### CRIランタイム
- kubeletからPod操作に関する指示を受け、
  イメージをレジストリから取得したり、
  コンテナ群をPodとして作成したりする

#### CNIプラグイン
- PodにIPアドレスを払い出し、仮想的なNICをPodに付与する
  - kube-proxy - Service機能を実現する通信を管理するコンポーネント
    - APIサーバー上のServiceなどのリソースを把握し、
      各Service宛の通信がそれを構成するPodに送られるように対応関係をノード上で管理する

#### OCIランタイム
- CRIランタイムなど高位のランタイムから指示を受け、
  ホストから隔離された実行環境をコンテナとして作り出し
  その直接操作の手段を与える

## 引用・参照
- [Kubernetes](https://kubernetes.io/)
- 仮想化&コンテナがこれ1冊でしっかりわかる教科書
- イラストでわかるDockerとKubernetes
- さわって学ぶクラウドインフラ docker基礎からのコンテナ構築
