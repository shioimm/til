# 安全なWebアプリケーションの作り方(脆弱性が生まれる原理と対策の実践) まとめ
- 徳丸浩 著

## 06 セッション管理の不備
- セッションハイジャック -> 第三者がセッションIDを悪用して成りすます攻撃
  - [セッションIDの推測]
    - アプリケーション -> セッションIDの推測
    - ミドルウェア -> セッションIDの推測
  - [セッションIDの盗出]
    - アプリケーション-> XSS・HTTPヘッダインジェクション・Refererの悪用
    - ミドルウェア -> XSS・HTTPヘッダインジェクション・Refererの悪用
    - ネットワーク -> ネットワーク盗聴
  - [セッションIDの強制]
    - アプリケーション -> セッションIDの固定化攻撃

### [セッションIDの推測]推測可能なセッションID
- 発生箇所: セッションIDを生成している箇所
- 影響範囲: セッション管理を利用している全てのページ
- 影響の種類: なりすまし
- 影響度合い: 大
- 利用者関与の範囲: 不要
- 対策: 信頼できるセッション管理機構を利用する

#### 事例
- 攻撃対象アプリケーションからセッションIDを収集
  - セッションIDの規則性の仮説を立てる
  - 推測したセッションIDを対象アプリケーションで試す

#### 原因
- 推測されやすいセッション管理機構を利用している

#### 対策
- 信頼できるセッション管理機構を利用する

### [セッションIDの盗出]URL埋め込みのセッションID
- 発生箇所: セッションIDを生成している箇所
- 影響範囲: セッション管理を利用している全てのページ
- 影響の種類: なりすまし
- 影響度合い: 中~大
- 利用者関与の範囲: 必要 -> リンクのクリック、罠サイトの閲覧
- 対策: URL埋め込みのセッションIDを使用しない

#### 事例
- 攻撃者が被害者に対して罠サイトを閲覧させることによって、
罠サイトのURLに埋め込まれていたセッションIDをReferer経由で取得する
- 被害者が自らセッションID付きのURLをSNSなどに公開する

#### 原因
- 歴史的経緯などによりセッションIDがURLに埋め込まれている

#### 対策
- セッションIDをクッキーに保存する

### [セッションIDの強制]セッションIDの固定化
- 発生箇所: ログイン処理を行う箇所
- 影響範囲: セッション管理を利用している全てのページ
- 影響の種類: なりすまし
- 影響度合い: 中
- 利用者関与の範囲: 必要 -> 罠サイトの閲覧、本番サイトでの認証
- 対策: ログイン時にセッションIDを変更する

#### 事例
- 罠サイトログイン時にセッションIDが固定化した状態で認証される
  - 利用者情報がセッションIDに蓄積される
  - 攻撃者は固定化したセッションIDを埋め込んだURLから被害者の個人情報を閲覧する
- アプリケーション利用者に対して固定化したセッションIDを埋め込んだ罠URLでログインさせる
  - 攻撃者は固定化したセッションIDを埋め込んだURLから被害者の個人情報を閲覧する

#### 原因
- セッションアダプション(未知のセッションIDを受け入れるミドルウェア側の特性)
- クッキーモンスターバグ
- XSS脆弱性
- HTTPヘッダインジェクション脆弱性

#### 対策
- 認証後にセッションIDを変更する
- ログイン時にトークンを生成し、クッキーとセッション変数両方に記憶させる
  - 各ページの認証時にクッキー上のトークンとセッション変数のトークンの比較を行う
- (ログイン前)hiddenパラメータで値を渡す
