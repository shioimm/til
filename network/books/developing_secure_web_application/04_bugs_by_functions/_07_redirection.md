# 安全なWebアプリケーションの作り方(脆弱性が生まれる原理と対策の実践) まとめ
- 徳丸浩 著

## 07 リダイレクト処理にまつわる脆弱性
- ログイン成功後、外部から指定したURLにリダイレクトを行うようなアプリケーションにおける脆弱性

### オープンリダイレクト脆弱性
- 発生箇所: 外部から指定したURLにリダイレクト可能な箇所
- 影響範囲: フィッシング手法により利用者が被害を受ける
- 影響の種類: フィッシングサイトへの誘導・マルウェアの配布
- 影響度合い: 中〜大
- 利用者関与の範囲: 必要 -> リンクのクリック、情報の入力
- 対策:
  - リダイレクト先を固定化
  - リダイレクト先のドメインを指定

#### 事例
- 正規サイトのログイン用URLに罠を仕込んで利用者に踏ませる
  - ログイン後のリダイレクト先を任意の罠サイトに変更する

#### 原因
- リダイレクト先のURLを外部から指定できる
- リダイレクト先のドメインの指定がない
- ただし次の条件を満たす場合は脆弱性ではない(バナー広告など)
  - 元々外部のサイトに遷移する仕様である
  - 利用者にとって外部サイトに遷移することが自明である

#### 対策
- リダイレクト先のURLを固定にする(推奨)
  - リダイレクト先を外部から指定できないようにする
- リダイレクト先のURLを直接指定せず番号指定にする(推奨)
  - リダイレクト先のURLをそのまま指定せずページ番号の形で指定する
  - URLとページ番号の対応づけは外部から見えないソース(DBなど)で行う
- リダイレクト先のドメインを指定する
  - 正規表現によってリダイレクト先のURLが正規のものであるかチェックする

### HTTPヘッダインジェクション
- リダイレクト処理以外にHTTPレスポンスヘッダの出力箇所で発生する恐れがある(クッキー出力など)
- 発生箇所: 外部から指定したパラメータによってHTTPレスポンスヘッダを出力している箇所
- 影響範囲: 任意のJavaScript実行によりアプリケーション全体
- 影響の種類: なりすまし、偽ページの表示、キャッシュ汚染
- 影響度合い: 中〜大
- 利用者関与の範囲: 必要 -> 罠サイトの閲覧・メール記載のURLの起動
- 対策:
  - 外部からのパラメータをHTTPレスポンスヘッダとして出力しない
  - リダイレクトやクッキー生成の専用ライブラリを使用し、パラメータ中の改行コードをチェックする

#### 事例
- URLパラメータに改行文字を挟むことによって複数のLocationヘッダを指定し、
  本来のリダイレクト先ではなく罠のリダイレクト先に遷移させる
- 上記と同様の手法でリダイレクト時に罠のSet-Cookieレスポンスヘッダを返す
- 上記と同様の手法で複数の改行を挟むことによって偽のレスポンスボディを返す

#### 原因
- 改行ごとに定義されるHTTPヘッダの仕様を悪用し、
  本来のパラメータに偽の改行を仕込むことで任意のレスポンスを生成する

#### 対策
- 外部からのパラメータをHTTPレスポンスヘッダとして出力しない
  - リダイレクト先のURLを固定にする
  - リダイレクト先のURLを直接指定せず番号指定にする
- リダイレクトやクッキー生成を専用APIに任せ、
  ヘッダ生成するパラメータ中の改行コードをチェックする
  - URL中の改行はエラーとする
    - そもそもリダイレクト処理にURLを渡す時点でパーセントエンコードは終わっているはずなので、
      URLに改行が入っていることが異常である
  - クッキー値をパーセントエンコードする
    - ただしクッキーに改行が入る可能性はあるので、パーセントエンコードによって脆弱性を防ぐ
