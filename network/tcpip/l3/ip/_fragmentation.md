# IPフラグメンテーション
## (前提)
- データリンクによってMTUが異なる
- IPはデータリンクごとのMTUの差異に左右されることなく利用できる必要がある

## パケットの分割・再構築
- IPデータグラムサイズが送信先のデータリンクのMTUよりも大きいという状況が発生する度、
  ノードは必要に応じてIPデータグラムを分割する
- 分割されたデータグラムはオフセットフィールドに元のデータグラム内での位置を持つ
- 分割されたデータグラムは終点ノードで再構築される(経路上のノードでは分割のみを行う)

## 経路MTU探索
- (前提) IPフラグメンテーションはルーターに負荷がかかり、パフォーマンスを劣化させる
- (前提) 分割の結果、一部のデータグラムが失われると、全てのデータグラムが失われる
- 経路MTU探索は経路MTUを発見し、送信元ホストで予めデータグラムを経路MTUサイズに分割してから送信する手法
  - 経路MTU - 送信元ホストから宛先ホストまで分割処理が必要にならない最大のMTU
  - 経路MTU探索によってルーターによる分割が不要になり、TCPは可能な限り大きなサイズのデータで送信できる

### 経路MTU探索の動作フロー
1. (送信元ホスト) IPヘッダ中の分割禁止フラグを1に設定
    - これによってルーターは分割処理を行わなくなる
2. (ルーター) (MTUサイズオーバーによりパケットが処理できない場合)パケットを破棄する
3. (ルーター) 送信元ホストへICMP到達不能メッセージを返送する
4. (送信元ホスト) ICMP到達不能メッセージからルーターのMTUを知る
5. (送信元ホスト) TCPの再送処理によりデータが再送される
    - TCPはMTUのサイズを元に最大セグメント長(MSS)の値を再計算し、
      MSSの値を元にパケットを区切ってIPに渡す
    - IPは分割処理を行わない
6. ICMP到達不能メッセージが返ってこなくなれば受信ホストまでの経路MTUが得られたことになる

## 参照
- Linuxプログラミングインターフェース 58章
- Software Design 2021年5月号 ハンズオンTCP/IP
- マスタリングTCP/IP 入門編
