# IP
- IPアドレスを元に、インターネット全体にパケットを送り届けるためのプロトコル
  - インターネットに接続されるすべてのノード(ホスト・ルーター)は必ずIP・TCPの機能を実装する
  - インターネットに接続されるノード以外の機器(ブリッジ・リピータ・ハブ)はIP・TCPの機能を実装する必要はない
    - ノード以外の機器はIPパケットを単なるビット列やフレームとして扱うため
- コネクションレス指向・信頼性を担保しない・ベストエフォート通信
  - 機能の簡略化と高速化のため
- IPデータグラムは20-60バイトのヘッダを持ち、宛先ホストのアドレスや送信元のアドレスを扱う

## IPv4パケットフォーマット
- バージョン (4ビット)
- IHL: ヘッダ長 (4ビット)
- ToS: Type of Service (8ビット)
  - IPパケットの優先度
  - QoSで使用
  - IPプレシデンス (先頭3ビット) - 8段階で表現する優先度
  - DSCP: DiffServ Coode Point (先頭6ビット) - 64段階で表現する優先度 + 破棄確率
- パケット長 (16ビット)
  - IPヘッダ長 + IPペイロード長
- 識別子 (16バイト)
  - IPフラグメンテーション用
  - IPパケット生成時にランダムに割り当てられるID
  - フラグメンテーション発生後、パケットの再結合に利用される
- フラグ
  - IPフラグメンテーション用
  - 1ビット + DF (Don't Fragment) ビット + MF (More Fragments) ビット
  - DFビット - フラグメントしても良いパケットかどうか
  - MFビット - 後続のフラグメントパケットがあるかどうか
- フラグメントオフセット
  - IPフラグメンテーション用
  - フラグメントした場合にそのパケットが元のパケットの先頭からどの位置にあるか
- TTL (Time To Live)
  - ホップできるノード数
  - 0になった場合はICMPで送信元ノードへ知らせる
- プロトコル番号
  - IPペイロードを構成するトランスポート層プロトコルの種類を示す番号
- ヘッダチェックサム
  - IPヘッダの整合性を確認する
- 送信元IPv4アドレス
- 送信先IPv4アドレス
- IPv4ペイロード

### PHB (Per Hop Behavior)
- IPパケットはDSCPに応じたPHBによって転送される

#### PHBの種類
- EF (Expedited Forwarding: 完全優先転送) - 絶対優先
- AF (Assured Forwarding: 相対的優先転送) - EFほどではないが優先
- CS (Class Selector) - IPプレシデンスとの下位互換確保のためのPHB
- デフォルト - ベストエフォートサービス

## IPv6パケットフォーマット
- バージョン
- トラフィックサイズ
- フローラベル
- 送信元IPv6アドレス
- 送信先IPv6アドレス
- IPv6ペイロード

## 送受信バッファ
- ホストマシン・ルーターはIPパケットを送受信するための送信バッファ・受信バッファを持つ
  IPパケットはホストマシン・ルーターの送受信バッファを介して転送される
- ホストマシン・ルーターの送受信バッファの実体はメモリ
- ホストマシン・ルーターの送受信バッファはキュー構造になっている

### 送受信バッファの利点
- 伝送速度が異なるネットワークに対応できる
- 送信先が異なるパケットが混在できる
- 処理能力が異なるホストに対応できる
- パケットの流量の変動に対応できる

## IPトンネリング
- IPv6またはIPv4パケットが自らと異なるIPv4またはIPv6プロトコルのネットワーク上を通過できるよう、
  パケットにIPv4ヘッダまたはIPv6ヘッダを付加する技術
- トンネルの手前に該当するノードがヘッダを付加し、トンネルの出口に該当するノードがヘッダを取り除く

## 参照
- Linuxプログラミングインターフェース 58章
- Software Design 2021年5月号 ハンズオンTCP/IP
- マスタリングTCP/IP 入門編
- パケットキャプチャの教科書
