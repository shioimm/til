# IPSec (Security Architecture for Internet Protocol)
- IPヘッダの後ろに暗号化のためのヘッダを付加し、以降のデータを暗号化するプロトコル (RFC4301)
- 暗号化のためのやりとりはVPNの両端にあたるノード(イニシエータ - レスポンダ)が行う
- IPパケット単位での暗号化・認証を提供する
- IPv4ではオプション、IPv6では標準実装
- ネットワーク層でIPパケットのカプセル化・認証・暗号化を行い、
  インターネット上に仮想的な専用線 (VPN: Virtual Private Netowork) を作るために利用される

## IPSecが提供する機能
- 鍵交換機能 (IKE)
- 対向認証機能 (IKE)
- トンネリング機能 (ESP / AH)
- 暗号化機能 (ESP)
- メッセージ認証機能 (IKE / ESP / AH)
- リプレイ防御機能 (IKE / ESP /AH)

#### 具体的な機能
- セキュリティポリシーに従ったパケットフィルタリング
- MACによるデータの完全性の保証
- MACによるパケットの真正性の保証
- シーケンス番号を用いた再送攻撃の防御
- ステートレスCookieを用いた送信元偽装鵜パケットの判別
- データの暗号化による機密生の確保(ESP)
- IPより上位層のヘッダを暗号化することによる機密性の確保

## 構成プロトコル
- IKE (Internet Key Exchange)
  - AHもしくはESPに先立って行われる鍵の共有、暗号方式のネゴシエーションのためのプロトコル
- ESP (Encapsulating Security Payload)
  - IPパケットの真正性・完全性・機密性を確保するプロトコル
- AH (Authenticatiion Header)
  - IPパケットの真正性・完全性を確保するプロトコル
- IPComp (IP Payload Compression Protocol)
  - IPSecパケットの圧縮を行うプロトコル

## 動作モード
#### トランスポートモード
- ホスト間のみでVPNを行う場合に利用する
- IPヘッダとTCP/UDPヘッダの間にトンネル用ヘッダを差し込み、
  TCP/UDPペイロードの後にトンネル用トレーラ・認証データを差し込む

#### トンネルモード
- VPN全般に利用する
- セキュリティゲートウェイがパケットにIPSecヘッダを追加する
  - = セキュリティゲートウェイ間でVPNを実現する
- IPヘッダの前ににトンネル用IPヘッダ・トンネル用ヘッダを差し込み(IPパケットのカプセル化)、
  TCP/UDPペイロードの後にトンネル用トレーラ・認証データを差し込む

## SA (Security Association)
- ピア間で確立される単方向のコネクション (仮想的な専用回線)
- ピア同士は上り通信用・下り通信用のSAをそれぞれ確立する
- セキュリティプロトコル、通信モード、暗号化方式などIPSec通信に必要なパラメータの集合
- IPSecで通信する機器同士はピアの関係となり、IPSecピア間でSAを確立する
- 双方向の通信を行う場合はSAを双方に対して一本ずつ張る

## 接続フロー
#### フェーズ1
1. IKEにより共通鍵を生成するためのパラメータを相互に交換し、お互いに共通鍵を生成する
2. 制御用SAであるISAKMP SAを確立し、ピアの認証を行う

#### フェーズ2
1. IPSec SAを確立するためのパラメータをISAKMP SAによる暗号化通信でやりとりし、IPSec SAを確立する
2. ESPを利用してパケットをカプセル化・ハッシュ化・暗号化し送信する
3. 受信後は複合して認証の検証を行い、上位レイヤにパケットを渡す

## 参照
- マスタリングTCP/IP 入門編
- マスタリングTCP/IP 情報セキュリティ編
- パケットキャプチャの教科書
