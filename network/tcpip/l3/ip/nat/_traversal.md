# NATトラバーサル (NAT越え)
- NATを用いて外部と接続されているプライベートネットワーク内のコンピュータが、
  直接インターネットに接続されているように振る舞うことができるようにする技術
- NAT利用時、内部のコンピュータが外部のサーバに接続することはできても
  外部から内部のコンピュータに接続することができない課題に対応する

## STUN
- Session Traversal Utilities for NAT
- 自身のネットワーク上のNATデバイスの存在を発見し、NATが存在する場合は
  自身の接続に割り当てられているパブリックIPとポート番号を取得するためのプロトコル
- STUNプロトコルはパブリックネットワーク上に存在するSTUNサーバーを利用する
  - STUNサーバーはパブリックIP・ポート番号を返す

#### STUNプロトコルの仕組み
1. STUNサーバーのIPアドレスが既知の場合、
   クライアントアプリケーションはSTUNサーバーへバインディングリクエストを送信する
2. STUNサーバーはレスポンスとして、
   クライアントアプリケーションのパブリックネットワークから見たIPアドレスとポート番号を返す

#### STUNプロトコルが解決する問題
- クライアントアプリケーションはパブリックIPとポート番号の組みを発見し、
  ピアとの通信時にパブリックIPとポート番号の組みをデータの一部として使用する
- STUNサーバーへのバインディングリクエストによって
  インバウンドパケットがクライアントアプリケーションへ到達できる
  ルーティングエントリが作成される
- STUNプロトコルにはKeep-Aliveメカニズムが定義されており、
  NATルーティングエントリのタイムアウトを防止する

## TURN
- Traversal Using Relays around NAT
- STUNが機能しない場合のフォールバックとして使用されるプロトコル
- UDPで動作し、動作しない場合はTCPへ切り替える
- TURNプロトコルはパブリックネットワーク上に存在するTURNサーバーを利用する
  - TURNサーバー(パブリックリレーサーバー)はピア間でデータを往復させる

#### TURNプロトコルの仕組み
1. 双方のクライアントが同一のTURNサーバーに割当要求を送信し、
   続けてパーミッションのネゴシエーションを行うことで接続を開始する
2. 双方のクライアントはデータをTURNサーバーに送信し、
   TURNサーバーがそのピアにデータを受け渡すことで通信を行う

## ICE
- Interactive Connectivity Establishment
- 通信の参加者間で最も効率の良い経路を確立するためのプロトコル
- 可能な限り直接接続を行い、必要ならばSTUNを活用し、動作しない場合はTURNを使用する

## 参照
- [NATトラバーサル 【NAT traversal】 NAT越え / NAT-T](https://e-words.jp/w/NAT%E3%83%88%E3%83%A9%E3%83%90%E3%83%BC%E3%82%B5%E3%83%AB.html)
- ハイパフォーマンスブラウザネットワーキング
