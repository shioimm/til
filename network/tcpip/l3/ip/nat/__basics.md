# NAT (Network Address Translation)
- 少数のグローバルIPアドレスを多数のプライベートIPアドレスで共有するための仕組み
- NAT対応ルーターは、内部にアドレス変換のためのテーブルを持つ
  - ローカルアドレスからルーターの外のアドレスへパケットが送信される際に作成される
- 一般的にはNAT = IPアドレスとポート番号の組み合わせを変換するNAPTを指す
  - IPアドレスだけを変換するNATはベーシックNAT

## 仕組み
- LAN内の特定のノード(NATノード)のみがグローバルアドレス・プライベートアドレスを持つ
- LAN内のNATノード以外のノードはプライベートアドレスのみを持つ
- 外部との通信を行う際はNATノードがアドレス変換を行い通信を中継する
  - 内部アドレス       - LANにおけるアドレス
  - 外部アドレス       - インターネットにおけるアドレス
  - ローカルアドレス   - NATによって変換する前のアドレス
  - グローバルアドレス - NATによって変換した後のアドレス

## 変換前後アドレスの対応による分類
#### スタティックNAT
- 変換前アドレスと変換後アドレスが1:1で対応する
- 主にLAN側に設置している特定のWebサーバーをインターネットに公開する際に使用される

#### ダイナミックNAT
- 変換前アドレスと変換後アドレスがN:Nで対応する
- アドレス変換の際、アドレスプールの中からその時点で使われていないアドレスが選択される
  - アドレスプール - 使用可能なアドレスの範囲

#### NAPT(Network Address Port Translation / IPマスカレード / PAT)
- 変換前アドレスと変換後アドレスが変換後アドレスのポート番号ごとに1:1で対応する
  - e.g.1 - グローバルIPアドレス`198.51.100.xxx:1234` - プライベートIPアドレス`192.168.0.2`
  - e.g.2 - グローバルIPアドレス`198.51.100.xxx:4567` - プライベートIPアドレス`192.168.0.3`
- アドレス変換の際、アドレスとポート番号を組み合わせて使用する
  - 同一のグローバルアドレスでもポート番号によってLAN側のクライアントPCを区別することができる

## 変換対象となるアドレスによる分類
#### SNAT (Source NAT: マスカレード)
- LAN -> インターネット方向の通信におけるNAT
- パケットの送信元をLAN内のプライベートアドレスからルーターのグローバルアドレスへ変換する
- 送信元がプライベートアドレス、送信先がグローバルアドレスであるケースにおいてルーターによって実行される
  - ルーターは送信元のプライベートアドレスとポート番号を書き換え、記録する
  - ルーターは送信先から返ってきたパケットの送信先を送信元のプライベートアドレスとポートへ書き換える
  - アドレスを書き換えるためのルールはルータープロセスにて`iptables(1)`を使用して設定する

#### DNAT (Destination Nat)
- インターネット -> LAN方向の通信におけるNAT
- パケットの送信先をルーターのグローバルアドレスからLAN内のプライベートアドレスへ変換する
  - 「ポートを開ける」
  - 送信先のポート番号が特定の値になっているパケットのみに対して操作を実行する

## NATの問題点
- NATの外側から内側のサーバーに接続できない (NATトラバーサルを用いて解決する)
- 変換テーブルの作成や変換処理にオーバーヘッドがかかる
- 通信中にNATが異常動作して再起動した場合、
  すべてのTCPコネクションがリセットされる
  - NATの台数を増やして冗長化してもTCPコネクションは必ず切れる

## 参照
- Linuxで動かしながら学ぶTCP/IPネットワーク入門 7
- [「NAT」の仕組みとルーターへの設定方法 ](https://www.atmarkit.co.jp/ait/articles/1512/03/news018.html)
- ハイパフォーマンスブラウザネットワーキング
