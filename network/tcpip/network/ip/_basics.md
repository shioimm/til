# IP
- IPアドレスを元に、インターネット全体にパケットを送り届けるためのプロトコル
  - インターネットに接続されるすべてのノード(ホスト・ルーター)は必ずIP・TCPの機能を実装する
  - インターネットに接続されるノード以外の機器(ブリッジ・リピータ・ハブ)はIP・TCPの機能を実装する必要はない
    - ノード以外の機器はIPパケットを単なるビット列やフレームとして扱うため
- コネクションレス指向・信頼性を担保しない・ベストエフォート通信
  - 機能の簡略化と高速化のため
- IPデータグラムは20-60バイトのヘッダを持ち、宛先ホストのアドレスや送信元のアドレスを扱う

## IPフラグメンテーション
### (前提)
- データリンクによってMTUが異なる
- IPはデータリンクごとのMTUの差異に左右されることなく利用できる必要がある

### パケットの分割・再構築
- IPデータグラムサイズが送信先のデータリンクのMTUよりも大きいという状況が発生する度、
  ノードは必要に応じてIPデータグラムを分割する
- 分割されたデータグラムはオフセットフィールドに元のデータグラム内での位置を持つ
- 分割されたデータグラムは終点ノードで再構築される(経路上のノードでは分割のみを行う)

### 経路MTU探索
- (前提) IPフラグメンテーションはルーターに負荷がかかり、パフォーマンスを劣化させる
- (前提) 分割の結果、一部のデータグラムが失われると、全てのデータグラムが失われる
- 経路MTU探索は経路MTUを発見し、送信元ホストで予めデータグラムを経路MTUサイズに分割してから送信する手法
  - 経路MTU - 送信元ホストから宛先ホストまで分割処理が必要にならない最大のMTU
  - 経路MTU探索によってルーターによる分割が不要になり、TCPは可能な限り大きなサイズのデータで送信できる

#### 経路MTU探索の動作フロー
1. (送信元ホスト) IPヘッダ中の分割禁止フラグを1に設定
    - これによってルーターは分割処理を行わなくなる
2. (ルーター) (MTUサイズオーバーによりパケットが処理できない場合)パケットを破棄する
3. (ルーター) 送信元ホストへICMP到達不能メッセージを返送する
4. (送信元ホスト) ICMP到達不能メッセージからルーターのMTUを知る
5. (送信元ホスト) TCPの再送処理によりデータが再送される
    - TCPはMTUのサイズを元に最大セグメント長(MSS)の値を再計算し、
      MSSの値を元にパケットを区切ってIPに渡す
    - IPは分割処理を行わない
6. ICMP到達不能メッセージが返ってこなくなれば受信ホストまでの経路MTUが得られたことになる

## 送受信バッファ
- ホストマシン・ルーターはIPパケットを送受信するための送信バッファ・受信バッファを持つ
  IPパケットはホストマシン・ルーターの送受信バッファを介して転送される
- ホストマシン・ルーターの送受信バッファの実体はメモリ
- ホストマシン・ルーターの送受信バッファはキュー構造になっている

### 送受信バッファの利点
- 伝送速度が異なるネットワークに対応できる
- 送信先が異なるパケットが混在できる
- 処理能力が異なるホストに対応できる
- パケットの流量の変動に対応できる

## IPトンネリング
- IPv6またはIPv4パケットが自らと異なるIPv4またはIPv6プロトコルのネットワーク上を通過できるよう、
  パケットにIPv4ヘッダまたはIPv6ヘッダを付加する技術
- トンネルの手前に該当するノードがヘッダを付加し、トンネルの出口に該当するノードがヘッダを取り除く

## 参照
- Linuxプログラミングインターフェース 58章
- Software Design 2021年5月号 ハンズオンTCP/IP
- マスタリングTCP/IP 入門編
