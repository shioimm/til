# DHCP (Dynamic Host Confuguration Protocol)
- 動的ホスト設定プロトコル
- TCP/IPのネットワークを使用するために必要な設定作業を自動化する
  - ネットワークインターフェースにIPアドレスを付与する
  - デフォルトルートのルーティングエントリをルーティングテーブルに追加する
  - 名前解決に利用するネームサーバーを指定する
- DHCP自体の設定はUDPで行われる

#### 構成要素
- DHCPサーバー
  - ネットワークの設定を配布するサーバープロセス
  - 予め配布するIPアドレス、サブネットマスク、経路制御、デフォルトルート、DNSサーバーのアドレスなどを設定
  - デフォルトルートとなるルーターが兼任するケースが多い
- DHCPクライアント
  - ネットワークの設定を受け取るクライアントプロセス

## 動作フロー
#### DHCP
1. DHCPクライアントがDISCOVER (DHCP発見) パケットをブロードキャストする
    - IPアドレスやネットマスクなどのネットワークの設定を要求する
    - 送信元: 0.0.0.0:68 (任意のIPv4アドレス)
    - 宛先: 255.255.255.255:67 (ブロードキャスト)
    - UDPを使用
2. DHCPサーバーがOFFER (DHCP提供) パケットを送信する
    - 使用して良いネットワークの設定を通知する
    - 宛先: ARPから提供されたクライアントのMACアドレス
3. DHCPクライアントがREQUEST (DHCP要求) パケットをブロードキャストする
    - `2`で通知された設定を使用したいことを通知する
    - 送信元: 0.0.0.0:68 (任意のIPv4アドレス)
    - 宛先: OFFERパケットで受け取ったサーバーのIPアドレス
4. DHCPサーバーがACKNOWLEDGEMENT (DHCP確認応答) パケットを送信する
    - `3`の要求に対する許可を通知する
    - 宛先: OFFERパケットで通知したクライアントのIPアドレス
5. IPアドレスが不要になった場合、DHCPクライアントがRELEASE (DHCP解放パケット) をブロードキャストする

#### DHCPv6
1. DHCPv6クライアントがSolicit (要請) パケットをマルチキャスト
    - 宛先: ff02::1:2
2. DHCPv6サーバーがAdvertise (広告) パケットを送信
    - 設定情報の送信
3. DHCPv6クライアントがRequest (要求) パケットをマルチキャスト
    - 設定情報の確認
4. DHCPv6サーバーがReply (応答) パケットを送信
    - 設定情報を送信

### IPアドレスの重複の確認
- DHCPサーバーはIPアドレスを配布する前にICMPエコー要求パケットを送信し、
  応答がないことを確認する
- DHCPクライアントはDHCPサーバーから配布されたIPアドレスに対してARP要求パケットを送信し、
  応答がないことを確認する

## 参照
- Linuxプログラミングインターフェース 58章
- サーバ・インフラエンジニアの基本がこれ一冊でしっかり身につく本 2.8-9
- Linuxで動かしながら学ぶTCP/IPネットワーク入門 4.5
- コンピュータネットワーク
- マスタリングTCP/IP 入門編
- 実践パケット解析 第3版
