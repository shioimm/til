# TLSの最適化
## TLSセッション再開(TLS Session Resumption)
- TLSは複数回にわたる接続においてネゴシエート済の秘密鍵を再利用または共有する機能を提供する
  - 複数プロセスやワーカーを走らせている共有のセッションキャッシュを使用する
  - 共有セッションキャッシュのサイズはトラフィック量によって調整する
  - セッションタイムアウトを設定する
  - 複数サーバーの環境において同一のクライアントIPもしくはTLSセッションIDを常に同じサーバーにルーティングする
  - TLSセッションキャッシュの統計情報を監視する

### セッションキャッシング
1. サーバー -> クライアント
    - 32バイトのセッションIDを生成し、ServerHelloメッセージに付加して送信する
    - サーバーはそれぞれのピアのセッションIDとネゴシエートされたセッションパラメータをキャッシュできる
2. クライアント -> サーバー
    - セッションID情報をキャッシュし、次のセッションのClientHelloメッセージに付加する
3. サーバー -> クライアント
    - それぞれのピアのセッションIDとネゴシエートされたセッションパラメータをキャッシュする
4. クライアント・サーバーの両者が共有セッションIDパラメータをキャッシュしている場合、
   短縮ハンドシェイクを行うことができる

#### 課題
- サーバーが全てのピアのセッションキャッシュを生成し、維持する必要がある
  - 確立したTLS接続後おtにメモリが消費される
  - セッションIDのキャッシュと削除ポリシーが必要

### ステートレスなセッション再開
1. クライアント -> サーバー
    - セッションチケットをサポートしていることをサーバーに伝える
2. サーバー -> クライアント
    - TLSハンドシェイクの最後にNewSessionTicketレコードを含める
    - NewSessionTicket - サーバーが持つ秘密鍵で暗号化された全てのセッションデータを含む
3. クライアント -> サーバー
    - セッションチケットを保持し、次のセッションのClientHelloメッセージのSessionTicket拡張に付加する

## TLS False Start
- アプリケーションデータを送信できるようになるタイミングを、
  TLSハンドシェイク時点からTLSハンドシェイクが部分的に完了した時点へ変更する
  - ClientHello、ServerHelloが完了すると、
    クライアントはClientKeyExcangeレコードと同時にアプリケーションデータを送信できる

## TLSレコードサイズ
- 小さいレコードサイズはオーバーヘッドを発生させ、大きいレコードサイズはレイテンシを発生させる
- レコードサイズはTCP接続の状態に応じて動的に調整する
  - 新規接続かつTCP輻輳ウィンドウが小さい場合またはアイドル状態:
    - 各TCPパケットはTLSレコードをひとつだけ送信させる
    - TLSレコードはTCPに割り当てられた最大MSSを占有させる
  - 輻輳ウィンドウが十分に大きく、サイズの大きなストリームを転送する場合:
    - TLSレコードのサイズはフレーム化処理を削減しCPUの無駄遣いを避けるため
      複数のTCPパケットにまたがっても構わない

## TLS圧縮
- TLS圧縮はセッションハイジャック脆弱性と不要な圧縮を行うアルゴリズムの実装により利用を避けるべき
- ブラウザ側はTLS圧縮を無効化しているため、サーバー側でも無効化する

## 証明書チェーン
- 中間認証局の数を最小化する
  - 理想的には証明書チェーンに含まれる証明書は自サイトとと認証局の中間証明書の2つのみであるべき
  - ルート証明書はブラウザに含まれるため送信するべきではない

## HSTS
- オリジンへのリクエストは全てHTTPSを使用して送信するべき
- 安全でないリンクやクライアントリクエストはリクエストが送信される前に自動的にHTTPSへ変換されるべき
- 証明書エラーが発生した場合はエラーメッセージを表示し、ユーザーはメッセージを迂回できない
- `max-age`は指定されたHSTSルールの生存期間を設定する
- 指定された証明書チェーンに指定されているホストのフィンガープリントを
  ユーザーエージェントに記憶するよう指示する

## チューニングチェックリスト
- [ ] TCPを最適化する
- [ ] TLSライブラリを最新版に更新し、そのライブラリでサーバーを再構築する
- [ ] セッションキャッシュとステートレス再開を有効化し、適切に設定する
- [ ] セッションキャッシュのヒットレートを監視し、適宜設定を調整する
- [ ] TLS False Startを有効にするために前方秘匿性に対応する暗号化形式を設定する
- [ ] TLSセッションを地理的にユーザーに近い場所で終了させ、パケット往復のレイテンシを最小化する
- [ ] TLSレコードサイズがTCPの1セグメントに収まるように設定する
- [ ] 証明書チェーンがTCPの初期輻輳ウィンドウサイズをオーバーフローしないようにする
- [ ] 証明書チェーンから不要な証明書を除き、チェーンを浅くする
- [ ] サーバーにOCSP Staplingを設定する
- [ ] TLS圧縮をサーバーで無効化する
- [ ] サーバーにSNIサポートを設定する
- [ ] HSTSヘッダを追加する


## 参照
- [How is data secure over https?](https://blog.joshsoftware.com/2019/08/23/how-is-data-secure-over-https/)
- よくわかるHTTP/2の教科書P18-20/124-125
- SSLをはじめよう ～「なんとなく」から「ちゃんとわかる！」へ～
- [図解で学ぶネットワークの基礎：SSL編](https://xtech.nikkei.com/it/article/COLUMN/20071002/283518/)
- ハイパフォーマンスブラウザネットワーキング
