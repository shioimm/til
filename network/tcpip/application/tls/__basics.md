# SSL/TLS
#### メッセージ交換プロトコルの基本
1. 認証と鍵交換を含んだハンドシェイクによって通信を開始する
2. ハンドシェイク後に機密性と完全性がある状態でデータを交換する
3. シャットダウンの手順で終了する

#### TLSが提供する機能
- 盗聴対策 - ハイブリッド暗号方式による情報の内容の暗号化
- 改竄対策 - MACによる改竄検知
- なりすまし対策 / 否認対策 - デジタル署名による通信相手の認証

| フェーズ         | 技術           | 役割                           | 種類                         |
| -                | -              | -                              | -                            |
| 事前準備         | 公開鍵暗号方式 | 共通鍵の素を配送               | RSA, DH/DHE, ECDH/ECDHE      |
| 事前準備         | デジタル署名   | 認証局による認証               | RSA, DSA, ECDSA, DSS         |
| 暗号化データ通信 | 共通鍵暗号方式 | アプリケーションデータの暗号化 | 3DES, AES, AES-GCM, Camellia |
| 暗号化データ通信 | MAC            | 改竄・なりすましの検知         | SHA-256, SHA-384             |

#### 特徴
- 暗号学的なセキュリティ (Cryptographic security)
  - 情報を交換しようとする二者間で安全な通信ができるようにする
- 相互運用性 (Interoperability)
  - 独立して開発されたプログラム間でも同じパラメータを使って暗号通信ができるようにする
- 拡張性 (Extensibility)
  - フレームワークとして提供することによりプロトコルは変更せず個別の新しい要素技術に対応できるようにする
- 効率性 (Efficiency)
   - コストがかかる暗号処理を最小限にし、後続のセッションでの再計算を避けるキャッシュ方式を用意する

### TLSにおける認証
- TLSにおける認証は鍵交換と一体になってハンドシェイク時に行われる
- TLSにおける認証は証明書を利用した公開鍵暗号化方式を基本とする
- 証明書の検証後、クライアントは利用可能な公開鍵を手に入れたことになり、
  手に入れた公開鍵をどう使って相手を認証するかは鍵交換の手法ごとに異なる

### TLSにおける暗号化
- TLSにおける暗号化はストリーム暗号化方式、ブロック暗号化方式、AEADのいずれかとなる

#### ストリーム暗号化方式
1. レコードのシーケンス番号、Recordヘッダ、平文データを結合しMACを計算する
2. 計算したMACと平文データとを暗号化することによって暗号文を作る

#### ブロック暗号化方式
1. シーケンス番号、Record ヘッダ、平文データを結合しMACを計算する
2. 暗号化する前のデータの長さが暗号化ブロックの長さの整数倍になるようにパディングを作る
3. 暗号化ブロックと同じ長さのIVを生成する
4. IVを使用し、同じ平文でも違う暗号文になる平文データ、MAC、パディングをCBCモードで暗号化する

#### AEAD
1. 64ビットのnonceを作る
2. 平文データをAEADのアルゴリズムで暗号化する
3. 完全性を検証するための付加的なデータとしてシーケンス番号とRecord ヘッダを暗号化アルゴリズムに渡す
3. nonceと暗号文を一緒に送る

## HTTP/2における仕様
- TLS1.2以上
- TLS SNIのサポート
- 圧縮機能無効化 -> HTTP/2自身が圧縮を行う
- 再ネゴシエーション禁止 -> クライアント証明書の要求はコネクションプリフェイス前に実行される必要がある
- 暗号スイート
  - `TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256`をサポート
  - 仕様で禁止されている暗号スイートの使用禁止

### 暗号スイートの条件が合わない場合
- `INADEQUEATE_SECURITY`エラーコネクションによって切断される場合がある -> コネクションエラー
  - ALPNネゴシエーションと暗号スイートの選択が独立して行われるため、
    暗号スイートの条件が一致しない場合がある

## 参照
- [How is data secure over https?](https://blog.joshsoftware.com/2019/08/23/how-is-data-secure-over-https/)
- よくわかるHTTP/2の教科書P18-20/124-125
- SSLをはじめよう ～「なんとなく」から「ちゃんとわかる！」へ～
- [図解で学ぶネットワークの基礎：SSL編](https://xtech.nikkei.com/it/article/COLUMN/20071002/283518/)
- ハイパフォーマンスブラウザネットワーキング
- 食べる！SSL！　―HTTPS環境構築から始めるSSL入門
- 暗号技術入門 第3版
- パケットキャプチャの教科書
- プロフェッショナルSSL/TLS
