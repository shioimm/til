# Handshakeプロトコル
- クライアント・サーバー間でアルゴリズムと共通鍵のネゴシエーションを行うプロトコル

## 役割
1. 双方のピアが接続で使いたいパラメータを提示し、互いに合意する
2. 提示された証明書か他の方法を使って認証を行う
3. セッションの保護に使うマスターシークレット(master secret)を共有する
4. ハンドシェイクのメッセージ群が第三者によって書き換えられていないことを検証する

## Handshakeレコードフォーマット

```c
struct {
   HandshakeType    msg_type; // メッセージの種類
   uint24           length;   // メッセージの長さ
   HandshakeMessage message;
} Handshake;

// メッセージの残りの部分はメッセージの種類によって異なる
```

## マスターシークレット(鍵素材)
- クライアント・サーバー間で合意した鍵
- プリマスターシークレット + クライアントランダム + サーバーランダムの値から計算する
  - クライアントランダム + サーバーランダムはソルトの役割を果たす
  - 暗号スイートで決められたハッシュ関数で作った擬似乱数生成関数で計算する

```
master_secret = PRF(pre_master_secret, "master secret", client_random + server_random)
```

- マスターシークレットから鍵ブロック(通鍵暗号の鍵・MACの鍵・初期化ベクトル)を生成する
  - 共通鍵暗号の鍵(クライアント -> サーバー)
  - 共通鍵暗号の鍵(クライアント <- サーバー)
  - MACの鍵(クライアント -> サーバー)
  - MACの鍵(クライアント <- サーバー)
  - GCMモードやCCMモードで用いる初期化ベクトルの一部(クライアント -> サーバー)
  - GCMモードやCCMモードで用いる初期化ベクトルの一部(クライアント <- サーバー)

```
key_block = PRF(master_secret, "key expansion", server_random + client_random)
```

## 参照
- プロフェッショナルSSL/TLS
- 暗号技術入門 第3版
- パケットキャプチャの教科書
