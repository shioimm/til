# DNS
- Domain Name Service
- ドメイン名からIPアドレスを見つけるシステム
- 名前解決はUDP、ゾーン転送はUDPとTCPを利用して実装されている

## 名前解決
- 正引き - ドメイン名 -> IPアドレス
- 逆引き - IPアドレス -> ドメイン名

## リソースレコード
- IPアドレスとドメイン名の対応づけを行うデータベース

| 値  | タイプ | 用途                                           |
| -   | -      | -                                              |
|   1 | A      | IPv4ホストのアドレス                           |
|   2 | NS     | ドメイン名のゾーンを管理するネームサーバー     |
|   5 | CNAME  | ホストの別名                                   |
|  15 | MX     | ドメイン名に紐づくメールサーバー               |
|  16 | TXT    | ドメイン名に紐づくテキスト文字列               |
|  28 | AAAA   | IPv6ホストのアドレス                           |
|  -  | SOA    | ドメイン名のゾーン自身の管理情報               |
|  -  | GNAME  | このドメイン名の別名でリソースレコードの参照先 |
| 251 | INFR   | 増分ゾーン転送                                 |
| 252 | ANFR   | 完全ゾーン転送                                 |

## DNSの仕組み
1. クライアントがドメインにアクセスを試行する
2. フルリゾルバがルートネームサーバーにリソースレコードを問い合わせる
    - ルートネームサーバーにリソースレコードが存在しない場合は
      ルートネームサーバー以下にゾーンを持つ各ネームサーバーに問い合わせる
3. ネームサーバーがフルリゾルバにIPアドレスを返す
4. フルリゾルバがクライアントにIPアドレスを返す

#### スタブリゾルバ (DNSクライアント)
- ユーザーの要望を基にフルリゾルバへリクエストを送信し、
  解決したいドメイン名の問い合わせを行うプログラム
- クライアント端末で動作する

#### フルリゾルバ　(DNSキャッシュサーバー / フルサービスリゾルバ)
- スタブリゾルバから送信されるリクエストに対して、リソースレコードをネームサーバーに問い合わせを行うサーバー
  - 名前解決した結果はキャッシュに保存しておき、再利用する
  - フルリゾルバは自分よりも更に上位のサーバーへ再帰的にアクセスを行い、
    最終的にそのドメインの権威サーバーへたどり着く

#### ネームサーバー　(DNSコンテンツサーバー / 権威DNSサーバー)
- リソースレコードを管理するホストやソフトウェア
- ネームサーバーは、自身が設置された階層のドメインに関する情報を管理する
  - それぞれのドメインの階層ごとにネームサーバーが配置される
  - ゾーン - 当該ネームサーバーが管理する階層
  - ルートネームサーバー - 階層のルートに設置されているネームサーバー・トップレベルドメインの管理を行う

#### 委任
- 各ネームサーバーが受け持つゾーンのうち、一部を他のネームサーバーに任せること
- ゾーンを委任されたネームサーバーはそのドメインについて権威を持つ
  - サブドメインを作った受け持つゾーンのうちその一部を更に他のネームサーバーに委任することができる

#### TTL
- 名前解決のキャッシュ保持時間
- DNSを切り替えた後、TTLが切れると切り替えが成立する -> DNSが浸透する

#### DNSゾーン
- DNSサーバーが管理を任された名前空間 (DNS名のグループ)
- 一つのゾーンファイル (DB) で管理するドメイン名の範囲

#### ゾーン転送
- 通常冗長化を行う目的で2つの機器 (サーバー) の間でゾーンデータを転送する際に発生する
- ゾーン内のプライマリDNSコンテンツサーバーのゾーンファイルを
  セカンダリDNSコンテンツサーバーに同期することで冗長化を図る仕組み
- バージョン確認 - セカンダリサーバーがプライマリサーバーへSOAレコードを要求すること (UDP)
- 完全ゾーン転送 - 機器間でゾーン全体を転送する
- 増分ゾーン転送 - ゾーン情報の一部のみを転送する

## DNSパケットフォーマット
- DNS識別子
  - DNSクエリに対するレスポンスを対応づける識別子
- QR (Query / Response)
  - パケットがDNSクエリかレスポンスかを示す
- オプコード
  - メッセージに含まれるクエリのタイプ
- AA (Authoritative Answer)
  - (レスポンス) ドメインに権威あるネームサーバーからのレスポンスであることを示す
- TC (truncation)
  - レスポンスが長すぎてパケット内に収まらないため切り詰められたことを示す
- RD (Recursion Desired)
  - (DNSクエリ) DNSクライアントは目的のネームサーバーに対して要求した情報がない場合、
    再帰クエリを要求することを示す
- RA (Recursion Available)
  - (レスポンス) ネームサーバーが再帰クエリをサポートしていることを示す
- Z (Reserved)
  - すべて0 (RCodeの拡張に使用される場合もある)
- RCode (Response Code)
  - DNSレスポンスで使われ、エラーの有無を示す
- Question Count
  - Questionセクションに含まれているエントリ数
- Answer Count
  - Answerセクションに含まれているエントリ数
- Name server (Authority) Record Count
  - Authorityセクションに含まれているネームサーバーのリソースレコード数
- Additional Records Count
  - Additional Informationセクションに含まれているその他のリソースレコード数
- Questionセクション
  - DNSサーバーに送信された一つ以上のクエリを含む可変長セクション
- Answerセクション
  - クエリのレスポンスとなる一つ以上のリソースレコードを含む可変長セクション
- Authorityセクション
  - 名前解決処理を継続する際に使用できる権威あるネームサーバーを示すリソースレコードを含む可変長セクション
- Additional Informationセクション
  - 必須ではない関連情報を保持するリソースレコードを含む可変長セクション

## DNSロードバランス
- 一つのドメインに対して複数のAレコードを設定することにより、
  一つのドメインに複数のIPアドレスを割り当てることが可能
  - その場合、ドメインへリクエストが発生した度にレスポンスとなるIPアドレスが変化する
  - この変化を利用して負荷分散を行う(DNSラウンドロビン)

## トラフィックの誘導
- ドメインから他のドメインへマッピングを返すことが可能(CNAME)
- CNAMEを利用すると他の権威サーバーへDNSリクエストを移譲できる

### Akamai(CDN)の事例
- CDNを利用するサーバーのCNAMEにAkamaiが管理するドメインを指定する
  - サーバーへのDNSリクエストをAkamaiの権威サーバーへ移譲する
  - Akamaiの権威サーバーはリクエスト元の地域に応じてその近隣のキャッシュサーバーのIPアドレスを返す

## SRVレコード
- サービスディスカバリーのために利用できるレコード
  - サービスディスカバリー - 特定の機能を持ったサービスを探し出す機能
- サービスの種別からホスト名を探すために利用される
- AWS ECSはSRVを利用したサービスディスカバリー機能を提供する

### レコード項目
- サービスの種別
- プロトコル(TCP / UDP)
- サービスが稼働するドメイン名
- TTL
- 優先度(昇順)
- 重み(同じ優先度の中でのアクセスの割合)
- サービスが稼働するポート番号
- 正確に特定可能なホスト名

## 参照
- DNSをはじめよう ～基礎からトラブルシューティングまで～ 改訂第2版
- サーバ・インフラエンジニアの基本がこれ一冊でしっかり身につく本 3.4
- Real World HTTP 第2版
- 実践パケット解析 第3版
