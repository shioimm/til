# DNS (Domain Name Service)
- ドメイン名からIPアドレスを見つけるシステム
  - 正引き - ドメイン名 -> IPアドレス
  - 逆引き - IPアドレス -> ドメイン名
  - 名前解決はUDP、ゾーン転送はUDPとTCPを利用して実装されている

## DNSの仕組み
1. クライアントがドメインにアクセスを試行する
2. スタブリゾルバ -> フルリゾルバ / フォワーダへDNSメッセージ (問い合わせ) を送信
3. フルリゾルバ -> ルートサーバーへDNSメッセージ (問い合わせ) を送信
4. ルートサーバー -> フルリゾルバにDNSメッセージ (応答) を送信
    - ルートドメインのNSレコードを送信
5. フルリゾルバ -> ルートサーバー以下の各権威サーバーへ再起的にDNSメッセージ (問い合わせ) を送信
    - ゾーン - 当該権威サーバーが管理する階層
6. リソースレコードを持つ権威サーバー -> フルリゾルバへDNSメッセージ (応答) を送信
7. フルリゾルバ -> スタブリゾルバへDNSメッセージ (応答) を送信

#### スタブリゾルバ (DNSクライアント)
- 解決したいドメイン名の問い合わせリクエストをフルリゾルバへ送信する
- クライアント端末のOSにAPIとして実装
- フルサービスリゾルバやフォワーダに再帰的問い合わせを送信する
- OSのネットワーク設定の「ネームサーバー」欄に利用するフルサービスリゾルバ、フォワーダのIPアドレスを設定する

#### フォワーダ
- スタブリゾルバや別のフォワーダから受け取った再帰的問い合わせを
  フルサービスリゾルバや別のフォワーダに転送するリゾルバ

#### フルリゾルバ (DNSキャッシュサーバー / フルサービスリゾルバ)
- スタブリゾルバから送信されるリクエストに対して、リソースレコードをネームサーバーに問い合わせを行うサーバー
  - 名前解決した結果はキャッシュに保存しておき、再利用する
  - フルリゾルバは自分よりも更に上位のサーバーへ再帰的にアクセスを行い、
    最終的にそのドメインの権威サーバーへたどり着く

#### 権威サーバー (ネームサーバー / DNSコンテンツサーバー / 権威DNSサーバー)
- リソースレコードを管理するホストやソフトウェア
- 自身が設置された階層のドメインに関する情報を管理する
  - それぞれのドメインの階層ごとに権威サーバーが配置される

#### ルートサーバー (ルートネームサーバー)
- 全てのトップレベルドメイン (.com、.jpなど) のネームサーバー情報を持つサーバー

#### 委任
- 各ネームサーバーが受け持つゾーンのうち、一部を他のネームサーバーに任せること
- ゾーンを委任されたネームサーバーはそのドメインについて権威を持つ
  - サブドメインを作った受け持つゾーンのうちその一部を更に他のネームサーバーに委任することができる

#### TTL
- 名前解決のキャッシュ保持時間
- DNSを切り替えた後、TTLが切れると切り替えが成立する -> DNSが浸透する

#### DNSゾーン
- DNSサーバーが管理を任された名前空間 (DNS名のグループ)
- 一つのゾーンファイル (DB) で管理するドメイン名の範囲

#### ゾーン転送
- 通常冗長化を行う目的で2つの機器 (サーバー) の間でゾーンデータを転送する際に発生する
- ゾーン内のプライマリDNSコンテンツサーバーのゾーンファイルを
  セカンダリDNSコンテンツサーバーに同期することで冗長化を図る仕組み
- バージョン確認 - セカンダリサーバーがプライマリサーバーへSOAレコードを要求すること (UDP)
- 完全ゾーン転送 - 機器間でゾーン全体を転送する
- 増分ゾーン転送 - ゾーン情報の一部のみを転送する

## DNSロードバランス
- 一つのドメインに対して複数のAレコードを設定することにより、
  一つのドメインに複数のIPアドレスを割り当てることが可能
  - その場合、ドメインへリクエストが発生した度にレスポンスとなるIPアドレスが変化する
  - この変化を利用して負荷分散を行う(DNSラウンドロビン)

## トラフィックの誘導
- ドメインから他のドメインへマッピングを返すことが可能 (CNAME)
- CNAMEを利用すると他の権威サーバーへDNSリクエストを移譲できる

### Akamai (CDN) の事例
- CDNを利用するサーバーのCNAMEにAkamaiが管理するドメインを指定する
  - サーバーへのDNSリクエストをAkamaiの権威サーバーへ移譲する
  - Akamaiの権威サーバーはリクエスト元の地域に応じてその近隣のキャッシュサーバーのIPアドレスを返す

## SRVレコード
- サービスディスカバリーのために利用できるレコード
  - サービスディスカバリー - 特定の機能を持ったサービスを探し出す機能
- サービスの種別からホスト名を探すために利用される
- AWS ECSはSRVを利用したサービスディスカバリー機能を提供する

### レコード項目
- サービスの種別
- プロトコル (TCP / UDP)
- サービスが稼働するドメイン名
- TTL
- 優先度 (昇順)
- 重み (同じ優先度の中でのアクセスの割合)
- サービスが稼働するポート番号
- 正確に特定可能なホスト名

## 参照
- DNSをはじめよう ～基礎からトラブルシューティングまで～ 改訂第2版
- サーバ・インフラエンジニアの基本がこれ一冊でしっかり身につく本 3.4
- Real World HTTP 第2版
- 実践パケット解析 第3版
