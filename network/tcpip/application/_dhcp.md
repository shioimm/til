# DHCP
- Dynamic Host Confuguration Protocol
- 動的ホスト設定プロトコル
- TCP/IPのネットワークを使用するために必要な設定作業を自動化する
  - ネットワークインターフェースにIPアドレスを付与する
  - デフォルトルートのルーティングエントリをルーティングテーブルに追加する
  - 名前解決に利用するネームサーバーを指定する

## 要素
- DHCPサーバー - ネットワークの設定を配布するサーバープロセス
  - 予め配布するIPアドレス、サブネットマスク、経路制御、デフォルトルート、DNSサーバーのアドレスなどを設定
  - デフォルトルートとなるルーターが兼任するケースが多い
- DHCPクライアント - ネットワークの設定を受け取るクライアントプロセス

## パケットフォーマット
#### DHCP
- オプコード (1バイト)
  - パケットがDHCP要求かDHCP応答かを示す
- ハードウェアタイプ (1バイト)
  - 使用しているL2プロトコルを表す (Ethernet = 0x0001)
- ハードウェアアドレスサイズ (1バイト)
  - MACアドレスの長さ
- ホップ数 (1バイト)
  - DHCPサーバーの発見を補助するリレーエージェントが使用
- トランザクションID (4バイト)
  - 要求と応答を対にするために使われるランダムな数字
- 経過秒数 (2バイト)
  - クライアントがDHCPサーバーにアドレスを要求してからの秒数
- フラグ (2バイト)
  - DHCPクライアントが受け取るトラフィックのタイプ (ユニキャスト、ブロードキャストetc)
- クライアントIPアドレス (4バイト)
  - IPアドレスフィールドから得られたDHCPクライアントのIPアドレス
- 割り当てIPアドレス (4バイト)
  - DHCPサーバーから提供されたアドレス (最終的にクライアントのIPアドレスフィールド値となる)
- サーバーIPアドレス (4バイト)
  - DHCPサーバーのIPアドレス
- ゲートウェイIPアドレス (4バイト)
  - ネットワークのデフォルトゲートウェイのIPアドレス
- クライアントハードウェアアドレス (16バイト)
  - クライアントのMACアドレス
- サーバーホスト名 (オプション) (64バイト)
  - サーバーのホスト名
- ブートファイル (オプション) (128バイト)
  - DHCPが使うブートファイル
- オプション
  - DHCPの機能を拡張したり追加情報を設定するために利用

#### DHCPv6
- メッセージタイプ (1バイト)
- トランザクションID (3バイト)
- オプション
  - メッセージタイプによって異なる

## 仕組み
#### DHCP
1. DHCPクライアントがDISCOVER (DHCP発見) パケットをブロードキャストする
    - IPアドレスやネットマスクなどのネットワークの設定を要求する
    - 送信元: 0.0.0.0:68 (任意のIPv4アドレス)
    - 宛先: 255.255.255.255:67 (ブロードキャスト)
    - UDPを使用
2. DHCPサーバーがOFFER (DHCP提供) パケットを送信する
    - 使用して良いネットワークの設定を通知する
    - 宛先: ARPから提供されたクライアントのMACアドレス
3. DHCPクライアントがREQUEST (DHCP要求) パケットをブロードキャストする
    - `2`で通知された設定を使用したいことを通知する
    - 送信元: 0.0.0.0:68 (任意のIPv4アドレス)
    - 宛先: OFFERパケットで受け取ったサーバーのIPアドレス
4. DHCPサーバーがACKNOWLEDGEMENT (DHCP確認応答) パケットを送信する
    - `3`の要求に対する許可を通知する
    - 宛先: OFFERパケットで通知したクライアントのIPアドレス
5. IPアドレスが不要になった場合、DHCPクライアントがRELEASE (DHCP解放パケット) をブロードキャストする

#### DHCPv6
1. DHCPv6クライアントがSolicit (要請) パケットをマルチキャスト
    - 宛先: ff02::1:2
2. DHCPv6サーバーがAdvertise (広告) パケットを送信
    - 設定情報の送信
3. DHCPv6クライアントがRequest (要求) パケットをマルチキャスト
    - 設定情報の確認
4. DHCPv6サーバーがReply (応答) パケットを送信
    - 設定情報を送信


### IPアドレスの重複の確認
- DHCPサーバーはIPアドレスを配布する前にICMPエコー要求パケットを送信し、
  応答がないことを確認する
- DHCPクライアントはDHCPサーバーから配布されたIPアドレスに対してARP要求パケットを送信し、
  応答がないことを確認する

## DHCPリレーエージェント
- 複数のEthernetセグメントで構築されるネットワークにおいて、
  複数の異なるセグメントのIPアドレスの割り当てを一台のDHCPサーバーで一元管理・運用する仕組み

### 仕組み
1. それぞれのセグメントにDHCPサーバーを置く代わりにDHCPリレーエージェントを設置する
2. 各DHCPリレーエージェントにはDHCPサーバーのIPアドレスを設定する
3. DHCPサーバーにはそれぞれのセグメントごとに配布するIPアドレスの範囲を登録する
4. DHCPリレーエージェントはDHCPクライアントが送信したDHCP要求パケットを受信し、
   ユニキャストパケットにしてDHCPサーバーへ転送する
5. DHCPサーバーはDHCPリレーエージェントから転送されたDHCPパケットを処理し、
   DHCPリレーエージェントへ応答を返す
6. DHCPリレーエージェントはDHCPサーバーから受信した応答をDHCPクライアントへ転送する

## 参照
- Linuxプログラミングインターフェース 58章
- サーバ・インフラエンジニアの基本がこれ一冊でしっかり身につく本 2.8-9
- Linuxで動かしながら学ぶTCP/IPネットワーク入門 4.5
- コンピュータネットワーク
- マスタリングTCP/IP 入門編
- 実践パケット解析 第3版
