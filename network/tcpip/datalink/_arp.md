# ARP
- Address Resolution Protocol(IPv4のみ)
- IPアドレスからパケットの送り先の物理アドレス(MACアドレス)を取得するプロトコル
- 送信元ノードが送信先ノードのMACアドレスを取得し、
  送信先MACアドレスをEthernetフレームのヘッダに書き込み、
  データを送出する
  - ARP要求 - IPアドレスを元にMACアドレスを問い合わせる(ブロードキャスト)
  - ARP応答 - IPアドレスを元にMACアドレスを解決して返す(ユニキャスト)
- IPv6ではARPは利用されず、代わりにICMPのNDP(近隣探索プロトコル)が利用される

## 仕組み
1. 送信元ノードがEthernet上でARP要求パケットをブロードキャストする
  - ARP要求パケットには送信元ノードのIPアドレスが含まれる
2. Ethernet上の全てのノードがブロードキャストパケットを受信し、自身のIPアドレスを調べる
3. 対象のノードがARP応答パケットに自身のMACアドレスを格納し返送する
4. 送信元ノードは対象のノードが該当するIPアドレスとMACアドレスと紐づいていることを知る
  - IPアドレスとMACアドレスの対応関係はノードのARPテーブルに数分間キャッシュされる

## ARPテーブル
- ホストがARPで解決した情報を一定時間保持するテーブル

## フレームフォーマット
- プリアンブル(8バイト)
- 宛先MACアドレス / 送信元MACアドレス (6バイト)
- タイプ (2バイト)
- ハードウェアタイプ (2バイト)
  - 使用しているL2プロトコルを表す (Ethernet = 0x0001)
- プロトコルタイプ (2バイト)
  - 使用しているL3プロトコルを表す (IP = 0x0800)
- ハードウェアアドレスサイズ (1バイト)
  - MACアドレスの長さ
- プロトコルアドレスサイズ (1バイト)
  - IPアドレスの長さ
- オプコード (2バイト)
  - ARPフレームの種類
    - ARP Request = 1
    - ARP Reply = 2
    - Request Reverse = 3 (RARP)
    - Reply Reverse = 4 (RARP)
- 送信元MACアドレス / 送信元IPアドレス (4バイト)
- 目標MACアドレス / 目標IPアドレス
  - ARPで解決したいMACアドレスとIPアドレスを表す
  - MACアドレスの初期値は`00:00:00:00:00:00`
- FCS (4バイト)

## RARP
- Reverse Address Resolution Protocol
- MACアドレスからパケットの送り先のIPアドレスを取得するプロトコル
- IPアドレスを入力するインターフェースがない組み込み機械などで利用される
- ノードはRARPサーバーに対してRARP要求を送信し、RARPサーバーはノードへRARP応答を返す
- RARPサーバーにあらかじめ機器のMACアドレスとIPアドレスの対応票を設定しておく必要がある

## GARP
- Gratuitous ARP
- ノード自身が自身のIPアドレスを対象にARP要求を送信する仕組み
- IPアドレスの重複がないか確認するために利用される
  - 対象のIPアドレスが、自身に対してすでに登録されているIPアドレスではないか

## 代理ARP
- 送信先ノードの代わりに前段のL3スイッチやルーターなどのプロキシがARP応答を返す仕組み
- ルーティングテーブルを使わずにIPパケットを別のセグメントに送りたい場合に利用される
- 送信先ノードはARP応答を返したプロキシのMACアドレスを宛先にしてフレームを送信する
- ARP応答を返したプロキシは本来の送信先のノードへフレームを転送する

## 参照
- Linuxプログラミングインターフェース 58章
- サーバ・インフラエンジニアの基本がこれ一冊でしっかり身につく本 2.8-9
- Linuxで動かしながら学ぶTCP/IPネットワーク入門 4.5
- コンピュータネットワーク
- マスタリングTCP/IP 入門編
