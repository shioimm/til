# QUICパケット
- QUICコネクションにおけるデータの送信単位
- QUICパケットはヘッダ領域とペイロード領域を持つ
  - ヘッダ (コネクションID、パケット番号etc)
  - ペイロード (QUICフレーム: フレームタイプetc)

#### パケット番号
- 送信者が採番し、受信者がパケットロスなどの判断を行うために確認する

## 種類
### ロングヘッダパケット
- QUICコネクション確立時に使用されるパケット
- ヘッダにQUICのバージョン、送信元コネクションID・送信先コネクションIDを格納

#### ロングヘッダパケットのコネクションIDの役割
- QUICコネクション確立時のハンドシェイク時に利用される
  - サーバーは受信したパケットに対して応答する際、
    受信パケットの送信元コネクションIDを自身の送信パケットの送信先コネクションIDとする

#### ロングヘッダパケットの種類

| 種類      | 用途                                                    |
| -         | -                                                       |
| Initial   | ハンドシェイク時にクライアントから最初に送信される      |
| 0-RTT     | 0-RTTハンドシェイク時に使用される                       |
| Handshake | ハンドシェイク時にInitialの次のパケットとして送信される |
| Retry     | ハンドシェイクをやりなおすときに送信される              |

### ショートヘッダパケット
- QUICコネクション確立後に使用されるパケット
- ヘッダにスピンビット、暗号鍵のフェーズ、送信先コネクションIDを格納

#### スピンビット
- 通信経路上での通信の最適化を期待する場合、スピンビットを用いることによって
  経路上の観測者が通信の遅延を観測できるようになる
- エンドポイントが使用するかどうかを選択できる

#### 暗号鍵のフェーズ
- 鍵の更新を示す

#### ショートヘッダパケットの種類

| 種類      | 用途                                                    |
| -         | -                                                       |
| 1-RTT     | 1-RTTハンドシェイク時に使用される                       |

## QUICフレーム
- QUICパケットにおけるペイロードの単位 (QUICにおけるメッセージの単位)
- QUIC パケットには1つ以上のフレームが格納される
- フレームの種類によってメッセージの内容が異なる

#### 種類

| フレームタイプ名       | タイプ値  | 意味                                                          |
| -                      | -         | -                                                             |
| `PADDING`              | 0x00      | QUICパケットのサイズ増やすために使用                          |
| `PING`                 | 0x01      | 疎通確認                                                      |
| `ACK`                  | 0x02      | 確認応答                                                      |
| `ACK`                  | 0x03      | 確認応答・輻輳状況を通知するECNを使用                         |
| `RESET_STREAM`         | 0x04      | ストリームの終了                                              |
| `CRYPTO`               | 0x06      | 暗号ハンドシェイク用のデータ送信                              |
| `NEW_TOKEN`            | 0x07      | (サーバー用) 再接続が必要な場合のハンドシェイク用トークン送信 |
| `STREAM`               | 0x08 ~ 0f | ストリームの作成とアプリケーションデータの送信                |
| `NEW_CONNECTION_ID`    | 0x18      | 通信中のコネクションID変更時、新しいコネクションIDを通知      |
| `RETIRE_CONNECTION_ID` | 0x19      | 0x18で発行されたコネクションIDを使用しない旨を通知            |
| `PATH_CHALLENGE`       | 0x1a      | コネクションマイグレーション時、新しい通信経路の有効性確認    |
| `PATH_RESPONSE`        | 0x1b      | コネクションマイグレーション時、0x1aへの応答                  |
| `CONNECTION_CLOSE`     | 0x1c      | QUICコネクションに起因するコネクションクローズ                |
| `CONNECTION_CLOSE`     | 0x1d      | アプリケーションプロコルに起因するコネクションクローズ        |
| `HANDSHAKE_DONE`       | 0x1e      | (サーバー用) ハンドシェイクの完了通知                         |

## QUICパケットの暗号化
- QUICパケットは復号時に改竄されていないことがわかる認証付き暗号で暗号化される
  - 暗号化の対象はヘッダの一部 (パケット番号など) とペイロード
    - ヘッダのうち暗号化されていない部分も改竄時は検知できる

#### 暗号化に使用する鍵の種類
- パケットの種類ごとに鍵の種類が異なる

| パケットの種類 | 鍵の名前                      |
| -              | -                             |
| Initial        | Initial Keys                  |
| 0-RTT          | Early Data (0-RTT) Keys       |
| Handshake      | Handshake Keys                |
| 1-RTT          | Application Data (1-RTT) Keys |

- Initial Keysは通信の開始に必要・仕様で定義された固定値をもとに導出される
- Initial Keys以外はQUIC コネクションの確立時に得られた秘密値から導出される
- Application Data (1-RTT) Keysは長く使うため使用上限がある
  - 同一の鍵で暗号化を行なったデータ量が上限を超えた場合、鍵を更新する

## パケットロスに伴うデータの再送
#### パケットロスの検出
- 受信ホストはパケットを受信すると、パケット番号を確認する
- 受信したパケット番号に歯抜けがある場合:
  - 歯抜けの幅が一定数以上 -> パケットロスが起こったと判断する
  - 歯抜けの幅が一定数以下 -> 歯抜けとなったパケット番号を持つパケットを待つ
- 一定時間以上待っても当該パケットが送られてこない場合:
  - パケットロスが起こったと判断する

#### 確認応答の送信
- 受信ホストは受信できたパケットと受信できていないパケットのパケット番号を相手に通知する(確認応答)
  - 受信できたパケット番号の範囲と、受信できなかったパケット番号の範囲を記述した`ACK`フレームを送信

#### 再送処理
- 送信ホストは`ACK`フレームを受信すると、再送の必要があるパケットに新しいパケット番号を付与して再送
  - `PADDING`フレームなど再送する意味のないデータを除く

## 参照
- WEB+DB PRESS Vol.123 HTTP/3入門
