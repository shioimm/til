# TCP
## 特徴
- データの信頼性
  - 失われたパケットの再送
  - 順番の入れ替わったパケットの並べ直し
- 輻輳制御
  - スロースタート
  - 輻輳状態の検知
  - フロー制御
- ユニキャスト通信のみ可能

## パケットフォーマット
- 送信元ポート番号 (16ビット)
- 送信先ポート番号 (16ビット)
- シーケンス番号 (32ビット)
  - TCPセグメントを正しい順序に並び替えるために使用 (データの位置を示す)
  - 初期値は乱数 (SYNパケットで送信)
  - SYN送信後、ACKの受信以降は受信したACK番号の値
  - 32ビットを超えると0に戻ってカウントアップを開始する
- 確認応答番号 (32ビット)
  - ACKビットがセットされている場合のみ有効
  - 受信しきったデータのシーケンス番号 + 受信したデータサイズ
    - 受信側は確認応答番号から1を引いたシーケンス番号までのデータを受信したと判断する
    - 送信側では返された確認応答番号から1を引いたシーケンス番号までのデータを送信したと判断する
- データオフセット (4ビット)
  - ヘッダ長
- 予約領域 (4ビット)
- コントロールフラグ (8ビット)
  - セグメントに意味を付加するフィールド
- ウィンドウサイズ (16ビット)
  - 送信ホストの受信ウィンドウサイズ (rwnd: 受信バッファの残バイト)
  - ウィンドウサイズ0 (= 受信可能バイトサイズが0) のパケットを受け取った受信ホストは
    ウィンドウの最新状況を知るためにウィンドウプルーブを送信することができる
- TCPチェックサム (16ビット)
  - データの信頼性を提供する
- 緊急ポインタ (16ビット)
  - コントロールフラグURGがセットされている場合のみ有効
  - 緊急データの位置を示す最後のバイトのシーケンス番号
- オプション (0~40バイト)
  - TCPに関連する拡張機能を通知し合う目的で使用される
  - オプションリストを並べる形で構成される
- パディング
- ペイロード

#### コントロールフラグ
- 左からCWR / ECE / URG / ACK / PSH / RST / SYN / FIN
- 0 = OFF / 1 = ON

| フラグ | 意味                                                                               |
| -      | -                                                                                  |
| CWR    | cwnd値の縮小・IPヘッダのECNと共に使用                                              |
| ECE    | ECE-Non(通信相手から自分方向のネットワークの輻輳を伝える)・IPヘッダのECNと共に使用 |
| URG    | 緊急に処理すべきデータ                                                             |
| ACK    | 確認応答番号のフィールドが有効                                                     |
| PSH    | 受信したデータをすぐアプリケーションに渡さず、バッファリングできる                 |
| RST    | コネクションの強制切断                                                             |
| SYN    | コネクションの確立                                                                 |
| FIN    | 今後送信するデータがないことを示し、コネクションの切断を意思する                   |

#### チェックサムの計算
1. 疑似TCPヘッダをTCPデータグラムの前に付加する
    - 送信元IPアドレス(32ビット)
    - 宛先IPアドレス(32ビット)
    - パディング(8ビット)
    - プロトコル番号(8ビット)
    - TCPパケット長(16ビット)
2. 全長が16ビットの倍数になるようにデータの最後に`0`のパディングを追加する
3. 16ビット単位で1の補数の和を求め、求めた和の1の補数をチェックサムフィールドに入れる
4. 受信ホストはデータグラム受信後、IPヘッダからIPアドレスの情報を得て
   擬似ヘッダを作成し、チェックサムを再計算する
5. チェックサムを含む全てのデータを足した結果、16ビット全てが1になると正しい

#### オプション
| 種別 | オプションヘッダ        | 意味                                                                |
| -    | -                       | -                                                                   |
| 0    | End Of OptionList       | オプションリストの末尾の要素                                        |
| 1    | No Option               | オプションの区切り文字                                              |
| 2    | Maximum Segment Size    | アプリケーションデータの最大サイズを通知                            |
| 3    | Window Scale            | ウィンドウサイズの最大サイズを拡張                                  |
| 4    | Selective ACK Permitted | Selective ACK (選択的確認応答)に対応                                |
| 5    | Selective ACK           | Selective ACKに対応している場合、すでに受信したシーケンス番号を通知 |
| 8    | Timestamps              | パケットの往復遅延時間を計測するタイムスタンプに対応                |

- オプションリストの各要素は種別・オプション長・オプションデータから構成される
- Maximum Segment Size - デフォルトでは`MTU - 40バイト(IP + TCPヘッダ長)
- Selective ACK - シーケンス番号が一部のみ欠けた場合に欠けたセグメントのみを再送する仕組み
- Timestamps - RTTを計測したりシーケンス番号の重複確認(PAWS)のために利用する

## 通信の確立
- 通信前に通信チャネルを確立する
- 送信データは複数のセグメントに分割される
  セグメントごとに送信エラーを検出可能なチェックサムを持つ
- TCPセグメントが受信側へ到着すると受信TCPは送信TCPへ確認応答を送信する

## 送受信バッファ
- TCPはホスト・ルーターの送受信バッファを使って送受信データを管理する
- 受信TCPは送信TCPから受信したデータを受信バッファに格納し、アプリケーションがデータを読み取ると削除する
- 送信TCPは送信するデータを送信バッファに格納し、送信条件が満たされている場合は送信する

## パケットの送信条件
- コネクションを確立済み
- 小さなデータパケットを連続して送信しない(Nagleアルゴリズム)
- 受信側のバッファに空きがある(フロー制御)
- ネットワークの混み具合が深刻ではない(輻輳制御)

### アプリケーションの動作と無関係に送信する条件
- データが届いたがしばらくACKを送信していなかった(遅延ACK 0.04s~0.2s)
- 送信したデータに対するACKの返信がない(再送制御 0.2s~1s)
- 受信バッファに空きができた(ウィンドウアップデート)
- 送信先から受信バッファの空きがないという通知があったしばらく後(ウィンドウプローブ)

## 送信セグメント長
- MSS(Maximum Segment Size)
  - 通信を行うデータサイズ
  - TCPはコネクション確立時に決定する
  - 理想的にはIPで分割処理されない最大のデータ長
- 大量のデータを送信する際はMSSの値ごとにデータが区切られて送信される
- MSSは3wayハンドシェイク時に送受信のホスト間で決められる
  - SYN送信時にTCPヘッダにMSSオプションを付加し、自分のインターフェースに適したMSSを通知する
  - 両ホストのMSSのうち、値が小さい方がMSSとして採用される

## 再送タイムアウト時間
- ACKの到着を待つ時間
  - TCPはパケットを送信するたびRTT(往復)時間とそのジッタ(揺らぎ)を計測する
  - RTT時間とジッタの時間を合計した値夜も少し大きな値を再送タイムアウト時間とする
  - 再送してもACKがない場合はExponential Backoffで再々送を行う
  - 再送回数が特定を越すと強制的にコネクションを切断し、アプリケーションに通信が異常終了したことを伝える

## HOLブロッキング(Head of Line Blocking)
- 通信路上で一部のパケットが失われた場合、それ以降のシーケンス番号を持つパケットは
  失われたパケットが再送されて届くまでの間、受信バッファに保持される
- アプリケーションは全てのデータが揃うまで処理を待機する
  - HOLブロッキングによる遅延はアプリケーション側には単なる伝送遅延と認識される

## TCPによるソケットプログラミングの流れ
- サーバーは`listen()`によりソケットをパッシブオープンし、`accept()`する
  `accept()`はコネクションが確立するまでブロックする
- クライアントは`connect()`によりソケットをアクティブオープンし、
  サーバーのパッシブソケットとのコネクションを確立する

### サーバー
1. ソケットの作成(`socket(2)`)
2. 接続を待つIPアドレスとポート番号を設定
3. ソケットに名前をつける(`bind(2)`)
4. 接続を待つ(`listen(2)`)
5. 接続を受け付ける(`accept(2)`)
6. 通信を行う(`read(2)` / `write(2)`)
7. ソケットを閉じる(`close(2)`)

### クライアント
1. ソケットの作成(`socket(2)`)
2. 接続する相手のIPアドレスとポート番号を設定
3. 接続要求を行う(`connect(2)`)
4. 通信を行う(`read(2)` / `write(2)`)
5. ソケットを閉じる(`close(2)`)

## 参照
- よくわかるHTTP/2の教科書P21-22/40-41
- Linuxプログラミングインターフェース 58章 / 61章
- Software Design 2021年5月号 ハンズオンTCP/IP
- ハイパフォーマンスブラウザネットワーキング
- マスタリングTCP/IP 入門編
- パケットキャプチャの教科書
