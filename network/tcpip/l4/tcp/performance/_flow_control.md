# フロー制御 (ウィンドウ制御)
- 受信ホストが行う流量調整
- 受信側が処理できないほどの大量のデータが送信側から送出されるのを防ぐ
  - 受信側がビジー状態、重い負荷がかかっている、決まった量のバッファ領域しか割り当てたくないなど

#### ウィンドウ
- 受信ホストが規定サイズのMSS (Maximum Segment Size) を受信するまで
  受信データをバッファ領域に溜めておくことによってACKの送信を遅延させ、
  パフォーマンスを向上させるメカニズム

#### 受信ウィンドウサイズ (rwnd値)
- 受信ホストがACKを送信せずにデータを受信できるデータ量 (セグメント単位)
- 送受信ホスト間の新規TCP接続における送信中未応答データ(ACKが返されていないデータ)の最大量は
  rwnd値とcwnd値のうちどちらか小さい方に制限される

#### スライディングウィンドウ制御方式
- 受信ホストは送信ホストへrwnd値を通知する
  - rwnd値はACKパケットのウィンドウサイズフィールドに格納する
  - 受信バッファの状態に応じてrwnd値を更新する
- 送信ホストはrwnd値までは受信ホストからのACKを待たずに複数のセグメントを並列に送信する

#### 受信ホストから見る処理の流れ
1. 接続確立時、システムデフォルト値のrwnd値で受信を開始する
2. 現在のペースの通信を維持できなくなった場合、より小さなrwnd値を送信ホストへ告知する
3. rwnd値が0になった場合、受信バッファ上のデータがアプリケーションによって処理されるまで受信を止める
4. バッファに空きができた場合、送信ホストへウィンドウ更新通知を送信する

#### 送信ホストから見る処理の流れ
1. 通知されたrwnd値あるいは現在のcwnd値のうち小さいサイズ分の送信データを用意し、セグメント単位で送信する
2. 送信済みセグメントのACKが届くまでは最初に用意した送信データを確保したままにしておく
3. 送信済みセグメントのACKが届いたら最初に用意した送信データのうち、該当するセグメントのデータを破棄する
4. rwnd値の空いたサイズあるいは現在のcwnd値のうち小さいサイズ分の新たな送信用データを用意する
5. rwnd値が0になった場合、受信ホストからウィンドウ更新通知が届くまで送信を止める
    - ウィンドウプルーブを送信することで受信ホストのバッファの空き状況を確認することができる

### ウィンドウスケーリングオプション
- 最大rwnd値をデフォルトの64Kbytes以上に設定するためのオプション
- 通常はデフォルトで有効になっている

### 課題
- ネットワークの帯域幅を超える通信を防ぐメカニズムが送受信どちら側にも組み込まれていない

## 参照
- ハイパフォーマンスブラウザネットワーキング
- Software Design 2021年5月号 ハンズオンTCP/IP
- パケットキャプチャの教科書
