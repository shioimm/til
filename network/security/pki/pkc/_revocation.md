# 公開鍵証明書の失効
- 証明書は対応する秘密鍵が危殆化した場合や、すでに必要がなくなった場合に失効する
- 秘密鍵や署名鍵が漏洩した場合などは速やかに鍵に紐づく証明書を失効させる必要がある
- 証明書は自身が失効したかどうかを確かめる方法を証明書自身に内包する
- 証明書の失効にはCRLモデル (Certificate Revocation List: 証明書失効リスト) と
  OCSPモデル (Online Certificate Status Protocol: オンライン証明書状態プロトコル) がある

## 証明書失効リスト CRL: Certificate Revocation List
- 公開鍵基盤で失効した証明書の一覧 (シリアル番号と失効日)
- まだ期限切れになっていないが失効済みの証明書の情報が記載される
- 証明書を失効させる必要がある場合、認証局に届出をし対象の証明書をCRLに追加する
- 認証局は新しいCRLに署名して定期的に公開する
- 検証者は署名の確認の際にCRLをチェックして証明書が失効していないか確認を行う
- CRLのURLは証明書のCRL配布点 (CRL Distribution Points) 拡張として格納される

#### 動作フロー
1. CRLに対応ブラウザから証明書が設定されたWebサイトへアクセスを行う際、
   CRLのURLへ自動的にアクセスを行い、CRLをダウンロードする
2. ブラウザは取得したCRLの全シリアル番号とWebサーバーから送信された証明書のシリアル番号を照合する

#### 課題
- リストのサイズがどんどん大きくなる
- リストのサイズを節約するために更新間隔を伸ばすと最新のCRLへの追従が遅れる
- CRLに対応しないブラウザがある

## OCSP: Online Certificate Status Protocol
- X.509公開鍵証明書の失効状態をリアルタイムで取得するための通信プロトコル
- 検証者が非検証者のサーバーにアクセスし、受信した証明書が執行していないかを
  OCSPレスポンダ (サーバー) に問い合わせる
- OCSPレスポンダは当該証明書が失効しているか有効かを返す (OCSPレスポンス)
  - OCSPレスポンダはOCSPレスポンスに署名済み
- 認証局や有効性検証局 (VA: Validation Authority) がOCSPレスポンダを運営する
- OCSPレスポンダのURLは証明書のAuthority Information Access拡張の
  オンライン証明書状態プロトコル項目に格納される

#### 動作フロー
1. OCSP対応ブラウザから証明書が設定されたWebサイトへアクセスを行う際、
   OCSPレスポンダのURLへ自動的にアクセスを行う
2. OCSPレスポンダは自身が保存するCRLの全シリアル番号と
   Webサーバーから送信された証明書のシリアル番号を照合し、
   ブラウザへ確認結果を送信する

#### 課題
- 検証する証明書全てに対してOCSPレスポンダへの問い合わせが必要
- 検証者がアクセスしようとしているサイトがOCSPレスポンダに伝わる

## OCSPステープリング
- 各サーバーがOCSPレスポンスをTLSハンドシェイクに埋め込めるようにする機能
- 予めサーバー側でCAのOCSPレスポンダに問合せを行い、そのキャッシュされた結果失効情報を保持しておき、
  クライアントがサーバーへ接続した際にその情報を含めて返す
- クライアントよりOCSPレスポンダへの問合せが不要となり、OCSPモデルの課題を克服する

## 参照
- 図解即戦力　暗号と認証のしくみと理論がこれ1冊でしっかりわかる教科書
- プロフェッショナルSSL/TLS
- [OCSP (Online Certificate Status Protocol)](https://www.cybertrust.co.jp/sureserver/support/glossary/ocsp.html)
