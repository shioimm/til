# UDP (User Datagram Protocol)
- データグラムソケットが使用するコネクションレスプロトコル
- アプリケーション層からは`SOCK_DGRAM`で通信を行う

## 特徴
- IPの性質を引き継ぎ、信頼性のないデータグラム型の通信サービスを提供する
- パケットは損失する可能性がある
- パケットに含まれるデータが破損していないことを保証する機能を提供する
- IPにポート番号・データチェックサムを追加し、送信データのエラー検出を可能にする
- 送信するデータグラムのサイズを576バイトのIPv4最小再構成バッファサイズよりも小さくすることで
  IPフラグメンテーションを回避する

#### データグラム
- 自己完結し、独立した存在としてのデータ(= メッセージ区切りを持つ)
- 送信元・送信先のノード間やネットワーク上の過去の通信内容に依存することなく、
  ノード間のルーティングを行うために十分な情報を持つ

#### UDPが提供しないサービス
- メッセージ配信の保証
- 順序通りの配信
- 状態追跡
- 輻輳制御

## データグラムフォーマット
- 送信元ポート番号 (16ビット)
  - データの送信元サービス・オプション
- 送信先ポート番号 (16ビット)
  - データの送信先サービス
- データグラム長 (16ビット)
  - ヘッダとペイロードの長さの和
- チェックサム (16ビット: オプション)
- ペイロード

## 送受信バッファ
- UDPはホスト・ルーターの送受信バッファを使った送受信管理を行わない
- 送信TCPが送信操作を行うと即座に送信が実行される
- 受信TCPは送信TCPから受信したデータを受信バッファに格納し、アプリケーションがデータを読み取ると削除する
- 受信側には受信バッファがあるが、空き容量を送信側へ伝える機能はない

#### チェックサムの計算
1. 疑似UDPヘッダをUDPデータグラムの前に付加する
    - 送信元IPアドレス(32ビット)
    - 宛先IPアドレス(32ビット)
    - パディング(8ビット)
    - プロトコル番号(8ビット)
    - UDPパケット長(16ビット)
2. 全長が16ビットの倍数になるようにデータの最後に`0`のパディングを追加する
3. 16ビット単位で1の補数の和を求め、求めた和の1の補数をチェックサムフィールドに入れる
4. 受信ホストはデータグラム受信後、IPヘッダからIPアドレスの情報を得て
   擬似ヘッダを作成し、チェックサムを再計算する
5. チェックサムを含む全てのデータを足した結果、16ビット全てが1になると正しい

## UDPによるソケットプログラミングの流れ
### サーバー
1. ソケットの作成(`socket(2)`)
2. 接続を待つIPアドレスとポート番号を設定
3. ソケットに名前をつける(`bind(2)`)
4. 受信する(`recv(2)` / `recvfrom(2)`)
5. ソケットを閉じる(`close(2)`)

### クライアント
1. ソケットの作成(`socket(2)`)
2. 接続する相手のIPアドレスとポート番号を設定
3. 送信する(`send(2)` / `sendto(2)` / `sendfrom(2)`)
4. ソケットを閉じる(`close(2)`)

## UDPを使用するアプリケーション

| 名称 | 用途             | UDPを使用する理由                                         |
| -    | -                | -                                                         |
| DHCP | IPアドレスの設定 | ブロードキャストを使用する                                |
| NTP  | 時刻同期         | TCPではバッファ機能により時刻を正確に合わせられないため 　|
| QUIC | HTTP/3           | TCPのコネクション管理と再送処理における課題を解決するため |
| RTP  | IP電話           | 双方向でのリアルタイム通信では再送処理は悪影響なため      |

- HTTP/3はWebの通信を高速効率化する
  - TCPと同等の輻輳制御を行った上でより効率の良いコネクション管理・再送処理・暗号化を行う

## IPマルチキャスト
- 特定の宛先ではなくグループを指すIPアドレスへの通信
  - 送信者はマルチキャストグループに対してパケットの送信を行う
  - 受信者はマルチキャストグループに参加するとマルチキャストパケットを受信する

```c
#include <netinet/in.h>

// マルチキャストグループ
struct group_req {
  uint32_t                gr_interface;
  struct sockaddr_storage gr_group;
};
```

## NATを介したUDP通信
1. 2つのピアがそれぞれにNATを介したUDP通信を行う場合
   最初にそれぞれのSTUNサーバーへバイディングリクエストを送信する
2. STUNサーバーからパブリックIPとポート番号を伴った成功レスポンスが返ると、
   それぞれのピアががパブリックIPとポート番号を使用して通信を行う
3. STUNが機能しない場合TURNをフォールバックとして利用する

## 参照
- Linuxプログラミングインターフェース 58章
- Software Design 2021年5月号 ハンズオンTCP/IP
- ハイパフォーマンスブラウザネットワーキング
