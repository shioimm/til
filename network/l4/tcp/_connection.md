# コネクションのライフサイクル
## 接続開始 (3wayハンドシェイク)
1. クライアント
    - サーバーへセグメントを送信 (アクティブオープンの開始)
      - SYNフラグをセット
      - クライアント自身のシーケンス番号 (ISN) をセット
    - クライアント: CLOSED -> SYN-SENT / サーバー: LISTEN
2. サーバー
    - クライアントからセグメントを受信 (パッシブオープンの開始)
    - クライアントへセグメントを送信
      - SYNフラグ・ACKフラグをセット
      - クライアントのシーケンス番号に対する確認応答番号をセット
      - サーバー自身のシーケンス番号 (ISN) をセット
    - クライアント: SYN-SENT / サーバー: LISTEN -> SYN-RECEIVED
3. クライアント
    - サーバーからセグメントを受信
    - サーバーへセグメントを送信
      - ACKフラグをセット
      - サーバーのシーケンス番号に対する確認応答番号をセット
    - クライアント: SYN-SENT -> ESTABLISHED / サーバー: SYN-RECEIVED
4. サーバー
    - クライアントからセグメントを受信 (コネクション確立)
    - クライアント: ESTABLISHED / サーバー: SYN-RECEIVED -> ESTABLISHED

## 接続確立
- クライアント - サーバー間で実際のアプリケーションデータのやりとりを行う
- データ転送の信頼性を保つためにフロー制御・輻輳制御・再送制御を利用する

## 接続終了 (4wayハンドシェイク)
- クライアント・サーバーのうちどちらかがFINパケットを送出し (アクティブクローズ)、
  相手ホストがそれを受け付ける (パッシブクローズ)
- 両ホストが送信するパケットのコントロールビットを
  FIN / ACK -> ACK -> FIN / ACK -> ACKの順にやりとりすることによって終了確認を行う
1. クライアント (サーバーも実行できるが通常は通常はクライアントが実行する)
    - アプリケーションからクローズ処理の要求を受け取る
    - サーバーへセグメントを送信
      - FINフラグ / ACKフラグ (前回受信分) をセット
    - クライアント: - -> FIN-WAIT1 / サーバー: -
2. サーバー
    - クライアントからセグメントを受信
    - クライアントへセグメントを送信
      - ACKフラグをセット
    - 以降サーバーが当該ソケットを`read()`するとEOFを検出する
    - サーバーはアプリケーションからのクローズ要求を待つ
    - クライアント: FIN-WAIT1 / サーバー: - -> CLOSE-WAIT
3. クライアント
    - サーバーからセグメントを受信
    - クライアント自身のバイトストリームはこれで終了
    - クライアント: FIN-WAIT1 -> FIN-WAIT2 / サーバー: CLOSE-WAIT
4. サーバー
    - アプリケーションからクローズ処理の要求を受け取る
    - クライアントへセグメントを送信
      - FINフラグ / ACKフラグをセット
    - クライアント: FIN-WAIT2 / サーバー: LAST-ACK
5. クライアント
    - サーバーからセグメントを受信
    - サーバーへセグメントを送信
      - ACKフラグをセット
    - クライアント: FIN-WAIT2 -> TIME-WAIT / サーバー: LAST-ACK
6. サーバー
    - クライアントからセグメントを受信
    - コネクションを削除
    - コネクションのために確保していたリソースを解放
    - クライアント: TIME-WAIT / サーバー: LAST-ACK -> CLOSED
7. クライアント
    - 設定された時間を待ってコネクションを削除
    - コネクションのために確保していたリソースを解放
    - クライアント: TIME-WAIT -> CLOSED / サーバー: CLOSED

### コネクションリセット
- コネクションを良性修了したい側がフラグフィールドのRSTビットを立てたセグメントを相手に送信
- 送信するべきデータが残っている場合は双方破棄する

## 参照
- よくわかるHTTP/2の教科書P21-22/40-41
- Linuxプログラミングインターフェース 58章 / 61章
- Software Design 2021年5月号 ハンズオンTCP/IP
- ハイパフォーマンスブラウザネットワーキング
- パケットキャプチャの教科書
