# パケットフォーマット
- 送信元ポート番号 (16ビット)
- 送信先ポート番号 (16ビット)
- シーケンス番号 (32ビット)
  - TCPセグメントを正しい順序に並び替えるために使用 (データの位置を示す)
  - 初期値は乱数 (SYNパケットで送信)
  - SYN送信後、ACKの受信以降は受信したACK番号の値
  - 32ビットを超えると0に戻ってカウントアップを開始する
- 確認応答番号 (32ビット)
  - ACKビットがセットされている場合のみ有効
  - 受信しきったデータのシーケンス番号 + 受信したデータサイズ
    - 受信側は確認応答番号から1を引いたシーケンス番号までのデータを受信したと判断する
    - 送信側では返された確認応答番号から1を引いたシーケンス番号までのデータを送信したと判断する
- データオフセット (4ビット)
  - ヘッダ長
- 予約領域 (4ビット)
- コントロールフラグ (8ビット)
  - セグメントに意味を付加するフィールド
- ウィンドウサイズ (16ビット)
  - 送信ホストの受信ウィンドウサイズ (rwnd: 受信バッファの残バイト)
  - ウィンドウサイズ0 (= 受信可能バイトサイズが0) のパケットを受け取った受信ホストは
    ウィンドウの最新状況を知るためにウィンドウプルーブを送信することができる
- TCPチェックサム (16ビット)
  - データの信頼性を提供する
- 緊急ポインタ (16ビット)
  - コントロールフラグURGがセットされている場合のみ有効
  - 緊急データの位置を示す最後のバイトのシーケンス番号
- オプション (0~40バイト)
  - TCPに関連する拡張機能を通知し合う目的で使用される
  - オプションリストを並べる形で構成される
- パディング
- ペイロード

#### コントロールフラグ
- 左からCWR / ECE / URG / ACK / PSH / RST / SYN / FIN
- 0 = OFF / 1 = ON

| フラグ | 意味                                                                               |
| -      | -                                                                                  |
| CWR    | cwnd値の縮小・IPヘッダのECNと共に使用                                              |
| ECE    | ECE-Non(通信相手から自分方向のネットワークの輻輳を伝える)・IPヘッダのECNと共に使用 |
| URG    | 緊急に処理すべきデータ                                                             |
| ACK    | 確認応答番号のフィールドが有効                                                     |
| PSH    | 受信したデータをすぐアプリケーションに渡さず、バッファリングできる                 |
| RST    | コネクションの強制切断                                                             |
| SYN    | コネクションの確立                                                                 |
| FIN    | 今後送信するデータがないことを示し、コネクションの切断を意思する                   |

#### チェックサムの計算
1. 疑似TCPヘッダをTCPデータグラムの前に付加する
    - 送信元IPアドレス(32ビット)
    - 宛先IPアドレス(32ビット)
    - パディング(8ビット)
    - プロトコル番号(8ビット)
    - TCPパケット長(16ビット)
2. 全長が16ビットの倍数になるようにデータの最後に`0`のパディングを追加する
3. 16ビット単位で1の補数の和を求め、求めた和の1の補数をチェックサムフィールドに入れる
4. 受信ホストはデータグラム受信後、IPヘッダからIPアドレスの情報を得て
   擬似ヘッダを作成し、チェックサムを再計算する
5. チェックサムを含む全てのデータを足した結果、16ビット全てが1になると正しい

#### オプション
| 種別 | オプションヘッダ        | 意味                                                                |
| -    | -                       | -                                                                   |
| 0    | End Of OptionList       | オプションリストの末尾の要素                                        |
| 1    | No Option               | オプションの区切り文字                                              |
| 2    | Maximum Segment Size    | アプリケーションデータの最大サイズを通知                            |
| 3    | Window Scale            | ウィンドウサイズの最大サイズを拡張                                  |
| 4    | Selective ACK Permitted | Selective ACK (選択的確認応答)に対応                                |
| 5    | Selective ACK           | Selective ACKに対応している場合、すでに受信したシーケンス番号を通知 |
| 8    | Timestamps              | パケットの往復遅延時間を計測するタイムスタンプに対応                |

- オプションリストの各要素は種別・オプション長・オプションデータから構成される
- Maximum Segment Size - デフォルトでは`MTU - 40バイト(IP + TCPヘッダ長)
- Selective ACK - シーケンス番号が一部のみ欠けた場合に欠けたセグメントのみを再送する仕組み
- Timestamps - RTTを計測したりシーケンス番号の重複確認(PAWS)のために利用する
