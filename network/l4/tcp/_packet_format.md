# パケットフォーマット
### 送信元ポート番号 (16ビット)
- 送信元ポート番号

### 送信先ポート番号 (16ビット)
- 送信先ポート番号

### シーケンス番号 (32ビット)
- 送信パケットのバイトの先頭を表す値
- 送信パケット全体のデータの位置を示し、TCPセグメントを正しい順序に並び替えるために使用する
- ISN (Initial sequence number: 初期値) は乱数 (SYNパケットで送信)
- SYN送信後、次回以降の送信時は前回送信時の値 + 前回送信バイト数
- 32ビットを超えると0に戻ってカウントアップを開始する

### 確認応答番号 (32ビット)
- 次回受信する予定のバイトの先頭を表す値 (次回受信する予定のシーケンス番号: 受信したシーケンス番号 + 1)
- ACKビットがセットされている場合のみ有効)
- パケット送信がどこまで進んだかを示すために使用する
- 送信側 (ACK受信側) は受信した確認応答番号から1を引いたシーケンス番号までのデータを送信したと判断する
- 送信側はセグメント送信時にタイマーを仕掛け、
  タイマーが切れる前に確認応答セグメントを受信しなければそのセグメントを再送する

### データオフセット (4ビット)
- ヘッダ長

### 予約領域 (4ビット)
- 未使用

### コントロールフラグ (8ビット)
- セグメントに意味を付加するフィールド

#### フィールド
- 左からCWR / ECE / URG / ACK / PSH / RST / SYN / FIN
- 0 = OFF / 1 = ON

| フラグ | 意味                                                                               |
| -      | -                                                                                  |
| CWR    | 輻輳ウィンドウサイズ (cwnd値) の縮小・IPヘッダのECNと共に使用                       |
| ECE    | ECE-Non(通信相手から自分方向のネットワークの輻輳を伝える)・IPヘッダのECNと共に使用 |
| URG    | 緊急に処理すべきデータ (最近では使用しないことが推奨される)                        |
| ACK    | 確認応答番号のフィールドが有効                                                     |
| PSH    | 受信したデータをすぐアプリケーションに渡さず、バッファリングできる                 |
| RST    | コネクションの強制切断                                                             |
| SYN    | コネクションの確立                                                                 |
| FIN    | 今後送信するデータがないことを示し、コネクションの切断を意思する                   |

### ウィンドウサイズ (16ビット)
- 送信ホストの受信ウィンドウサイズ (rwnd値: 受信バッファの残バイト)
- ウィンドウサイズ0 (= 受信可能バイトサイズが0) のパケットを受け取った受信ホストは
  ウィンドウの最新状況を知るためにウィンドウプルーブを送信することができる

### TCPチェックサム (16ビット)
- データの信頼性を提供する

#### チェックサムの計算
1. 疑似TCPヘッダをTCPデータグラムの前に付加する
    - 送信元IPアドレス(32ビット)
    - 宛先IPアドレス(32ビット)
    - パディング(8ビット)
    - プロトコル番号(8ビット)
    - TCPパケット長(16ビット)
2. 全長が16ビットの倍数になるようにデータの最後に`0`のパディングを追加する
3. 16ビット単位で1の補数の和を求め、求めた和の1の補数をチェックサムフィールドに入れる
4. 受信ホストはデータグラム受信後、IPヘッダからIPアドレスの情報を得て
   擬似ヘッダを作成し、チェックサムを再計算する
5. チェックサムを含む全てのデータを足した結果、16ビット全てが1になると正しい


### 緊急ポインタ (16ビット)
- コントロールフラグURGがセットされている場合のみ有効
- 緊急データの位置を示す最後のバイトのシーケンス番号

### オプション (0~40バイト)
- TCPに関連する拡張機能を通知し合う目的で使用される
- オプションリストを並べる形で構成される

#### オプション
| 種別 | オプションヘッダ        | 意味                                                                |
| -    | -                       | -                                                                   |
| 0    | End Of OptionList       | オプションリストの末尾の要素                                        |
| 1    | No Option               | オプションの区切り文字                                              |
| 2    | Maximum Segment Size    | アプリケーションデータの最大サイズを通知                            |
| 3    | Window Scale            | ウィンドウサイズの最大サイズを拡張                                  |
| 4    | Selective ACK Permitted | Selective ACK (選択的確認応答) に対応                               |
| 5    | Selective ACK           | Selective ACKに対応している場合、すでに受信したシーケンス番号を通知 |
| 8    | Timestamps              | パケットの往復遅延時間を計測するタイムスタンプに対応                |

- オプションリストの各要素は種別・オプション長・オプションデータから構成される
- Maximum Segment Size - デフォルトでは`MTU - 40バイト(IP + TCPヘッダ長)
- Selective ACK - シーケンス番号が一部のみ欠けた場合に欠けたセグメントのみを再送する仕組み
- Timestamps - RTTを計測したりシーケンス番号の重複確認(PAWS)のために利用する

### パディング
- パディング

### ペイロード
- ペイロード
