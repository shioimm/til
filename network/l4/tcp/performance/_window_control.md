# ウィンドウ制御
- ウィンドウサイズを用いて送受信するデータ量を制御する手法
- 受信ホストが規定MSS (Maximum Segment Size) のデータを受信するまで
  受信データをバッファ領域に溜めておくことによってACKの送信を遅延させ、
  パフォーマンスを向上させるメカニズム
- 送受信ホスト間の新規TCP接続における送信中未応答データ (ACKが返されていないデータ) の最大量は
  rwnd値とcwnd値のうちどちらか小さい方に制限される

#### 受信ウィンドウサイズ (rwnd値)
- 受信ホストがACKを送信せずにデータを受信できるデータ量 (セグメント単位)
- 両ホストは通信のたびに自身の受信ウィンドウサイズを広告する

#### 輻輳ウィンドウサイズ (cwnd値)
- 送信ホストが送信中未応答データとして送信できるデータ量
- 送信ホストはTCP接続ごとに初期値 (1セグメント: 1MSS) を設定し、
  ACKを受け取るたびに増加する (増加幅はフェーズによって異なる)
- 受信ホストには送信されず、送信側ホスト内部で管理される

## スライディングウィンドウ制御方式
- 受信ホストは送信ホストへrwnd値を広告する
  - rwnd値はACKパケットのウィンドウサイズフィールドに格納する
  - 受信バッファの状態に応じてrwnd値を更新する
- 送信ホストはrwnd値までは受信ホストからのACKを待たずに複数のセグメントを並列に送信する

#### 受信ホストから見る処理の流れ
1. 接続確立時、システムデフォルト値のrwnd値で受信を開始する
2. 現在のペースの通信を維持できなくなった場合、より小さなrwnd値を送信ホストへ告知する
3. rwnd値が0になった場合、受信バッファ上のデータがアプリケーションによって処理されるまで受信を止める
4. バッファに空きができた場合、送信ホストへウィンドウ更新通知を送信する

#### 送信ホストから見る処理の流れ
1. 通知されたrwnd値あるいは現在のcwnd値のうち小さいサイズ分の送信データを用意し、セグメント単位で送信する
2. 送信済みセグメントのACKが届くまでは最初に用意した送信データを確保したままにしておく
3. 送信済みセグメントのACKが届いたら最初に用意した送信データのうち、該当するセグメントのデータを破棄する
4. rwnd値の空いたサイズあるいは現在のcwnd値のうち小さいサイズ分の新たな送信用データを用意する
5. rwnd値が0になった場合、受信ホストからウィンドウ更新通知が届くまで送信を止める
    - ウィンドウプルーブを送信することで受信ホストのバッファの空き状況を確認することができる

#### ウィンドウスケーリングオプション
- 最大rwnd値をデフォルトの64Kbytes以上に設定するためのオプション
- 通常はデフォルトで有効になっている

#### 課題
- ネットワークの帯域幅を超える通信を防ぐメカニズムが送受信どちら側にも組み込まれていない

## 輻輳制御 (スロースタート)
- 送信ホストが行う流量調整
- 常に変化するネットワークの帯域幅を超えないように通信を行うためのメカニズム

#### パケットロス
- ルーターがパケットを中継するよりも早く送信TCPがパケットを送出した場合、
  ルーターでパケットが欠落する現象

#### スロースタート閾値
- ネットワークキャパシティの閾値
- トラフィックの急激な増加を防ぐために設定する
- 初期値としてrwnd値以上に設定され、輻輳を検知するたびにその時点のcwnd値の半分の値に設定される

### フロー
#### スロースタートフェーズ (データの送信を新たに開始、またはタイムアウトが発生した際)
- 小さいcwnd値分のデータを送信し、ACKを受け取るたびにcwnd値を級数的に増加させる
- cwnd値がスロースタート閾値に到達すると輻輳回避フェーズに移行する

#### 輻輳回避フェーズ
- OSごとに設定されている輻輳制御アルゴリズムによって異なる
  - ロスベース
    - パケットのロスが発生した場合に輻輳を検知
  - 遅延ベース
    - 想定RTTに比べ実RTTが大きくなった場合に輻輳を検知
  - ハイブリッドベース
    - ロスベースと遅延ベースを組み合わせて輻輳を検知

## 参照
- ハイパフォーマンスブラウザネットワーキング
- Software Design 2021年5月号 ハンズオンTCP/IP
- パケットキャプチャの教科書
