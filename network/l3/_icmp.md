# ICMP
- Internet Control Message Protocol(インターネット制御メッセージプロトコル)
- IPパケットが目的のホストまで届くかの確認、
  IPパケットが廃棄された時の原因の通知、
  不十分な設定をより良い設定に変更するなどIPによる通信の補助に使用される
- ICMPメッセージは一つのIPパケットを使って配送される
- C言語で扱うためのインターフェースは`/usr/include/netinet/ip_icmp.h`にて定義される

## メッセージタイプ

| タイプ | 意味           | 説明                                          |
| -      | -              | -                                             |
| 0      | エコー応答     | エコー要求への応答                            |
| 3      | 到達不能       | 転送先にパケットが届かない                    |
| 5      | リダイレクト   | 最適ではない経路の変更                        |
| 8      | エコー要求     | エコー応答の要求                              |
| 9      | ルーター広告   | ルーター請願への応答                          |
| 10     | ルーター請願   | ルーター広告の要求                            |
| 11     | 時間超過       | TTLを使い切った(ループが発生している場合など) |
| 42     | 拡張エコー要求 | 拡張エコー応答の要求                          |
| 43     | 拡張エコー応答 | 拡張エコー要求への応答                        |

- タイプごとにコードを持ち、タイプとコードの組み合わせでネットワークの状態を表す

#### 通信状態の確認
- Echo Request (タイプ: 8 / コード: 0) - パケットに識別子とシーケンス番号を追加
- Echo Response (タイプ: 0 / コード: 0) - パケットに識別子とシーケンス番号を追加

#### ルーティングできなかった場合
- Destination Unreachable (タイプ: 3 / コード: 原因別) - 全て0の24ビットを追加
  - コード: 0 - ルーティングエントリがない
  - コード: 1 - ネクストホップが動作していない
  - コード: 4 - 出口のMTUが小さい、かつフラグメントが禁止されている
  - コード: 13 - FWなどのフィルタリングによってパケットが拒否されている

#### 送信元へ別のゲートウェイを通知する場合
- Redirect (タイプ: 5 / コード: 原因別) - 経路変更後のゲートウェイアドレスを追加

#### TTLがゼロになった場合
- Time-to-live exceeded (タイプ: 11 / コード: 0) - 全て0の24ビットを追加

## パケットフォーマット
- バージョン
- ヘッダ長
- ToS
- パケット長
- 識別子
- プロトコル番号
- ヘッダチェックサム
- 送信元IPアドレス
- 宛先IPアドレス
- タイプ
- コード
- チェックサム
- ペイロード

## `ping(1)`
- ICMPパケットのうちICMP Echo Request / ICMP Echo Responseを利用して疎通確認を行う
- 2つのTCP/IPノード間でICMPパケットの送受信を行う

## ICMPv6
- IPv6による通信の補助に使用されるプロトコル(必須)

### メッセージタイプ
#### エラーメッセージ

| タイプ | 意味           |
| -      | -              |
| 1      | 終点到達不能   |
| 2      | パケット過大   |
| 3      | 時間超過       |
| 4      | パラメータ問題 |

#### 情報メッセージ

| タイプ | 意味           |
| -      | -              |
| 128    | エコー要求     |
| 129    | エコー応答     |
| 133    | ルーター要請   |
| 134    | ルーター広告   |
| 135    | 近隣要請       |
| 136    | 近隣告知       |
| 137    | リダイレクト   |
| 160    | 拡張エコー要求 |
| 160    | 拡張エコー応答 |

## 参照
- Linuxプログラミングインターフェース 58章
- サーバ・インフラエンジニアの基本がこれ一冊でしっかり身につく本 2.8-9
- Linuxで動かしながら学ぶTCP/IPネットワーク入門 4.5
- コンピュータネットワーク
- マスタリングTCP/IP 入門編
- パケットキャプチャの教科書
