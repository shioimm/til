# DHCP (Dynamic Host Confuguration Protocol)
- 動的ホスト設定プロトコル
- TCP/IPのネットワークを使用するために必要な設定作業を自動化する
  - ネットワークインターフェースにIPv4アドレスを付与する
  - デフォルトルートのルーティングエントリをルーティングテーブルに追加する
  - ドメイン名解決に利用するDNSフルリゾルバのIPアドレスを配布する
- UDPによって通信する
- ホームネットワークにおいては無線LANルーターがDHCPの機能を持つ

#### 構成要素
- DHCPサーバー
  - IPv4アドレスプールを保持するサーバープロセス
  - クライアントに必要なネットワークの設定を配布する
    - IPアドレス
    - サブネットマスク
    - ブロードキャストアドレス
    - 経路制御
    - デフォルトルート
    - キャッシュDNSサーバーのIPアドレスなど
  - デフォルトルートとなるルーターが兼任するケースが多い
- DHCPクライアント
  - ネットワークの設定を受け取るクライアントプロセス

## 動作フロー
1. DHCPクライアントがDHCP Discover (DHCP発見) パケットをブロードキャストする
    - IPアドレスやネットマスクなどのネットワークの設定を要求する
    - 送信元: 0.0.0.0:68 (任意のIPv4アドレス)
    - 宛先: 255.255.255.255:67 (ブロードキャスト)
    - UDPを使用
2. DHCPサーバーがDHCP Offer (DHCP提供) パケットを送信する
    - 使用して良いネットワークの設定を通知する
    - 宛先: ARPから提供されたクライアントのMACアドレス
3. DHCPクライアントがDHCP Request (DHCP要求) パケットをブロードキャストする
    - `2`で通知された設定を使用したいことを通知する
    - 送信元: 0.0.0.0:68 (任意のIPv4アドレス)
    - 宛先: DHCP Offerパケットで受け取ったサーバーのIPアドレス
4. DHCPサーバーがDHCP Acknowledgement (DHCP確認応答) パケットを送信する
    - `3`の要求に対する許可を通知する
    - 宛先: Offerパケットで通知したクライアントのIPアドレス
5. IPアドレスが不要になった場合、DHCPクライアントがDHCP Release (DHCP解放パケット) をブロードキャストする

### IPアドレスの重複の確認
- DHCPサーバーはIPアドレスを配布する前にICMPエコー要求パケットを送信し、
  応答がないことを確認する
- DHCPクライアントはDHCPサーバーから配布されたIPアドレスに対してARP要求パケットを送信し、
  応答がないことを確認する

### IPアドレスの有効期限
- 通常DHCPサーバーから割り振られるアドレスには有効期限が設定されており
  期限を超えて使用したい場合はクライアントからDHCPREQUESTを送信する
- DHCPサーバーは延長を許可する場合DHCPNACKを返送する

## 参照
- Linuxプログラミングインターフェース 58章
- サーバ・インフラエンジニアの基本がこれ一冊でしっかり身につく本 2.8-9
- Linuxで動かしながら学ぶTCP/IPネットワーク入門 4.5
- コンピュータネットワーク
- マスタリングTCP/IP 入門編
- 実践パケット解析 第3版
