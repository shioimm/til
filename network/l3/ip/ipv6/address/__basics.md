# IPv6アドレス
- `サブネットプレフィクス` + `インターフェースID (ネットワークインターフェースを識別するID)`からなる
- IPv6では一つのネットワークインターフェースに対して複数のIPv6アドレスを追加できる
  - すべてのネットワークインターフェースには一つ以上のリンクローカルユニキャストアドレスを設定する必要がある
- IPv6では単一のリンクに複数のサブネットを関連づけることができる
  - サブネット = ある範囲のIPアドレスを集約した概念
- 上記から、IPv6においては一つのネットワークインターフェースに対して
  「サブネットプレフィックスは異なるがインターフェースIDは同じ」というようなIPv6アドレスを複数設定できる

## 構成
- 128ビットサイズ (16ビットずつをコロンで区切り16進数で表記する)

```
0010 0000 0000 0001 .../60

2001: .../60
```

- アドレス中0のみで表現されるグループは1グループに限り省略可能
- グループの先頭の0は省略可能

```
(省略なし)      2001:0db8:0000:0056:0000:abcd:ef12:3456/60
(0000を0に省略) 2001: db8:   0:  56:   0:abcd:ef12:3456/60 (非推奨)
(0000を省略1)   2001: db8:    :  56:   0:abcd:ef12:3456/60
(0000を省略2)   2001: db8:   0:  56:    :abcd:ef12:3456/60 (非推奨)

(省略なし)      2001:0db8:0000:0000:0000:0000:0002:0001/60
(0000を0に省略) 2001:0db8:   0:   0:   0:   0:   2:0001/60 (非推奨)
(0000を省略)    2001: db8:                   :   2:   1/60

(ポート番号併記) [2001:db8::1]:80
```

#### プレフィクス
- そのIPアドレスが属するネットワークの識別子

#### プレフィクス長
- プレフィクスの長さ

#### インターフェースID
- 当該ネットワーク上の特定のネットワークインターフェースの識別子
- 同じホストに複数のインターフェースIDが割り当てられるケースがある

## IPv6アドレス / キャッシュDNSサーバの自動設定

| IPv6アドレスの自動設定 | キャッシュDNSサーバの自動設定        |
| -                      | -                                    |
| SLAAC                  | ステートレスDHCPv6                   |
| SLAAC                  | NDP (Router Advertisementメッセージ) |
| DHCPv6                 | ステートフルDHCPv6                   |

#### 自動設定されたアドレスのステート
- tentative (DADによりアドレスの重複がないか確認中)
- preferred (有効・preferred-lifetime中)
- deprecated (有効・valid-lifetime中)
- invalid (無効)

## 送信元アドレスと送信先アドレスの選択 (RFC6724)
- 送信元アドレスはアプリケーションによる指定がない場合、ルールに従いネットワーク層で適切なアドレスを選択する
- 送信先アドレスはネットワーク層で適切な順番にアドレスをソートして`getaddrinfo()`の返り値とする

##### 送信元アドレスの優先ルール
- ルール 1: 同じアドレスを優先する
- ルール 2: 適切なスコープを選択する (より小さいスコープを選択する)
- ルール 3: 非推奨のアドレスは避ける
- ルール 4: ホームアドレスを優先する
- ルール 5: 送出されるネットワークインターフェースのアドレスを優先する
- ルール 6: ポリシーテーブルでラベルがマッチするものを優先する
- ルール 7: Temporary IPv6 アドレスを優先する
- ルール 8: 宛先アドレスとより一致するものを優先する

#### 宛先アドレスの優先ルール
- ルール 1: 利用できない宛先は避ける
- ルール 2: 送信元アドレスとスコープが一致するものを優先する
- ルール 3: 非推奨のアドレスは避ける
- ルール 4: ホームアドレスを優先する
- ルール 5: ポリシーテーブルでラベルがマッチするものを優先する
- ルール 6: ポリシーテーブルで優先度が高いものを優先する
- ルール 7: カプセル化しないと到達できない宛先は避ける
- ルール 8: スコープが小さいほうを優先する
- ルール 9: 送信元 IPv6 アドレスとより一致するものを優先する
- ルール 10: リストの掲載順に従う

#### ポリシーテーブル
- アドレスプレフィックスに対するアドレスの優先度 (Precedence) およびラベル (Label) を設定するための仕組み
  - 優先度 - 宛先アドレス候補のリストを並べ替える際に利用される場合がある
  - ラベル - 対象となるIPアドレスを分類する (送信元と同じラベルのプレフィックスのほうが選択されやすい)
- RFC 6724で推奨されるデフォルトのポリシーテーブルが定めれている

## 参照
- Linuxプログラミングインターフェース 58章
- Software Design 2021年5月号 ハンズオンTCP/IP
- マスタリングTCP/IP 入門編
- パケットキャプチャの教科書
