# IPv4パケットフォーマット
- バージョン (4ビット)
- IHL: ヘッダ長 (4ビット)
- ToS: サービス種別 (Type of Service) (8ビット)
  - 経路上のルーターにデータグラムの処理方法を伝えるためのフィールド
  - e.g. IPパケットの優先度、IPパケットの種類
  - ToSの内容によって当該パケットが混雑時に廃棄されるかされないかが判断される (判断はルータごとに行われる)
    - IPプレシデンス (先頭3ビット) - 8段階で表現する優先度
    - DSCP: 差別化コードポイント (DiffServ Coode Point) (先頭6ビット) - 64段階で表現する優先度 + 破棄確率
- パケット長 (16ビット)
  - IPヘッダ長 + IPペイロード長
- 識別子 (16バイト) (IPフラグメンテーション用)
  - IPパケット生成時にランダムに割り当てられるID
  - 当該パケットが元々どのパケットに属していたのかを示す
  - フラグメンテーション発生後、パケットの再結合に利用される
- フラグ (IPフラグメンテーション用)
  - 1ビット + DF (Don't Fragment) ビット + MF (More Fragments) ビット
  - DFビット - フラグメントしても良いパケットかどうかを示す
  - MFビット - 後続のフラグメントパケットがあるかどうか示す
  - フラグメント化が禁止されており、かつ転送先のルーターのMTUよりも大きいパケットは転送前に廃棄される
- フラグメントオフセット (IPフラグメンテーション用)
  - フラグメントした場合にそのパケットが元のパケットの先頭からどの位置にあるかの順番を示す
- TTL (Time To Live)
  - ホップできるノード数
  - ホップするたびにルーターによって一つずつ減じられる
  - 0になった場合はICMPで送信元ノードへ知らせる
  - ルーターはTTLが0のパケットを転送してはいけない (ホスト同士は同一ネットワーク上なら受信可能)
- プロトコル
  - IPペイロードを構成するトランスポート層プロトコルの種類を示す番号
- ヘッダチェックサム
  - IPヘッダの整合性を確認する (1の補数演算)
- 送信元IPv4アドレス
- 送信先IPv4アドレス
- IPv4ペイロード

### PHB (Per Hop Behavior)
- IPパケットはDSCPに応じたPHBによって転送される

#### PHBの種類
- EF (Expedited Forwarding: 完全優先転送) - 絶対優先
- AF (Assured Forwarding: 相対的優先転送) - EFほどではないが優先
- CS (Class Selector) - IPプレシデンスとの下位互換確保のためのPHB
- デフォルト - ベストエフォートサービス

## 参照
- Linuxプログラミングインターフェース 58章
- Software Design 2021年5月号 ハンズオンTCP/IP
- マスタリングTCP/IP 入門編
- パケットキャプチャの教科書
