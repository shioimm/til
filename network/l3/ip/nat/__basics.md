# NAT (Network Address Translation)
- 少数のグローバルIPアドレスを多数のプライベートIPアドレスで共有するための仕組み
- NAT対応ルータはプライベートアドレスからルータ外へパケットが送信される際、
  あるいはルータ外からプライベートアドレスへパケットを受信する際に
  グローバルアドレスとプライベートアドレスをマッピングするテーブル (NATテーブル) を作る (NAT binding)
    - NATの内側における送信元IPv4アドレスとポート
    - NATの内側における宛先IPv4アドレスとポート (NATの外側における宛先IPv4アドレスとポートと同じ)
    - NATの外側における送信元IPv4アドレスとポート
    - NATの外側における宛先IPv4アドレスとポート (NATの内側における宛先IPv4アドレスとポートと同じ)
- 一般的にはNAT = IPアドレスとポート番号の組み合わせを変換するNAPTを指す
  - IPアドレスだけを変換するNATはBasic NAT (RFC 3022)
- IPアドレスとポート番号の変換を行うため、通信時にはNATテーブルを持つNATルータによって
  IPヘッダ、TCPヘッダ、UDP ヘッダに変更が加えられる

#### 分類
- L3 NAT (Basic NAT)
- L4 NAT (NAPT)
- L7 NAT (ALG: Application Level Gateway)

## 仕組み
- LAN内の特定のノード (NATノード) のみがグローバルアドレス・プライベートアドレスを持つ
- LAN内のNATノード以外のノードはプライベートアドレスのみを持つ
- 外部との通信を行う際はNATルータがアドレス変換を行い通信を中継する
  - 内部アドレス       - LANにおけるアドレス
  - 外部アドレス       - インターネットにおけるアドレス
  - ローカルアドレス   - NATによって変換する前のアドレス
  - グローバルアドレス - NATによって変換した後のアドレス

## NATの問題点
- NATの外側から内側のサーバーに接続できない (NATトラバーサルを用いて解決する)
- 変換テーブルの作成や変換処理にオーバーヘッドがかかる
- 通信中にNATが異常動作して再起動した場合、
  すべてのTCPコネクションがリセットされる
  - NATの台数を増やして冗長化してもTCPコネクションは必ず切れる

## ALG (Application Level Gateway)
- NAT時、IPヘッダ、TCPヘッダ、UDPヘッダはNATルータによって内部アドレスと外部アドレスの変換が行われる
- IPパケットのペイロードとなるプロトコルによってはペイロード中にIPアドレスやポート番号が含まれる場合がある
- その場合、NATルータはALGの機能を利用して各プロトコルの中身を理解しつつ変換を行う必要がある

## 参照
- Linuxで動かしながら学ぶTCP/IPネットワーク入門 7
- [「NAT」の仕組みとルーターへの設定方法 ](https://www.atmarkit.co.jp/ait/articles/1512/03/news018.html)
- ハイパフォーマンスブラウザネットワーキング
- プロフェッショナルIPv6 19.3
