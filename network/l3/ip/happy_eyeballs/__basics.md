# Happy Eyeballs [RFC6555 / RFC8305]
- IPv6 / IPv4がいずれも利用可能な環境 (デュアルスタック環境) において
  通信状態の良い方を優先して接続する仕組み
- 通信開始時点でIPv6 / IPv4両プロトコルを用いて通信先と接続を行い、
  先に接続に成功した方のプロトコルから得られた結果をユーザーへ出力する
- ホストの宛先アドレス優先ポリシーがIPv6を優先することを前提とする
- IPv6 / IPv4のデュアルスタック環境におけるDNSの利用を前提とする

#### IPv6 / IPv4フォールバック
- IPv6 (IPv4) による通信が不可能な場合にIPv4 (IPv6) で接続し直す

## 接続フロー
1. Aレコード (IPv4用) とAAAAレコード (IPv6用) に対してそれぞれ非同期にDNSクエリを開始
    - AAAAレコードに対する問い合わせを先に行うことを推奨
    - AAAAレコードの結果が先に到達した場合:
      即座にそのAAAAレコードが示すIPv6アドレスに対する接続確立を試行することを推奨
    - Aレコードの結果が先に到達した場合:
      IPv6を優先するための猶予時間を設定することを推奨 (50ミリ秒)
    - 猶予時間中にAAAAレコードに対するネガティブな結果が返ってきた場合:
      すでに受け取っているIPv4 アドレスを利用して、IPアドレスリストのソートや接続確立を試行する
2. 名前解決済みのIPアドレスを優先順でソート
    - リストには得られた結果すべてが含まれていること
    - リストには異なるアドレスファミリが交互に登録されること
    - デフォルトIPv6アドレス選択 (RFC 67240) における宛先IPv6 アドレスの決定ルールに基づいてソートを行うこと
3. 優先順が反映されたリストが構築された段階で非同期に接続確立を試行
    - リストにあるIP アドレスに対して複数の接続確立を同時に開始しないことを推奨
    - 1 つの接続確立を試行して一定時間でその試行が成功しなかった場合、次の試行を開始する (250ミリ秒)
4. 得られた接続を採用し、他の接続確立の試行をすべてキャンセル

## 参照
- [Happy Eyeballsとは](https://www.nic.ad.jp/ja/basics/terms/happy-eyeballs.html)
- [Happy Eyeballs: Success with Dual-Stack Hosts](https://www.ietf.org/rfc/rfc6555.txt)
- [Happy Eyeballs Version 2: Better Connectivity Using Concurrency](https://www.ietf.org/rfc/rfc8305.txt)
- プロフェッショナルIPv6 15.3
