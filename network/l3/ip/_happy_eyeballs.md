# Happy Eyeballs [RFC6555 / RFC8305]
- IPv6 / IPv4がいずれも利用可能な環境 (デュアルスタック環境) において
  通信状態の良い方を優先して接続する仕組み
- 通信開始時点でIPv6 / IPv4両プロトコルを用いて通信先と接続を行い、
  先に接続に成功した方のプロトコルから得られた結果をユーザーへ出力する

#### IPv6 / IPv4フォールバック
- IPv6 (IPv4) による通信が不可能な場合にIPv4 (IPv6) で接続し直す

## 仕様

```
   DNS Server                  Client                  Server
       |                          |                       |
 1.    |<--www.example.com A?-----|                       |
 2.    |<--www.example.com AAAA?--|                       |
 3.    |---192.0.2.1------------->|                       |
 4.    |---2001:db8::1----------->|                       |
 5.    |                          |                       |
 6.    |                          |==TCP SYN, IPv6===>X   |
 7.    |                          |--TCP SYN, IPv4------->|
 8.    |                          |<-TCP SYN+ACK, IPv4----|
 9.    |                          |--TCP ACK, IPv4------->|
10.    |                          |==TCP SYN, IPv6===>X   |
```

- IPv6アドレスとIPv4アドレスへそれぞれSYNを同時に送信すること (6) (7)
- IPv6アドレスでの接続が失敗した場合、クライアントが諦めるまで再試行すること (10)
- クライアントはIPv6アドレスとIPv4アドレスへの各接続の試行結果をキャッシュし (MUST) 、
  その情報を使用してその後の接続を行うこと (10以降)
- キャッシュエントリはシステムで定義された最長時間 (10分程度) を超えるとフラッシュされること

```
   DNS Server                  Client                  Server
       |                          |                       |
 1.    |<--www.example.com A?-----|                       |
 2.    |<--www.example.com AAAA?--|                       |
 3.    |---192.0.2.1------------->|                       |
 4.    |---2001:db8::1----------->|                       |
 5.    |                          |                       |
 6.    |                          |==TCP SYN, IPv6=======>|
 7.    |                          |--TCP SYN, IPv4------->|
 8.    |                          |<=TCP SYN+ACK, IPv6====|
 9.    |                          |<-TCP SYN+ACK, IPv4----|
10.    |                          |==TCP ACK, IPv6=======>|
11.    |                          |--TCP ACK, IPv4------->|
12.    |                          |--TCP RST, IPv4------->|
```

- IPv6アドレスとIPv4アドレスへそれぞれ接続を試行した結果、
  IPv6アドレスへの接続が成功した場合はIPv4アドレスへの接続を放棄すること (12)
- ネットワークごとに特性が異なるため、
  インターフェースが新しいネットワークに接続された場合は再初期化すること (SHOULD)

#### IPv6失敗時のステートフルアルゴリズム
- 優先アドレスファミリ (IPv6など) で接続を試みて一定時間内に接続を確立できなかった場合、
  同じアドレスファミリまたは他のアドレスファミリを使用して2回目の接続を開始すること
  - 成功したアドレスファミリでその後の接続を試みる (MAY)
  - 新しい接続が試行される際、ホストの優先するアドレスファミリを試行する (MUST)
    - Happy Eyeballsの状態を10分ごとにフラッシュする (SHOULD)
    - 優先アドレスファミリを使用する接続が成功した場合、その後の接続は優先アドレスファミリを使用する (SHOULD)
    - アドレスファミリのプレフィックスに基づく接続の成功 / 失敗を追跡する (MAY)

#### IPv4のみホストへの対応
- ステートフルアルゴリズムを実装しない限り、
  ホストのアドレス選択ポリシーによって返された最初のIPアドレスファミリを優先して接続すること (MUST)
  - 通常はIPv6を優先
  - ユーザー設定またはネットワーク設定によって上書きすることが可能
  - ホストのポリシーが不明な場合はIPv6を優先

#### 複数のA / AAAAレコード
- DNSが複数のA / AAAAアドレスを返した場合、
  ホストのアドレス優先ポリシーに従い最初のアドレスを試行すること (RECOMMENDED)
  - 一定時間後に失敗した場合、その次に返された他のIPv4アドレスを試行すること (SHOULD)

#### コネクションタイムアウト
- 接続試行の間隔を150～250ミリ秒にすること (RECOMMENDED)

## Google ChromeとMozilla FirefoxにおけるHappy Eyeballs 2の実装アルゴリズム
1. `getaddinfo()`を呼び出し、ホストのアドレス優先ポリシーでソートしたIPアドレスのリストを返す
2. リストの最初のIPv6アドレスで接続の試行を開始する
3. 300ミリ秒内に接続が完了しない場合、リストの最初のIPv4アドレスで接続の試行を開始する
4. 2、3のうちいずれか最初に確立された接続が使用され、他の接続は破棄される
5. 4の結果をキャッシュする

## 参照
- [Happy Eyeballsとは](https://www.nic.ad.jp/ja/basics/terms/happy-eyeballs.html)
- [Happy Eyeballs: Success with Dual-Stack Hosts](https://www.ietf.org/rfc/rfc6555.txt)
- [Happy Eyeballs Version 2: Better Connectivity Using Concurrency](https://www.ietf.org/rfc/rfc8305.txt)
