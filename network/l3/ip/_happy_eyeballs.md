# Happy Eyeballs [RFC6555 / RFC8305]
- IPv6 / IPv4がいずれも利用可能な環境 (デュアルスタック環境) において
  通信状態の良い方を優先して接続する仕組み
- 通信開始時点でIPv6 / IPv4両プロトコルを用いて通信先と接続を行い、
  先に接続に成功した方のプロトコルから得られた結果をユーザーへ出力する
- ホストの宛先アドレス優先ポリシーがIPv6を優先することを前提とする

#### IPv6 / IPv4フォールバック
- IPv6 (IPv4) による通信が不可能な場合にIPv4 (IPv6) で接続し直す

## 接続フロー
1. 非同期DNSクエリの開始
2. 解決済み宛先アドレスを優先順でソート
3. 非同期接続の試行開始
4. 接続を確立後、他の試行を破棄

## 仕様
#### 非同期DNSクエリ

```
    Client                  DNS Server
       |                          |
 1.    |---www.example.com AAAA?->|
 2.    |---www.example.com A?---->|
 3.    |<--2001:db8::1------------| IPv6接続試行を直ちに開始
 4.    |<--192.0.2.1--------------|
```

- クライアントがIPv4とIPv6の両方の接続性を持ち、指定されたホストとの接続を確立しようとする場合、
  先にAAAAクエリを送信し (1) 、その直後にAクエリを送信する (2) (SHOULD)
- クライアントは両クエリの解決を待つべきではなく (SHOULD NOT) 、DNS解決を非同期として扱う (SHOULD)
  - プラットフォームが非同期DNS APIを提供していない場合、
    アドレスファミリごとに異なるスレッドで2つの同期クエリを実行することによってこの挙動をシミュレートする
- DNSクエリの実行により有効なAAAAレコードを持つ応答が先に帰ってきた場合:
  - 最初のIPv6接続試行を直ちに開始する
- DNSクエリの実行とアドレスのソートにより有効なAレコードを持つ応答が先に帰ってきた場合:
  - AAAA応答を50ミリ秒 (推奨値) 待つ (Resolution Delay)
  - Resolution Delay時間内に肯定的なAAAA応答を受信した場合、直ちにIPv6接続の試行を開始する
  - Resolution Delay時間内に否定的なAAAA応答 (エラーなし、データなし) を受信した場合
    またはResolution Delay時間内にAAAA応答を受信しなかった場合、
    これまでに返されたIPv4アドレスのソートを行い、スタッガード接続する (SHOULD)
    - その接続が確立される前にAAAA応答が到着した場合、
      新しく受信したIPv6アドレスを利用可能な候補アドレスのリストに組み込み、
      接続が確立するまでIPv6アドレスを追加して接続試行のプロセスを継続する

#### アドレスのソート
- クライアントは解決されたIPv4アドレスのいずれかに接続を試みる前に、アドレスをソートする (MUST)
- 1番目のアドレスファミリと2番目のアドレスファミリが異なるように並べ替える必要がある

#### 非同期接続の試行

```
   Client                  Server
      |                       |
1.    |==TCP SYN, IPv6=======>|
2.    |--TCP SYN, IPv4------->| 250ミリ秒後
3.    |<=TCP SYN+ACK, IPv6====|
4.    |<-TCP SYN+ACK, IPv4----|
5.    |==TCP ACK, IPv6=======>|
6.    |--TCP ACK, IPv4------->|
7.    |--TCP RST, IPv4------->| 中止
```

- 受信したアドレスのリストが構築された後で接続試行を行う
- まず一つのアドレスへの接続を試み、その後にリストの他のアドレスへの接続を一つずつ試みる
- 接続の試行がひとつ成功した (TCPハンドシェイクが完了) 場合:
  - 成功していない他のすべての接続の試行は破棄される
  - 接続を試行していないアドレスはすべて無視する
  - 非同期DNS問い合わせは中止する
    - DNSクライアントリゾルバは、DNS応答を1秒間 (推奨値) 処理する (DNSキャッシュとして有効活用できるため)
- 次の接続試行を開始するまで250ミリ秒 (推奨値) 待機する (Connection Attempt Delay)

#### IPv6失敗時のステートフルアルゴリズム
- 優先アドレスファミリ (IPv6など) で接続を試みて一定時間内に接続を確立できなかった場合、
  同じアドレスファミリまたは他のアドレスファミリを使用して2回目の接続を開始すること
  - 成功したアドレスファミリでその後の接続を試みる (MAY)
  - 新しい接続が試行される際、ホストの優先するアドレスファミリを試行する (MUST)
    - Happy Eyeballsの状態を10分ごとにフラッシュする (SHOULD)
    - 優先アドレスファミリを使用する接続が成功した場合、その後の接続は優先アドレスファミリを使用する (SHOULD)
    - アドレスファミリのプレフィックスに基づく接続の成功 / 失敗を追跡する (MAY)

#### IPv4のみホストへの対応
- ステートフルアルゴリズムを実装しない限り、
  ホストのアドレス選択ポリシーによって返された最初のIPアドレスファミリを優先して接続すること (MUST)
  - 通常はIPv6を優先
  - ユーザー設定またはネットワーク設定によって上書きすることが可能
  - ホストのポリシーが不明な場合はIPv6を優先

#### 複数のA / AAAAレコード
- DNSが複数のA / AAAAアドレスを返した場合、
  ホストのアドレス優先ポリシーに従い最初のアドレスを試行すること (RECOMMENDED)
  - 一定時間後に失敗した場合、その次に返された他のIPv4アドレスを試行すること (SHOULD)

#### コネクションタイムアウト
- 接続試行の間隔を150～250ミリ秒にすること (RECOMMENDED)

## Google ChromeとMozilla FirefoxにおけるHappy Eyeballs 2の実装アルゴリズム
1. `getaddinfo()`を呼び出し、ホストのアドレス優先ポリシーでソートしたIPアドレスのリストを返す
2. リストの最初のIPv6アドレスで接続の試行を開始する
3. 300ミリ秒内に接続が完了しない場合、リストの最初のIPv4アドレスで接続の試行を開始する
4. 2、3のうちいずれか最初に確立された接続が使用され、他の接続は破棄される
5. 4の結果をキャッシュする

## 参照
- [Happy Eyeballsとは](https://www.nic.ad.jp/ja/basics/terms/happy-eyeballs.html)
- [Happy Eyeballs: Success with Dual-Stack Hosts](https://www.ietf.org/rfc/rfc6555.txt)
- [Happy Eyeballs Version 2: Better Connectivity Using Concurrency](https://www.ietf.org/rfc/rfc8305.txt)
