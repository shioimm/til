# ICMP
- Internet Control Message Protocol (インターネット制御メッセージプロトコル)
- 到達を保証する機能を持たないIPの代わりにエラー報告を行うために利用されるプロトコル
  - IPパケットが目的のホストまで届くかの確認
  - IPパケットが廃棄された時の原因の通知
  - 不十分な設定をより良い設定に変更するなどIPによる通信の補助など
- ICMPメッセージはIPパケットのペイロードとして配送される
- C言語で扱うためのインターフェースは`/usr/include/netinet/ip_icmp.h`にて定義される

## メッセージタイプ

| タイプ | 意味           | 説明                                          |
| -      | -              | -                                             |
| 0      | エコー応答     | エコー要求への応答                            |
| 3      | 到達不能       | 転送先にパケットが届かない                    |
| 5      | リダイレクト   | 最適ではない経路の変更                        |
| 8      | エコー要求     | エコー応答の要求                              |
| 9      | ルーター広告   | ルーター請願への応答                          |
| 10     | ルーター請願   | ルーター広告の要求                            |
| 11     | 時間超過       | TTLを使い切った(ループが発生している場合など) |
| 42     | 拡張エコー要求 | 拡張エコー応答の要求                          |
| 43     | 拡張エコー応答 | 拡張エコー要求への応答                        |

- タイプごとにコードを持ち、タイプとコードの組み合わせでネットワークの状態を表す

### 通信状態の確認
- Echo Request (タイプ: 8 / コード: 0) - パケットに識別子とシーケンス番号を追加
- Echo Response (タイプ: 0 / コード: 0) - パケットに識別子とシーケンス番号を追加

#### `ping(1)`
- ICMPパケットのうちICMP Echo Request / ICMP Echo Responseを利用して疎通確認を行う
- 2つのTCP/IPノード間でICMPパケットの送受信を行う

### ルーティングできなかった場合
- Destination Unreachable (タイプ: 3 / コード: 原因別) - 全て0の24ビットを追加
  - コード: 0 - ルーティングエントリがない
  - コード: 1 - ネクストホップが動作していない
  - コード: 4 - 出口のMTUが小さい、かつフラグメントが禁止されている
  - コード: 13 - FWなどのフィルタリングによってパケットが拒否されている

### 送信元へ別のゲートウェイを通知する場合
- Redirect (タイプ: 5 / コード: 原因別) - 経路変更後のゲートウェイアドレスを追加

### TTLがゼロになった場合
- Time-to-live exceeded (タイプ: 11 / コード: 0) - 全て0の24ビットを追加

## ICMPメッセージフォーマット
- タイプ
  - メッセージの種類
- コード
  - 障害理由の詳細
- チェックサム
  - ICMPメッセージ全体のチェックサム
- 識別子
  - パケットの識別子 (送信元プロセスの特定に使用)
- シーケンス番号
  - 要求と応答を対応づける
- ペイロード
  - メッセージタイプによって異なるペイロード

## 参照
- Linuxプログラミングインターフェース 58章
- サーバ・インフラエンジニアの基本がこれ一冊でしっかり身につく本 2.8-9
- Linuxで動かしながら学ぶTCP/IPネットワーク入門 4.5
- コンピュータネットワーク
- マスタリングTCP/IP 入門編
- パケットキャプチャの教科書
