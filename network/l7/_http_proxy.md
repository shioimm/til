# HTTPプロキシ
- HTTP通信を中継するサーバ
- パフォーマンス向上とセキュリティ向上のために利用される

#### HTTPへの透過プロキシ
1. クライアント - HTTPプロキシ間で3wayハンドシェイクを用いてTCPコネクションを確立
2. クライアント -> HTTPプロキシ: HTTPリクエストを送信
3. HTTPプロキシ - サーバ間で3wayハンドシェイクを用いてTCPコネクションを確立
4. HTTPプロキシ -> サーバ: HTTPリクエストを送信
5. HTTPプロキシ <- サーバ: HTTPレスポンスを送信
6. クライアント <- HTTPプロキシ: HTTPレスポンスを送信

#### HTTPSへの透過プロキシ
1. クライアント - HTTPプロキシ間で3wayハンドシェイクを用いてTCPコネクションを確立
2. クライアント -> HTTPプロキシ: CONNECTリクエストを送信
3. HTTPプロキシ - サーバ間で3wayハンドシェイクを用いてTCPコネクションを確立
4. クライアント <- HTTPプロキシ: 準備完了を示すレスポンスを返却
5. クライアント -> HTTPプロキシ: HTTPによってカプセル化した暗号メッセージを送信
6. HTTPプロキシ -> サーバ: HTTPによるカプセル化を解除した暗号メッセージを送信
7. HTTPプロキシ <- サーバ: 暗号化したHTTPレスポンスを送信
8. クライアント <- HTTPプロキシ: HTTPによってカプセル化した暗号化HTTPレスポンスを送信

## フォワードプロキシ / リバースプロキシ
#### フォワードプロキシ
- システムから外部へアクセスする際に経由する

```
サーバ -> フォワードプロキシサーバ -> インターネット -> 外部システム
```

- 内部ネットワークから外部ネットワークにアクセスする際、接続元にとって好ましくない接続先への接続を制限する
- Webシステムが外部システムにアクセスする際、外部システムからのレスポンスを一定期間キャッシュし、
  同じAPIを何度も叩かずに済むようにする

#### リバースプロキシ
- 外部からシステムへアクセスする際に経由する
  - ロードバランサ、CDNなど

```
利用者 -> インターネット -> リバースプロキシサーバ -> サーバ
```

- サーバに対するアクセスの流量制限やリクエストの検査を行う
- 負荷分散によるスループット向上 (ロードバランサ)
- DoS / DDoSをサーバに代わって被弾する (CDN)
- キャッシュや圧縮による高速化・スループット向上 (CDN)
- TLSの終端 (アプリケーションデータを復号化)
- SSLの集中管理

## Forwardedヘッダ
- [Forwarded](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Forwarded)
- リバースプロキシサーバによって追加される可能性のある情報を格納する
- リクエストの経路にプロキシサーバが介在している場合は変更されるか失われる
- X-Forwarded-For、X-Forwarded-Host、X-Forwarded-Proto

```
Forwarded: by=<identifier>;    # リクエストがプロキシサーバに入ってきたインターフェイス
           for=<identifier>;   # リクエストを発行したクライアントと、その後のプロキシチェーン内のプロキシ
           host=<host>;        # プロキシから受信したときのHostリクエストヘッダ
           proto=<http|https>  # リクエスト作成時に使用されたプロトコル

# identifier - 変更または失われた情報を公開する識別子(IPアドレス、難読化された識別子、etc)
```

#### X-Forwarded-For
- [X-Forwarded-For](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/X-Forwarded-For)
- プロキシーサーバを通過してサーバへ接続するクライアントの送信元IPアドレスをサーバに伝えるために使用されるヘッダ

```
X-Forwarded-For: <client>,          # クライアントの IP アドレス
                 <proxy1>, <proxy2> # 通過するプロキシのIPアドレス (通過する順)
```

## 参照
- よくわかるHTTP/2の教科書P26-27
- サーバ・インフラエンジニアの基本がこれ一冊でしっかり身につく本 5
- Real World HTTP 第2版
- [リバースプロキシ（Reverse Proxy）](https://www.atmarkit.co.jp/ait/articles/1608/25/news034.html)
- [SOCKSプロキシとHTTPプロキシの違いについて勉強してみた](https://dev.classmethod.jp/articles/socks-proxy-and-http-proxy/)
