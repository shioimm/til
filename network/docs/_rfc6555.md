# Happy Eyeballs: Success with Dual-Stack Hosts
- IPv4 / IPv6デュアルスタッククライアントにおいてユーザから見える遅延を低減するアルゴリズムの要件の規定
- IPv6 / IPv4のトラフィックが倍増したとしてもネットワークとサーバに過度な損害を与えず、
  ホストのアドレス選好を尊重することを目標とする
- IPv4ネットワーク・IPv4ネットワークアドレストランスレータの負荷を軽減するためIPv6をIPv4よりわずかに優先させる

#### 解決したい課題
- IPv4 / IPv6デュアルスタッククライアントが接続試行を行う際、
  サーバのIPv4プロトコルは動作しているがIPv6プロトコルは動作していない、という状況において
  IPv4のみのクライアントよりもむしろ接続が遅延する
  - IPv6対応アプリケーションに対してIPv6の接続性が損なわれる際、
    IPv4にフォールバックするまでに数秒の遅延が発生するため

## Algorithm Requirements
- IPv6接続を素早く試み、接続が成功しなかった場合はIPv4接続を試みることによりユーザーに高速接続を提供する
  - クライアントはIPv6とIPv4で2つのTCP SYNを送信する
    - [MUST] ホストのアドレス優先ポリシーが返す最初のIPアドレスファミリーを優先する
      (ステートフルアルゴリズムを実装していない場合)
    - [MUST] ホストのポリシーが不明または達成できない場合、IPv4よりもIPv6を優先する
  - 接続が確立できなかった場合、アプリケーションがあきらめるまで接続は再試行される
- ネットワークのスラッシングを回避するため、IPv6とIPv4の同時接続を試行しない
  - [MUST] クライアントは各接続試行の結果をキャッシュし、その後の接続試行に対してキャッシュを利用することで
    ネットワークのスラッシングを避ける
  - キャッシュエントリは、システムで定義された最大値が10分を超えたらフラッシュされるべき

#### Stateful Behavior When IPv6 Fails (ステートフルアルゴリズムによる実装)
- 優先するアドレスファミリで接続を試行し、一定時間内に接続を確立できなかった場合、
  同じアドレスファミリまたは他のアドレスファミリを使用して2回目の接続試行を開始する
- [MAY] 接続に成功したアドレスファミリを使用して同じホスト、または他のホストに対して接続を試みることができる
- [MUST] ホストによって新しい接続が試行されている限り、時折ホストの優先アドレスファミリを使用して接続試行する
  (ホストが再び機能する可能性があるため)
  - [SHOULD] 10分ごとに接続試行する
    - Happy Eyeballsのステートを10分ごとにフラッシュすることが必要
- [SHOULD] 優先アドレスファミリによる接続が再び成功した場合、優先アドレスファミリはその後の接続にも使用する
- [MAY] IPv6またはIPv4プレフィックスに基づいて接続の結果を追跡することができる

#### Reset on Network (Re-)Initialization
- [SHOULD] Happy Eyeballsアルゴリズムはインターフェースが新しいネットワークに接続されたときに再初期化を行う
  - Detecting Network Attachment in IPv4 (DNAv4) (RFC4436)
  - Detecting Network Attachment in IPv6 (DNAv6) (RFC6059)

#### Abandon Non-Winning Connections
- 接続に成功していないコネクションは破棄することが推奨される
  - サーバ (ファイルディスクリプタ、TCPコントロールブロック) と
    ステートフルミドルボックス (NATとFW) の負荷軽減のため
  - 対象のコネクションがIPv4の場合、IPv4アドレス共有の競合を減らすため
  - サーバのHTTP Cookieの設定によってはすべての接続が同じIPアドレスからであることを要求される場合があるため
  - HTTPの場合、接続に成功していないコネクションを使用することがsame-origin policyを妨害する可能性があるため

## A and AAAA Resource Records
- A / AAAAリソースレコードに対するDNSクエリは、複数のA / AAAAアドレスを返す可能性がある
- [RECOMMENDED] 複数のA / AAAAアドレスを取得した場合、ホストのアドレス優先ポリシーに従って応答を順番に並べ、
  最初のアドレスを接続試行する
  - [SHOULD] 一定時間後に接続が失敗した場合、次はIPv4アドレスで接続試行する
  - [SHOULD] 一定時間後に接続が失敗した場合、他のアドレスで接続試行する

## Connection Timeout
- [RECOMMENDED] ネットワークトラフィックの混雑を避けるため、接続試行に時間をかけることが推奨される
  - [RECOMMENDED] 150～250ms間隔
  - ステートフルアルゴリズムの場合は予想される接続完了時間の見積もりを保持するため、
    より短い間隔で接続試行を行うことが推奨される

## 参照
- https://datatracker.ietf.org/doc/html/rfc6555
