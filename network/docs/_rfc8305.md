# Happy Eyeballs Version 2: Better Connectivity Using Concurrency
- IPv4 / IPv6デュアルスタックホストにおいて、
  IPv6の使用を優先しつつ複数の接続を並行してより早く接続を確立するための手法

#### Happy Eyeballs Connection Setup
1. 非同期DNSクエリの開始
2. 解決された宛先アドレスを優先順に並べ替える
3. 一つの接続を確立した後、他のすべての接続をキャンセルする

### Hostname Resolution Query Handling
- クライアントがIPv4 / IPv6デュアルスタックである場合、AAAAレコードとAレコード両方にクエリを送信する
- [SHOULD] AAAAクエリを最初に行い、直後にAクエリを行う
- [SHOULD] 両方の回答が返ってくるのを待ってからコネクション確立を試行するべきではない
- [SHOULD] クライアントはDNS解決を非同期で行う
  - クライアントが非同期DNS APIを持たない場合:
    アドレスファミリごとに一つずつ、異なるスレッドで二つの別々の同期クエリを行う

#### アルゴリズム
- フルリゾルバから最初に有効なAAAA応答を受信した場合、クライアントは最初のIPv6接続を直ちに試行する
- [SHOULD] 並べ替えによりフルリゾルバから最初に有効なA応答を受信した場合、クライアントはAAAA応答をしばらく待つ
  - Resolution Delay: 推奨値は50ms
  - IPv6を優先するため
  - 一般的には数ミリ秒程度A応答がAAAA応答よりも早い
- Resolution Delay中にフルリゾルバからpositiveなAAAA応答を受信した場合、クライアントは直ちにIPv6接続を試行する
- [SHOULD] Resolution Delay中にフルリゾルバからnegativeなAAAA応答を受信した場合、
  またはResolution Delay終了までにフルリゾルバがAAAA応答を返さなかった場合、
  クライアントはこれまでに受信したIPv4アドレスを使用してアドレスの並び替えとtaggered connection attemptsを行う
  - それらの接続試行中、接続が確立される前にフルリゾルバからAAAA応答を受信した場合、
    新たに受信したIPv6アドレスを利用可能な候補アドレスのリストに追加し、
    接続が確立されるまでIPv6アドレスが追加された状態で接続を試みるプロセスを継続する

#### Handling Multiple DNS Server Addresses
- DNSフルリゾルバに対してDNSクエリを送信する際、クライアントはフルリゾルバのIPv6アドレスを優先して宛先とする
- DNSフルリゾルバのIPv6アドレスに送信されたDNSクエリに対する応答が受信できない場合、
  クライアントは当該アドレスをペナルティとしてマークし、他のIPアドレスにクエリを送信する
- [SHOULD] クライアントは設定可能なDNSサーバーの数に明示的な制限を設けるべきではない
  - [SHOULD] ハードウェアの制限により制限が必要な場合、クライアントは利用可能なリストのうち
    各アドレスファミリから少なくとも一つのアドレスを使用する

## 参照
- https://datatracker.ietf.org/doc/html/rfc8305
- https://datatracker.ietf.org/doc/html/rfc6555
