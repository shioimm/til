# プロセス
## プロセスの作成
### `fork(2)`
- プロセスの複製を作成する

#### 返り値
- 親プロセス - 子プロセスのプロセスIDを返す
  - エラー時は数値-1を返す
- 子プロセス - 数値0を返す

### `clone(2)`
- `fork(2)`と同目的
- スレッドライブラリの内部で使用される
- 可搬性がなくアプリケーションから直接使用されることはない
- 実行開始点となる関数を指定する(子関数)
  - 生成された子プロセスは子関数からリターンするか`exit()`で終了する
  - 関数の返り値が子プロセスの終了コードになる

#### `flags`で制御できる操作
- ファイルディスクリプタの共有
- ファイルシステム関連情報の共有
- シグナル動作の共有
- 仮想メモリの共有
- スレッドグループの共有
- スレッドライブラリの対応
- スレッドローカルストレージの設定
- SystemVセマフォ`undo`の共有
- マウント名前空間の設定
- 子プロセスを自プロセスの兄弟プロセスとする
- プロセスIDを親プロセスIDに一致させる(現在使用されない)
- プロセスのトレース
- プロセスの終了または`exec()`実行を待つ
- コンテナ対応

#### 引数
- `*func`、`*child_stack`、`flags`、`*func_args`を指定する
  - `*func` - 実行開始点となる子関数へのポインタ
  - `*child_stack` - 子プロセスに新たに割り当てられるスタックへのポインタ
  - `flags` - `clone(2)`の動作を制御するフラグ
  - `*func_args` - 子関数の引数

#### 返り値
- 子プロセス / スレッドのIDを返す
  - エラー時は数値-1を返す

## プロセスの正常終了
### `_exit(2)`
- 指定の`wait`ステータスでプロセスを終了させる

#### 引数
- `status`を指定する
  - `status` - プロセスの`wait`ステータス
    - 親プロセスに送信する

### `exit(2)`
1. `exit`ハンドラを登録順と逆順に実行する
2. `stdio`ストリームのバッファをフラッシュする
3. `_exit(2)`を実行する - 指定の`wait`ステータスでプロセスを終了させる

#### 引数
- `status`を指定する
  - `status` - プロセスの`wait`ステータス
    - 親プロセスに送信する

### `atexit(3)`
- 指定の`exit`ハンドラを登録する
- プロセスの終了コードを参照する方法はない
- ハンドラに引数を渡せない

#### 引数
- `*func`を指定する
  - `*func` - 指定の`exit`ハンドラ

```c
void func(void)
{
  // 処理
}
```

#### 返り値
- 数値0
  - エラー時は数値0以外を返す

### `on_exit(3)`
- 指定の`exit`ハンドラを登録する
- ハンドラがプロセスの終了コードと任意の値を引数にとる

#### 引数
- `*func`、`*arg`を指定する
  - `*func` - 指定の`exit`ハンドラ
  - `*arg` - `*func`に渡す引数

```c
void func(int status, void *arg)
{
  // 処理
}
```

#### 返り値
- 数値0
  - エラー時は数値0以外を返す

## プロセスの監視
### `wait(2)`
- 指定の子プロセスが終了するまで処理をブロックする
  - すでに終了済みの場合は`ECHLD`を送信して即時返す
- 子プロセスが終了したら`wait`ステータスを取得する

#### 引数
- `*status`を指定する
  - `*status` - `wait`ステータスを格納するメモリへのポインタ

#### 返り値
- 子プロセスのプロセスIDを返す
  - エラー時は数値-1を返す

### `waitpid(2)`
- 指定の子プロセスが終了するまで処理をブロックする
  - `WNOHANG`フラグをセットすると処理をブロックせず
    子プロセスの終了を定期的に確認する
- 子プロセスが終了したら`wait`ステータスを取得する
- オプションで処理のブロックを行うことができる
- オプションでジョブ制御を扱うことができる
- `waitid(2)`は`siginfo_t`構造体を使用して子プロセスの状態をより詳細に取得できる
- `wait3(2)` / `wait(4)`は`rusage`構造体を使用してリソース消費情報を取得できる
  - `wait(3)`は`waitpid(-1, &status, options)`と同じ
  - `wait(4)`は`waitpid(pid, &status, options)`と同じ

#### 引数
- `pid`、`*status`、`options`を指定する
  - `pid` - 指定の子プロセスのプロセスID
    - `pid > 0` - 指定したPIDを持つ子プロセス
    - `pid == 0` - 親プロセスと同じプロセスグループに属する子プロセス
    - `pid == -1` - 任意の子プロセス(`wait`と同じ)
    - `pid < -1` - プロセスグループIDが指定したPIDの絶対値に等しい子プロセス
  - `*status` - `wait`ステータスを格納するメモリへのポインタ
  - `options` - `waitpid(2)`の動作を制御するフラグ

#### 返り値
- 子プロセスのプロセスIDを返す
  - エラー時は数値-1を返す

### `wait`ステータス用標準マクロセット
- `WIFEXITED(status)` - 子プロセスが正常終了した場合、真を返す
- `WIFSIGNALE(status)` - 子プロセスが補足しないシグナルによって異常終了した場合、真を返す
- `WIFSTOPPED(status)` - 子プロセスがシグナルにより実行を一時停止している場合、真を返す
- `WIFCONTINUED(status)` - 子プロセスが`SIGCONT`により実行を再開した場合、真を返す

## プログラムの実行
### `execve(2)`
- 自プロセスに指定のプログラムをロードして実行

#### `exec`関数群
- いずれも`内部でexecve(2)`を実行する

| 関数名      | プログラム名(-, p)  | パラメータ(v, l) | 元にする環境(e, -)    |
| -           | -                   | -                | -                     |
| `execve(2)` | パス名              | 配列             | 引数`envp`            |
| `execle(2)` | パス名              | 文字列リスト     | 引数`envp`            |
| `execlp(2)` | ファイル名 + `PATH` | 文字列リスト     | 自プロセスの`environ` |
| `execvp(2)` | ファイル名 + `PATH` | 配列             | 自プロセスの`environ` |
| `execv(2)`  | パス名              | 配列             | 自プロセスの`environ` |
| `execl(2)`  | パス名              | 文字列リスト     | 自プロセスの`environ` |

- `fexecve(3)` - ファイルディスクリプタ指定によるプログラム実行

#### 引数
- `*pathname`、`argv[]`、`envp[]`を指定する
  - `*pathname` - 指定のプログラムのパス名を示す文字列へのポインタ
  - `argv[]` - 新規プログラムへのコマンドラインパラメータを示す配列へのポインタ
  - `envp[]` - 新規プログラムの環境リストを示す配列へのポインタ

#### 返り値
- リターンしない
  - エラー時は数値-1を返す

### `system(2)`
- 自プロセスから任意のシェルコマンドを実行する
  - 子プロセスを作成し、シェルを実行し、シェル内でコマンドを実行する

#### 引数
- `*command`を指定する
  - `*command` - シェルコマンドを示す文字列へのポインタ

#### 返り値
- NULLポインタを指定 - シェルが有効なら数値0 / シェルが無効なら数値0以外を返す
- 子プロセスの作成に失敗 - 数値−１を返す
- 子プロセスがシェルを実行できない - シェルが`_exit(127)`を実行したものとして処理
- 成功 - 指定したコマンドを実行したシェルの終了ステータス

## プロセスアカウンティング
### `acct(2)`
- プロセスアカウンティングを有効化し、
  アカウンティングレコード`acct`構造体をアカウンティングファイルへ記録する

```c
// <sys/acct.h>

struct acct {
  char      ac_flag;     // 実行中の事象を記録するフラグ
  u_int16_t ac_uid;      // 実ユーザーID
  u_int16_t ac_gid;      // 実グループID
  u_int16_t ac_tty;      // 制御端末
  u_int32_t ac_btime;    // 開始時間
  comp_t    ac_utime;    // ユーザーCPU時間
  comp_t    ac_stime;    // システムCPU時間
  comp_t    ac_etime;    // 経過時間
  comp_t    ac_mem;      // 平均使用メモリ量
  comp_t    ac_io;       // 読み書きによる転送バイト数
  comp_t    ac_rw;       // 読み書きしたブロック数
  char      ac_comm[17]; // 17文字
};

// ac_flag
//   AFORK - forkされたプロセスがexecを呼んでいない
//   ASU   - スーパーユーザー権限を使ったプロセス
//   ACORE - コアダンプしたプロセス
//   AXSIG - シグナルでkillされたプロセス
```

```c
// 新ファイルフォーマット
// CONFIG_BSD_PROCESS_ACCT_V3`を有効化する必要がある

// <sys/acct.h>

struct acct_v3 {
  char      ac_flag;     // 実行中の事象を記録するフラグ
  char      ac_version;  // アカウンティングバージョン
  u_int32_t ac_uid;      // 実ユーザーID(32ビット)
  u_int32_t ac_gid;      // 実グループID(32ビット)
  u_int32_t ac_pid;      // プロセスID
  u_int32_t ac_ppid;     // 親プロセスID
  u_int16_t ac_tty;      // 制御端末
  u_int32_t ac_btime;    // 開始時間
  u_int32_t ac_etime;    // 経過時間
  comp_t    ac_utime;    // ユーザーCPU時間
  comp_t    ac_stime;    // システムCPU時間
  comp_t    ac_etime;    // 経過時間
  comp_t    ac_mem;      // 平均使用メモリ量
  comp_t    ac_io;       // 読み書きによる転送バイト数
  comp_t    ac_rw;       // 読み書きしたブロック数
  comp_t    ac_minflt;   // マイナーページフォールト回数
  comp_t    ac_majflt;   // メジャーページフォールト回数
  char      ac_comm[17]; // 17文字
};
```

#### 引数
- `*acctfile`
  - `*acctfile` - アカウンティング情報を格納するファイル名を示す文字列へのポインタ
    - 一般に`/var/log/pacct`または`/usr/account/pacct`
    - NULLを指定すると無効化

#### 返り値
- 数値0
  - エラー時は数値-1以外を返す

## プロセスIDの取得
### `getpid(2)`
- プロセスIDの取得

#### 返り値
- プロセスID(`pid_t`)を返す

### `getppid(2)`
- プロセスの親プロセスIDの取得

#### 返り値
- プロセスID(`pid_t`)を返す

## プロセスグループ
### `getpgrp(2)`
- 自プロセスが所属するプロセスグループIDを取得する

### 返り値
- 自プロセスのプロセスグループIDを返す

### `setpgid(2)`
- 指定のプロセスが所属するプロセスグループを指定のプロセスグループへ変更する
  - 指定できるのは自プロセスか自プロセスの子プロセスのみ
  - プロセスグループを移動する場合、移動先のプロセスグループは同一セッション内に限られる
  - `exec`実行後の子プロセスのプロセスグループIDは変更できない

```c
// 自プロセスを所属するプロセスグループのリーダーにする
setpgrp(0, 0)
```

### 引数
- `pid`、`pgid`を指定する

### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

### `tcgetpgrp(2)`
- 端末のプロセスグループを参照する

#### 引数
- `fd`を指定する
  - `fd` - 自プロセスの制御端末のファイルディスクリプタ

#### 返り値
- フォアグラウンドプロセスグループのIDを返す
  - エラー時は数値-1を返す

### `tcsetpgrp(2)`
- 端末のプロセスグループを変更する

#### 引数
- `fd`、`pgid`を指定する
  - `fd` - 自プロセスの制御端末のファイルディスクリプタ
  - `pgid` - 自プロセスと同じセッションに属するプロセスグループID

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す

## プロセススケジューリング
### `getpriority(2)`
- プロセス、プロセスグループ、ユーザのnice値を取得する

#### 引数
- `which`、`who`を指定する
  - `which` - どんなプロセスを対象にするかを示すマクロ定数
  - `who` - プロセスIDまたはユーザーID(`which`によって変わる)

#### 返り値
- 指定したプロセスのIDを返す
  - エラー時は数値-1を返す

### `setpriority(2)`
- プロセス、プロセスグループ、ユーザのnice値を変更する

#### 引数
- `which`、`who`、`prio`を指定する
  - `which` - どんなプロセスを対象にするかを示すマクロ定数
  - `who` - プロセスIDまたはユーザーID(`which`によって変わる)
  - `prio` - 優先度

#### 返り値
- 指定したプロセスのIDを返す
  - エラー時は数値-1を返す

## 参照
- 例解UNIX/Linuxプログラミング教室P185-224
- 詳解UNIXプログラミング第3版 7. プロセスの環境 / 8. プロセスの制御 / 9. プロセスの関係
- Linuxプログラミングインターフェース 6章
