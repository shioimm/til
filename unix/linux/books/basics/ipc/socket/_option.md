# ソケットオプション
- 参照: 例解UNIX/Linuxプログラミング教室P291-322
- 参照: 詳解UNIXプログラミング第3版 16. ネットワークIPC: ソケット
- 参照: Linuxプログラミングインターフェース 56章 / 61章

## TL;DR
- ソケットの動作を変化させる
- ソケットオプションはオープンファイル情報として保持される
  - `accept()`が生成するソケットはリスニングソケットの設定可能なオプションを受け継ぐ
  - 複製されたソケットディスクリプタは同じソケットオプションを受け継ぐ

## オプションの種類
- 全てのソケット種別に適用できる汎用オプション
- 下位プロコトルに依存し、ソケットレベルで管理されるオプション
- 個々のプロトコル特有のオプション

## オプション
### `SO_TYPE`
- ソケット種類を得る(読み取り専用)

### `SO_REUSEADDR`
- 再起動したTCPサーバーが動作中のポートにソケットをバインドした際に発生する`ESDDRINUSE`を防ぐ
- `SO_REUSEADDR`は接続済みTCPソケットを特定する方法を実際の実装から本来の仕様に近づける

#### 設定値
- デフォルト値は数値1
  ソケットのバインド前にデフォルト値以外を設定することによって有効化する

#### `ESDDRINUSE`エラーが発生する条件
- 前回実行したサーバーがクライアントと通信し、アクティブクローズを実行した
- 前回実行したサーバーがクライアントと通信する子プロセスを作成し、親プロセスのみが終了し、
  子プロセスがクライアント処理を継続した

#### `ESDDRINUSE`エラーが発生する原因
- TCP本来の仕様では接続済みTCPソケットは次の組み合わせにより一意に識別される
  - `{ ローカルIPアドレス, ローカルポート, リモートIPアドレス, リモートポート }`
- TCPの実際の実装ではローカルポートに一致するコネクションがホスト上に存在する場合、ローカルポートの再利用を禁止している(`TIME_WAIT`の規定時間)

## 帯域外データ
- ストリームソケットが持つ機能
- 送信側が送信データを高優先度とマークする
- 受信側はストリーム内のデータを全て読み取る前に帯域外データの存在を通知される
- 帯域外データを受信するとカーネルが`fnctl(2)`の`F_SETOWN`により指定されたソケットオーナーへ`SIGURG`を送信する
- TCPソケットが同時に帯域外データとマークできるのは1バイトのみ
  - 複数の帯域外データが送信された場合、最後に送信されたデータが有効になる
- 現在は非推奨(ストリームソケットを二つ用意することで代用する)

### 設定
- `send(2)` / `recv(2)`に`MSG_OOB`を指定する

### 緊急マーク
- データストリームの中で緊急データが占める位置
  - ソケットオプション`SO_OOBINLINE`で通常データに埋め込まれた
    緊急データを受け取ることができる

## シーケンスパケットソケット
- ストリームソケット・データグラムソケットの機能を併せ持つ
  - ストリームソケット同様にコネクション指向
  - ストリームソケット同様に信頼性を備える
    - メッセージはピアアプリケーションへ順序を維持し、重複なく到達する
  - データグラムソケット同様にメッセージ区切りを維持し、`read()`は1メッセージのみを読み取る

### 設定
- `socket(2)`に`type`として`SOCK_SEQPACKET`を指定する

## API
### `getsockopt(2)` / `setsockopt(2)`
- `getsockopt(2)` - オプションの現在値を取得する
- `setsockopt(2)` - オプションの現在値を変更する
  - プロトコルの識別
  - オプションのON/OFF

#### 引数
- `sockfd`、`level`、`optname`、`*optval`、`*optlen`を指定する
  - `sockfd` - 対象のソケットディスクリプタ
  - `level` - 対象のプロトコル
    - `SOL_SOCKET` - ソケットAPIレベル
  - `optname` - 操作対象のソケットオプションを示すマクロ定数
  - `*optval` - ソケットオプションの値を格納するバッファへのポインタ
  - `*optlen` - `optval`が指すバッファのサイズ

#### 返り値
- 数値0を返す
  - エラー時は数値-1を返す
