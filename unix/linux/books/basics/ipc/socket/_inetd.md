# `inetd`
- 参照: Linuxプログラミングインターフェース 60章

## TL;DR
- ホスト上の多種多様なサービス(ほとんどは接続要求待ちになるもの)の起動を
  最小限に抑えることを目的に開発されたデーモンプロセス
- それぞれのサービスのデーモンを個別に起動せず、代わりに`inetd`デーモン1プロセスを起動する
  `inetd`デーモンは指定されたポートを監視し、要求に応じて本来のサービスサーバーを起動する
- ネットワークサーバー一般に必要な処理を全て`inetd`が担うことにより
  起動するサーバーのプログラミングを簡略化できる
- [Linux]`xinetd` - セキュリティ強化を主眼とした拡張`inetd`

## `inetd`の役割
- ソケット関連の初期化全般
  `socket()` / `bind()` / `listen()`(TCPサーバーの場合)
- (TCPサービスの場合)接続要求の`accept()`
- 受信したUDPデータグラムまたはTCPコネクションを処理する子プロセスを作成
  - プロセスは自動的にデーモン化する
  - `fork()`によるプロセス作成、終了した子プロセスの処理
- UDPソケット / TCPソケットを標準入出力へ複製し、他のファイルディスクリプタをクローズする
- サーバープログラムを`exec()`する

## `inetd`の設定
1. `inetd`はシステム起動時に起動され、デーモン化される
2. `/etc/inetd.conf`に指定された各サービスに適切なソケットを作成し、ポートへバインドする
    - TCPソケットには`listen()`を実行し、接続要求を受けるとマークする
3. `select()`を実行し全ソケットにデータグラムまたは接続要求が届くのを監視する
    - `select()`はUDPソケットからデータグラムが読み取り可能になるか
      TCPソケットが届いた接続要求を`accept()`するまで処理をブロックする
4. それぞれのソケットに対応する本来のサーバーを`fork()` -> `exec()`する
    - `exec()`前に子プロセスは
      1. 親プロセスから受け継いだディスクリプタを全てクローズする(ソケットを除く)
      2. ソケットディスクリプタを標準入出力に複製する
      3. ソケットディスクリプタをクローズする
    - `exec()`されたサーバーは必要に応じて`/etc/inetd.conf`に指定されたUID・GIDを設定する
5. 受信したのがTCPソケットの場合は接続済みソケットをクローズする
4. `3`~`5`繰り返し

### `/etc/inetd.conf`の内容
- サービス名
- ソケット種類(`stream` / `dgram`)
- プロトコル(`tcp` / `udp`)
- フラグ(`wait` / `nowait`)
- ログイン名
- `exec()`するサーバープログラムのパス名
- `exec()`するサーバープログラムへのコマンドラインパラメータ
