# 高度なIO
- 参照: Linuxプログラミングインターフェース 63章

## TL;DR
- 1~nファイルディスクリプタがIO可能になったかどうかを監視する
  - IOシステムコールを実行するとブロックするかどうか
- ファイルディスクリプタの状態は何らかのIOイベントをきっかけにIO可能状態へ移行する
- どのIOモデルもIOモデル自身は監視・通知のみを行い、実際のIOには他のシステムコールの実行が必要
- どのIOモデルにおいてもノンブロッキングIOを組み合わせるのが通例
  - エッジトリガ通知への対応のため
  - 通知から実際のIOまでの間にファイルディスクリプタの状態が変化する可能性があるため
  - ストリームソケットのファイルディスクリプタへ大量に書き込むとブロックされる可能性があるため

## IOモデル
### 多重IO
- 1プロセスが複数のファイルディスクリプタを監視する
- `select(2)` / `poll(2)`によって実現する

#### 特性
- 可搬性に優れる
- 監視対象ファイルディスクリプタ数が増加すると効率よくスケールしない

### シグナルドリブンIO
- 指定したファイルディスクリプタが読み取り・書き込み可能になったら
  カーネルからプロセスへシグナルを送信する
- プロセスが別の処理を行っている場合はシグナルによって割り込む

#### 特性
- 多数のファイルディスクリプタを効率よく監視する
- 複雑なシグナル処理が必要
- シグナルドリブンIOの機能をフル活用すると可搬性が下がる

### `epoll(2)`
- IO多重化とシグナルドリブンIOの特性を兼ね備える

#### 特性
- 可搬性が低い(Linux固有)
- 多数のファイルディスクリプタを効率よく監視する
- 複雑なシグナル処理を回避できる
- 監視内容を指定できる
- 通知の契機としてレベルトリガ・エッジトリガを選択できる

## 通知

| IOモデル                | レベルトリガ | エッジトリガ |
| -                       | -            | -            |
| `select(2)` / `poll(2)` | 対応         | -            |
| シグナルドリブンIO      | -            | 対応         |
| `epoll(2)`              | 対応         | 対応         |

### レベルトリガ
- 指定したファイルディスクリプタが現在IO可能かどうかを判定する
- IOシステムコールを実行してもブロックしない状態であれば通知する
  - 対象のファイルディスクリプタのIO可否を監視する

### エッジトリガ
- 前回監視後のファイルディスクリプタに対してIOが発生したかどうかを判定する
- 最後に監視して以降にIOイベントが発生したら通知する
  - 対象のファイルディスクリプタに発生するIOイベントを監視する
  - 監視対象ファイルディスクリプタはノンブロッキングモードとし、
    IOシステムコールは`EAGAIN` / `EWOULDBLOCK`が発生するまで繰り返し実行する
