# 仮想メモリ
- プロセスから使用されるメモリ
  - 物理メモリのアドレスとプロセスの間に仮想的なアドレス情報を割り当て、
    プロセスはそれを経由してメモリを管理する
  - 空間的局所性・時間的局所性に基づき、プロセスアドレス空間の一部のみをRAM上に乗せて実行する

#### 特徴
- 各プロセスは互いに独立したアドレス空間を持つ
  - プロセスのページテーブルエントリが個別の物理メモリページを持つことで実現する
- 同じ物理メモリページを参照することで複数のプロセスがメモリを共有できる
  - e.g. プログラムコード、共有ライブラリ
  - e.g. `shmget()`による共有メモリ、`mmap`によるファイルマッピング

#### 空間的局所性
- プログラムは直近にアクセスしたメモリに近いアドレスへアクセスするという傾向
- 命令はシーケンシャルに実行され、データもシーケンシャルに処理される

#### 時間的局所性
- プログラムは直近にアクセスしたメモリへ近い将来再びアクセスするという傾向

## 仮想メモリ方式
1. プログラムが使用するメモリを固定サイズの小さな単位 (ページ) に分割する
    - 物理メモリも同じサイズのページフレームに分割する
2. プログラムの未使用ページはスワップ領域に置かれ、必要時に物理メモリへロードされる
    - プログラムの一部のページは物理メモリページフレーム内に常時存在する(常駐メモリ)
3. プロセスが物理メモリ上に存在しないページを参照すると、ページフォールトが発生する
   ページがディスクからメモリへロードされるまで、カーネルがプロセスの実行を一時停止する

## ページテーブル
- プロセス仮想アドレス空間内の、プロセスが使用可能な仮想メモリの全ページ位置を管理するためのテーブル
- カーネルはプロセス毎にページテーブルを管理する
  - カーネルはページ・ページテーブルエントリを割り当て・解放するため
    プロセスが使用可能な仮想アドレスは常に変化する
    - スタックが成長し下限を超えた場合
    - `malloc()`によりブレークが移動した場合
    - `shmat()`により共有メモリがアタッチ・デタッチされた場合
    - `mmap()`によりファイルがマッピング・`unmmap`によりアンマッピングされた場合

#### ページテーブルエントリ
- 各エントリはプロセス仮想アドレス空間のアドレス位置と物理メモリのアドレス位置を紐づける
- 各エントリはページ保護属性(= メモリ保護方式)を管理する(読み書き実行)
  - 複数のプロセスがメモリを共有する場合、プロセス毎に独立したページ保護属性を設定可能
- 対応するエントリが存在しないアドレスへプロセスがアクセスすると`SIGSEGV`シグナルが発生する

## 参照
- Linuxプログラミングインターフェース 6章
