# 動作の排他(動作同期)
## TL;DR
- 動作の排他(動作同期)
  - `pthread_mutex_init(3)`           - ミューテックスの初期化
  - `pthread_mutex_destroy(3)`        - ミューテックスの破棄
  - `pthread_mutex_lock(3)`           - ミューテックスのロック
  - `pthread_mutex_trylock(3)`        - ミューテックスのロック
  - `pthread_mutex_unlock(3)`         - ミューテックスのロック解除
  - `pthread_mutex_cond_wait(3)`      - 条件変数が有効になるのを待つ
  - `pthread_mutex_cond_timedwait(3)` - 条件変数が有効になるのを待つ
- イベント通知(条件待ち同期)
  - `pthread_cond_wait(3)`    - 条件変数の初期化
  - `pthread_cond_destroy(3)` - 条件変数の破棄
  - `pthread_cond_signal(3)`  - 条件変数の有効化

## 排他制御
- Mutual Execution(排他実行) - スレッド同士が同じリソースに対して同時に操作を行うことを防止する
  - スレッドが処理の実行に入る前にミューテックスをONにする
  - スレッドが処理の実行を終えた後にミューテックスをOFFにする
  - `pthread_mutex_t`型        - ミューテックス
  - `pthread_mutex_init(3)`    - ミューテックスの初期化
  - `pthread_mutex_lock(3)`    - アンロック時 -> ロックして0を返す / ロック時 -> アンロックするまで待つ
  - `pthread_mutex_trylock(3)` - アンロック時 -> ロックして0を返す / ロック時 -> 0以外を返す
  - `pthread_mutex_unlock(3)`  - ロック時 -> アンロックする
  - `pthread_mutex_destroy(3)` - 排他制御完了時にミューテックスを破棄

### デッドロック
- ミューテックスがアンロックされるのを待っているが、アンロックできるスレッドが存在しない状態

#### アンロック処理漏れ
- 【原因】アンロック処理の書き忘れ
- 【対策】ロックするコードとアンロックするコードを同じ関数の中に書く

#### 自己ロック
- 【原因】すでにロックしているミューテックスを再度ロック
- 【対策】ロック中に行う処理を関数に切り出し、ロック -> 内部関数 -> アンロックの順で呼び出す

#### 相互ロック
- 【原因】複数のスレッドが複数のミューテックスを持ち、スレッド同士でお互いのミューテックスをロック
- 【対策】
  - 複数のミューテックスを同時にロックしない(処理性能が落ちる)
  - 複数のミューテックスをロックする場合は順番を決める
  - 無駄なロックをかけない

### 読み書きロック機構(rw lock)
- データ読み取り時と書き込み時にそれぞれ排他制御の仕組みを用意する
  - `pthread_rwlock_t`型 - rw lock型
  - `pthread_rwlock_init(3)`
  - `pthread_rwlock_destroy(3)`
  - `pthread_rwlock_rdlock(3)`
  - `pthread_rwlock_tryrdlock(3)`
  - `pthread_rwlock_wrlock(3)`
  - `pthread_rwlock_trywrlock(3)`
  - `pthread_rwlock_unlock(3)`
- 読み出しロック
  - ロックなし状態     -> 読み出しロック状態にする
  - 読み出しロック状態 -> 読み出しロック状態のまま
  - 書き込みロック状態 -> 書き込みロックが解除されるまで待つ
- 書き込みロック
  - ロックなし状態     -> 書き込みロック状態にする
  - 読み出しロック状態 -> 読み出しロックが解除されるまで待つ
  - 書き込みロック状態 -> 書き込みロックが解除されるまで待つ

## 条件待ち
- 条件変数を使用し、通知元から通知先へ条件が満たされたことを通知する
  - `pthread_cond_t`型          - 条件変数の型
  - `pthread_cond_init(3)`      - 条件変数の初期化
  - `pthread_cond_destroy(3)`   - 条件変数の消去
  - `pthread_cond_wait(3)`      - 条件変数を通知待ち状態にする
  - `pthread_cond_timedwait(3)` - 条件変数を通知待ち状態にし、指定の時刻に通知待ち状態を解除する
  - `pthread_cond_signal(3)`    - 条件変数に通知を行う
  - `pthread_cond_broadcast(3)` - その時点で条件待ちになっている全てのスレッドを起こす
    - スレッドは同時に動作しない
    - 条件待ちするスレッドは条件変数一つにつき一つだけにする(複数のスレッドで条件待ちさせない)

### 条件変数
- 通知待ち状態を保存する
- `pthread_cond_wait(3)`で通知待ちを開始し、
  他のスレッドが`pthread_cond_wait(3)`で通知を受信するのを待ち続ける
- 対になるミューテックスと一緒に使用する

### ライフサイクル
1. ミューテックスを初期化
2. 条件変数を初期化
3. ミューテックスをロック
4. 条件変数を通知待ちにする
     - ミューテックスをアンロック
5. 条件件数が通知を受信
     - ミューテックスをロック
6. ミューテックスをアンロック
7. ミューテックスの破棄
8. 条件変数の破棄
