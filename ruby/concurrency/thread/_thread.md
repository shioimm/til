# class Thread
- [class Thread](https://docs.ruby-lang.org/ja/2.7.0/class/Thread.html)
- 同じプロセス上でメモリ空間を共有して同時に実行される制御の流れ
  - 複数のスレッドが同じ変数にアクセスする
- ネイティブスレッドによって実装されている
  - プリエンプティブな処理
  - スレッドスケジューラリングはカーネルが行う
- GVLにより同時に実行されるスレッドは一つに限定される
  - VMを獲得したスレッドがIO待ちの状態になるとGVLが解放され、
    他のスレッドがVMにアクセスできるようになる

### スレッドの状態
| `run`      | 実行可能 / 実行中 |
| `sleep`    | 停止中            |
| `aborting` | 終了処理中        |
| `false`    | 正常終了した      |
| `nil`      | 異常終了した      |

- 生きているスレッドは`run` - `sleep`の状態を行ったり来たりする
- `run`状態のスレッドはスレッドスケジューリングにより定期的に実行される
- `sleep`時のスレッドの状態は
  - `Kernel.#sleep`
  - `Thread.stop`
  - 他のスレッドの終了待ち
  - IO待ち

## メインスレッドと派生スレッドの関係
- メインスレッドが終了すると、派生スレッドは終了する
  - スレッドの待ち合わせを行う場合は`#join`する
- 派生スレッドが終了してもメインスレッドには影響がない

## 各スレッド固有のデータ
```
# setter
Theadオブジェクト[:名前] = 固有のデータ

# getter
Theadオブジェクト[:名前] # => 固有のデータ
```

## スレッドの生成(-> `run`)
- `.start` / `.fork` - スレッドを生成し、生成したスレッドでブロック内の処理を行う
- `.new` - スレッドを生成し、生成したスレッドでブロック内の処理を行う(`initialize`を呼ぶ)

## スレッドの終了(-> `dead`)
- `#exit` / `#kill` - スレッドの実行を終了させ、終了時に`ensure`節を実行する
  - `.exit` - カレントスレッドに対して`#exit`を呼ぶ
  - `.kill` - 指定したスレッドに対して`#kill`を呼ぶ
    - 対象のスレッドがカレントスレッドではない可能性がある

## スレッドの待機(-> `sleep`)
- `#join` - `self`の実行が終了するまでカレントスレッドを停止して待つ
- `#value` - `self`の実行が終了するまでカレントスレッドを停止して待ち、`self`のブロックの返り値を返す

## スレッドの停止(-> `sleep`)
- `.stop` - カレントスレッドを`sleep`状態にする

## スレッドの起動(-> `run`)
- `#wakeup` - 指定のスレッドを`sleep`状態から`run`状態にする
- `#run` - 指定のスレッドを`sleep`状態から`run`状態にする・すぐにスレッドの切り替えを行う
  - `#run` = `#wakeup` + `.pass`(他のスレッドに実行権を譲る)

## 例外の捕捉
- `#abort_on_exception = true` - 指定のスレッドに例外が発生した際、プログラムを中断させる
  - `.abort_on_exception = true` - いずれかのスレッドに例外が発生した際、プログラムを中断させる
- `#raise` - 指定のスレッドに対して例外を発生させる

## スレッドの状態を確認
- `#status` - `self`の状態を返す

# class ThreadGroup
- [class ThreadGroup](https://docs.ruby-lang.org/ja/latest/class/ThreadGroup.html) - スレッドグループ

## TL;DR
- Threadオブジェクトは必ずいずれかひとつのThreadGroupオブジェクトに属する
  - 生成されたばかりのThreadオブジェクトは、生成したThreadオブジェクトのThreadGroupを引き継ぐ
  - デフォルトでは`ThreadGroup::Default`に属する(メインスレッド含む)

## スレッドグループへの追加
- `#add` - 指定のスレッドが属するスレッドグループを`self`に変更する
  - `add`されたスレッドは元のスレッドグループからは除かれる

## スレッドグループ内のスレッド一覧
- `#list` - `self`に属するスレッドの配列を返す
