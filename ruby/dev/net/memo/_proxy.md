# フォワードプロキシについてのメモ

```
クライアント <-> プロキシ <-> オリジン
```

### Explicit Proxy
- クライアントが明示的に指定したプロキシサーバを介してオリジンとの通信を行う

#### HTTPでの通信
1) クライアント - プロキシ間でTCP接続を確立
2) クライアント -> プロキシへHTTPリクエスト

```
# リクエスト先にURLを指定する
GET http://example.com/index.html HTTP/1.1
Host: example.com
```

3) プロキシ - オリジン間でTCP接続を確立
4) プロキシ -> オリジンへリクエスト転送

```
GET /index.html HTTP/1.1
Host: example.com
```

5) オリジン -> プロキシへレスポンス
6) プロキシ -> クライアントへレスポンス

#### HTTPSでの通信

1) クライアント - プロキシ間でTCP接続を確立
2) クライアント -> プロキシへCONNECTリクエスト

```
# CONNECTメソッドを使用する
CONNECT example.com:443 HTTP/1.1
Host: example.com:443
```

3) プロキシ - オリジン間でTCP接続を確立
4) プロキシ -> クライアントへ200 (CONNECTの成功) を返す
5) クライアント - (プロキシを経由して) - オリジン間でTLS接続を確立
6) クライアント -> (プロキシを経由して) -> オリジンへHTTPリクエスト
7) オリジン -> (プロキシを経由して) -> クライアントへレスポンス

### Transparent Proxy
- クライアントからインターネットへの通信経路上に設置されたプロキシサーバを介してオリジンとの通信を行う

1) クライアントはDNSを利用してオリジンのIPアドレスを取得し、TCP接続試行を開始
2) 経路上のルータなどが検知してプロキシサーバへ転送
3) プロキシ -> クライアントへSYN/ACKを返してクライアント - プロキシ間でTCP接続が確立
4) クライアント -> 接続先 (プロキシ) へHTTPリクエストを送信
5) プロキシ - オリジン間でTCP接続を確立
6) プロキシ -> オリジンへリクエスト転送
7) オリジン -> プロキシへレスポンス
8) プロキシ -> クライアントへレスポンス
