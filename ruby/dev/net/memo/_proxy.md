# フォワードプロキシについてのメモ

```
クライアント <-> プロキシ <-> オリジン
```

### Explicit Proxy
- クライアントが明示的に指定したプロキシサーバを介してオリジンとの通信を行う

#### CONNECTメソッドなしの場合
プロキシがHTTPレベルで通信を解釈・制御したい場合やHTTP平文を通信する場合

- 1) クライアント - プロキシ間でTCP接続を確立
- 2) クライアント -> プロキシへHTTPリクエスト

```
# リクエスト先にURLを指定する
GET http://example.com/index.html HTTP/1.1
Host: example.com
```

- 3) プロキシ - オリジン間でTCP接続を確立
- 4) プロキシ -> オリジンへリクエスト転送

```
GET /index.html HTTP/1.1
Host: example.com
```

- 5) オリジン -> プロキシへレスポンス
- 6) プロキシ -> クライアントへレスポンス

#### CONNECTメソッドありの場合
プロキシにはアプリケーションデータを解釈させず、TCPバイトストリームとして扱わせる場合
(クライアント - オリジン間ではこのTCPバイトストリームをアプリケーションデータとして扱う)

- 1) クライアント - プロキシ間でTCP接続を確立
- 2) クライアント -> プロキシへCONNECTリクエストを送信

```
# CONNECTメソッドを使用する
CONNECT example.com:443 HTTP/1.1
Host: example.com:443
```

- 3) プロキシ - オリジン間でTCP接続を確立
- 4) プロキシ -> クライアントへ200 (CONNECTの成功) を返す (HTTPトンネルが確立)
- 6) クライアント -> (プロキシを経由して) -> オリジンへリクエストを送信
  - HTTPSの場合はこのタイミングでTLSのハンドシェイクを開始する
- 7) オリジン -> (プロキシを経由して) -> クライアントへレスポンスを送信

### Transparent Proxy
クライアントからインターネットへの通信経路上に設置されたプロキシサーバを介してオリジンとの通信を行う

#### Interception Proxy (NAT方式)

経路上のルータからプロキシサーバへ通信を転送する

1. クライアントがDNSを利用してオリジンのIPアドレスを取得
2. クライアントからオリジンへTCP SYNを送信
3. 経路上のルータがパケットを検知し、宛先を書き換えてプロキシへ転送 (NAT)
4. プロキシがクライアントのTCP SYNを受信し、SYN/ACKを返してクライアント-プロキシ間のTCP接続が確立
5. プロキシからオリジンへTCP SYNを送信
6. オリジンがプロキシのTCP SYNを受信し、SYN/ACKを返してプロキシ-オリジン間のTCP接続が確立
7. クライアントからオリジン (プロキシ) へリクエストを送信
8. プロキシがリクエストを読み取ってオリジンへ転送
9. オリジンからプロキシへレスポンスを送信
10. プロキシからクライアントへレスポンスを送信

#### Proxy-terminated

経路上のルータがプロキシサーバとして機能する。プロキシサーバが通信の内容を解釈する。

1. クライアントがDNS を利用してオリジンのIPアドレスを取得
2. クライアントがオリジンへTCP SYNを送信
3. 経路上のルータがTCP SYNを受信
4. プロキシがクライアントへSYN/ACK を返し、クライアント–プロキシ間のTCP接続が確立
5. クライアントからオリジン (プロキシ) へリクエストを送信
6. プロキシからオリジンへTCP SYNを送信
7. オリジンがプロキシのTCP SYNを受信し、SYN/ACKを返してプロキシ-オリジン間のTCP接続が確立
8. プロキシからオリジンへリクエストを転送
9. プロキシはHTTPリクエストを受信し、L7レベルで内容を解釈する
10. オリジンからプロキシへレスポンスを送信
11. プロキシからクライアントへレスポンスを送信
