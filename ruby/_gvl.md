# GVLに関するメモ
- 参照: [スレッド](https://docs.ruby-lang.org/ja/latest/doc/spec=2fthread.html)
- 参照: [Rubyのスケール時にGVLの特性を効果的に活用する（翻訳）](https://techracho.bpsinc.jp/hachi8833/2020_05_27/92042)
- Global VM Lock
- Rubyでは各プロセスが独自のGVLを持つ
- RubyではIO待ちの可能性があるシステムコールを行う場合には明示的にGVLを解放する

### 前提
- 仮想マシン
  - ソフトウェア上で実装された「CPUの中にあるCPU」
  - Ruby1.9より前
    - プログラムを実行時、コードを実際に一行ずつ解釈しながら実行を進める
  - Ruby1.9以降
    - コードを一回だけ解釈し、一連の仮想マシンインストラクションに変換する
    - その後インストラクションがRuby VMに送り込まれてCPUインストラクションに変換され、実行される

## 役割
- Ruby VMはスレッドセーフではなく、複数のスレッドによって同時にアクセスされうる
- 複数のスレッドがRuby VMに同時にアクセスすることを避けるため、
  VMにグローバルロックをかけることによって
  一度に一つのスレッドのみがパラレルにRuby VMにアクセスできるようにする

## 利点
- シングルスレッドのパフォーマンスが向上する
- 拡張を統合しやすい
- ロックをかけないVMの方が作りやすい

## パフォーマンス
- メモリが足りなくなった場合はスレッドを追加してGVLを飽和させる
  - 少ないメモリ使用量でCPUをより効率よく動かせるようになる
  - Sidekiqなどマルチスレッドのバックグランドジョブプロセッサに切り替える
  - PumaなどマルチスレッドWebサーバーに切り替える
