# GC (ガベージコレクション)
## マークアンドスイープGC
- マークフェーズ + スイープフェーズ
  - マークフェーズ - 生きているオブジェクトをすべてマークする
  - スイープフェーズ - マークされていないオブジェクトを回収し解放する

#### 対象とならないオブジェクト
- GCのルートとなるオブジェクト
  - グローバル変数から参照されているオブジェクト
  - スタック上にあるオブジェクト
  - 他のオブジェクトのインスタンス変数などから指されているオブジェクト
  - 他のオブジェクトからリンクを辿って到達できるオブジェクト

#### 対象となるオブジェクト
- GCのルートとなるオブジェクト以外のオブジェクト
  - 誰からも参照されていないオブジェクト
  - 生きているオブジェクトを参照しているが、自身は参照されていないオブジェクト
  - 循環参照しているがルートセットからたどれないオブジェクト

#### Lazy Sweep
1. オブジェクトを生成する際、フリーリスト (空きスロットの列) から空きスロットを探す
2. 空きスロットの確認
   - (a) フリーリストに空きスロットがある場合、それを利用する
   - (b) フリーリストに空きスロットがない場合、まだスイープしていないページを探す
3. ページの確認
   - (a) スイープしていないページがある場合、Lazy Sweepを実行する
   - (b) スイープしていないページがない場合、GCのマークフェーズを実行し1へ戻る
4. 空きスロットの確認
   - (a) Lazy Sweepしたページに空きスロットがある場合、フリーリストにそれを加え1へ戻る
   - (b) Lazy Sweepしたページに空きスロットがない場合、3へ戻る

## 世代別GC
- オブジェクトの寿命からオブジェクトを若い世代、古い世代の2世代に分け、
  優先的に若い世代のみを対象にGCを行い (マイナーGC)、
  メモリが足りなくなった場合古い世代にもGCを行う (メジャーGC)
- マイナーGCを (何回か) 生き残ったオブジェクトは古い世代のオブジェクトへ昇格する
- 古いオブジェクトから若いオブジェクトへの参照をチェックし (ライトバリア) 、
  その情報を保存しておく (リメンバーセット)

## インクリメンタルGC
- オブジェクトを黒/白/灰に色分けする
  - 白: マークされていないオブジェクト
  - 灰: マークされたオブジェクト
    - このオブジェクトから直接たどれるオブジェクトの中に、まだマーク済みではないものがある
  - 黒: マークされたオブジェクト
    - このオブジェクトから直接たどれるオブジェクトはすべてマーク済み
- 灰色オブジェクトがある間インクリメンタルにマーキングを繰り返し、白になったオブジェクトの解放を行う

## 参照
- [第5章 ガ－ベージコレクション](https://i.loveruby.net/ja/rhg/book/gc.html)
- Rubyのウラガワ ── Rubyインタプリタに学ぶデータ構造とアルゴリズム
  - RubyのGCの基礎 GCのデータ構造とアルゴリズム
  - RubyのスゴイGC 世代別GCとインクリメンタルGC
