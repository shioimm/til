# システムの性能のボトルネックを見極める
## 0. 負荷試験
1. ベンチマーカーを実行
2. ベンチマーカーによる負荷試験結果の確認
3. 負荷試験実行中にWebサービスの実行環境の負荷を観察
4. 改善を実施
5. 負荷試験を繰り返す

## 1. ロードアベレージ (実行待ちの平均タスク数) の確認
- ロードアベレージ - 実行待ちの平均タスク数
  - タイマ割り込み時点での (実行可能なタスク + I/O待ちのタスク数) / 単位時間
- top(1)、uptime(1)

#### ロードアベレージが低く、システムのスループットが低い場合:
- ソフトウェアの不具合
- ネットワークやリモートホスト側の問題

#### ロードアベレージが高く、システムのスループットが低い場合:
- CPU負荷が高い (計算処理)
- I/O負荷が高い (プログラムからの入出力、ディスク (含DB) に対する入出力)

## 2. 1. CPU負荷が高い場合の確認事項
### 原因となっているプログラムの確認
- top(1)、sar(1)
- ユーザープログラム
- システムプログラム

### 原因となっているプロセスの確認
- ps(1)

### 原因となっているプロセスの詳細の確認
- strace(1)、oprofile(1)
- システムのスループットに問題がある場合:
  - サーバー増設、プログラムのロジック・アルゴリズムの改善
- プログラムが暴走してCPUに負荷がかかっている場合:
  - プログラムの不具合を取り除く

## 2.2. I/O負荷が高い場合の確認事項
### スワップの発生状況の確認
- sar(1)、vmstat(1)
- プログラムからの入出力が多い場合:
  - キャッシュに必要なメモリが不足している
  - サーバーの持つデータ容量と増設可能なメモリ量を比較する
  - メモリ増設でキャッシュ領域を拡大させることができる場合:
    - メモリ増設
  - メモリ増設で対応しきれない場合:
    - データの分散、キャッシュサーバーの導入、プログラムの改善によるI/O頻度の軽減

#### スワップが発生している場合:
  - 特定のプロセスが極端にメモリを消費している -> ps(1)
  - プログラムの不具合でメモリを使い過ぎている -> プログラムを改善する
  - 搭載メモリが不足している -> メモリ増設
  - メモリ増設で対応できない -> データの分散、キャッシュサーバーの導入

## 参照
- ［Web開発者のための］大規模サービス技術入門 ― データ構造、メモリ、OS、DB、サーバ/インフラ Lesson 5
- 達人が教えるWebパフォーマンスチューニング〜ISUCONから学ぶ高速化の実践 3-4
