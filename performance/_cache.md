# キャッシュ
#### キャッシュを保存するミドルウェア (e.g. memcached, Redis, インメモリ, ファイル...)
- KVSであること
- TTLを設定でき、TTLが超過後はexpireしてデータが削除されること

#### キャッシュの導入基準
- ある程度の不整合が許されるデータ
- データの特性上においてキャッシュを有効活用できるデータ (全ユーザーに共通のデータなど)
- 更新頻度が低いデータ
- 生成コストが高いデータ

#### キャッシュを導入する際の注意点
- データの特性を考えて十分短いTTLを設定する
- データが更新された時にキャッシュも同時に更新するようにする

## キャッシュの監視ポイント
- evicted items
  - expireしていないがキャッシュから追い出されたアイテム数 (キャッシュ容量を超えた場合など)
- cache-hit ratio
  - キャッシュヒット率

#### Thundering herd problem
- キャッシュデータが蓄積されるまでの間、Originへのリクエストが大量に発生し、Originが高負荷になる現象
  - Originへの同一リクエストを束ねるような仕組みを実装する
  - キャッシュのexpire以前の残存時間が一定以下となった段階で、キャッシュエントリのアップデートを行う

## OSのキャッシュと分散
#### キャッシュを最大限活用する
- 物理メモリ > 扱うデータサイズである場合、全てキャッシュできる
- 経済的コストとのバランスを考える
  - ハードウェアのメモリ量を増設するか、ソフトウェアのメモリ量を削減するか

#### データがキャッシュに乗り切らない場合
- アクセスパターンを考慮し局所性を活用できるような形で複数サーバーに分散させる

#### パーティショニング
- 局所性を活用できるようなロジックによって1つのDBを複数のサーバに分割する
- テーブル単位での分割、データの途中での分割

## 参照
- ［Web開発者のための］大規模サービス技術入門 ― データ構造、メモリ、OS、DB、サーバ/インフラ
- 達人が教えるWebパフォーマンスチューニング 〜ISUCONから学ぶ高速化の実践
- [キャッシュシステムの Thundering Herd 問題](https://labs.cybozu.co.jp/blog/kazuho/archives/2007/09/cache_and_thundering_herd.php)
