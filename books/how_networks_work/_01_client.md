# ネットワークはなぜつながるのか まとめ01
- 戸根勤 著

## 全体像
1. ブラウザがリクエストメッセージを作成する
2. ブラウザがDNSサーバーに名前解決を依頼する
  - DNSサーバーは送信先のWebサーバーのIPアドレスを調べる
3. ブラウザがOSのプロトコルスタックにリクエストメッセージの送信を依頼する

### 1. ブラウザがリクエストメッセージを作成する
- ブラウザはユーザーが指定したURLから
ユーザーが「何を」「どう」したいのかを表すリクエストメッセージを作成する
  - 「何を」 -> URL
  - 「どう」 -> HTTPメソッド
```
リクエストメッセージの構造

- リクエストライン
- メッセージヘッダ
- メッセージボディ(メソッドによっては省略される)
```

### 2. ブラウザがDNSサーバーに名前解決を依頼する
- リクエストメッセージはIPアドレス宛に送信されるため、
ブラウザは送信先のIPアドレスを取得する必要がある
- 送信先の確認のため、DNSにドメイン名とIPアドレスの名前解決を依頼する
```
ブラウザがIPアドレスを取得する手順

1. ブラウザがSocketライブラリの`gethostbyname`(DNSリゾルバ)を呼び出す
  - DNSリゾルバ -> DNSサーバーに対するクライアント(Socketの機能に含まれる)
    - Socket -> OS組み込みのネットワーク機能をアプリケーションから呼び出すライブラリ
2. リゾルバがDNSサーバーに対して名前解決を依頼するメッセージを作成する
  - メッセージはドメイン名、クラス(インターネット)、タイプを含む
3. リゾルバがOSのプロトコルスタック(ネットワーク制御用ソフト)を呼び出し、メッセージ送信操作を依頼する
4. DNSサーバーがIPアドレスを格納した応答メッセージを返す
5. リゾルバが応答メッセージからIPアドレスを取り出し、ブラウザの指定するローカルのメモリ領域に保存する
6. ブラウザがメモリ領域からIPアドレスを取り出し、リクエストメッセージと共にOSに渡して送信を依頼する
```

#### TCP/IPの基礎
- ネットワークはサブネットをルーターで接続した集合
- サブネットは何台かのPCをハブで接続した集合
- IPアドレスは各コンピュータの住所
  - IPアドレス = ネットワーク番号(「x丁目」) + ホスト番号(「y番地」)
  - 32bitのデジタルデータを8bitずつ区切って10進数で表記する
    - ネットワーク番号とホスト番号の区切り(内訳)を表す情報 -> ネットマスク(IPアドレスの末尾に付加)
  - ホスト番号が全て0 -> サブネット全体を指す
  - ホスト番号が全て1 -> ブロードキャストを指す

### 3. ブラウザがOSのプロトコルスタックにリクエストメッセージの送信を依頼する
- ブラウザはリクエストメッセージの送信依頼のため、Socketライブラリを使用する

#### データ送受信操作の流れ
1. ソケットを作る
2. サーバー側のソケットにパイプをつなぐ
3. データを送受信する
4. パイプを外してソケットを抹消する

```
ブラウザがリクエストメッセージの送信を依頼する手順

1. ブラウザがSocketライブラリの`socket`を呼び出す
2. `socket`がソケットを作る
3. `socket`がブラウザにディスクリプタを返し、ブラウザはディスクリプタをメモリに保存する
  - ディスクリプタ -> 個々のソケットを一意に識別するフラグ
4. ブラウザがSocketライブラリの`connect`を呼び出し、ディスクリプタと送信先のIPアドレス / ポート番号を渡す
5. `connect`がプロトコルスタックを呼び出し、接続操作を依頼する
6. プロトコルスタックが接続操作を行い、送信先の情報をソケットに記録する
7. ブラウザがSocketライブラリの`write`を呼び出し、ディスクリプタとリクエストメッセージを渡す
8. `write`がプロトコルスタックを呼び出し、送信操作を依頼する
  - プロトコルスタックが送信先のWebサーバーにメッセージを送信する
9. ブラウザがSocketライブラリの`read`を呼び出す
9. `read`がプロトコルスタックを呼び出し、受信動作を依頼する
  - プロトコルスタックが送信先のWebサーバーからメッセージを受信する
10. `read`がレスポンスメッセージをブラウザ内部のメモリ領域(受信バッファ)に格納する

---
- サーバーはレスポンスメッセージ送信後、Socketライブラリの`close`を呼び出し切断動作を行う
- その後ブラウザが`read`で受信動作を依頼した際、`raad`は受信メッセージの代わりに切断状態をブラウザへ通知する
- ブラウザも以下の切断フェーズに入る
---

11. ブラウザがSocketライブラリの`close`を呼び出す
12. `close`がプロトコルスタックを呼び出し、切断動作を依頼する
  - プロトコルスタックが送信先のWebサーバーからメッセージを受信する
13. 
```

#### ソケットの作成
WIP
