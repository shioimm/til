# ネットワークはなぜつながるのか まとめ02
- 戸根勤 著

## 全体像
1. サーバーがソケットを作成し、接続待ち状態にする
2. プロトコルスタックがリクエストメッセージを受信する
3. サーバーはリクエストメッセージを解釈してレスポンスメッセージを作成し、クライアントに送り返す

### サーバーの動作
- サーバーの構成
  - a. クライアントからの接続を待つ部分 -> ソケットを作る
  - b. クライアントとやりとりする部分から成る -> 作成済みのソケットを利用してクライアントとのやりとりを行う
    - サーバーはクライアントが接続してくる都度、bを起動することでクライアントとの一対一関係を作る(マルチタスク)

### データ送受信操作の流れ
1. ソケットを作る -> ソケットを接続待ち状態にする -> 接続を受け付ける
2. データを送受信する
3. パイプを外してソケットを抹消する

### 1. サーバーがソケットを作成し、接続待ち状態にする
```
ソケット作成の手順

1. サーバーがSocketライブラリの`socket`を呼び出す
2. プロトコルスタックがソケットを作成する
3. サーバーがSocketライブラリの`bind`を呼び出す
4. プロトコルスタックがソケットにポート番号を記録する
5. サーバーがSocketライブラリの`listen`を呼び出す
6. プロトコルスタックがソケットに接続待ち状態を記録する
7. サーバーがSocketライブラリの`accept`を呼び出す
8. プロトコルスタックが接続受付状態になる
```

### 2. プロトコルスタックがリクエストメッセージを受信する
```
リクエストメッセージ受信の手順

1. プロトコルスタック(IP部分)にパケットが渡される
  - プロトコルスタック(IP部分)がIPヘッダ、IPアドレスをチェックする
  - パケットが分割されている場合はメモリにパケットを溜め、復元する
2. プロトコルスタック(TCP部分)が接続パケットを受信する
  - 接続動作のパケットの場合 -> 接続を受け付ける動作を実行
  - データパケットの場合 -> 送受信動作をチェックし、readが呼ばれるまでデータを受信バッファに保管する / IP担当部分を通してクライアントにACK番号を送り返す
3. サーバーがSocketライブラリの`close`を呼び出す
4. プロトコルスタック(TCP部分)がコントロールビットFIN=1にしたTCPヘッダを作成し、IP担当部分を通してクライアントに送り返す
```
```

### 3. サーバーはリクエストメッセージを解釈してレスポンスメッセージを作成し、クライアントに送り返す
```
レスポンスメッセージの作成手順

1. サーバーがSocketライブラリの`read`を呼び出す
2. プロトコルスタックがサーバーにリクエストメッセージを渡す
3. サーバーがリクエストメッセージを解釈する
  - アプリケーションがリクエストメッセージに対して処理を行う
4. サーバーがSocketライブラリの`write`を呼び出す
  - 引数にディスクリプタ(ソケットを特定する) / レスポンスメッセージを渡す
5. プロトコルスタックがレスポンスメッセージをパケットの最大長に分割し、ヘッダをつけて送り返す
```
