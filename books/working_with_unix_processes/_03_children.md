# なるほどUNIXプロセス まとめ03
- Jesse Storimer 著
- 島田浩二・角谷信太郎 翻訳

## Chapter11
- fork -> 実行中のプロセス(親)から新しいプロセス(子)を生成する
  - 子プロセスは親プロセスで使われているメモリのコピーを持つ
    - コピーしたメモリは親の持つメモリとは独立して自由に変更できる
  - 子プロセスは親プロセスとファイルディスクリプタ番号を共有する
  - 子プロセスは固有のpidを持つ
- forkは1回の呼び出しで、親プロセスと子プロセスにそれぞれ戻り値を返す
  - 親プロセスには子プロセスのpidを返す
  - 子プロセスにはnilを返す
- forkを繰り返すとメモリの消費量が線形に増える(Fork爆弾)
```
プロセスを複製する

Kernel.#fork <-> fork(2)

fork do
  # 子プロセスでのみ実行したい処理を記述する
end
# ブロック内の処理が終了すると子プロセスも終了する

# 親プロセスでのみ実行したい処理を記述する
```

## Chapter12
- 親プロセスが子プロセスより先に終了する場合、親プロセスは子プロセスを道連れにしない
- 子プロセスの処理はそのまま続行される
- 子プロセスは端末からの制御を受け付けない場合がある
  - デーモンプロセス -> 意図的にプロセスを孤児化することで処理を続行させる
  - 端末セッションを持たないプロセスとの通信方法 -> Unixシグナルを使用

## Chapter13
- コポーオンライト(CoW) -> 書き込みが必要になるまで親プロセスから子プロセスへのメモリコピーを行わない仕組み
  - forkするとメモリは親から子へとコピーされるが、親子間でメモリへの変更が必要になるまで処理を遅延させる
  - 子プロセス側で必要となるデータのみコピーし、残りのデータは親子間で共有する

## Chapter14
- 子プロセス側で非同期に処理を行いたい場合は親プロセスが先に終了しても問題ない
- それ以外のケースでは子プロセスを定期的に管理できる仕組みが必要

```
Process.#wait -> 子プロセスのうちどれかひとつが終了するまで、親プロセスの実行をブロックする
返り値は終了した子プロセスのpid
```
```
Process.#wait2 -> 子プロセスのうちどれかひとつが終了するまで、親プロセスの実行をブロックする
返り値は終了した子プロセスのpidと終了ステータスの配列
終了ステータスはProcess::Statusクラスのインスタンス
```
```
Process.#waitpid -> pidで指定した子プロセスが終了するまで親プロセスの実行を待つ
返り値は終了した子プロセスのpid
```
```
Process.#waitpid2 -> pidで指定した子プロセスが終了するまで親プロセスの実行を待つ
返り値は終了した子プロセスのpidと終了ステータスの配列
```

- カーネルは終了したプロセスの情報をキューに入れておく
  - 親プロセスは子プロセスが終了した順に、順次終了した子プロセスの情報を処理することができる
- 終了を待つ子プロセスがない状態でwaitするとErrno::ECHILD例外が送出される
- prefork -> 子守プロセス、マスター/ワーカー
  - 用意した一つのプロセスから、並行処理のために複数の子プロセスを生成して、その後子プロセスの子守をする
  - Unicorn -> サーバー起動時にワーカープロセスをいくつ使うか指定し、親プロセスが死活監視する

```
子プロセスが終了するまで親プロセスの終了をブロックする

Process.#wait族 <-> waitpid(2)
```

## Chapter15
- カーネルは終了した子プロセスの情報を(親プロセスがwaitを実行するまで)持ち続ける
  - 親プロセスが子プロセスの終了を待たない場合(waitを使わない場合)、子プロセスをデタッチする必要がある
```
Process.#detach -> pidで指定された子プロセスの終了を待ち受けるスレッドを生成する
```
- 親プロセスに待たれずに終了した子プロセスは例外なくゾンビ化する
