# 安全なWebアプリケーションの作り方(脆弱性が生まれる原理と対策の実践) まとめ
- 徳丸浩 著

## 10 ファイルアクセスにまつわる問題
- サーバー上のファイル名を外部からパラメータの形で指定できる場合(テンプレートをパラメータで指定しているようなケース)
  - ディレクトリトラバーサル
  - OSコマンドインジェクション
  - 意図しないファイル公開

### ディレクトリトラバーサル
- 発生箇所: ファイル名を外部から指定できるページ
- 影響範囲: すべてのページ
- 影響の種類:
  - 重要情報の漏洩
  - ファイルの改ざん
  - コンテンツの改ざん
  - サーバー機能停止
  - サーバースクリプト実行
- 影響度合い: 大
- 利用者関与の範囲: 不要
- 対策:
  - 外部からファイル名を指定できる仕様を避ける
  - ファイル名にディレクトリ名が含まれないようにする
  - ファイル名を英数字に限定する

#### 事例
- パラメータで'../'と'[NUL]'を組み合わせたファイルパスを指定されることによって
  サーバー直下のファイルが呼ばれてしまう

#### 原因
- ファイル名を外部から指定できる
- ファイル名として絶対パスや相対パスの形で異なるディレクトリを指定できる
- 組み立てたファイル名に対してアクセスの可否をチェックしていない

#### 対策
- 外部からファイル名を指定できる仕様を避ける
  - ファイル名を固定にする
  - ファイル名をセッション変数に保持する
  - ファイル名を番号などで間接的に指定する
- ファイル名にディレクトリを表す記号文字が含まれないようにする
  - '/' '\' ';'など
- ファイル名を英数字に限定する
  - ファイル名を英数字に限定すると、ディレクトリトラバーサル攻撃に用いられる記号文字が使えなくなる

###  意図しないファイル公開
- 発生箇所: Webサイト全般
- 影響範囲: 公開されたファイル
- 影響の種類: 重要情報の漏洩
- 影響度合い: ファイルの重要性次第
- 利用者関与の範囲: 不要
- 対策: 非公開ファイルを公開ディレクトリに置かない

#### 事例
- ディレクトリリスティング(URLでディレクトリをしていした際にファイル一覧を表示する)によって
  非公開にするべきファイルが公開されてしまう

#### 原因
- ファイルが公開ディレクトリに置かれている
- ファイルに対するURLを知る手段がある
  - ディレクトリリスティングが有効
  - ファイル名が類推可能
  - エラーメッセージ等他の脆弱性によりファイル名が漏洩
  - 外部サイトからリンクされる
- ファイルに対するアクセスの可否をチェックしていない

#### 対策
- アプリケーション設計時にファイルの安全な格納場所を決める
- (レンタルサーバー利用時)非公開ディレクトリが利用できることを確認する
- ディレクトリリスティングを無効化する
