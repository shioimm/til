# 安全なWebアプリケーションの作り方(脆弱性が生まれる原理と対策の実践) まとめ
- 徳丸浩 著

## 05 「重大な処理」の際に混入する脆弱性
- 重大な処理
  - 利用者のアカウントによる物品購入
  - 利用者のアカウントの退会処理
  - 利用者のアカウントによるSNSなどへの書き込み
  - 利用者のアカウントのメールアドレスやパスワードの変更

### CSRF
- 発生箇所: クッキーのみでセッション管理が行われているサイト・HTTP認証、TLSクライアント証明書のみで利用者の識別が行われているサイト
- 影響範囲: CSRF脆弱性のあるページ
- 影響の種類: 被害者の権限で重要な処理を実行させられる
- 影響度合い: 中〜大
- 利用者関与の範囲: 必要 -> リンクのクリック、罠サイトの閲覧
- 対策: 重要な処理の前に正規利用者であることを確認する

### 事例
- 重要な処理を行う条件を満たしたリクエストを送信させる
  - 被害者がサイトにログイン
  - 攻撃者がインターネット上に罠を用意
  - 被害者が罠を閲覧
  - 攻撃対象サーバーにPOSTリクエストが送信される
  - 重要な処理が実行される
- フォーム入力画面
  - 確認画面
- ファイルアップロードフォーム画面

### XSSとの比較
- 被害者に攻撃用リクエストを送信させ、攻撃対象サイトで不正操作を行う攻撃がCSRF
- 被害者に攻撃用リクエストを送信させ、攻撃対象サイトから仕掛けを含むレスポンスを受け取り、HTMLの改変やスクリプトを実行させるのがXSS

### 原因
- HTMLの仕様を悪用した攻撃
  - form要素のaction属性にはどのドメインのURLでも指定できる
  - クッキーに保管されたセッションIDは対象サイトに自動的に送信される

### 対策
- CSRF対策の必要なページを区別する
  - 決済
  - 個人情報の変更
- 正規利用者の意図したリクエストを確認できるよう実装する
  - 秘密情報(トークン)の埋め込み
    - 暗号論的擬似乱数生成器をhidden_fieldとしてフォームへ埋め込む
    - 実行時にトークンの確認を行う
  - パスワード再入力
    - 最終的な実行ページにてパスワード再入力を要求する
  - Refererヘッダのチェック
    - Refererを抑止している利用者は実行できなくなる
    - 利用者の環境を限定でき、既存のアプリケーショの脆弱性対策の場合のみ利用する

### クリックジャッキング
- 発生箇所: ポインティングデバイスの操作のみで重要な処理を実行でき、かつ認証を要するページ
- 影響範囲: クリックジャッキング脆弱性のあるページ
- 影響の種類: 被害者の権限で重要な処理を実行させられる
- 影響度合い: 中〜大
- 利用者関与の範囲: 必要 -> 攻撃者の罠サイトを閲覧した上で罠ページ上のクリック
- 対策: 重要な処理の実行ボタンなどがあるページでX-Frame-Optionsヘッダを出力

#### 事例
- ウェブインテント機能を利用した攻撃対象入力フォームの上に罠画像を重ね、攻撃対象フォームを送信させる

#### 原因
- HTMLの仕様を悪用した攻撃

#### 対策
- アプリケーション側での対策が困難なため、ブラウザ側の支援が必要となる
- X-Frame-Optionsレスポンスヘッダ
  - 参照: [X-Frame-Options](https://developer.mozilla.org/ja/docs/Web/HTTP/X-Frame-Options)
  - ブラウザが対象のページをframe / iframe / embed / object の中に表示することを許可するかどうかを示す
    - deny(拒否) / sameorigin(同一生成元に限り許可)
    - Webサーバー側で設定することも可能
