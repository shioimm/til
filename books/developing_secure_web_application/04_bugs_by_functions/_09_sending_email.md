# 安全なWebアプリケーションの作り方(脆弱性が生まれる原理と対策の実践) まとめ
- 徳丸浩 著

## 09 メール送信の問題
- メールヘッダインジェクション
  - ヘッダフィールドに改行を挿入し、任意のフィールドを追加したり本文を改ざんしたりする
- hiddenパラメータによる宛先保持
  - 概要: メールの送信先をhiddenパラメータで持つことができるメールフォームにおいて、
    hiddenパラメータの送信先を任意のアドレスに変更する
  - 対策: 送信先メールアドレスはサーバー上の安全な場所に保持する
- メールサーバーによる第三者中継
  - 概要: 第三者のメールを中継することができる設定になっているメールサーバーが、迷惑メールなどの送信に利用される

### メールヘッダインジェクション
- 発生箇所: メール送信機能のあるページ
- 影響範囲: メールを送られたユーザーが被害に遭う
- 影響の種類: 迷惑メールの送信、メールの改ざん、ウイルス添付メールの送信
- 影響度合い: 中
- 利用者関与の範囲: 不要
- 対策:
  - 専用のメール送信ライブラリを使用する
    - 外部からのパラメータをメールヘッダに含ませない
    - 外部からのパラメータをメールヘッダに含ませる場合は改行を含ませない

#### 事例
- メールアドレス欄でメールアドレス入力後に改行を入れ、任意のアドレスをBCCとして追加されてしまう
- メールアドレス欄でメールアドレス入力後に空行を入れ、本文入力欄を介さない任意の本文を送信されてしまう
- メールアドレス欄でメールアドレス入力後に空行を入れ、本文入力欄を介さないウイルス添付ファイルを送信されてしまう

#### 原因
- メールのメッセージ仕様を悪用した攻撃
  - 改行ごとに定義されるメールヘッダの仕様を悪用し、
  　本来のパラメータに偽の改行を仕込むことで任意のヘッダ・本文を生成する

#### 対策
- メール送信時に専用のライブラリを使用する
  - 外部からのパラメータをメールヘッダに含ませない
  - 外部からのパラメータをメールヘッダに含ませる場合は改行を含ませない
- メールアドレス・件名の妥当性を検証する
  - 外部からのパラメータをメールヘッダに含ませる場合は改行を含ませない
