# 安全なWebアプリケーションの作り方(脆弱性が生まれる原理と対策の実践) まとめ
- 徳丸浩 著

## 03 表示処理に伴う問題
### XSS脆弱性(基礎)
- 発生箇所: HTML/JSを生成している箇所
- 影響範囲: アプリケーション全体
- 影響の種類: ユーザーのプラウザ上でのJSの実行・偽情報の表示
- 影響度合い: 中〜大
- 利用者関与の範囲: 罠サイトの閲覧・メール記載のURLの起動・攻撃を受けたサイトの閲覧
- 対策: 属性値を""で囲む・メタ文字をエスケープする

#### 事例
- クッキー値の盗み出し
- フォームの書き換え
- その他のJSによる攻撃

### 種別
- 反射型XSS -> 攻撃者がユーザーを悪意のあるスクリプトを仕掛けた罠サイトへ誘導する
- 持続型XSS -> 攻撃者が攻撃対象のサイトへ悪意のあるスクリプトを仕掛ける

### 原因
- メタ文字をエスケープしていない

### 対策
- HTMLの要素内容・属性値をエスケープする
- HTTPレスポンスに文字エンコーディングを明示する
- X-XSS-Protectionレスポンスヘッダを設定する
  - 参照: [X-XSS-Protection](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/X-XSS-Protection)
  - XSS攻撃を検出した際にページの読み込みを停止する
```sh
X-XSS-Protection: 1; mode=block
// XSS フィルタリングを有効化
```
- 入力値の検証
- クッキーにHttpOnly属性を付与
  - JSからのクッキーの読み出しを禁止
- TRACEメソッドの無効化
  - XST攻撃対策

### XSS脆弱性(発展)
- リンクを入力値から動的に生成する場合
  - javascriptスキームを入力された場合、悪意のあるスクリプトの実行を許容してしまう
    - 対策: http/httpsから始まる絶対URL、もしくは相対URLのみを許容する
  - 罠サイトへのURLを入力されてしまう
    - 対策①: ドメインの異なるURLを許容しない
    - 対策②: ドメインの異なるサイトへの誘導であることをユーザーに知らせるクッションページを表示
- JSを入力値から動的に生成する場合
  - イベントハンドラの入力部分を終了させ、第二のスクリプトを入力されてしまう
    - 対策: 入力値をJSの文字列リテラルとしてエスケープし、その結果をHTMLエスケープする
  - script要素を終了させ、別のscript要素を挿入されてしまう
    - 入力値をJSの文字列リテラルとしてエスケープし、その結果に \</script という文字列が出現しないようにする

### 根本的な対策
- スクリプトの動的生成を避ける
- script要素の外部でパラメータを定義する
  - カスタムデータ属性を取得する
  - カスタムデータ属性内はHTMLエスケープを行う
- インラインJSONPを使用する
  - JSON形式のパラメータを扱う関数をscript要素で呼び出す
  - JSONを安全に扱うエンコーディングを行う

### エラーメッセージからの情報漏洩
- 攻撃者によって有益な情報がエラーメッセージに含まれている
- 意図的な攻撃としてエラーメッセージに秘密情報を表示させられる
- 対策: アプリケーションエラーの詳細内容はエラーログに表示させるようにする
