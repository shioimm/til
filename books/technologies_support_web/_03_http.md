# Webを支える技術 まとめ03
- 山本陽平 著

## 03 HTTP
### ネットワークプロトコル
```
[ネットワークインターフェース層] - イーサネット
  物理的なケーブルやネットワークアダプタ等
[インターネット層] - IP
  指定したIPアドレス宛にパケット単位でデータを送る
[トランスポート層] - TCP, UDP
  IPが送り出したデータの到達を保証する
[アプリケーション層] - HTTP, SSH, SMTP, DNS etc
  具体的なインターネットアプリケーション
  ソケットを使用しネットワークでのデータのやり取りを行う
```

### リクエスト-レスポンス
```
[CLIENT]リクエストメッセージの構築(サーバーは待機状態)
  ↓
[CLIENT]リクエストメッセージの送信(サーバーは待機状態)
  ↓
[SERVER]リクエストメッセージの受信(クライアントは待機状態)
  ↓
[SERVER]リクエストメッセージの解析(クライアントは待機状態)
  ↓
[SERVER]アプリケーションプログラムへの処理の移譲(クライアントは待機状態)
  ↓
[SERVER]アプリケーションプログラムから結果を取得(クライアントは待機状態)
  ↓
[SERVER]レスポンスメッセージの構築(クライアントは待機状態)
  ↓
[SERVER]レスポンスメッセージの送信(クライアントは待機状態)
  ↓
[CLIENT]レスポンスメッセージの受信(サーバーは待機状態)
  ↓
[CLIENT]レスポンスメッセージの解析(サーバーは待機状態)
  ↓
[CLIENT]クライアントの目的を達成するために必要な処理(サーバーは待機状態)
```
- クライアントとサーバーは、相手の処理中に待機状態になる(一対一の処理が同期する)

### HTTPメッセージ
-  リクエストの場合
```
- リクエストライン
- ヘッダ
- 空行
- ボディ
```
- レスポンスの場合
```
- ステータスライン
- ヘッダ
- 空行
- ボディ
```
- リクエストラインとステータスラインはまとめて「スタートライン」

### アプリケーション状態
- セッション -> ユーザーがシステムログインしてからログアウトするまでの一連の操作
- セッション状態 -> ユーザー固有の情報がある状態
  - セッション中の状態はアプリケーション状態であるため、セッション状態とアプリケーション状態はほとんど同じ

#### ステートフル
- サーバーがアプリケーション状態を持つ
- 一台のサーバーで管理できるユーザーの数に上限があるためスケールしない

#### ステートレス
- サーバーがアプリケーション状態を持たない
- すべてのリクエストが自己記述型メッセージになるためパフォーマンスが低下する
- 通信エラー時にリクエストを二重で受け付ける可能性がある

### HTTPメソッド
```
- 冪等 -> 何度操作しても結果が変わらない
- 安全 -> リソースに対する変化を発生させない
```

#### GET
- リソースの取得
- ステータスは200を返す
- ボディは指定されたURIのデータを返す
- 冪等かつ安全

#### POST
- リソースの作成、追加
- リソースのURIはサーバーによって生成される
- ステータスは作成の場合201、追加の場合200を返す
- ヘッダは作成の場合新しく作成されたリソースのURIをLocationヘッダとして返す
- ボディは作成・追加されたコンテンツを返す
- 冪等でなく安全でもない

#### PUT
- リソースの更新、作成
- リソースのURIはリクエスト時にユーザーがURIを指定する
- リクエスト時に指定したURIが存在する場合更新、存在しない場合作成になる
- ステータスは更新の場合200、作成の場合201を返す
- ボディは更新・作成されたコンテンツを返す
- 冪等だが安全でない

#### DELETE
- リソースの削除
- ステータスは200を返す(204でも良い)
- ボディは存在しないため返さない
- 冪等だが安全でない

#### HEAD
- リソースのヘッダの取得
- ステータスは200を返す
- 冪等かつ安全

#### OPTIONS
- リソースがサポートしているHTTPメソッドの取得
- ステータスは200を返す
- ヘッダはHTTPメソッドをAllowヘッダとして返す
- 冪等かつ安全

### ステータスコード
- 1xx -> 処理中
- 2xx -> 成功
- 3xx -> リダイレクト(レスポンスヘッダのLocationヘッダを見てリダイレクト先を決定する)
- 4xx -> クライアントエラー
- 5xx -> サーバーエラー

### ヘッダ
- リソースに対するメタデータ

#### ヘッダで管理する主な情報
- 日時
  - 生成日時、リソースの更新日時、キャッシュの期限etc
- MIMEメディアタイプ
  - メディアタイプ、文字エンコーディング
- 自然言語
- コンテントネゴシエーション
  - 処理できるメディアタイプや文字エンコーディング、自然言語
- ボディの長さ(Content-Length)
```
# チャンク転送
ボディを分割して転送する処理(動的にリソースを生成する場合など)
```
- 認証情報
  - ユーザー名とパスワード、realm(リソースが属するURI空間) etc
```
# Basic認証
ユーザー名とパスワードを:で連結しBase64エンコードした認証方法

# Digest認証
1. ユーザー名、realm、パスワードを:で連結しMD5ハッシュ値を求める
2. メソッドとURIパスを:で連結しMD5ハッシュ値を求める
3. 1、サーバーから得たnonce(一度だけ使われる数字)、クライアントがnonceを送った回数、qop(保証の品質)、2を:で連結しMD5ハッシュ値を求める
Basic認証よりもセキュア
```
- キャッシュに必要な情報
  - Pragma、 Expires、Cache-Control
- 条件付きGETに必要な情報
  - If-Modified-Since、If-None-MatchとETag
- 持続的接続に必要な情報
  - Keep-Alive、Connection
- ファイル名
  - Content-Disposition etc
