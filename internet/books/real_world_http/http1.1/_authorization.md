# Real World HTTP 歴史とコードに学ぶインターネットとウェブ技術 まとめ
- 渋川よしき 著

## 認証・認可プラットフォーム
- 認証 -> ブラウザを操作しているユーザーが、サービスに登録されているどのアカウントの所有者なのかを確認する
- 認可 -> 認証したユーザーを把握した上でどんな権限を与えるのかを決定する

### シングルサインオン
- 各システム間のアカウント管理を一元化する
- 一つのサービスにサインインすると、関連する全てのシステムが有効になる

#### 方法
- 各サービスが認証サーバーに自前でアクセスする
- 各サービスの前段にHTTPプロキシを置き、認証を代行する
- 各サービスに認証を代行するエージェントを置き、ログイン時に中央のサーバーにログインの有無を問い合わせる
- Kerberos認証
  - LDAP規格
  - チケットとセッションキーをサービスに送る
- SAML(Security Assertion Markup Language)
  - Cookieを使用し、ドメインをまたいだサービス間でシングルサインオンを利用できる
  - 用語
    - ユーザー
    - 認証プロバイダ(idP) -> IDを管理するサービス
    - サービスプロバイダ -> ログインを必要とするサービス
  - 実装方法
    - SAML SOAPバインディング
    - リバースSOAP(PAOS)バインディング
    - HTTPリダイレクトバインディング
    - HTTP POSTバインディング
    - HTTPアーティファクトバインディング
    - SAML URIバインディング
  - メタデータ(XML)を使用して認証プロバイダーとサービスプロバイダーにサービスを登録する
  - ユーザーアクセス時、未ログイン状態であればサービスプロバイダーは認証プロバイダーにリダイレクトを行う
  - ユーザーのブラウザに認証プロバイダの画面を表示
    - ログインに成功した場合、認証プロバイダーはサービスプロバイダーにログイン情報をPOST
    - サービスプロバイダーは最初にリクエストされたコンテンツを返す

### OpenID
- すでに使われているWebサービスのユーザー情報を使い、他のサービスにログインする
  - 後続はOpenID Connect
- 用語
  - OpenIDプロバイダー
    - ユーザー情報を持つWebサービス
  - リライニングパーティー
    - ユーザーが新たに使用したいサービス
  - ユーザー入力識別子
    - OpenIDプロバイダーが提供するユーザー情報(URL形式)
- OpenIDプロバイダのWebサイトからユーザー入力識別子を取得
- リライニングパーティーにユーザー入力識別子を登録
  - リライニングパーティーがOpenIDプロバイダーに対してHTTPで情報交換を行い、秘密鍵を共有
- OpenIDプロバイダーのWebサイトにリダイレクト -> ユーザーが承認 -> リライニングパーティーにリダイレクト

### OpenSocial
- 認証だけでなく会員情報、友人関係、アクティビティ、情報の保存や共有、メッセージ送信など多岐にわたるAPIを有する
- 認可・認証をすべてソーシャルネットワークサービスの事業提供者が行う
- ドメインをまたいだ画オブサーバーへのリクエストやブラウザが使うAjax対応はSNSの外部のガジェットサーバーが行う
- ガジェット提供者(ユーザーが利用したいサービス)とプラットフォーム提供者間の通信はHTTPで行う

### OAuth
- 認証ではなく認可のための仕組み
- 用語
  - 認可サーバー
    - ユーザー情報を持つWebサービス
  - リソースサーバー
    - ユーザーが認可した権限でアクセスできる対象
  - クライアント
    - ユーザーが新たに使用したいサービス
    - 認可サーバーにアプリケーション情報を登録し、専用のID(client_id, client_secret)を取得する必要がある
- OpenIDと同じような画面遷移をする
- フロー
  - Authorization Code
    - 通常のフロー
    - Webサービスのサーバー内にclient_secretを隠せる場合に使用
  - Implicit Code
    - client_secret無しでアクセスできるパターン
    - クライアントの身元を保証しない
    - JSやアプリダウンロード向け
  - Resource Owener Password Credentials Grant
    - 認可サーバーに信頼されているクライアントで使う
    - クライアント自身がユーザーのID/PWに触れる
    - iOS内蔵のFacebook、Twitter向け
  - Clients Credentials Grant
    - ユーザーの同意なしにclient_id、client_secretだけを使用してアクセスできるようにする
    - client_secretを外部から秘匿できる環境で使用

### OpenID Connect
- OAuth2.0をベースに、認可だけでなく認証まで行えるように拡張したもの
- OAuthとの違い
  - ユーザープロフィールへのアクセスが規格化
  - 通常のアクセストークンとは別にIDトークンが発行され、アクセスに利用する
- アクセストークンとIDトークンの取得方法
  - エンドポイント
    - 認可エンドポイント
      - クライアントが認可リクエストを送る窓口
      - クライアント認証の場合 -> 認可コード(トークンエンドポイントにアクセスするための鍵)を返す
      - クライアント認証でない場合 -> アクセストークンとIDトークンを返す
    - トークンエンドポイント
      - アクセストークンとIDトークンを返す窓口
      - クライアントを認証することで強い権限のトークンを返す
  -フロー
    - Authorization Code Flow
      - OAuthのAuthorization Codeと同じ
      - 認可エンドポイントにアクセスしてコード取得後、トークンエンドポイントにアクセスしてトークンを得る
    - Implicit Flow
      - OAuthのImplicit Codeと同じ
    - Hybrid Flow
      - Implicit Flowと似ている
      - 認可エンドポイントで通信に必要なトークンと追加で情報を得るための認可コードを得る
      - 認可コードを利用してトークンエンドポイントにアクセスする
      - モバイルアプリケーション向け
        - スマートフォン端末上のアプリケーション向けにImplicit Flowで認可を行った後、
        バックエンドのWebサービスがクライアント認証を行うことで強固な権限を保つトークンを得られる
