# 安全なWebアプリケーションの作り方(脆弱性が生まれる原理と対策の実践) まとめ
- 徳丸浩 著

## 14 構造化データの読み込みにまつわる問題
### evalインジェクション
- 発生箇所: `eval`のような機能を利用しているページ
- 影響範囲: すべてのページ
- 影響の種類: 情報漏洩、サイト改ざん、不正な機能実行、他サイトへの攻撃(踏み台)、暗号通貨の採掘
- 影響度合い: 大
- 利用者関与の範囲: 不要
- 対策:
  - `eval`に相当する機能を使わない
  - `eval`の引数の外部からのパラメータを含めない
  - `eval`の与える外部からのパラメータを英数字に限定する

#### 事例
- `eval`の実行箇所に対して終了文字を混入させることによって式を終了させ、任意のスクリプトを実行されてしまう

#### 原因
- `eval`自体がそもそも危険
- `eval`に与えるパラメータをチェックしていない

#### 対策
- `eval`に相当する機能を使わない
- `eval`の引数の外部からのパラメータを含めない
  - `hidden`パラメータではなくセッション変数で値を受け渡す
  - ただしスクリプトの注入経路がhTTPリクエスト経由以外(ファイルやDB経由)の場合別の対策が必要
- `eval`の与える外部からのパラメータを英数字に限定する
  - パラメータに式の終了文字(記号)を渡すことができないようにする

### 安全でないデシリアライゼーション
- シリアライズ -> アプリケーション内部の構造を持ったデータを保存・伝送する目的でバイト列に変換する
- デシリアライズ -> シリアライズされたデータを元に戻す
- シリアライズされたデータが信頼できない場合、
  デシリアライズ時に意図しないオブジェクトがアプリケーション内部に生成され、
  任意のコードを実行される脆弱性となる
- 発生箇所: 外部からの値をデシリアライズしているページ
- 影響範囲: すべてのページ
- 影響の種類: 情報漏洩、サイト改ざん、不正な機能実行、他サイトへの攻撃(踏み台)、暗号通貨の採掘
- 影響度合い: 大
- 利用者関与の範囲: 不要
- 対策:
  - シリアライズ・デシリアライズ機能を使わない
  - デシリアライズ処理には外部からのパラメータを含めない

#### 事例
- クッキーにシリアライズしたデータを保存するようなアプリケーションにおいて、
  保存値を外部から操作できるような場合、攻撃用クッキーとして任意のスクリプトを保存される可能性がある
  - デシリアライズを行なった時点でプログラムが実行される

#### 原因
- 外部からの信用できない処理に対してシリアライズが行われると、意図しないオブジェクトがメモリ内に生成される
- 攻撃者はオブジェクトのプロパティを巧妙に設定することによって任意のコードを外部から操作できるようにする

#### 対策
- シリアライズ形式ではなくJSON形式でデータを受け渡す
- シリアライズ形式でデータを受け渡す場合はセッション変数など書き換えできない形にする
- 改ざん検知の仕組みを導入してデータが改ざんされていないことを確認する

### XXE
- XMLの外部実体参照機能 -> XMLに外部ファイルの内容を取り込むことができる機能
  - XMLデータを外部から受け取るプログラムにおいて、
    外部実体参照の形でWebサーバー内部のファイルを不正に読み取られる脆弱性 -> XXE
- 発生箇所: XMLを外部から受け取り解析しているページ
- 影響範囲: すべてのページ
- 影響の種類: 情報漏洩、他サイトへの攻撃(踏み台)
- 影響度合い: 大
- 利用者関与の範囲: 不要
- 対策:
  - 外部からのデータ受け取りにJSONを使用する(XMLの代わりに)
  - XMLを解析する際に外部実体参照の機能を無効化する

#### 事例
- XMLファイルをアップロードし、内容を登録するようなアプリケーションにおいて、
  外部実体参照機能を利用してアプリケーション内部の特定のディレクトリ・ファイルやURLを指定される
- 外部実体参照によって指定されたファイルにアクセスされてしまい、情報が漏洩する

#### 原因
- XMLの機能を悪用した攻撃

#### 対策
- XMlの代わりにJSONを使用する
- XMLを解析する際に外部実体参照の機能を無効化できる言語バージョンを使用する
