# TCP/IPプロトコルスイート
- 参照: Linuxプログラミングインターフェース 58章

## TL;DR
- 現在主流のインターネットワークプロトコル
- 「インターネット」はTCP/IPのインターネットワーク

## レイヤ

| 階層               | プロトコル        | 送信データ                  | メモリ領域   |
| -                  | -                 | -                           | -            |
| アプリケーション層 | HTTP, SMTP etc    | アプリケーションデータ      | ユーザー空間 |
| トランスポート層   | TCP, UDP etc      | TCPセグメント, データグラム | カーネル空間 |
| ネットワーク層     | IP, ICMP, ARP etc | IPデータグラム              | カーネル空間 |
| データリンク層     | Ethernet          | データフレーム              | ハードウェア |

- トランスポート層ではアプリケーション層間の通信を`SOCK_STREAM` / `SOCK_DGRAM`によって行う

## データリンク層
- ネットワークの物理リンク上へフレームを送信し、宛先からの確認応答を受信する
  - ネットワーク層からのデータグラムをフレーム単位にカプセル化して送受信する
- 送信時には各フレームの宛先アドレス・フレームサイズをヘッダとして付加する
  - フレームサイズ上限をMTU(最大転送ユニット)という
  - MTUの最大値はPath MTU Discovery技術(内部的にICMPを使用する)によって探索される

### 通信種別
- ユニキャスト - 1:1通信
- マルチキャスト - 複数ノードへ一斉同報
- ブロードキャスト - 特性のネットワーク内の全ノードへ一斉同報
- エニーキャスト - 同じIPアドレスを持つ複数ノードへ一斉同報

## ネットワーク層
- 送信元ホストから宛先ホストへパケットを送信する
  - インターネットワーク上の宛先を決定する
  - トランスポート層へ機能を提供する
- IPがデータとして扱うIPデータグラムは20-60バイトのヘッダを持ち、
  宛先ホストのアドレスや送信元のアドレスを扱う
- IPはコネクションレスであり信頼性がない
- IPのデータグラムサイズがデータリンク層のMTUよりも大きい場合、
  IPがデータグラムを分割し、サイズを小さくする
  - 分割されたデータグラムはオフセットフィールドに元のデータグラム内での位置を持つ
  - 分割されたデータグラムは宛先のIPによって復元される
  - [TCP]IPフラグメンテーション防止のためホスト間でのMTUを決定し、IPへデータを渡す前に分割しておく
  - [UDP]TCPのような機構が無くIPがデータを分割するためIPフラグメンテーションが発生する可能性がある

### IPアドレス
- ネットワークID(ホストを接続したネットワーク) + ホストID(ネットワーク上のホスト)

#### IPv4アドレス
- 32ビットサイズ(ドット区切りの10進数)
  - ネットワークアドレス - ネットワークID + ホストID
  - ネットワークマスク - ネットワークID部: すべて1 + ホストID部: すべて0
  - サブネット化 - ホストIDをサブネットIDとホストIDへ分割する
    - 拡張ネットワークID - ネットワークID + サブネットID
    - サブネットマスク - 拡張ネットワークID部：すべて1 + ホストID部: すべて
- ループバックアドレス - 127.0.0.1
- IPv4ワイルドカード - 0.0.0.0
  - 自ホストの全てのIPアドレス宛のUDPデータグラム・TCP接続要求を処理する

#### IPv6アドレス
- 128ビットサイズ(コロン区切りの16ビットの16進数)
  - 先頭数ビットはフォーマットプレフィックスを用いてアドレス種類を示す
- ループバックアドレス - ::1
- IPv6ワイルドカード - 0::0
- IPv4射影IPv6アドレス - IPv4にのみ対応しているホストと通信する際のIPv4-mappedアドレス

### ICMP
- [TCP/IPプロトコルを支えるICMPメッセージ](https://www.atmarkit.co.jp/ait/articles/0306/13/news002.html)
- TCP/IPが動作するために補助的な役割を担うプロトコル
- TCP、UDPなどの通信においてエラーが発生した際にエラーを通知する
- `ping(1)`の内部で使用される

#### ICMPエコー
- 指定されたエコー・データ・パケットを2つのTCP/IPノード間で送受信するメッセージ(要求・応答)

## トランスポート層
- 異なるホスト上のアプリケーション間E2E通信を行う
  - ホスト上のアプリケーションを特定する方法として16ビットのポート番号を使用する

### ポート番号
- well-knownポート
  - 特定のアプリケーションに固定的に割り当てられるポート番号
- 登録済みポート
  - アプリケーション開発者が割り当てるポート番号(1024-49151)
- 特権ポート
  - 特権プロセスのみがバインドできるポート番号(0-1023)
- エフェメラルポート
  - アプリケーションが明示的に番号を選択しない場合、一時的に割り当てられるポート番号
  - [Linux]`/proc/sys/net/ipv4/local_port_range`の範囲内

### UDP
- データグラムソケットが使用するコネクションレスプロトコル
- アプリケーション層からは`SOCK_DGRAM`で通信を行う
- IPにポート番号・データチェックサムを追加し、送信データのエラー検出を可能にする
- 送信するデータグラムのサイズを576バイトのIPv4最小再構成バッファサイズよりも小さくすることで
  IPフラグメンテーションを回避する
  - UDPヘッダ(8バイト) + IPヘッダ(20バイト以上) + データグラム本体(残りバイト)

### TCP
- ストリームソケットが使用するコネクション指向のプロトコル
- アプリケーション層からは`SOCK_STREAM`で通信を行う

#### TCPによる通信の特徴
- データの信頼性
  - 失われたパケットの再送
  - 順番の入れ替わったパケットの並べ直し
- 輻輳制御
  - スロースタート
  - 輻輳状態の検知
  - フロー制御

#### TCPエンドポイント
- TCPコネクションの一方の接続端点に対応するカーネルが管理する情報(受信TCP / 送信TCP)
  - 送信バッファ
  - 受信バッファ
  - 接続済みエンドポイントを同期するための状態情報

#### 通信の確立
- 通信前に通信チャネルを確立する
- 送信データは複数のセグメントに分割される
  セグメントごとに送信エラーを検出可能なチェックサムを持つ
- TCPセグメントが受信側へ到着すると受信TCPは送信TCPへ確認応答を送信する

#### シーケンス番号
- TCPコネクション上を流れる全てのバイトには論理シーケンス番号が振られ、
  そのコネクションのストリーム内での位置を示す
- TCPセグメント送信時はセグメントの先頭バイトのシーケンス番号をTCPヘッダに格納する
- シーケンス番号は32ビットの幅を持ち、最大値に達すると0に戻る

#### フロー制御
- 高速な送信側が低速な送信側を飽和させるのを防ぐための機能
- 受信TCPが送信TCPから受信したデータは受信バッファへ保持され、
  アプリケーションがデータを読み取ると削除される
  - 受信TCPは確認応答送信時に受信バッファサイズを送信TCPに告知する
  - 確認応答前のセグメントが最大合計Nバイト(ウィンドウサイズ)まで存在して良いとする
    (スライディングウィンドウ)
  - 受信バッファが一杯になると、送信TCPは送信を停止する

#### 輻輳制御
- 高速な送信側がネットワークを飽和させるのを防ぐための機能
  - 中継ルーターがパケットを中継するよりも早く送信TCPがパケットを送出した場合、
    ルーターでパケットが欠落する
- スロースタート
  - 送信TCPは遅い速度で送信を開始し、受信TCPが確認応答を返すたびに級数的に速度を上昇させる
- 輻輳回避
  - 接続直後は送信TCPは小さな輻輳ウィンドウを設けて送信可能な未応答データ量を制限し、
    送信側がピアTCPから確認応答を受信するたびに輻輳ウィンドウのサイズを級数的に上昇させる
  - ネットワークキャパシティに近い規定の閾値に達すると増加ペースを級数的から線形へ落とす

### SCTP / DCCP
- トランスポート層の比較的新しいプロトコル
- SCTP - Stream Control Transmission Protocol
  - 信頼性・双方向性を備えたコネクション指向のプロトコル
  - メッセージ区切りを維持する
  - マルチストリーム(1コネクション上で複数の論理データストリームを実現する)
- DCCP - Datagram Congestion Control Protocol
  - 信頼性や順序の維持を保証しない
  - 輻輳制御機能を持つ
