# TCP/IPプロトコルスイート
- 参照: Linuxプログラミングインターフェース 58章
- 参照: サーバ・インフラエンジニアの基本がこれ一冊でしっかり身につく本 2.8-9
- 参照: Linuxで動かしながら学ぶTCP/IPネットワーク入門 4.5

## TL;DR
- 現在主流のインターネットワークプロトコル
- 「インターネット」はTCP/IPのインターネットワーク

## レイヤ

| 階層               | プロトコル        | 送信データ                  | メモリ領域   |
| -                  | -                 | -                           | -            |
| アプリケーション層 | HTTP, SMTP etc    | アプリケーションデータ      | ユーザー空間 |
| トランスポート層   | TCP, UDP etc      | TCPセグメント, データグラム | カーネル空間 |
| ネットワーク層     | IP, ICMP, ARP etc | IPデータグラム              | カーネル空間 |
| データリンク層     | Ethernet          | データフレーム              | ハードウェア |

- トランスポート層ではアプリケーション層間の通信を`SOCK_STREAM` / `SOCK_DGRAM`によって行う

## 物理層
### ネットワークスイッチ
- 接続機器間の距離やポート数などの物理的な問題を解決するための機器
- 電気信号の中継(ケーブルの延伸)と接続端子の集約・分化を担う

### NIC
- Network Interface Card(LANカード / Ethernetカード)
- ノードやスイッチ、ルータのIPアドレスを持つ物理デバイス

## データリンク層
- ネットワークの物理リンク上へフレームを送信し、宛先からの確認応答を受信する
  - ネットワーク層からのデータグラムをフレーム単位にカプセル化して送受信する
- 送信時には各フレームの宛先アドレス・フレームサイズをヘッダとして付加する
  - フレームサイズ上限をMTU(最大転送ユニット)という
  - MTUの最大値はPath MTU Discovery技術(内部的にICMPを使用する)によって探索される

### 通信種別
- ユニキャスト - 1:1通信
- マルチキャスト - 複数ノードへ一斉同報
- ブロードキャスト - 特性のネットワーク内の全ノードへ一斉同報
- エニーキャスト - 同じIPアドレスを持つ複数ノードへ一斉同報

### ブリッジ
- データリンク層でフレームを転送する機器
- 同じブロードキャストドメインにおいて複数のネットワーク機器を接続する目的で使用する
- ブリッジはMACアドレステーブルの管理を行う
  - MACアドレステーブル - ブリッジの各ポートとポートに接続された各ネットワーク機器のMACアドレスの対応表
- ブリッジはフレームを受信すると、フレームの送信先MACアドレスを読み取り、
  該当MACアドレスを持つ機器の接続されたポートに向かってフレームを転送する

## ネットワーク層
- 送信元ホストから宛先ホストへパケットを送信する
  - インターネットワーク上の宛先を決定する
  - トランスポート層へ機能を提供する

### ルーティング
- ルータ - 複数のネットワークに所属し、パケットを仲介するネットワークノード・機器
- ルーティング - ルータがパケットの経路を決定し、パケットを送出する処理
- ルーティングテーブル - 各ノードが持つ経路制御表(ルーティング規則)
- デフォルトゲートウェイ - どのルーティング規則にも該当しない場合に採用される宛先

#### 静的ルーティング
- ルーティングテーブルを予め定義しておく手法

#### 動的ルーティング
- ルーティングテーブルを動的に定義する手法
  - BGP - ネットワークの集合をASとしてまとめ、AS単位で一意なAS番号を振り、経路を制御する
  - AS - 自律システム

### IP
- Internet Protocol

### ICMP
- Internet Control Message Protocol
- IPを制御する伝達のプロトコル
- ルーティングテーブルが正しいか検査したり、ルーティングテーブルに以上がある場合に通知する
- `ping(1)`の内部で使用される
- ICMPエコー - 指定されたエコー・データ・パケットを2つのTCP/IPノード間で送受信するメッセージ(要求・応答)

| タイプ | 意味       | 説明                         |
| -      | -          | -                            |
| 0      | エコー応答 | エコー要求への応答           |
| 3      | 到達不能   | 転送先にパケットが届かない   |
| 5      | 転送先変更 | 効率が悪い経路の変更         |
| 8      | エコー要求 | エコー応答の要求             |
| 11     | 時間超過   | ループが発生している場合など |

### ARP
- Address Resolution Protocol
- 送信元ノードが送信先ノードのMACアドレスを取得し、
  送信先MACアドレスをEthernetフレームのヘッダに書き込み、
  データを送出するプロトコル
  - ARPリクエスト - IPアドレスを元にMACアドレスを問い合わせる(ブロードキャスト)
  - ARPリプライ - IPアドレスを元にMACアドレスを解決して返す
- IPと同じようにEthernetフレームで送出される
- `arp(1)` - ノードでキャッシュしているMACアドレスを確認する

## トランスポート層
- 異なるホスト上のアプリケーション間E2E通信を行う
  - ホスト上のアプリケーションを特定する方法として16ビットのポート番号を使用する

### ポート番号
- well-knownポート
  - 特定のアプリケーションに固定的に割り当てられるポート番号
- 登録済みポート
  - アプリケーション開発者が割り当てるポート番号(1024-49151)
- 特権ポート
  - 特権プロセスのみがバインドできるポート番号(0-1023)
- エフェメラルポート
  - アプリケーションが明示的に番号を選択しない場合、一時的に割り当てられるポート番号
  - [Linux]`/proc/sys/net/ipv4/local_port_range`の範囲内

### UDP
- User Datagram Protocol
- データグラムソケットが使用するコネクションレスプロトコル
- アプリケーション層からは`SOCK_DGRAM`で通信を行う

### TCP
- Transmission Control Protocol
- ストリームソケットが使用するコネクション指向のプロトコル
- アプリケーション層からは`SOCK_STREAM`で通信を行う

### SCTP / DCCP
- トランスポート層の比較的新しいプロトコル
- SCTP - Stream Control Transmission Protocol
  - 信頼性・双方向性を備えたコネクション指向のプロトコル
  - メッセージ区切りを維持する
  - マルチストリーム(1コネクション上で複数の論理データストリームを実現する)
- DCCP - Datagram Congestion Control Protocol
  - 信頼性や順序の維持を保証しない
  - 輻輳制御機能を持つ

## アプリケーション層
- HTTP、DNS、SMTP、DHCP、etc

### DHCP
- Dynamic Host Confuguration Protocol
- TCP/IPのネットワークを使用するために必要な設定作業を自動化する
  - ネットワークインターフェースにIPアドレスを付与する
  - デフォルトルートのルーティングエントリをルーティングテーブルに追加する
  - 名前解決に利用するネームサーバーを指定する
- DHCPサーバー - ネットワークの設定を配布するサーバープロセス
  - デフォルトルートとなるルーターが兼任するケースが多い
  - 配布するIPアドレスの範囲やデフォルトルートの情報を指定しておく
- DHCPクライアント - ネットワークの設定を受け取るクライアントプロセス
