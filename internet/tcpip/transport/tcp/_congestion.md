# 輻輳回避と輻輳制御
## フロー制御
- 受信側が処理できないほどの大量のデータが送信側から送出されるのをふせぐためのメカニズム
  - 受信側はビジー状態、重い負荷がかかっている、決まった量のバッファ領域しか割り当てたくないなど
- 接続中の両ホストにおいて、受信データの維持に使用可能なバッファサイズを知らせるために
  各ホストは通信相手に対して受信ウィンドウサイズ(rwnd)値を告知する
  - ACKパケットが各ホストの最新のrwnd値を送信する
- データ受信側の容量をオーバーフローさせないようデータ送信側で制御できる

### 仕組み
- 接続確立時、各ホストはシステムデフォルト値のrwnd値で通信を開始する
- 各ホストのどちらかが現在のペースの通信を維持できなくなった場合:
  より小さなrwnd値を通信相手へ告知する
- rwnd値が0になった場合:
  今までに送信されたバッファ上のデータがアプリケーションによって処理されるまで
  新たにデータを送るべきではないという合図になる

### 課題
- ネットワークの帯域幅を超える通信を防ぐメカニズムが送受信どちら側にも組み込まれていない

## スロースタート
- 常に変化するネットワークの帯域幅を超えないように通信を行うためのメカニズム
  - ルーターがパケットを中継するよりも早く送信TCPがパケットを送出した場合、
    ルーターでパケットが欠落する(パケットロス)
- 送信TCPは小さい輻輳ウィンドウサイズ(cwnd)変数値で送信を開始し、
  受信TCPがACKを返すたびに級数的にcwnd値を増加させる

### 仕組み
- サーバーはTCP接続ごとにcwnd変数を初期化し、初期値として控えめなシステム設定値を設定する
  - cwnd値 - データ送信側がクライアントからACKを受け取る前に続けて送信できるデータ量
  - cwnd値はサーバーにプライベート変数として保存される
- rwnd値とcwnd値のうち小さい方をクライアント・サーバー間の新規TCP接続における送信中データの最大量とする
  - 送信中データ - ACKが返されていないデータ
- サーバーはパケットにACKが返されるごと(パケット1往復ごと)にcwnd値を1セグメントずつ増加させていく
  - ACKを受け取るごとに新たに2つのパケットを送信できる(指数的増加アルゴリズム)
- ネットワークキャパシティの閾値に達した(パケットロスが発生した)場合:
  増加ペースを級数的から線形へ落とす

## KeepAlive
- 一度確立したTCPコネクション上で複数のHTTP通信を行う技術(HTTP/1.1)
- クライアントは複数のリクエストを送信できる
- サーバーは複数のレスポンスを送信できる
  - サーバーはクライアントがリクエストを送信した順でレスポンスを返す必要がある
- クライアントがKeepAlive接続を要求する際はConnectionリクエストヘッダをkeep-aliveに設定する
- サーバーがKeepAlive接続を行う場合はConnectionレスポンスヘッダをkeep-aliveに設定する
  - サーバーがKeepAlive接続を行わない場合はConnectionレスポンスヘッダをcloseに設定する

## TCP FAST OPEN
- 参照: [TCP FAST OPENとは？](https://blog.redbox.ne.jp/tcp-fast-open-cdn.html)
- TCPレイヤーにおける高速化の手法のひとつ
- 通信確立時の1RTTを節約する

### 手法
- 初回通信開始時、クライアントからSYNにFast Open Cookieを付けてハンドシェイクを行う
  - サーバーはTCPオプション34番でTFOクッキーを返す
  - クライアントはTFOクッキーをキャッシュする
- 初回以降の通信時、クライアントはSYNパケットにTFOクッキーとリクエストデータを含めて送信する
  - サーバーはクライアントから送られてきたTFOクッキーと自身の生成したTFOクッキーを比較検証
  - 正しければサーバーはリクエストデータをアプリケーションに渡し、クライアントにはSYN-ACKを返却

## 参照
- よくわかるHTTP/2の教科書P21-22/40-41
- Linuxプログラミングインターフェース 58章 / 61章
- Software Design 2021年5月号 ハンズオンTCP/IP
- ハイパフォーマンスブラウザネットワーキング
