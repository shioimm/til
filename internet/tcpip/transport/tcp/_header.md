# TCPヘッダフォーマット
### 1段目
- 送信元TCPポート番号(16ビット)
- 宛先TCPポート番号(16ビット)

### 2段目
- シーケンス番号(32ビット)
  - 初期値には乱数が割り振られ、SYNパケットで受信ホストに伝えられる
  - 転送したバイト数を初期値に加算してデータの位置を示す
    - SYNパケットやFINパケットは1オクテット分加算する

### 3段目
- 確認応答番号
  - ACKビットがセットされている場合、受信側が次に受信するべきデータのシーケンス番号
    - 実際には確認応答番号から1を引いたシーケンス番号までデータを受信したことになる
    - 送信側では返された確認応答番号より前のデータまでは正常に通信が行われたと判断する

### 4段目
- データオフセット(ヘッダ長)(4ビット)
- 予約領域(4ビット)
- コントロールフラグ(8ビット)
  - セグメントに意味を付加するフィールド
  - 0 = OFF / 1 = ON
  - 左からCWR / ECE / URG / ACK / PSH / RST / SYN / FIN
    - CWR - cwnd値の縮小・IPヘッダのECNと共に使用
    - ECE - ECE-Non(通信相手から自分方向のネットワークの輻輳を伝える)・IPヘッダのECNと共に使用
    - URG - 緊急に処理すべきデータ
    - ACK - 確認応答番号のフィールドが有効
    - PSH - 受信したデータをすぐアプリケーションに渡さず、バッファリングできる
    - RST - コネクションの強制切断
    - SYN - コネクションの確立
    - FIN - 今後送信するデータがないことを示し、コネクションの切断を意思する
- ウィンドウサイズ(16ビット)
  - 同じヘッダに含まれる確認応答番号で示した位置から受信可能なデータサイズ
  - ウィンドウが0の場合、相手はウィンドウの最新状況を知るためにウィンドウプルーブを送信できる

### 5段目
- TCPチェックサム(16ビット)
  - データの信頼性を提供する
- 緊急ポインタ(16ビット)
  - URGコントロールフラグがセットされている場合、緊急データの位置を示すポインタ

#### チェックサムの計算
1. 疑似TCPヘッダをTCPデータグラムの前に付加する
    - 送信元IPアドレス(32ビット)
    - 宛先IPアドレス(32ビット)
    - パディング(8ビット)
    - プロトコル番号(8ビット)
    - TCPパケット長(16ビット)
2. 全長が16ビットの倍数になるようにデータの最後に`0`のパディングを追加する
3. 16ビット単位で1の補数の和を求め、求めた和の1の補数をチェックサムフィールドに入れる
4. 受信ホストはデータグラム受信後、IPヘッダからIPアドレスの情報を得て
   擬似ヘッダを作成し、チェックサムを再計算する
5. チェックサムを含む全てのデータを足した結果、16ビット全てが1になると正しい

### 6段目
- オプション(0~40バイト)
  - TCPによる通信の性能を向上させるために利用される
- パディング

## 参照
- よくわかるHTTP/2の教科書P21-22/40-41
- Linuxプログラミングインターフェース 58章 / 61章
- Software Design 2021年5月号 ハンズオンTCP/IP
- ハイパフォーマンスブラウザネットワーキング
