# QUICの通信
- コネクション単位で管理され、各QUICコネクションはコネクションIDで識別される
  - クライアント・サーバーがそれぞれ送信元コネクションIDと送信先コネクションIDを持つ
- QUICのデータはUDPパケットに格納され、QUICパケットとして送信される
  - 1つのUDPパケットは複数のQUICパケットを持つ場合がある
  - 1つのQUICパケットが複数のUDP パケットにまたがることはない

## QUICコネクション
- QUICの通信単位

### コネクションの確立(1-RTTハンドシェイク)
1. クライアント -> サーバー: Initialパケット
    - `CRYPTO` [ClientHello]
2. サーバー -> クライアント: Handshakeパケット
    - `CRYPTO` [ServerHello]
    - `CRYPTO` [EncryptedExtensions, Certificate, Certificateverify,Finished]
3. クライアント -> サーバー: Handshakeパケット
    - `CRYPTO` [Finished]
4. クライアント -> サーバー: 1-RTTパケット
    - `STREAM`
5. サーバー -> クライアント: Handshakeパケット
    - `HANDSHAKE_DONE`

#### トランスポートパラメータ(`quic_transport_ parameters`)
- ハンドシェイク時にTLS拡張(TLSハンドシェイクメッセージに付随するデータ)として
  `quic_transport_parameters`を送信する
  - `max_idle_timeout` - 最大アイドル時間
  - `stateless_reset_token` - ステートレスリセット用トークン(後述)
  - `max_ack_delay` - Ack を送るまでの最大遅延時間
  - `initial_max_streams_bidi` - オープンできる双方向ストリーム数の初期値
  - `initial_max_streams_uni` - オープンできる単方向ストリーム数の初期値

#### プロトコルアップグレード
- QUICコネクション確立時、TLSハンドシェイクのメッセージで
  ALPNとしてh3を送り合うことによりHTTP/3の使用を決定する

### コネクションクローズ
- QUICコネクション上の通信を終了し、QUICコネクションに関する情報を破棄する

#### コネクションクローズの方法
- アイドルタイムアウト
  - 事前に設定した一定時間以上相手から通信がない場合、自動的にクローズ
- 即時クローズ
  - `CONNECTION_CLOSE`フレームを送信し、即時クローズ
- ステートレスリセット
  - 切断用のトークンをサーバーからクライアントへ払い出し、クライアントがトークンを送信しクローズ

#### `CONNECTION_CLOSE`に格納されるエラーコード(HTTP/3の場合)
- `H3_NO_ERROR` - 正常終了
- `H3_GENERAL_PROTOCOL_ERROR` - 具体的には示さないが仕様違反により切断
- `H3_INTERNAL_ERROR` - HTTPスタック内のエラー
- `H3_MISSING_SETTING` - 必要なSETTINGSフレームを受信できなかった
- `H3_VERSION_FALLBACK` - HTTP/3でリクエストに答えられない

### コネクションマイグレーション
- コネクションを切断することなくクライアントから自発的に通信経路を切り替える機能
  - e.g. キャリア回線 <-> Wi-Fi 回線
1. クライアント -> サーバー: `PATH_CHALLENGE`
2. サーバー -> クライアント: `PATH_RESPONSE`
3. 新しい経路で通信できることを確認できたら通信を開始し、古い経路の通信を中止する
    - 新しいコネクションIDを払い出す

## QUICパケット
- QUICコネクションにおけるデータの送信単位
- ヘッダ(コネクションID、パケット番号etc) + ペイロード(QUICフレーム)

### ロングヘッダパケット
- QUICコネクション確立時に使用
- QUICのバージョンを格納
- 送信元コネクションID・送信先コネクションIDを格納
  - QUICコネクション確立時のハンドシェイク中に双方のコネクションIDを示し合う
  - サーバーは受信したパケットに対して応答する際、パケットの送信元コネクションIDを送信先コネクションIDに設定してデータを返送する

#### 種類
- Initial - ハンドシェイク時にクライアントから最初に送信される
- 0-RTT - 0-RTTハンドシェイク時に使用される
- Handshake - ハンドシェイク時にInitialの次のパケットとして送信される
- Retry - ハンドシェイクをやりなおすときに送信される

### ショートヘッダパケット
- QUICコネクション確立後に使用
- スピンビットと暗号鍵のフェーズを格納
- 送信先コネクションIDを格納

#### 種類
- 1-RTT

### 暗号化
- QUICパケットは復号時に改ざんされていないことがわかる認証付き暗号で暗号化される
  - パケットのヘッダ部分の一部(パケット番号など)とペイロード部分がそれぞれ暗号化の対象になる

#### 暗号化の鍵の種類
| 鍵の名前                      | 用途                     | その他                               |
| -                             | -                        | -                                    |
| Initial Keys                  | Initialパケット用の鍵    | 仕様で定義された固定値をもとに導出   |
| Early Data (0-RTT) Keys       | 0-RTTパケット用の鍵      | データ量が上限を超えた場合、鍵を更新 |
| Handshake Keys                | Handshake パケット用の鍵 | -                                    |
| Application Data (1-RTT) Keys | 1-RTT パケット用の鍵     | -                                    |

## QUICフレーム
- QUICパケットにおけるペイロードの単位(QUICにおけるメッセージの単位)

| タイプ名               | タイプ値    | 説明                                                           |
| -                      | -           | -                                                              |
| `PADDING`              | 0x00        | QUICパケットのサイズの調整用                                   |
| `PING`                 | 0x01        | 疎通確認用                                                     |
| `ACK`                  | 0x02 / 0x03 | 確認応答 / 輻輳状況の通知                                      |
| `RESET_STREAM`         | 0x04        | ストリームの終了                                               |
| `CRYPTO`               | 0x06        | 暗号ハンドシェイク用のデータ送信                               |
| `NEW_TOKEN`            | 0x07        | 再接続が必要な場合のハンドシェイク用のトークン送信             |
| `STREAM`               | 0x08 ~ 0x0f | ストリーム作成、ストリームデータ(アプリケーションデータ)送信   |
| `NEW_CONNECTION_ID`    | 0x18        | 通信中にコネクションIDを変更する際の新しいコネクションIDを通知 |
| `RETIRE_CONNECTION_ID` | 0x19        | `NEW_CONNECTION_ID`発行されたコネクションIDを使用しない通知    |
| `PATH_CHALLENGE`       | 0x1a        | コネクションマイグレーションにおいて新しい通信経路が有効性確認 |
| `PATH_RESPONSE`        | 0x1b        | コネクションマイグレーションにおいて`PATH_CHALLENGE`への応答   |
| `CONNECTION_CLOSE`     | 0x1c / 0x1d | コネクションのクローズ                                         |
| `HANDSHAKE_DONE`       | 0x1e        | ハンドシェイクの完了通知                                       |

## ストリーム
- アプリケーションデータ(`STREAM`フレーム)を送受信するための通信管理の仮想単位
  - `STREAM`フレームはいずれかのストリームに属する
  - `STREAM`フレーム以外のフレームはストリームを用いない
- 1つのQUICコネクションは複数のストリームを持ち、ストリームごとに`STREAM`フレームの送受信を管理する
- ストリームは使い終わるとクローズされ、再利用はできない

### 通信の信頼性
- ストリームはストリーム単位で信頼性を担保する
  - ストリーム内でパケットロスやパケットの順番の入れ替わりが発生した場合、
    ストリーム内でパケットの再送処理・リカバリーを行う
  - ストリーム同士は独立しており、ストリーム内のリカバリーは他のストリームに影響を与えない

### 種類
- 単方向ストリーム - ストリームを開始した側のみ`STREAM`フレームを送信する
- 双方向ストリーム - ストリームを開始した後双方から`STREAM`フレームを送信する

| 種類                                | ストリームID    | ストリームIDのビット表現の下位2ビット |
| -                                   | -               | -                                     |
| クライアント開始 / 双方向ストリーム | 0, 4, 8, 12...  | 00                                    |
| サーバー開始     / 双方向ストリーム | 1, 5, 9, 13...  | 01                                    |
| クライアント開始 / 単方向ストリーム | 2, 6, 10, 14... | 10                                    |
| サーバー開始     / 単方向ストリーム | 3, 7, 11, 15... | 11                                    |

## 参照
- WEB+DB PRESS Vol.123 HTTP/3入門
