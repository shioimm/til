# DNS
- Domain Name Service
- ドメイン名からIPアドレスを見つけるシステム
- トランスポート層でUDPを利用して実装されている

## 名前解決
- 正引き - ドメイン名 -> IPアドレス
- 逆引き - IPアドレス -> ドメイン名

## DNSの仕組み
1. クライアントがドメインにアクセスを試行する
2. フルリゾルバがルートネームサーバーにリソースレコードを問い合わせる
    - ルートネームサーバーにリソースレコードが存在しない場合は
      ルートネームサーバー以下にゾーンを持つ各ネームサーバーに問い合わせる
3. ネームサーバーがフルリゾルバにIPアドレスを返す
4. フルリゾルバがクライアントにIPアドレスを返す

### リソースレコード
- ドメイン名に関連付けられた情報

| レコード名 | 用途                                           |
| -          | -                                              |
| Aレコード  | ドメイン名とIPアドレスの対応付け               |
| NSレコード | ドメイン名のゾーンを管理するネームサーバー     |
| MXレコード | ドメイン名に紐づくメール受信サーバー           |
| TXT        | このドメイン名のメール送信元サーバー           |
| SOA        | ドメイン名のゾーンの管理情報                   |
| GNAME      | このドメイン名の別名でリソースレコードの参照先 |

### ネームサーバー(DNSコンテンツサーバー / 権威DNSサーバー)
- リソースレコードを管理するホストやソフトウェア
- ネームサーバーは、自身が設置された階層のドメインに関する情報を管理する
  - それぞれのドメインの階層ごとにネームサーバーが配置される
  - ゾーン - 当該ネームサーバーが管理する階層
  - ルートネームサーバー - 回想のルートに設置されているネームサーバー

#### 委任
- 各ネームサーバーが受け持つゾーンのうち、一部を他のネームサーバーに任せること
- ゾーンを委任されたネームサーバーはそのドメインについて権威を持つ
  - サブドメインを作った受け持つゾーンのうちその一部を更に他のネームサーバーに委任することができる

### リゾルバ
#### スタブリゾルバ
- ユーザーの要望を基にフルリゾルバへリクエストを送信し、
  解決したいドメイン名の問い合わせを行うプログラム
- クライアント端末で動作する

#### フルリゾルバ(DNSキャッシュサーバー / フルサービスリゾルバ)
- スタブリゾルバから送信されるリクエストに対して、リソースレコードをネームサーバーに問い合わせを行うサーバー
  - 名前解決した結果はキャッシュに保存しておき、再利用する
  - フルリゾルバは自分よりも更に上位のサーバーへ再帰的にアクセスを行い、
    最終的にそのドメインの権威サーバーへたどり着く

#### TTL
- 名前解決のキャッシュ保持時間
- DNSを切り替えた後、TTLが切れると切り替えが成立する -> DNSが浸透する

## DNSロードバランス
- 一つのドメインに対して複数のAレコードを設定することにより、
  一つのドメインに複数のIPアドレスを割り当てることが可能
  - その場合、ドメインへリクエストが発生した度にレスポンスとなるIPアドレスが変化する
  - この変化を利用して負荷分散を行う(DNSラウンドロビン)

## トラフィックの誘導
- ドメインから他のドメインへマッピングを返すことが可能(CNAME)
- CNAMEを利用すると他の権威サーバーへDNSリクエストを移譲できる

### Akamai(CDN)の事例
- CDNを利用するサーバーのCNAMEにAkamaiが管理するドメインを指定する
  - サーバーへのDNSリクエストをAkamaiの権威サーバーへ移譲する
  - Akamaiの権威サーバーはリクエスト元の地域に応じてその近隣のキャッシュサーバーのIPアドレスを返す

## SRVレコード
- サービスディスカバリーのために利用できるレコード
  - サービスディスカバリー - 特定の機能を持ったサービスを探し出す機能
- サービスの種別からホスト名を探すために利用される
- AWS ECSはSRVを利用したサービスディスカバリー機能を提供する

### レコード項目
- サービスの種別
- プロトコル(TCP / UDP)
- サービスが稼働するドメイン名
- TTL
- 優先度(昇順)
- 重み(同じ優先度の中でのアクセスの割合)
- サービスが稼働するポート番号
- 正確に特定可能なホスト名

## 参照
- DNSをはじめよう ～基礎からトラブルシューティングまで～ 改訂第2版
- サーバ・インフラエンジニアの基本がこれ一冊でしっかり身につく本 3.4
- Real World HTTP 第2版
