# 安全なWebアプリケーションの作り方(脆弱性が生まれる原理と対策の実践) まとめ
- 徳丸浩 著

## 認証
- 認証 -> 利用者が本人であることを何らかの手段で確認すること
  - HTTP認証
    - Basic認証
    - Digest認証
  - フォーム認証
    - フォームによるID/PWの認証
  - クライアント認証
    - TLSクライアント証明書による認証

### [ログイン機能]全般
#### 事例
- SQLインジェクション
  - ログイン機能の迂回
- ソーシャルエンジニアリング
  - ID/パスワードの入手
- フィッシング
  - ID/パスワードの入手

#### 影響
- なりすまし
- 情報漏洩

#### 対策
- セキュリティバグをなくす
  - SQLインジェクション脆弱性
  - セッションIDの固定化
  - クッキーのセキュア属性不備
  - オープンリダイレクト脆弱性
  - HTTPヘッダインジェクション

### [ログイン機能]パスワード
- SQLインジェクション
  - パスワードの入手
- ソーシャルエンジニアリング
  - ID/パスワードの入手
- フィッシング
  - ID/パスワードの入手
- 辞書攻撃 -> ID(固定)に対して使用頻度の高いパスワードを試行
  - パスワードの施行
- ジョーアカウント探索 -> IDと同じパスワードに設定しているアカウントを探索
  - パスワードの施行
- リバースブルートフォース攻撃 -> 使用頻度の高いパスワード(固定)に対してIDを試行
  - パスワードの施行
- パスワードスプレー攻撃 -> IDもパスワードも固定せず少数のパスワード候補をIDを変えながら試行
  - パスワードの施行
- パスワードリスト攻撃 -> 別のサイトから漏洩したID/パスワードの一覧を用いてログイン試行
  - パスワードの施行

#### 対策
- パスワードを予測困難なものにする
  - 暗号論的擬似乱数生成器によるパスワード生成
  - パスワードの文字種・桁数の要件定義
  - パスワードポリシーへのチェック
- 複数回ログイン試行に対するアカウントロック
- 2段階認証の実装
- ログイン失敗率の監視
- パスワード保護
  - パスワードを暗号化して保存する
  - パスワードをメッセージダイジェストとして保存する
    - 任意の長さのデータ(ビット列)を固定長のデータ(メッセージダイジェスト・ハッシュ値)に圧縮する
    - ハッシュ解読対策: ソルト
      - 元データに文字列を追加する(見かけのパスワードを長くする)
      - ある程度の長さを確保し、ユーザーごとに異なるものにする
    - ハッシュ解読対策: ストレッチング
      - ハッシュ化を繰り返し行う
      - 計算速度が遅いハッシュ関数を使う

### [ログイン機能]自動ログイン
- 自動ログインする -> セッションの有効期限が長期化する -> XSS攻撃などの被害に遭いやすくなる
- 自動ログインしない -> ログイン機能が増える -> ユーザーが安全性の低いパスワードを使いがち

#### 事例
- ユーザー名と自動ログインを示すフラグのみクッキーとして管理しているようなサイトにおいて、
  ユーザーがクッキーのユーザー名を変更して他人のアカウントになりすますことができる

#### 対策
- セッションタイムアウトを伸ばす
  - ログイン状態をクッキーの値で管理せず、
    セッションタイムアウトをログインから一週間後などに延長することによってログイン状態を保持する
- トークンを使う
  - ログイン時、クッキーに暗号論的擬似乱数生成器を利用して発行したトークンを保存する
    - Expires属性、HttpOnlu属性、セキュア属性(HTTPSの場合)もつける
  - トークン・ユーザーID・有効期限を持つテーブルに情報を格納する
  - クッキーの保存されたトークンとテーブルの該当行トークンを付き合わせてログイン状態を確認する
  - ログアウト時に該当行を削除する
- チケットを使う
  - ユーザーID・有効期限をサーバー外に持ち出せるようにする
    - Kerberos認証
    - OpenID Connect

### [ログイン機能]ログインフォーム
- パスワード入力欄をマスク表示する
- HTTPSを利用する
  - パスワード入力欄/ログイン処理ページいずれもHTTPS化する

### [ログイン機能]エラーメッセージの要件
#### 事例
- ログイン失敗時、ID/パスワードのどちらが間違っているのかを表示するエラーメッセージによって
  総当たり攻撃を補助してしまう

#### 対策
- エラーメッセージで何が間違っているのかを示さない
```
IDまたはパスワードが間違っています
```
- ID/パスワード入力画面を分け、二段階で入力させる

### [ログイン機能]ログアウト機能
- POSTメソッドでリクエストする
- セッションを破棄する
- CSRF対策の対象とする
