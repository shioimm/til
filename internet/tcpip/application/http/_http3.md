# HTTP/3
## TL;DR
- HTTP/2以上の効率化・高速化のために実装されたプロトコル
- トランスポート層でUDPを使用することにより初回接続時のネゴシエーションを軽量化し、
  アプリケーション層でTCPが担っていた再送処理、輻輳処理などを行う
- TLSの機能を最初から融合している
- TCPのレイヤーで持っているデータ(シーケンス番号など)を隠蔽する
- TCPとHTTPの両方に実装されていたフロー制御機能は一元化された

### QUIC
- Googleで開発されたHTTP/3の基盤となるプロトコル

## レイヤー
- HTTP/3はQUICトランスポート層とHTTP/3の二層構造によって動作する
  - QUICトランスポート層
    - ストリーム制御などTCPの上位互換レイヤーとTLS1.3
  - HTTP over QUIC(HTTP/3)層
    - HTTP/2の機能からQUICトランスポートと重複する機能を落とし、HPACKをQPACKに置き換えたもの

### QUICトランスポートプロトコル
- UDPを元にして再送処理・輻輳制御・暗号化などを実装したもの
  - TCPとTLSのレイヤーの置き換え
- QUICの接続時には一意なコネクションIDが発行され、これを元にストリームの通信を行う
  - HTTP/2まではコネクションを送信アドレス、宛先アドレス、送信元ポート番号、
    宛先ポート番号、プロトコルで識別していた
  - HTTP/3ではコネクションをコネクションIDで識別する
- QUICではストリームごとにフロー制御を行ったり、ウィンドウサイズを変更できる

## HTTP/3での変更
- レイヤーが2層に分かれたためHTTPのフレーム構造がシンプルになった
- ストリームIDのビット数が31ビットから62ビットに増えた
- 各フレームはストリームIDとフラグを持たなくなった
- フラグによって増減するフィールドがなくなった
- ヘッダの圧縮アルゴリズムがHPACKからQPACKに変更された

## フレームタイプ

| タイプ名         | 概要                                           | HTTP/2との相違点                   |
| -                | -                                              | -                                  |
| `DATA`           | リクエスト・レスポンスボディ                   | パディングがなくなる               |
| `HEADERS`        | HTTPヘッダ                                     | 優先度が`PRIORITY`へ移動           |
| `PRIORITY`       | 依存するストリーム、優先度、排他フラグ         | コントロールストリーム上のみ流れる |
| `SETTINGS`       | 接続に関する設定(ストリームID 0で使用)         | コネクションの最初でだけ呼ばれる   |
| `PUSH_PROMISE`   | サーバープッシュ開始の予約                     | -                                  |
| `GOAWAY`         | 最終ストリームID                               | サーバー -> クライアントでのみ送信 |
| `MAX_PUSH_ID`    | クライアントが受け取る可能なPush IDの最大値    | 新規                               |
| `CANCEL_PUSH`    | サーバープッシュの受取拒否                     | 新規                               |
| `DUPLICATE_PUSH` | サーバー -> クライアントの複数の関連リクエスト | 新規                               |

## QPACK
- QUICトランスポートにより、ストリーム内部でのパケット順序は保証されるが
  ストリーム間のパケット順序が保証されなくなった
- そのため、送信順序に依存するHPACKが利用できなくなった
- HPACKの代わりに導入されたQPACKはHPACKのインデックステーブル方式を受け継ぐ
- QPACKは圧縮率を犠牲にしてインデックスの位置を追加で送信する

## 参照
- Real World HTTP 第2版
