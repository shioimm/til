# セッションハイジャッキング
- 第三者がセッショントークンを盗み出し、正規のユーザーに成りすましてログインする
  - セッショントークンの推測
  - セッショントークンの盗出
  - セッショントークンの強制
- XSSや中間者攻撃がセッションハイジャッキングの踏み台とされることが多い

### セッショントークンの推測
#### 発生箇所
- セッショントークンを生成している箇所

#### 影響範囲
- セッション管理を利用している全てのページ

#### 影響の種類
- なりすまし

#### 原因
- 推測されやすいセッション管理機構を利用している

#### 対策
- 信頼できるセッション管理機構を利用する
- Cookieに`httpOnly`属性を付与する(JavaScriptからアクセスできなくなる)
- Cookieに`secure`属性を付与する(HTTPS以外で通信しなくなる)

### セッショントークンの盗出
#### 発生箇所
- セッションIDを生成している箇所

#### 影響範囲
- セッション管理を利用している全てのページ

#### 影響の種類
- なりすまし

#### 原因
- 歴史的経緯などによりセッショントークンがURLに埋め込まれている

#### 対策
- セッショントークンをCookieに保存する
- Cookieに`httpOnly`属性を付与する(JavaScriptからアクセスできなくなる)
- Cookieに`secure`属性を付与する(HTTPS以外で通信しなくなる)
- サブドメインを網羅したHSTSを採用する

### セッショントークンの強制
#### 発生箇所
- 認証処理(ログイン)を行う箇所

#### 影響範囲
- セッション管理を利用している全てのページ

#### 影響の種類
- なりすまし

#### 原因
- セッションアダプション(未知のセッショントークンを受け入れるミドルウェア側の特性)
- Cookieインジェクション
- XSS
- HTTPヘッダインジェクション
- Refererヘッダの悪用

#### 対策
- 認証後にセッショントークンを変更する
- 認証時にトークンを生成し、Cookieとセッション変数両方に記憶させる
  - 各ページの認証時にCookie上のトークンとセッション変数のトークンの比較を行う
- (認証前)hiddenパラメータで値を渡す
- Cookieに`httpOnly`属性を付与する(JavaScriptからアクセスできなくなる)
- Cookieに`secure`属性を付与する(HTTPS以外で通信しなくなる)

## Cookieをターゲットにした攻撃
### Cookieインジェクション
- Secure属性があるCookieをSecure属性がないCookieで上書きする攻撃

#### 直接的な攻撃
- 攻撃者はユーザーが開始する平文のHTTPトランザクションに割り込み、
  標的Webサイトに対して平文でHTTPリクエストを送信させ、
  リクエストヘッダに含まれるCookieを上書きする

#### 親戚関係にあるサブドメインを利用した攻撃
- 攻撃者はユーザーを攻撃対象サイトと別のサブドメインへ誘導し、
  リクエストヘッダに含まれるCookieを上書きする

### Cookie排除
- ブラウザのCookie格納場所に対する攻撃
  - Cookie格納場所の総サイズ上限を超すサイズのダミーCookieを送信することで本物のCookieを一掃し、
    攻撃に必要なものだけを格納場所に強制的に残す

## 参照
- 安全なWebアプリケーションの作り方(脆弱性が生まれる原理と対策の実践)
- Real World HTTP 第2版
- プロフェッショナルSSL/TLS
