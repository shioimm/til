# インターネットPKI
- お互いに会ったことがない者同士での安全な通信を実現するための仕組み
  - PKI - Public Key Infrastructure: 公開鍵基盤
  - X.509 - インターネットPKIの国際標準

## インターネットPKIにおける登場人物
- CA (Certification Authority: 認証局) - 証明書所有者の本人性を保証するための証明書を発行する
- RS (Registration Authority: 登録局) - 証明書所有者とCAの間で証明書発行関連のマネジメントを行う
- 証明書所有者 - 証明書を必要とする安全なサービスを後悔する主体(サーバー)
- 証明書利用者 - 証明書所有者に証明書を要求し、送付された証明書を検証する主体 (クライアント)
- CRLサーバー - 証明書利用者からの証明書失効確認に応答する
- OCSPレスポンダ - 証明書利用者からの証明書失効確認に応答する

## 証明書チェーン
- 個々のサーバーが準備する、信頼の起点となるルートへと連なるチェーン

## 証明書
### 証明書のフィールド
- Version(バージョン) - 証明書のバージョン
- Serial Number(シリアル番号) - あるCAから発行された証明書を一意に識別する番号
- Signature Algorithm(署名アルゴリズム) - 証明書の署名に使われているアルゴリズム
- Public key(公開鍵) - 公開鍵を表現するSubject Public-Key Info構造体
- Validity(有効性) - 有効期限(開始日・終了日の組み)
- Issuer(発行者) - 証明書を発行した主体の識別名(DN: Distinguished Name)
- Subject(主体者) - 証明書の発行を受けた者の公開鍵に紐づけられた団体の識別名(DN: Distinguished Name)
  - 現在はSubjectの代わりにSAN(Subject Alternative Name)拡張が使用される

### 種類
- DV - 被証明者のドメイン証明
- OV - 被証明者のドメイン証明、被証明者の法的な実在証明
- EV - 被証明者のドメイン証明、被証明者の法的な実在証明、被証明者の物理的な実在証明

### 発行元
- 自己認証
- プライベート認証局
- パブリック認証局
  - ルート認証局
  - 中間認証局

### クライアント - サーバー間の認証
- クライアントは予め信頼できるルート認証局の証明書を複数インストールしている
- クライアントは予め自身にインストールされている証明書と
  サーバーから送信されたルート認証局の証明書が一致するかを確認する
  ‐ クライアントにはサーバー証明書とルート認証局の自己証明書が両方送信される
  - 一致した場合、受信した証明書は信頼できると判断する
- クライアントはルート認証局の証明書の中に入っている公開鍵でサーバー証明書に付けられた署名を検証する
  - 一致した場合、受信した証明書は信頼できると判断する

### 証明書作成フロー
1. 秘密鍵・公開鍵の作成(SSLライブラリを使用する)
    - 暗号化アルゴリズム・鍵の長さを選択
    - 秘密鍵にはパスワードをかけ、公開しないようにする
    - 公開鍵は秘密鍵と同時に作成されたり、CSR作成時に作成されたりする
2. CSRの作成
    - Certificate Signing Request(証明書署名要求)
    - 証明したい情報を入力する
3. 証明書の作成
    - [自己署名の場合] CSRから証明書を作成
    - [認証局署名の場合] CSRを認証局に送付し、証明書の発行を待つ
4. 証明書の設置
    - 証明書をサーバー上に配置する

### 証明書認証フロー
0. 認証局がサーバーにSSL証明書を発行する
1. クライアントがサーバーからSSL証明書を取得する
2. クライアントが認証局へSSL証明書の信頼性を確認する
3. クライアントが共通鍵を作成し、SSL証明書内の公開鍵で暗号化
4. サーバーが暗号化された鍵を複製する
5. サーバー・クライアントが複合した鍵で通信を行う

### 証明書の失効
- 証明書は対応する秘密鍵が危殆化した場合や、すでに必要がなくなった場合に失効する
- 証明書は自身が失効したかどうかを確かめる方法を証明書自身に内包する
  - CRL(Certificate Revocation List: 証明書失効リスト)
  - OCSP(Online Certificate Status Protocol: オンライン証明書状態プロトコル)

#### CRL
- まだ期限切れになっていないが失効した証明書のシリアル番号を一覧にしたもの
- 証明書に対応するCRLの場所はCRL配布点(CRL Distribution Points)拡張として格納される

#### OCSP
- 単一の証明書の失効状態を証明書利用者が取得できるようにする仕組み
- OCSPのサーバーはOCSPレスポンダと呼ばれる
- CAのOCSPレスポンダの場所はAuthority Information Access拡張にエンコードされる
- OCSPステープリング - 各サーバーがOCSPレスポンスをTLSハンドシェイクに埋め込めるようにする機能

### 証明書拡張
- 証明書のフォーマットに柔軟性を持たせるための機能
- 一意の識別子オブジェクト(OID:object identifier) + 拡張子の重要度(critical) + 値(ASN.1構造体)で構成される

| 拡張名                       | 機能                                                                         |
| -                            | -                                                                            |
| Subject Alternative Name     | 公開鍵を結び付ける主体を柔軟に指定する                                       |
| Name Constraints             | CAが証明書を発行できる主体に制約を課す                                       |
| Basic Constraints            | CA証明書であることを示す、または下位CAの証明書パスの深さを制御する           |
| Key Usage                    | 証明書に含まれる鍵の用途を規定する                                           |
| Extended Key Usage           | 公開鍵に任意の用途を追加で指定できるようにする                               |
| Certificate Policies         | 一つ以上のポリシー(OID - 限定子)を格納する                                   |
| CRL Distribution Points      | CRL(Certificate Revocation List: 証明書失効リスト)の場所を示す               |
| Authority Information Access | 証明書を発行するCAが提供している付加的な情報やサービスへのアクセス方法を示す |
| Subject Key Identifier       | 特定の公開鍵を含む証明書を識別するために利用可能な一意の値を含む             |
| Authority Key Identifier     | 証明書に対する署名の鍵を一意に特定できる識別子を含む                         |

### 証明書発行手順
1. OpenSSLで秘密鍵を生成
```
$ openssl genrsa -out ./xxx.key 2048`
$ chmod 600 ./xxx.key
```

2. 秘密鍵からCSR(証明書署名リクエスト)を作成
```
$ openssl req -new -key xxx.key -out xxx.csr
```
3. 認証局にCSRを提出しSSL証明書の発行を依頼
  - FujiSSL
4. CAによる審査・証明書の発行
5. CAから発行される値でネームサーバー上にTXTレコードを作りDNS認証
6. SSL証明書・中間CA証明書が届く
    - SSL証明書(`.crt`)
    - 中間CA証明書(`.ca`)
    - SSL証明書 + 中間CA証明書
7. WebサーバーにSSL証明書・中間CA証明書を設置
    - 証明書を一ファイルにまとめる(`$ awk 1 xxx.crt yyy.ca > zzz.crt`)
8. Webサーバー上にHTTPSのバーチャルホストを作成
    - 秘密鍵・SSL証明書 + 中間CA証明書・暗号スイート・TLSプロトコルバージョンを指定

## CAA(Certification Authority Authorization)レコード
- 運営者以外の第三者が証明書を勝手に発行することを防止するための仕組み
- 該当のドメインの証明書を発行できる認証局を事前に設定しておく

## SSLターミネーション
- Webサーバー手前のロードバランサーに証明書を設置する手法
- ロードバランサーとWebサーバー間はHTTPで通信を行う

## 参照
- [How is data secure over https?](https://blog.joshsoftware.com/2019/08/23/how-is-data-secure-over-https/)
- よくわかるHTTP/2の教科書P18-20/124-125
- SSLをはじめよう ～「なんとなく」から「ちゃんとわかる！」へ～
- [図解で学ぶネットワークの基礎：SSL編](https://xtech.nikkei.com/it/article/COLUMN/20071002/283518/)
- ハイパフォーマンスブラウザネットワーキング
- サーバ／インフラエンジニアの基本がこれ1冊でしっかり身につく本 3.6
- 食べる！SSL！　―HTTPS環境構築から始めるSSL入門
- プロフェッショナルSSL/TLS
