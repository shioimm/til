# プロトコルの階層
- TLS Record + TLS Handshake(Handshake + ChangeCipherSpec + Alert + アプリケーションデータプロトコル)

## TLS Recordプロトコル
- メッセージの圧出、暗号化、転送、認証を行う
  - 共通鍵暗号(ハイブリッド暗号)とMACを使用する
  - 使用する共通鍵・アルゴリズムはHandshakeプロトコルレイヤーでネゴシエーションを行うことによって決定される
  - その他の機能はサブプロトコルによって行う

#### 動作フロー
1. メッセージを複数の小さなフラグメントに分割し圧縮
    - 圧縮アルゴリズムはネゴシエーションで決定する
2. フラグメントにMACを付加
    - ハッシュ関数アルゴリズムと共通鍵はネゴシエーションで決定する
3. 圧縮したフラグメントとMACを合わせて暗号化(CBCモード)
  　- 暗号化アルゴリズムと共通鍵はネゴシエーションで決定する
4. `3`にヘッダ(データタイプ・バージョン番号・圧縮した長さ)を追加して送信

#### TLSレコード定義
- TLSレコード = ヘッダ + メッセージデータ
  - ヘッダ - コンテントタイプ・プロトコルバージョン・レコード長
- 最大レコードサイズは16KB
  - 16KBよりも大きいバッファは小さなチャンクへと分割される
  - 16KBよりも小さいバッファは複数のバッファから単一のレコードにまとめられる
  - 各レコードは5バイトのヘッダ、32バイトのMAC、ブロック暗号利用時はパディングが付与される
- 暗号を解読してレコードを検証するためにはレコード全体が必要となる

```c
struct {
  uint8 major;
  uint8 minor;
} ProtocolVersion;

enum {
  change_cipher_spec (20),
  alert              (21),
  handshake          (22),
  application_data   (23)
} ContentType;

struct {
  ContentType     type;
  ProtocolVersion version;
  uint16          length;                         // 最長 2^14 (16,384) バイト
  opaque          fragment[TLSPlaintext.length];  // 書式が定まっていない(opaque)データのバッファ
} TLSPlaintext;

// その他に64ビットのシーケンス番号が割り当てられる
```

## TLS Handshakeプロトコル
- TLS Recordプロトコルの上位プロトコル

### Handshakeプロトコル
- クライアント・サーバー間でアルゴリズムと共通鍵のネゴシエーションを行うプロトコル

#### 役割
1. 双方のピアが接続で使いたいパラメータを提示し、互いに合意する
2. 提示された証明書か他の方法を使って認証を行う
3. セッションの保護に使うマスターシークレット(master secret)を共有する
4. ハンドシェイクのメッセージ群が第三者によって書き換えられていないことを検証する

#### Handshakeレコード定義
```c
struct {
   HandshakeType    msg_type; // メッセージの種類
   uint24           length;   // メッセージの長さ
   HandshakeMessage message;
} Handshake;

// メッセージの残りの部分はメッセージの種類によって異なる
```

#### マスターシークレット(鍵素材)
- クライアント・サーバー間で合意した鍵
- プリマスターシークレット + クライアントランダム + サーバーランダムの値から計算する
  - クライアントランダム + サーバーランダムはソルトの役割を果たす
  - 暗号スイートで決められたハッシュ関数で作った擬似乱数生成関数で計算する
```
master_secret = PRF(pre_master_secret, "master secret", client_random + server_random)
```

- マスターシークレットから鍵ブロック(通鍵暗号の鍵・MACの鍵・初期化ベクトル)を生成する
  - 共通鍵暗号の鍵(クライアント -> サーバー)
  - 共通鍵暗号の鍵(サーバー -> クライアント)
  - MACの鍵(クライアント -> サーバー)
  - MACの鍵(サーバー -> クライアント)
  - GCMモードやCCMモードで用いる初期化ベクトルの一部(クライアント -> サーバー)
  - GCMモードやCCMモードで用いる初期化ベクトルの一部(サーバー -> クライアント)
```
key_block = PRF(master_secret, "key expansion", server_random + client_random)
```

### ChangeCipherSpecプロトコル
- Handshakeプロトコルによるネゴシエーションの合意後、暗号通信への切り替え通知を行うプロトコル
- ハンドシェイク中に双方のピアから送信されるChangeCipherSpecメッセージを定義する

### Alertプロトコル
- 異常通知・接続終了のためのプロトコル
- 通信中の相手に例外的な状況を伝える

#### Alertレコード定義
```c
struct {
  AlertLevel level;
  AlertDescription description;
} Alert;

// 接続終了時はどちらかのピアがclose_notifyアラートを送信する
```

### アプリケーションデータプロトコル
- TLSの上位レイヤーであるアプリケーションのデータを通信相手に伝えるプロトコル
- アプリケーションのデータはセキュリティパラメータに従い、
  Recordプロトコルのレイヤーでパッケージ化、細分化、暗号化される

## 参照
- プロフェッショナルSSL/TLS
- 暗号技術入門 第3版
