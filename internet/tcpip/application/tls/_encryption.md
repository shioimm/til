# 暗号技術
## 暗号方式
### ストリーム暗号化方式
- 平文をバイト単位で暗号化する
  - 鍵ストリーム(ランダムなデータの無限列)の指定バイトと平文の指定バイトとの排他的論理和を取る
  - 同じ鍵ストリームと暗号文との排他的論理和を求めることによって復号が可能

#### 作り方
1. TLSレコードのシーケンス番号、Recordヘッダ、平文データを結合したもののMACを計算する
2. MACと平文データとを暗号化することで暗号文をつくる

```
                  ----------------------------------
                  | シーケンス番号 | ヘッダ | 平文 |
           -----------------------------------------
           | 平文 |               MAC              |
----------------------------------------------------
|  ヘッダ  |                 暗号文                |
----------------------------------------------------
```

### ブロック暗号化方式
- データの塊(ブロック)をまとめて暗号化する
  - 固定長の平文を入力として受け取り、平文と同じ長さの暗号文を出力する

#### 暗号化利用モード
- ブロック暗号化方式を拡張して任意の長さのデータを暗号化できるようにした処理

#### 作り方
1. TLSレコードのシーケンス番号、Recordヘッダ、平文データを結合したものMACを計算する
2. 暗号化する前のデータの長さが暗号化ブロックの長さの整数倍になるようにパディングを作る(16バイトのブロック長)
3. 暗号化ブロックと同じ長さで、IV(Initialization Vector: 初期化ベクター)を生成する
    - IVにより、同じ平文から異なる暗号文を生成できる
4. 平文データ、MAC、およびパディングをCBCモードで暗号化する
5. IVと暗号文を一緒に送る

```
                      ----------------------------------
                      | シーケンス番号 | ヘッダ | 平文 |
               ------------------------------------------------------
               | 平文 |               MAC              | パディング |
---------------------------------------------------------------------
|  ヘッダ | IV |                        暗号文                      |
---------------------------------------------------------------------
```

### AHEAD
- Authenticated Encryption with Associated Data: 認証付き暗号
- 暗号化および完全性の検証を1つのアルゴリズムにまとめたもの
- nonce(乱数)を使用する

#### 作り方
1. 64ビットのnonceを作る
2. 平文データをAEADのアルゴリズムで暗号化する
    - 完全性を検証するための付加的なデータとしてシーケンス番号とRecordヘッダも暗号化アルゴリズムに渡す
3. nonceと暗号文を一緒に送る

```
                  ---------------------------    --------
                  | シーケンス番号 | ヘッダ |    | 平文 |
---------------------------------------------------------
|  ヘッダ | nonce |                 暗号文              |
---------------------------------------------------------
```

## 鍵生成
1. マスターシークレットおよびシードから、PRFを一回適用して鍵ブロックを生成する
2. 鍵ブロックを最大6個に分割する
    - MAC鍵2つ
    - 暗号鍵2つ
    - IV2つ(必要時)

### 擬似乱数生成器
- PRF(pseudorandom function)
- シークレット、シード、一意なラベルを引数に取り、任意の長さの疑似乱数を生成する

### マスターシークレット
- 鍵交換プロトコルから得られるプリマスターシークレット値を、PRFを使って処理することで生成する48バイト(384ビット)の値

## 暗号スイート
- 認証の種類
- 鍵交換の種類
- 暗号化アルゴリズム
- 暗号鍵の長さ
- 暗号化利用モード
- MACのアルゴリズム
- PRF
- Finishedメッセージで使うハッシュ関数
- `verify_data`構造体の長さ

```
TLS_鍵交換_認証_WITH_アルゴリズム_長さ_モード_MACまたはPRF
                     -----------------------
                               暗号
```

#### ハッシュ関数
- 任意の長さの入力を受け取り、固定長の出力へと変換するアルゴリズム
- ハッシュ値(フィンガープリント・メッセージダイジェスト) - ハッシュ関数が出力したもの

#### 暗号学的ハッシュ関数に求められる性質
- 原像計算困難性(Preimage resistance)
- 第2原像計算困難性(Second preimage resistance)
- 衝突耐性(Collision resistance)

## 暗号化アルゴリズム
### 共通鍵暗号化方式
#### DES
- Data Encryption Standard
- ブロック暗号方式
- 固定長64ビット
- 鍵長が短いため総当りで短時間に解析可能
- 安全性を上げるためDESを3回繰り返す3DESを利用することが推奨される

#### AES
- Advanced Encryption Standard
- ブロック暗号(固定長の平文を入力し、平文と同じ長さの暗号文を出力する)方式
- 固定長128ビット、192ビット、256ビットから選択可能
- DESよりも強固で高速な暗号化を目的とする(3DESより高速)

##### RC4
- Rivest Cipher 4
- ストリーム暗号方式
- 中間者攻撃を受けると情報が復号化されてしまう恐れが指摘されている

### 公開鍵暗号化方式
#### RSA
- 素因数分解問題(桁数が大きい素数2つをかけ合わせた数から各素数の値を求めるのは困難)を利用した方式

#### DH/DSS
- Diffie-Hellman key exchange(DH鍵交換) - 鍵合意に使用される
- Digital Signature Standard(デジタル署名標準) - デシタル署名に使用される
- DH/DSSの組み合わせによりRSAと同じ公開鍵暗号化方式の働きをする
- DH単体では中間者攻撃に弱いため単体で使用することは推奨されない

### MACアルゴリズム
- ハッシュアルゴリズムが使用される
  - ある入力に対して常に同じ値を出力し、どの入力にも偏らず一様に分布する結果を返す性質を持つ
  - ハッシュ値からは入力値を求めることができない(復号化できない)

#### MD5
- 入力に対して128ビットのハッシュ値を生成する
- 手軽に扱えるが脆弱性があり、異なる入力値から同じ値を容易に生成できるため非推奨

#### SHA-1
- 入力に対して160ビットのハッシュ値を生成する
- 衝突困難性に対する脆弱性があり、SHA-2への移行が推奨される

#### SHA-2
- SHA-224、SHA-256、SHA-384、SHA-512、SHA-512/224、SHA-512/256の総称
- SHA-移行の数値が出力するハッシュ値にビット数と一致する
- 現在主流のハッシュアルゴリズム

## 参照
- 食べる！SSL！　―HTTPS環境構築から始めるSSL入門
- プロフェッショナルSSL/TLS
