# SSL証明書
## 証明書が含む情報
- サイトのドメイン名
- 認証用の公開鍵
- 認証局
- 目的(サーバー認証)

## 役割
- なりすまし防止
  - レスポンスが正しいサーバーから送信されたことを認証する
- データの改ざん防止
  - リクエストデータが送信中に改ざんされていないことを確認する
  - レスポンスデータが送信中に改ざんされていないことを確認する
- 情報漏洩防止
  - リクエストデータが漏洩しないように暗号化する
  - レスポンスデータが漏洩しないように暗号化する

## サーバー証明書
### クライアント - サーバー間の認証
- クライアントは予め信頼できるルート認証局の証明書を複数インストールしている
- クライアントは予め自身にインストールされている証明書と
  サーバーから送信されたルート認証局の証明書が一致するかを確認する
  (クライアントにはサーバー証明書とルート認証局の自己証明書が両方送信される)
  一致したら受信した証明書は信頼できると判断する
- クライアントはルート認証局の証明書の中に入っている公開鍵でサーバー証明書に付けられた署名を検証する
  一致したら受信した証明書は信頼できると判断する

### 種類
- DV証明書 - ドメインの所有確認
- OV証明書 - ドメインの所有確認、発行先の組織の存在を示す
- EV証明書 - ドメインの所有確認、発行先の組織の存在をガイドラインに従って厳格に示す

### フロー
0. 認証局がサーバーにSSL証明書を発行する
1. クライアントがサーバーからSSL証明書を取得する
2. クライアントが認証局へSSL証明書の信頼性を確認する
3. クライアントが共通鍵を作成し、SSL証明書内の公開鍵で暗号化
4. サーバーが暗号化された鍵を複製する
5. サーバー・クライアントが複合した鍵で通信を行う

### 証明書の失効
- 証明書は自身の失効を確かめる方法を証明書自身に内包する
  - 証明書失効リスト(CRL)
  - オンライン証明書状態プロトコル(OCSP)

### 証明書発行手順
1. OpenSSLで秘密鍵を生成
```
$ openssl genrsa -out ./xxx.key 2048`
$ chmod 600 ./xxx.key
```

2. 秘密鍵からCSR(証明書署名リクエスト)を作成
```
$ openssl req -new -key xxx.key -out xxx.csr
```
3. 認証局にCSRを提出しSSL証明書の発行を依頼
  - FujiSSL
4. CAによる審査・証明書の発行
5. CAから発行される値でネームサーバー上にTXTレコードを作りDNS認証
6. SSL証明書・中間CA証明書が届く
    - SSL証明書(`.crt`)
    - 中間CA証明書(`.ca`)
    - SSL証明書 + 中間CA証明書
7. WebサーバーにSSL証明書・中間CA証明書を設置
    - 証明書を一ファイルにまとめる(`$ awk 1 xxx.crt yyy.ca > zzz.crt`)
8. Webサーバー上にHTTPSのバーチャルホストを作成
    - 秘密鍵・SSL証明書 + 中間CA証明書・暗号スイート・TLSプロトコルバージョンを指定

### 証明書の記載内容
- 参照: サーバ／インフラエンジニアの基本がこれ1冊でしっかり身につく本 3.6
- 主体者(申請者)
- 主体者の公開鍵
- 発行元
- 有効期間

### CAA(Certification Authority Authorization)レコード
- 運営者以外の第三者がSSL証明書を勝手に発行することを防止するための仕組み
- 該当のドメインの証明書を発行できる認証局を事前に設定しておく

### SSLターミネーション
- Webサーバー手前のロードバランサーにSSL証明書を設置する手法
- ロードバランサーとWebサーバー間はHTTPで通信を行う

## 参照
- [How is data secure over https?](https://blog.joshsoftware.com/2019/08/23/how-is-data-secure-over-https/)
- よくわかるHTTP/2の教科書P18-20/124-125
- SSLをはじめよう ～「なんとなく」から「ちゃんとわかる！」へ～
- [図解で学ぶネットワークの基礎：SSL編](https://xtech.nikkei.com/it/article/COLUMN/20071002/283518/)
- ハイパフォーマンスブラウザネットワーキング
- 食べる！SSL！　―HTTPS環境構築から始めるSSL入門
