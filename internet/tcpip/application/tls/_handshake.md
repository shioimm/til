# ハンドシェイク
- TLSを使ったデータの交換の前にクライアント・サーバー間に暗号化されたトンネルを確立する

## ハンドシェイクで実行すること
1. 暗号化アルゴリズムの合意
2. サーバーの認証
3. データ転送で使用する鍵の確立
4. ハンドシェイクが正しく行われたことの確認

## 動作フロー
1. クライアント -> サーバー
    - 暗号化鍵とMAC鍵の生成に用いる乱数を生成
    - クライアントが対応している暗号化スイートのリストと生成した乱数を送付
      - SSLのバージョン
      - サーバー認証アルゴリズム
      - データ転送で使用するデータ保護用の共通鍵暗号方式アルゴリズム
      - データ転送で使用するデータの完全性を確認するためのMACアルゴリズム
      - 圧縮アルゴリズム
2. サーバー -> クライアント
    - 暗号化鍵とMAC鍵の生成に用いる乱数を生成
    - 使用するアルゴリズムの合意、サーバーの公開鍵を含む証明書、生成した乱数を送付
3. クライアント
    - サーバーの証明書を確認
    - ランダムな文字列を生成し、2つの乱数と鍵生成関数を使用して暗号化鍵とMAC鍵を生成
    - 暗号化鍵とMAC鍵を生成するために使用したランダムな文字列をサーバーの公開鍵で暗号化
4. クライアント -> サーバー
    - 暗号化されたランダムな文字列を送付
5. サーバー
    - 暗号化されたランダムな文字列を自身の秘密鍵で複合
    - クライアントと同じ鍵生成関数を使用し、2つの乱数とランダムな文字列から暗号化鍵とMAC鍵を生成
6. クライアント / サーバー(ハンドシェイクの終了確認)
    - 互いに合意したMACアルゴリズムと生成したMAC鍵でMACを取得
    - 互いに合意した暗号化アルゴリズムと生成した暗号化鍵でMACを暗号化し、送付
    - 互いに受信したデータに対し、自ら生成した暗号化鍵で復号化したMACと自ら生成したMACが等しいことを確認
7. クライアント / サーバー(データ転送)
    - ハンドシェイク完了後はフラグメントに分割されたデータをそれぞれ暗号化して送付
    - フラグメントごとに検証用のヘッダとMACを付加する
    - ヘッダにはSSLのバージョン、Content-Type、Content-Lengthを含む

## 参照
- [How is data secure over https?](https://blog.joshsoftware.com/2019/08/23/how-is-data-secure-over-https/)
- よくわかるHTTP/2の教科書P18-20/124-125
- SSLをはじめよう ～「なんとなく」から「ちゃんとわかる！」へ～
- [図解で学ぶネットワークの基礎：SSL編](https://xtech.nikkei.com/it/article/COLUMN/20071002/283518/)
- ハイパフォーマンスブラウザネットワーキング
- 食べる！SSL！　―HTTPS環境構築から始めるSSL入門
