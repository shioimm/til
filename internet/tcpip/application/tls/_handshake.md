# TLSハンドシェイク
## 種類
- 認証を伴うフルハンドシェイク
- 前回のセッションを再開するセッションリザンプション
- クライアントとサーバの認証を伴うハンドシェイク

## フルハンドシェイク
- クライアント・サーバーがそれ以前にセッションを確立したことがない場合、フルハンドシェイクを実行する必要がある
1. クライアント -> サーバー: ClientHello
    - 使用できるバージョン番号、現在時刻、クライアントランダム、セッションID(初期値はNULL)、
      使用できる暗号スイート一覧、使用できる圧縮方法一覧を送信
    - ClientHelloは新規にコネクションを開始するとき、再ネゴシエーションするとき、
      サーバーからの再ネゴシエーションの要求(HelloRequest)に応えるときに送信される
2. サーバー -> クライアント: ServerHello
    - 使用するバージョン番号、現在時刻、サーバーランダム、セッションID(サーバーが生成した値)、
      使用する暗号スイート、使用する圧縮方法を送信
3. サーバー -> クライアント: Certificate
    - X.509証明書チェーンを送信(X.509証明書以外の形式でも可)
    - チェーンの先頭はサーバー証明書、その次に中間証明書、末尾にルート証明書がつくがルート証明書は不要なので省くべき
    - クライアントはX.509証明書チェーンを検証する
4. サーバー -> クライアント: ServerKeyExchange(optional)
    - 使用する暗号スイートの内容によって必要な場合、追加の情報を送信
5. サーバー -> クライアント: CertificateRequest(optional)
    - クライアント認証を行う場合、サーバーが理解できる証明書のタイプ・認証局の名前一覧を送信
6. サーバー -> クライアント: ServerHelloDone
7. クライアント -> サーバー: Certificate(optional)
    - クライアント認証を行う場合、証明書を送信
    - サーバーは証明書を検証する
8. クライアント -> サーバー: ClientKeyExchange
    - 暗号スイートがRSAを用いる場合、暗号化したプリマスターシークレット(乱数)を送信
    - 暗号スイートがDH鍵交換を用いる場合、Diffie-Hellman公開値を送信
    - サーバーとクライアントはプリマスターシークレットを用いてマスターシークレットを計算
    - サーバーとクライアントマスターシークレットを用いて共通鍵暗号の鍵・MACの鍵・初期化ベクトルの一部を作成
9. クライアント -> サーバー: CertificateVerify
    - クライアント認証を行う場合、クライアント証明書の秘密鍵を持っていることを通知
10. クライアント -> サーバー: ChangeCipherSpec
11. クライアント -> サーバー: Finished
    - `verify_data`フィールドを含む
12. サーバー -> クライアント: ChangeCipherSpec
13. サーバー -> クライアント: Finished
    - `verify_data`フィールドを含む
14. アプリケーションデータプロトコルへ移行
15. Alertによって異常の発生を通信相手に通知する
166. AlertによってSSL/TLSの終了を伝え、SSL/TLSセッションを終了する

#### `verify_data`
- クライアントとサーバがそれぞれ受信したハンドシェイクメッセージのすべてをハッシュ化したもの、
  `finished_label`(クライアントは`client finished`、サーバーは`server finished`)、
  マスターシークレットを組み合わせて擬似乱数生成器にかけて計算したもの

```
verify_data = PRF(master_secret, finished_label, Hash(handshake_messages))
```

- Finishedメッセージは暗号化されており、ネゴシエーション済みのMACによって真正性が保証されている

#### 暗号スイート
- 認証の種類
- 鍵交換の種類
- 暗号化アルゴリズム
- 暗号鍵の長さ
- 暗号化利用モード(適用可能な場合)
- MACアルゴリズム(適用可能な場合)
- 擬似乱数生成器
- Finished メッセージで使うハッシュ関数
- `verify_data`構造体の長さ

```
TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256

// TLS_鍵交換_認証_WITH_アルゴリズム_長さ_暗号化モード_MACまたは擬似乱数生成器
```

## セッションリザンプション
- 一意のSession IDを使ってセッションの再開を可能にする仕組み
- Session IDはサーバーからクライアントへ、ServerHelloを利用して送信される
- クライアントとサーバーはフルハンドシェイクによって確立した接続の終了後、Session IDを一定期間保持する
1. クライアント -> サーバー: ClientHello
    - セッションを再開する場合、 ClientHelloメッセージに適切なSession IDを含めて送信
2. サーバー -> クライアント: ServerHello
    - 当該セッションを再開する場合、同じSession IDをServerHelloメッセージに含めて送信
3. サーバー -> クライアント: [ChangeCipherSpec]
    - 以前共有したマスターシークレットを使って新しい暗号鍵(暗号化に使う鍵やMAC鍵)を生成
    - サーバー側で暗号通信に切り替え、その旨をクライアントに送信
4. サーバー -> クライアント: Finished
    - 送信および受信したハンドシェイクメッセージのMACを送信
5. クライアント -> サーバー: [ChangeCipherSpec]
    - 以前共有したマスターシークレットを使って新しい暗号鍵(暗号化に使う鍵やMAC鍵)を生成
    - クライアント側で暗号通信に切り替え、その旨をサーバーに送信
6. クライアント -> サーバー: Finished
    - 送信および受信したハンドシェイクメッセージのMACを送信

## 参照
- プロフェッショナルSSL/TLS
- 暗号技術入門 第3版
