# IP
- IPアドレスを元に、インターネット全体にパケットを送り届けるためのプロトコル
  - インターネットに接続されるすべてのノード(ホスト・ルーター)は必ずIP・TCPの機能を実装する
  - インターネットに接続されるノード以外の機器(ブリッジ・リピータ・ハブ)はIP・TCPの機能を実装する必要はない
    - ノード以外の機器はIPパケットを単なるビット列やフレームとして扱うため
- コネクションレス指向・信頼性を担保しない・ベストエフォート通信
  - 機能の簡略化と高速化のため
- IPデータグラムは20-60バイトのヘッダを持ち、宛先ホストのアドレスや送信元のアドレスを扱う

## ルーティング(経路制御)
- 宛先IPアドレスのホストまでパケットを届けるための仕組み
- IPの経路制御はホップバイホップルーティング(1区間ごとに次のルートが決定される)によって行われる

### ルーティングテーブル(経路制御表)
- ノードはルーティングテーブルを保持・更新する
- ノードはルーティングテーブルに基づき、データグラムをルーターに向かって送出する
- IPはルーティングテーブルが正しい前提で機能するが、
  実際にルーティングテーブルが正しいかどうかを調べる機能を持たない
  - ルーティングテーブルが正しいかどうかはICMPが調べる

## パケットの分割処理
- IPのデータグラムサイズがデータリンクのMTUよりも大きい場合、
  IPがデータグラムを分割し、1データグラムあたりのサイズを小さくする
- 分割されたデータグラムはオフセットフィールドに元のデータグラム内での位置を持つ
- 分割されたデータグラムは宛先のIPによって復元される

## 送受信バッファ
- ホストマシン・ルーターはIPパケットを送受信するための送信バッファ・受信バッファを持つ
  IPパケットはホストマシン・ルーターの送受信バッファを介して転送される
- ホストマシン・ルーターの送受信バッファの実体はメモリ
- ホストマシン・ルーターの送受信バッファはキュー構造になっている

### 送受信バッファの利点
- 伝送速度が異なるネットワークに対応できる
- 送信先が異なるパケットが混在できる
- 処理能力が異なるホストに対応できる
- パケットの流量の変動に対応できる

## IPアドレス
- 終端ノードを示す識別子
- ネットワークインターフェースごとに割り当てられる
  - ホストには1つ以上、ルーターには2つ以上のIPアドレスが割り当てられる
- `ネットワーク部 . ホスト部 / プレフィックス長`
  - ネットワーク部はデータリンクのセグメントごとに重複しない値が割り当てられる
    - 同じセグメントに接続されているノードのネットワークインターフェースには同じ値が設定される
    - IPパケットが途中のルーターで転送される際は宛先IPアドレスのネットワーク部を利用する
  - ホスト部は同一セグメント内で重ならない値が割り当てられる
- グローバルIPアドレスはICANNによって全世界的に一元管理される

### ネットワーク部とホスト部の区切り方
#### クラスによる区切り(初期のIPで使用)
- Aクラス - 先頭1ビットが0、先頭から8ビットまでがネットワーク部
  - 0.0.0.0 ~ 127.255.255.255.255
- Bクラス - 先頭2ビットが10、先頭から16ビットまでがネットワーク部
  - 128.0.0.0 ~ 191.255.255.255.255
- Cクラス - 先頭3ビットが110、先頭から24ビットまでがネットワーク部
  - 192.0.0.0 ~ 223.255.255.255.255
- Dクラス - 先頭4ビットが1110、先頭から32ビットまでがネットワーク部
  - 224.0.0.0 ~ 239.255.255.255.255

#### CIDR(Classless InterDomain Routing)による区切り
- クラスA・B・Cのネットワークを小さく区切るサブネットワークアドレスを利用する
  - ホスト部をサブネットワークアドレス部として使うことにより複数の物理ネットワークに分割する
  - サブネットマスク - IPアドレスと同じ構造を持つ32ビットの正値
    - ネットワーク部を表すビット数と同じ桁の部分が1
    - ホスト部を表すビット数と同じ桁の部分が0
- プレフィックス長を用いてネットワークIDとホストIDの区切りを示す(CIDR記法)

```
192.0.2.1/24

192.0.2.0     - ネットワーク部
       .1     - ホスト部
          /24 - プレフィックス長
```

### IPv4アドレス
- 32ビットサイズ(ドット区切りの10進数)
- ループバックアドレス - 127.0.0.1
- IPv4ワイルドカード - 0.0.0.0
  - 自ホストの全てのIPアドレス宛のUDPデータグラム・TCP接続要求を処理する

### IPv6アドレス
- 128ビットサイズ(コロン区切りの16ビットの16進数)
  - 先頭数ビットはフォーマットプレフィックスを用いてアドレス種類を示す
- ループバックアドレス - ::1
- IPv6ワイルドカード - 0::0
- IPv4射影IPv6アドレス - IPv4にのみ対応しているホストと通信する際のIPv4-mappedアドレス

### ブロードキャストアドレス
- 同一リンクに接続されたすべてのホストにパケットを送信するためのアドレス
- ホスト部のビットを全て1にしたもの

#### ローカルブロードキャスト
- 自身が属しているリンク内のブロードキャスト

#### ダイレクトブロードキャスト
- 異なるIPネットワークへのブロードキャスト

### マルチキャストアドレス
- 特定のグループに属する全てのホストにパケットを送信するために利用されるクラスDのIPアドレス
- 先頭1110を除くネットワーク部28ビットでマルチキャストの対象となるグループ番号を示す
  - 224.0.0.0 ~ 239.255.255.255
  - 224.0.0.0 ~ 224.0.0.255までは経路制御されず、同一リンク内でもマルチキャストになる

## 参照
- Linuxプログラミングインターフェース 58章
- Software Design 2021年5月号 ハンズオンTCP/IP
- マスタリングTCP/IP 入門編
