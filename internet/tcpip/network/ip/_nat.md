# NAT
- Network Address Translation
- 少数のグローバルIPアドレスを多数のプライベートIPアドレスで共有するための仕組み
  - LAN内の特定のノード(NATノード)のみがグローバルアドレス・プライベートアドレスを持つ
  - LAN内のNATノード以外のノードはプライベートアドレスのみを持つ
  - 外部との通信を行う際はNATノードがアドレス変換を行い通信を中継する
    - 内部アドレス       - LANにおけるアドレス
    - 外部アドレス       - インターネットにおけるアドレス
    - ローカルアドレス   - NATによって変換する前のアドレス
    - グローバルアドレス - NATによって変換した後のアドレス

#### プライベートアドレスの範囲
- クラスA - 10.0.0.0 ~ 10.255.255.255
- クラスB - 172.16.0.0 ~ 172.31.255.255
- クラスC - 192.168.0.0 ~ 192.168.255.255

## 種類
### スタティックNAT
- 変換前アドレスと変換後アドレスが1対1で対応する
- 主にLAN側に設置している特定のWebサーバーをインターネットに公開する際に使用される

### ダイナミックNAT
- 変換前アドレスと変換後アドレスが多対多で対応する
- アドレス変換の際、アドレスプールの中からその時点で使われていないアドレスが選択される
  - アドレスプール - 使用可能なアドレスの範囲

### PAT(Port Address Translation / IPマスカレード / NAPT)
- 変換前アドレスと変換後アドレスが多対1で対応する
- アドレス変換の際、アドレスとポート番号を組み合わせて使用する
  - 同一のグローバルアドレスでもポート番号によってLAN側のクライアントPCを区別することができる

## Source NAT
- LAN -> インターネット方向の通信におけるNAT
- パケットの送信元をLAN内のプライベートアドレスからルーターのグローバルアドレスへ変換する
- 送信元がプライベートアドレス、送信先がグローバルアドレスであるケースにおいてルーターによって実行される
  - ルーターは送信元のプライベートアドレスとポート番号を書き換え、記録する
  - ルーターは送信先から返ってきたパケットの送信先を送信元のプライベートアドレスとポートへ書き換える
  - アドレスを書き換えるためのルールはルータープロセスにて`iptables(1)`を使用して設定する

## Destination Nat
- インターネット -> LAN方向の通信におけるNAT
- パケットの送信先をルーターのグローバルアドレスからLAN内のプライベートアドレスへ変換する
  - 「ポートを開ける」
  - 送信先のポート番号が特定の値になっているパケットのみに対して操作を実行する

## NATトラバーサル
### STUN
- Session Traversal Utilities for NAT
- 自身のネットワーク上のNATデバイスの存在を発見し、NATが存在する場合は
  自身の接続に割り当てられているパブリックIPとポート番号を取得するためのプロトコル
- STUNプロトコルはパブリックネットワーク上に存在するSTUNサーバーを利用する
  - STUNサーバーはパブリックIP・ポート番号を返す

#### STUNプロトコルの仕組み
1. STUNサーバーのIPアドレスが既知の場合、
   クライアントアプリケーションはSTUNサーバーへバインディングリクエストを送信する
2. STUNサーバーはレスポンスとして、
   クライアントアプリケーションのパブリックネットワークから見たIPアドレスとポート番号を返す

#### STUNプロトコルが解決する問題
- クライアントアプリケーションはパブリックIPとポート番号の組みを発見し、
  ピアとの通信時にパブリックIPとポート番号の組みをデータの一部として使用する
- STUNサーバーへのバインディングリクエストによって
  インバウンドパケットがクライアントアプリケーションへ到達できる
  ルーティングエントリが作成される
- STUNプロトコルにはKeep-Aliveメカニズムが定義されており、
  NATルーティングエントリのタイムアウトを防止する

### TURN
- Traversal Using Relays around NAT
- STUNが機能しない場合のフォールバックとして使用されるプロトコル
- UDPで動作し、動作しない場合はTCPへ切り替える
- TURNプロトコルはパブリックネットワーク上に存在するTURNサーバーを利用する
  - TURNサーバー(パブリックリレーサーバー)はピア間でデータを往復させる

#### TURNプロトコルの仕組み
1. 双方のクライアントが同一のTURNサーバーに割当要求を送信し、
   続けてパーミッションのネゴシエーションを行うことで接続を開始する
2. 双方のクライアントはデータをTURNサーバーに送信し、
   TURNサーバーがそのピアにデータを受け渡すことで通信を行う

### ICE
- Interactive Connectivity Establishment
- 通信の参加者間で最も効率の良い経路を確立するためのプロトコル
- 可能な限り直接接続を行い、必要ならばSTUNを活用し、動作しない場合はTURNを使用する

## 参照
- Linuxで動かしながら学ぶTCP/IPネットワーク入門 7
- [「NAT」の仕組みとルーターへの設定方法 ](https://www.atmarkit.co.jp/ait/articles/1512/03/news018.html)
- ハイパフォーマンスブラウザネットワーキング
