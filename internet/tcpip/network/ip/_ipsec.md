# IPSec
- IPヘッダの後ろに暗号化のためのヘッダを付加し、以降のデータを暗号化するプロトコル(RFC4301)
- IPパケット単位での暗号化・認証を提供する
- IPv4ではオプション、IPv6では標準実装

## 機能
- セキュリティポリシーに従ったパケットフィルタリング
- MACによるデータの完全性の保証
- MACによるパケットの真正性の保証
- シーケンス番号を用いた再送攻撃の防御
- ステートレスCookieを用いた送信元偽装鵜パケットの判別
- データの暗号化による機密生の確保(ESP)
- IPより上位層のヘッダを暗号化することによる機密性の確保

## 構成要素
#### AH(Authenticatiion Header)
- IPパケットの真正性・完全性を確保するプロトコル

#### ESP(Encapsulating Security Payload)
- IPパケットの機密性を確保するプロトコル

#### IKE(Internet Key Exchange)
- AHもしくはESPに先立って行われる鍵の共有、暗号方式のネゴシエーションのためのプロトコル

#### IPComp(IP Payload Compression Protocol)
- IPSecパケットの圧縮を行うプロトコル

## 動作モード
- トランスポートモード
  - ホスト間で接続し、IPヘッダ・ペイロード部のセキュリティを確保する
- トンネルモード
  - IPSecを実装したルーター間でIPパケット全体のセキュリティを確保する
  - セキュリティゲートウェイがパケットにIPSecヘッダを追加する(
    - = セキュリティゲートウェイ間でVPNを実現する

## SA(Security Association)
- ピア間で確立される単方向のコネクション
- セキュリティプロトコル、通信モード、暗号化方式などIPSec通信に必要なパラメータの集合
- IPSecで通信する機器同士はピアの関係となり、IPSecピア間でSAを確立する
- 双方向の通信を行う場合はSAを双方に対して一本ずつ張る

## 動作フロー
1. IKEにより共通鍵を生成するためのパラメータを相互に交換し、お互いに共通鍵を生成する
2. ISAKMP SAを確立し、ピアの認証を行う
3. IPSec SAを確立するためのパラメータをISAKMP SAによる暗号っか通信でやりとりし、IPSec SAを確立する
4. IPSec SAのセキュリティ通信モード、暗号化方式などに従って暗号化通信を行う
5. 受信後は複合して認証の検証を行い、上位レイヤにパケットを渡す

## 参照
- マスタリングTCP/IP 入門編
- マスタリングTCP/IP 情報セキュリティ編
