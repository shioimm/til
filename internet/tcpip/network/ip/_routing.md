# ルーティング(経路制御)
- 宛先IPアドレスのホストまでパケットを届けるための仕組み
- IPの経路制御はホップバイホップルーティング(1区間ごとに次のルートが決定される)によって行われる

## 種類
#### スタティックルーティング
- 管理者がルーティングテーブルを予め定義する方法

#### ダイナミックルーティング
- ルーター自身が他のルーターと情報を交換してルーティングテーブルを自動的に定義する方法
- ダイナミックルーティングを利用する場合、管理者はルーティングプロトコルの選択とプロトコルごとに必要な設定を行う
- 経路制御に必要な情報を交換するために隣り合うルーター間で定期的にメッセージを交換する


## 経路制御アルゴリズム
- 距離ベクトル型 - 距離と方向によって目的のネットワークやホストの位置を決定する
  - ルーター間でネットワークの方向と距離に関する情報が交換される
  - ネットワークの方向と距離の情報からルーティングテーブルを作成する
  - 経路制御情報が安定するまで時間がかかる、経路にループが生じやすい
- リンク状態型 - ルーターがネットワーク全体の接続状態を理解して経路制御を作成する
  - 各ルーターが他のルーターと同じ経路制御表を持つために、お互い素早く同期を行う
  - トポロジー情報の管理や処理に高いCPU能力と多くの資源が必要

## AS
- Autonomous System(自律システム / Routing Domain: 経路制御ドメイン)
- 同一のルールやポリシーによって経路制御を管理する単位
  - 組織内部で経路制御に関する方針を立て、その方針に従って経路制御が行われる
  - 地域ネットワークや大きなISPなど
  - ASに接続する組織はその管理者の指示に従って正露制御の設定を行う
- それぞれのASには16ビットのAS番号が割り当てられている

## ルーティングプロトコルの適用範囲
### EGP
- Exterior Gateway Protocol
- AS間の経路制御に利用されるドメイン間ルーティングプロトコル
  - 地域ネットワークやプロバイダを識別する
- RIP、RIP2、OSPFなどのプロトコルが利用される

### IGP
- Interior Gateway Protocol
- ASの内部でダイナミックルーティングに利用されるドメイン内ルーティングプロトコル
  - 地域ネットワークやプロバイダの内部に存在しているホストを識別する
- BGPなどのプロトコルが利用される
  - ネットワークの集合をASとしてまとめ、AS単位で一意なAS番号を振り、経路を制御する

## 主なルーティングプロトコル

| ルーティングプロトコル | 下位プロトコル | 方式         | 適用範囲 | ループの検出 |
| -                      | -              | -            | -        | -            |
| RIP                    | UDP            | 距離ベクトル | 組織内   | -            |
| RIP2                   | UDP            | 距離ベクトル | 組織内   | -            |
| OSPF                   | IP             | リンク状態   | 組織内   | 対応         |
| EGP                    | IP             | 距離ベクトル | 対外接続 | -            |
| BGP                    | TCP            | 経路ベクトル | 対外接続 | 対応         |

- EGPはExterior Gateway Protocolではなく特定のプロトコル名
  - CIDRに対応していないため現在のインターネットの対外接続用のプロトコルとして使用されていない

### RIP
- Routing Information Protocol
- 経路情報を定期的に(30秒周期)ネットワーク上にブロードキャストする
  - 6回待っても経路情報が届かない場合は接続切れと判断する
- 距離ベクトル型プロトコル
  - ホップ数(通過するルーター数)によって距離を計測する
- 距離ベクトルアルゴリズムによって距離ベクトルデータベースを作成し、
  距離が小さい経路を抜き出してルーティングテーブルを生成する
- 1種類のパケットで動作する
  - 経路制御情報を利用し、ネットワークが接続されているかどうかを確認しながら
    他のネットワークの情報も流す

#### 無限カウント
1. 経路上に二つのルーターがあり、片側のルーターの先のネットワークで障害が発生した場合、
2. 障害側のルーターAは経路情報を流さなくなる
3. もう片方のルーターBは元の経路情報に基づいてパケットを送信し続ける
4. ルーターAはもルーターBからの情報で、ルーターB経由で障害が発生しているネットワークにたどり着けると勘違いし、
   ルーティングテーブルを更新し続ける
- 解決策1. 距離16を通信不能とする
- 解決策2. スプリットホランズン(ルーターBはルーターAから教えられた情報をルーターAに伝えないようにする)

#### ポイズンリバース
- 経路が切れた時、通信不能であることを表す距離16を流す

#### トリガーアップデート
- 情報が変化した時、30秒待たずにすぐ伝える

### RIP2
- RIPバージョン2
  - 経路制御情報の交換のためにマルチキャストを使用する
  - サブネットマスクに対応
  - 一つのネットワーク上で論理的に独立した複数のRIPが使えるようになっている
  - BGPなどから得た経路制御情報を、RIPを使ってもAS内に通知する外部ルートタグ機能を実装
  - パスワードを用いて、自分が認識できるパスワードを持っているパケットのみを受容する

### OSPF
- Open Shortest Path First
- リンク状態型プロトコルであるため、ループのあるネットワークでも安定した経路制御が可能
  - 各リンクに重み(コスト)をつけることができ、重みが小さくなるように経路が選択される
- サブネットマスクに対応
- トラフィックの軽減のため、ネットワークの論理的な領域を意味するエリアの概念を導入
  - ネットワークをエリアに分けることによって不必要なルーティングプロトコルのやりとりを減少させる
- IPヘッダのサービスタイプフィールドごとに複数のルーティングテーブルを作成できる
- 役割ごとに5種類のパケットを使い分ける

#### 経路情報の交換
- ルーターが1対1で接続されるネットワークの場合は隣接ルーター間で経路情報が交換される
- 複数のルーターが同一リンクに接続されている場合は指名ルーターが決められ、
  指名ルーターを中心に経路情報が交換される

#### パケットの種類

| タイプ | パケット名         | 機能                                                         |
| -      | -                  | -                                                            |
| 1      | HELLO              | 隣接ルーター(同リンク上のルーター)の確認、指名ルーターの決定 |
| 2      | データベース記述   | データベースの要約情報                                       |
| 3      | リンク状態要求     | データベースのダウンロード要求                               |
| 4      | リンク状態更新     | データベースの更新情報                                       |
| 5      | リンク状態確認応答 | リンク状態更新の確認応答                                     |

- HELLOパケットを定期的に(LANの場合10秒周期)送信する
  - 4回待っても経路情報が届かない場合は接続切れと判断する
- 接続状態に変更があった場合はリンク状態更新パケットでネットワークLSAとルーターLSAを送信する
  - ネットワークLSA - そのネットワークにどのルーターが接続されているかの情報
  - ルーターLSA - そのルーターにはどのネットワークが接続されているかの情報
- ネットワークLSAとルーターLSAがOSPFで送信されると、ルーターはリンク状態データベースを作成する

#### エリア
- ネットワーク同士やホスト同士をまとめてグループ化したもの
- 各AS内には複数のエリアが存在できるが、必ず一つのバックボーンエリアに接続されている必要がある
  - バックボーンエリア - エリアID=0
  - エリア境界ルーター - エリアとバックボーンを結ぶルーター
  - 内部ルーター - エリア内のルーター
  - バックボーンルーター - バックボーンエリアにのみ接続されているルーター
  - AS境界ルーター - 外部と接続しているルーター
  - スタブエリア - エリア境界ルーターが一つしかないエリア
- ルーターはエリア内部のリンク状態のみを知っている
  - エリア外の経路についてはエリア境界ルーターがエリア境界ルーターからの距離のみを伝える

### BGP
- Border Gateway Protocol
- AS同士を接続するためのプロトコル
- 経路ベクトル型プロトコル
  - 通過するASの数によって距離を計測する
  - 各AS間の接続契約に基づいたパケット転送を行う
- 目的とするネットワークアドレスにパケットを送った際、
  そこに到達するまでに通過するAS番号のリスト(AS経路リスト)を作る

#### BGPスピーカー
- 経路制御情報を交換するルーター
- BGPスピーカーはAS間でBGPの情報を交換する全てのASと対等にBGPコネクションを確立する

### MPLS
- Multiprotocol Label Switching
- IPパケットにラベルを設定し、ラベルに基づいて転送するラベルスイッチングプロトコルの代表
  - 固定長のラベルを利用することで転送処理の高速化を図る
  - ラベエルを利用して仮想的なパスを張り、その上でIPなどパケットを使った通信ができる
- LSR(Label Switching Router) - MPLS機能に対応したルーター
- LER(Label Edge Router) - 外部のネットワークとの接続部分にあたるエッジのLSR
- 宛先や扱いが同じパケットはどれもラベルによって決まる同一の道筋(LSP: Label Switch Path)を通る
  - ポイントツーポイントLSP - 1対1接続
  - マージLSP - 同じ宛先のものを複数束ねた接続
  - 各LSRが隣接するLSPにMPLSラベルを配布するか、
    ルーティングプロトコルにラベル情報を乗せてやりとりすることでLSPを張る

#### MPLSのフォワーディング動作
1. MPLSネットワークに入るパケットに対して、LERが宛先IPアドレスを見てラベルを付加して転送(Push)
2. LSRがパケットに付加されたラベルを見て転送
3. MPLSネットワークから出てきたパケットに対して、LERがラベルを外して転送(Pop)

## 参照
- Linuxプログラミングインターフェース 58章
- Software Design 2021年5月号 ハンズオンTCP/IP
- マスタリングTCP/IP 入門編
