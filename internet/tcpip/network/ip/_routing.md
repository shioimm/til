# ルーティング(経路制御)
- 宛先IPアドレスのホストまでパケットを届けるための仕組み
- IPの経路制御はホップバイホップルーティング(1区間ごとに次のルートが決定される)によって行われる

## 種類
#### スタティックルーティング
- 管理者がルーティングテーブルを予め定義する方法

#### ダイナミックルーティング
- ルーター自身が他のルーターと情報を交換してルーティングテーブルを自動的に定義する方法
- ダイナミックルーティングを利用する場合、管理者はルーティングプロトコルの選択とプロトコルごとに必要な設定を行う
- 経路制御に必要な情報を交換するために隣り合うルーター間で定期的にメッセージを交換する


## 経路制御アルゴリズム
- 距離ベクトル型 - 距離と方向によって目的のネットワークやホストの位置を決定する
  - ルーター間でネットワークの方向と距離に関する情報が交換される
  - ネットワークの方向と距離の情報からルーティングテーブルを作成する
  - 経路制御情報が安定するまで時間がかかる、経路にループが生じやすい
- リンク状態型 - ルーターがネットワーク全体の接続状態を理解して経路制御を作成する
  - 各ルーターが他のルーターと同じ経路制御表を持つために、お互い素早く同期を行う
  - トポロジー情報の管理や処理に高いCPU能力と多くの資源が必要

## AS
- Autonomous System(自律システム / Routing Domain: 経路制御ドメイン)
- 同一のルールやポリシーによって経路制御を管理する単位
  - 組織内部で経路制御に関する方針を立て、その方針に従って経路制御が行われる
  - 地域ネットワークや大きなISPなど
  - ASに接続する組織はその管理者の指示に従って正露制御の設定を行う

## ルーティングプロトコル
### EGP
- Exterior Gateway Protocol
- AS間の経路制御に利用されるドメイン間ルーティングプロトコル
  - 地域ネットワークやプロバイダを識別する
- RIP、RIP2、OSPF(Open Shortest Path First)などのプロトコルが利用される

### IGP
- Interior Gateway Protocol
- ASの内部でダイナミックルーティングに利用されるドメイン内ルーティングプロトコル
  - 地域ネットワークやプロバイダの内部に存在しているホストを識別する
- BGP(Border Gateway Protocol)などのプロトコルが利用される
  - ネットワークの集合をASとしてまとめ、AS単位で一意なAS番号を振り、経路を制御する

## 主なルーティングプロトコル

| ルーティングプロトコル | 下位プロトコル | 方式         | 適用範囲 | ループの検出 |
| -                      | -              | -            | -        | -            |
| RIP                    | UDP            | 距離ベクトル | 組織内   | -            |
| RIP2                   | UDP            | 距離ベクトル | 組織内   | -            |
| OSPF                   | IP             | リンク状態   | 組織内   | 対応         |
| EGP                    | IP             | 距離ベクトル | 対外接続 | -            |
| BGP                    | TCP            | 経路ベクトル | 対外接続 | 対応         |

- EGPはExterior Gateway Protocolではなく特定のプロトコル名
  - CIDRに対応していないため現在のインターネットの対外接続用のプロトコルとして使用されていない

### RIP
- Routing Information Protocol
- 経路情報を定期的に(30秒周期)ネットワーク上にブロードキャストする
  - 6回待っても経路情報が届かない場合は接続切れと判断する
- ホップ数(通過するルーター数)によって距離を計測する
- 距離ベクトルアルゴリズムによって距離ベクトルデータベースを作成し、
  距離が小さい経路を抜き出してルーティングテーブルを生成する

#### 無限カウント
1. 経路上に二つのルーターがあり、片側のルーターの先のネットワークで障害が発生した場合、
2. 障害側のルーターAは経路情報を流さなくなる
3. もう片方のルーターBは元の経路情報に基づいてパケットを送信し続ける
4. ルーターAはもルーターBからの情報で、ルーターB経由で障害が発生しているネットワークにたどり着けると勘違いし、
   ルーティングテーブルを更新し続ける
- 解決策1. 距離16を通信不能とする
- 解決策2. スプリットホランズン(ルーターBはルーターAから教えられた情報をルーターAに伝えないようにする)

#### ポイズンリバース
- 経路が切れた時、通信不能であることを表す距離16を流す

#### トリガーアップデート
- 情報が変化した時、30秒待たずにすぐ伝える

### RIP2
- RIPバージョン2
  - 経路制御情報の交換のためにマルチキャストを使用する
  - サブネットマスクに対応
  - 一つのネットワーク上で論理的に独立した複数のRIPが使えるようになっている
  - BGPなどから得た経路制御情報を、RIPを使ってもAS内に通知する外部ルートタグ機能を実装
  - パスワードを用いて、自分が認識できるパスワードを持っているパケットのみを受容する

## 参照
- Linuxプログラミングインターフェース 58章
- Software Design 2021年5月号 ハンズオンTCP/IP
- マスタリングTCP/IP 入門編
