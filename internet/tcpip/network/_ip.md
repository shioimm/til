# IP
- IPアドレスを元に、インターネット全体にパケットを送り届けるためのプロトコル
  - インターネットに接続されるすべてのノード(ホスト・ルーター)は必ずIP・TCPの機能を実装する
  - インターネットに接続されるノード以外の機器(ブリッジ・リピータ・ハブ)はIP・TCPの機能を実装する必要はない
    - ノード以外の機器はIPパケットを単なるビット列やフレームとして扱うため
- コネクションレス指向・信頼性を担保しない・ベストエフォート通信
  - 機能の簡略化と高速化のため
- IPデータグラムは20-60バイトのヘッダを持ち、宛先ホストのアドレスや送信元のアドレスを扱う

## ルーティング(経路制御)
- 宛先IPアドレスのホストまでパケットを届けるための仕組み
- IPの経路制御はホップバイホップルーティング(1区間ごとに次のルートが決定される)によって行われる

### ルーティングテーブル(経路制御表)
- ノードはルーティングテーブルを保持・更新する
- ノードはルーティングテーブルに基づき、データグラムをルーターに向かって送出する
- IPはルーティングテーブルが正しい前提で機能するが、
  実際にルーティングテーブルが正しいかどうかを調べる機能を持たない
  - ルーティングテーブルが正しいかどうかはICMPが調べる

## パケットの分割処理
- IPのデータグラムサイズがデータリンクのMTUよりも大きい場合、
  IPがデータグラムを分割し、1データグラムあたりのサイズを小さくする
- 分割されたデータグラムはオフセットフィールドに元のデータグラム内での位置を持つ
- 分割されたデータグラムは宛先のIPによって復元される

## 送受信バッファ
- ホストマシン・ルーターはIPパケットを送受信するための送信バッファ・受信バッファを持つ
  IPパケットはホストマシン・ルーターの送受信バッファを介して転送される
- ホストマシン・ルーターの送受信バッファの実体はメモリ
- ホストマシン・ルーターの送受信バッファはキュー構造になっている

### 送受信バッファの利点
- 伝送速度が異なるネットワークに対応できる
- 送信先が異なるパケットが混在できる
- 処理能力が異なるホストに対応できる
- パケットの流量の変動に対応できる

## IPアドレス
- 終端ノードを示す識別子
- ネットワークインターフェースごとに割り当てられる
  - ホストには1つ以上、ルーターには2つ以上のIPアドレスが割り当てられる
- `ネットワーク部.ホスト部/ネットワークプレフィックス`
  - ネットワーク部はデータリンクのセグメントごとに重複しない値が割り当てられる
    - 同じセグメントに接続されているノードのネットワークインターフェースには同じ値が設定される
    - IPパケットが途中のルーターで転送される際は宛先IPアドレスのネットワーク部を利用する
  - ホスト部は同一セグメント内で重ならない値が割り当てられる

### ネットワーク部とホスト部の区切り方
- クラスによる区切り
- ネットワークプレフィックスによる区切り

### IPv4アドレス
- 32ビットサイズ(ドット区切りの10進数)
  - ネットワークアドレス - ネットワークID + ホストID
    - プレフィックス長を用いてネットワークIDとホストIDの区切りを示す(CIDR記法)
    - Ex. `192.0.2.1/24`の場合は`192.0.0.0`がネットワークID、`.1`がホストID、`/24`がプレフィックス長
  - ネットワークマスク - ネットワークID部: すべて1 + ホストID部: すべて0
  - サブネット化 - ホストIDをサブネットIDとホストIDへ分割する
    - 拡張ネットワークID - ネットワークID + サブネットID
    - サブネットマスク - 拡張ネットワークID部：すべて1 + ホストID部: すべて
- ループバックアドレス - 127.0.0.1
- IPv4ワイルドカード - 0.0.0.0
  - 自ホストの全てのIPアドレス宛のUDPデータグラム・TCP接続要求を処理する

### IPv6アドレス
- 128ビットサイズ(コロン区切りの16ビットの16進数)
  - 先頭数ビットはフォーマットプレフィックスを用いてアドレス種類を示す
- ループバックアドレス - ::1
- IPv6ワイルドカード - 0::0
- IPv4射影IPv6アドレス - IPv4にのみ対応しているホストと通信する際のIPv4-mappedアドレス

## 参照
- Linuxプログラミングインターフェース 58章
- Software Design 2021年5月号 ハンズオンTCP/IP
- マスタリングTCP/IP 入門編
