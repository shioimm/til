# ロードバランサ
- リクエストを受け、必要に応じて複数のインスタンスへリクエストを振り分けるミドルウェア
- クライアントに対しては仮想的な単一のサーバーとして機能する
- リクエストに対しサーバーファーム内から適切な実サーバーを選択し、パケットを転送する
- 実サーバーは到着したパケットに対するレスポンスを、直接クライアントへ送信する
- 実サーバー選択後、同一のクライアントからのリクエストは同じ物理サーバーに転送される(パーシステンス)
  - クライアントの状態をサーバ側で管理する必要がある
    - Ex. サーバーサイドは状態情報を共有DBに保持し、クライアントサイドはCookieなどで状態情報を持つ

### ロードバランシングの利点
- 拡張性
  - サーバー台数を増やすことにより、アクセスの増加に対して容易に対応することができる
- 可用性
  - サーバーに対して死活監視を行うことにより、サーバーダウン時もサービスを続行させることができる

## レイヤー
- ロードバランサはトランスポート層で分散するものとアプリケーション層で分散するものがある
- L7ロードバランサ - 負荷分散機構を備えたプロキシ・リクエスト単位で振り分ける
  - 接続先バックエンドを示すCookieを使用して接続維持を行う
- L4ロードバランサ - セッション単位で振り分ける
  - 接続元IPアドレスを基に接続維持を行う

## ロードバランシング手法
- ラウンドロビン方式
  - クライアントからのリクエストを各サーバーへ均等に転送する方式
- リーストコネクション
  - クライアントからのリクエストを現在のコネクション数が最も小さいサーバーへ転送する方式

## 代表的なロードバランサ
- LVS、HAProxy
- ロードバランス機能を備えたWebサーバー - Apache、Nginx
- ロードバランス機能を備えたプロキシサーバー - Varnish Cache、Apache Traffic Server
- クラウド事業者が提供するマネージドサービス - AWS ELB、Azure ALB、GCP GLB

## 死活監視
- ロードバランサは各サーバに対してKeep-Aliveを定期的に送り、応答時間を監視する
  - サーバーダウン時、ロードバランサは残りのサーバー群で負荷分散を続行する

## 接続ドレイン
- 古いバージョンのアプリケーションと新しいバージョンのアプリケーションへの接続を切り替える際、
  接続中のリクエストは古いアプリケーションへ、新規のリクエストは新しいアプリケーションへ
  ロードバランサを利用して振り分ける制御

## 参照
- [サーバロードバランス](https://ja.wikipedia.org/wiki/%E3%82%B5%E3%83%BC%E3%83%90%E3%83%AD%E3%83%BC%E3%83%89%E3%83%90%E3%83%A9%E3%83%B3%E3%82%B9)
- [ロードバランサの仕組み – 「さくらのクラウド入門」(4)](https://knowledge.sakura.ad.jp/6274/)
- サーバ・インフラエンジニアの基本がこれ一冊でしっかり身につく本 5
- Real World HTTP 第2版
