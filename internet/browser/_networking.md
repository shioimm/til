# ブラウザネットワーキング
## ソケット接続管理と最適化
- ブラウザはネットワークソケットを管理する
  - ソケットの再利用
  - リクエスト優先度付け
  - レイトバインディング
  - プロトコルネゴシエーション
  - 接続数制限の実施

### ソケットプール
- ソケットはオリジンごとにグループ化され、プールされる
  - 各プールには接続せ永源とセキュリティ制約が与えられる
  - 送信待ち状態のリクエストはキューに入れられ、優先度を付与され、プール内の個別のソケットにバインドされる
  - 同じソケエットが複数のリクエストで再利用される
- 最大プールサイズは6ソケット

## ネットワークセキュリティとサンドボックス化
- ソケット管理をブラウザが担うことにより、ブラウザをサンドボックスとして利用し、
  信頼できないアプリケーションコードに対して一定のセキュリティやポリシーの制約をかけることができる
  - 接続数制限
  - リクエスト整形とレスポンス処理
  - TLSネゴシエーション
  - 同一生成元ポリシー

## リソースとクライアント状態キャッシュ
- リクエスト送信時、ブラウザは自動的にリソースキャッシュを確認し、必要な検証を行い、
  指定された制限が満たされるとリソースのローカルコピーを返す
- ローカルリソースが使用不可能である場合はネットワークリクエストを行う
- レスポンスに対してキャッシュが許可される場合は自動的にキャッシュに保存する
- ブラウザはオリジンごとに個別のCookieを保存し、必要時にリクエストヘッダに書き込む

## アプリケーションAPIとプロトコル

| -                          | XMLHttpRequest | Server-Sent Events | WebSocket            |
| -                          | -              | -                  | -                    |
| リクエストストリーミング   | ×              | ×                  | ○                    |
| レスポンスストリーミング   | 制限あり       | ○                  | ○                    |
| フレーミングメカニズム     | HTTP           | イベントストリーム | バイナリフレーミング |
| バイナリデータ転送         | ○              | ×(base64)          | ○                    |
| 圧縮                       | ○              | ○                  | 制限あり             |
| アプリケーションプロトコル | HTTP           | HTTP               | WebSocket            |
| ネットワークプロトコル     | TCP            | TCP                | TCP                  |

### XMLHttpRequest
- クライアント -> サーバーへデータ転送できるブラウザAPI
- トランザクション的なリクエスト・レスポンス型の通信に最適化
- 通信あたりHTTPメタデータの分のオーバーヘッドが付与される

#### XMLHttpRequestにおいてブラウザが抽象化する低レベル動作
- 接続の確立・接続プーリング管理
- HTTPトランスポート決定
- HTTPキャッシュ・リダイレクト・コンテンツタイプネゴシエーション処理
- セキュリティ・認証・プライバシー制限実施
- その他

### Server-Sent Events
- サーバー -> クライアントへの効率的かつ低レイテンシなデータストリーミングを行うブラウザAPI
  - EventResource API - サーバーからのプッシュ通知をクライアントがDOMイベントとして取得するAPI
  - event stream データフォーマット - アップデートを配信する際に利用するデータフォーマット
- テキストベース + 単方向のストリーミングに最適化
- メッセージあたり5バイトのオーバーヘッドが付与される

#### Server-Sent Eventsにおいてブラウザが抽象化する低レベル動作
- 単一の持続的接続における低レイテンシ配信
- 効率的なメッセージ解析、バッファ容量管理
- 最後に送信されたメッセージの自動追跡、自動再接続
- DOMイベントとしてのクライアントメッセージ通知
- メッセージはフレームに分割され、フレームあたり2~14バイトのオーバーヘッドが付与される

### WebSocket
- クライアント <-> サーバー間における低レイテンシなデータストリーミングを行うブラウザAPI
- テキスト・バイナリデータベース + メッセージ指向 + 双方向のストリーミングに最適化

#### WebSocketにおいてブラウザが抽象化する低レベル動作
- 接続ネゴシエーションと同一生成元ポリシーの適用
- 既存のHTTPインフラとの相互運用
- メッセージ指向の通信とメッセージの効率的なフレーム化
- サブプロトコルネゴシエーションと拡張性

#### WebSocketにおいてブラウザが抽象化しない低レベル動作
- 状態管理
- 圧縮
- キャッシング

## 参照
- ハイパフォーマンスブラウザネットワーキング
