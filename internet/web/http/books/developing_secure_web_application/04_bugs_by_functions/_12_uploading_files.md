# 安全なWebアプリケーションの作り方(脆弱性が生まれる原理と対策の実践) まとめ
- 徳丸浩 著

## 12 ファイルアップロードにまつわる問題
- アップロード機能に対するDoS攻撃
  - アップロード機能に対して大量のデータを送信し攻撃対象サイトに負荷をかける
- アップロードファイルによるサーバー側スクリプト実行
  - アップロードしたスクリプトファイルがWebサーバー上で実行される
  - OSコマンドインジェクションと同じ影響
- ファイルダウンロードによるXSS
  - 仕掛けを含むファイルを利用者にダウンロードさせる
  - PDFのFormCalcによるコンテンツハイジャック

### アップロードファイルによるサーバー側スクリプト実行
- 発生箇所: ファイルのアップロード機能を提供するページ
- 影響範囲: すべてのページ
- 影響の種類: 情報漏洩、データの改ざん・削除、外部への攻撃、システムの停止
- 影響度合い: 大
- 利用者関与の範囲: 不要
- 対策:
  - 利用者がアップロードしたファイルは公開ディレクトリに置かず、スクリプト経由で閲覧させる
  - スクリプト実行の可能性のある拡張子を禁止する

#### 事例
- アップロードしたファイルを公開ディレクトリに保存した上で画面にも表示する仕組みのサイトにおいて、
  アップロードしたファイルへのリンクを踏むと任意のスクリプトが実行される

#### 原因
- アップロードしたファイルが公開ディレクトリに保存される
- スクリプト実行の可能性のある拡張子のファイルアップロードを許可している

#### 対策
- スクリプト実行の可能性のある拡張子を禁止する
- ダウンロードスクリプトを利用する
  - ダウンロードスクリプト -> スクリプト経由でダウンロードするファイル

### ファイルダウンロードによるXSS
- 発生箇所: ファイルのアップロード機能、ダウンロード機能
- 影響範囲: すべてのページ
- 影響の種類: なりすまし
- 影響度合い: 中〜大
- 利用者関与の範囲: 必要 -> リンクのクリックなど
- 対策:
  - ファイルのContent-Typeを正しく設定する
  - レスポンスヘッダX-Content-Type-Options: nosniffを指定する
  - ダウンロードを想定したファイルにはレスポンスヘッダとしてContent-Disposition: attachmentを指定する

#### 事例
- scriptタグを含むHTMLを記述したPDFファイルをアップロードされる
  - PATH_INFOを挿入したリンクからファイルアクセスを行うと、
  ブラウザがPDFファイルをHTMLに誤認し、任意のスクリプトを実行させてしまう

#### 原因
- ブラウザがコンテンツをHTMLと誤認する
  - 間違ったContent-Typeの指定
  - ブラウザが扱うことのできないContent-Typeの指定

#### 対策
- ファイルアップロード時の対策
  - スクリプト実行の可能性のある拡張子を禁止する
- ファイルダウンロード時の対策
  - Content-Typeを正しく設定する
  - X-Content-Type-Options: nosniffを指定する
    - X-Content-Type-Options -> Content-Typeで指定されたMIMEタイプをブラウザが変更しないことを指定する
    - 参照: [X-Content-Type-Options](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/X-Content-Type-Options)
  - 必要に応じてContent-Disposition: attachmentを指定する
    - Content-Disposition -> コンテンツをWebページとして表示するか、Webページの一部として表示するか、ダウンロードしてローカルに保存する添付ファイルとするかを示す
    - 参照: [Content-Disposition](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Content-Disposition)

### PDFのFormCalcによるコンテンツハイジャック
- 発生箇所: 利用者がアップロードしたPDFファイルをダウンロードする機能
- 影響範囲: セッション管理や認証のあるページ
- 影響の種類: なりすまし
- 影響度合い: 中〜大
- 利用者関与の範囲: 必要 -> 罠サイトの閲覧など
- 対策:
  - PDFファイルはブラウザ内で開かずダウンロードを強制する
  - PDFをobject要素やembed要素では開けない仕組みを実装する

#### 事例
0. 被害者が攻撃対象サイトにログインする
1. 攻撃者がFormCalcスクリプトを埋め込んだPDFファイルを攻撃対象サイトにアップロードする
2. 攻撃者が攻撃対象サイトにアップロードしたPDFファイルを埋め込んだ罠のページを罠サイトに設置する
3. 被害者が罠サイトを閲覧する
4. 埋め込まれたFormCalcスクリプトから攻撃対象サイトに対して被害者のクッキーでリクエストが送信される
5. 攻撃対象サイトから被害者の秘密情報がレスポンスとして送信され、罠サイトがFormCalcとJavaScriptを利用して秘密情報を受け取る

#### 原因
- Adobe Acrobat Readerのセキュリティ上好ましくない仕様を悪用した攻撃

#### 対策
- PDFファイルはブラウザ内で開かずダウンロードを強制する
  - 利用者のブラウザ上でスクリプトが実行されないようにする
- PDFをobject要素やembed要素では開けない仕組みを実装する
  - ファイルダウンロードをPOSTリクエストで行い、object要素やembed要素がロードされないようにする
