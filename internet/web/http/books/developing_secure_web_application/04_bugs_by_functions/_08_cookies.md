# 安全なWebアプリケーションの作り方(脆弱性が生まれる原理と対策の実践) まとめ
- 徳丸浩 著

## 08 クッキー出力にまつわる脆弱性
- クッキーにまつわる脆弱性
  - クッキーを利用すべきでない目的で使用している
    - クッキーに保存するべき情報
      - セッションID -> ログイン状態の保持などのために使用する
    - クッキーに保存するべきでない情報
      - ユーザーID
      - 権限情報
  - クッキーの出力方法に問題がある

#### クッキー出力時に発生しやすい脆弱性
  - HTTPヘッダインジェクション
  - クッキーのセキュア属性不備

### クッキーのセキュア属性不備
- 発生箇所: クッキーを発行しているすべての箇所
- 影響範囲: HTTPS通信を利用し、認証のあるすべてのページ
- 影響の種類: なりすまし
- 影響度合い: 中
- 利用者関与の範囲: 必要(HTTPSのみのサイト) -> リンクのクリック
- 対策:
  - クッキーにセキュア属性をつける
  - セッションIDとは別にセキュア属性つきのクッキーとしてトークンを発行し、ページごとにトークンを確認する

#### 事例
0. 被害者が攻撃対象サイトにログイ(セキュア属性のないクッキーがブラウザにセットされる)
1. 攻撃者が罠を用意
2. 被害者が罠を閲覧
3. 攻撃対象サイトへのリクエストを発行するHTMLが返る
4. 3によって攻撃対象サイトへのリクエストが発行される
5. 攻撃者がHTTPリクエストの中のクッキーを盗聴

#### 原因
- クッキーにセキュア属性をつけていない
  - つけ忘れ
  - HTTPとHTTPSが混在するサイト

#### 対策
- サイト全体をHTTPS化し、クッキーにセキュア属性をつける
- HTTPとHTTPSが混在するサイトの場合はセキュア属性つきのクッキーにトークンを保持する
  - HTTPのページとHTTPSのページでセッションを共有する
  - トークンは認証成功時に一回だけサーバーから出力される
  - トークンはHTTPSのページで生成される(サーバー -> ブラウザ)
  - トークンは確実に暗号化されてブラウザから送信される(ブラウザ -> サーバー)
  - HTTPSのページを閲覧するにはトークンが必須

#### その他セキュリティに関するクッキーの属性値
- Donmain属性
- Path属性
- Expires属性
- HttpOnly属性
